Title  : EMPEND Program
Purpose: Convert EMPIRE output into ENDF format
Author : A.Trkov
Version: 1996 Original code (ENEA, Bologna, Italy)
  98/10 Final version for distribution.
  99/11 Minor corrections to fix bugs.
  00/11 Implement formatting of elastic ang.distrib.
  00/12 Process total cross section.
  02/05 Fix MF4 processing for discrete levels.
  02/09 - Fix thresholds for multi-particle emission
        - Photon branching ratios for the last level (MF12)
        - Atomic weight ratios for target and recoils.
  02/11 Implement continuum photon spectra processing.
  03/06 Define MT numbers for incident protons.
  03/07 Fix processing of double differential data for protons.
  04/06 - Process discrete levels flagged with -ve energies.
        - Let EMPIRE handle the max. outgoing particle energy.
  04/07 - Fix ordering of levels in MF12,
        - Read in values in double precision to avoid underflow.
        - Fix MTs and yields of minor reactions (37, 41, etc).
  04/07 - Add (n,5n) MT47 (temporarily deactivated 23jun05)
        - Check for absence of distribution data (NP=0 in MF6).
  04/09 - Check for normalisation overflow in WRIMF4
  04/10 Implement formatting for incident alphas and photons.
  05/04 - Copy comments to MF1/MT451.
        - Upgrade to proces partially exclusive/inclusive spectra.
        - Allow metastable targets.
  05/06 Increase MXR from 200K to 800K.
  05/08 - Improved logic to reduce convergence problems of fitting
          angular distributions.
        - Add unassigned reactions to MT5 with yields for neutrons,
          protons and alpha particles.
        - Fix yields and pseudo-threshold distributions in MF6/MT5.
  06/02 - Input NLIB, ALAB, EDATE, AUTHOR strings.
  07/02 - Trivial change for single-character element designation.
  07/03 - Remove extra SEND record after MF1 data.
  07/05 - Remove redundant messages about ang.dist.interpolation.
        - Fix small bug in gamma-yields at threshold.
        - Read isomer-production cross sections.
  07/10 - Add scattering radius and target spin in File 2.
        - Improve radioisotope production formatting in MF10.
  07/11 Major cleanup with the following features:
        - Improvement of the resonance file, adding fictitious
          resonances in the thermal range based on systematics
          (2 bound levels and 2 s-wave resonances that normally
          fall outside the resonance range, giving an order-of-
          magnitude estimate of the thermal value).
        - Extension of the cross sections for incident neutrons
          to the lower limit of 1E-5eV.
        - Addition of MF8 for reactions in MF10.
        - Normalisation of branching ratios in MF12.
        - Set Tape-ID to 7777 (STANEF does not like zero).
        - Trap negative gamma-yields (force zero).
        - Write MEND, TEND records to ENDF file and stop when problems
          are encountered (REAMF6 routine).
        The resulting ENDF file does not include the dictionary
        section, which can be generated by the STANEF utility code.
        Apart from this, the ENDF file should be "clean" as far as the
        checking codes are concerned.
  08/01 Check for legal outgoing particle for the assigned reaction;
        ignore the spectrum if the particle is illegal
        (current empire does not distinguish between (2n2p) and (a)).
  08/02 Improved compiler compatibility (use of undefined variables).
  08/05 - Separate (z,2n2px) from (z,ax), when possible.
        - Fix gamma yields at high energies when cross sections go
          to zero, e.g. (z,ax) after subtracting (z,2n2px).
  08/12 - Fix formatting of MF10 reactions involving alphas.
        - Print WARNING when unprocessable spectra are encountered.
        - Fix unititialised variables.
        - Activate formatting of charged particles.
  09/04 - Fix gamma BR=1 to ground state in MF12 when no data given.
  09/06 - Fix ELFS=QM-QI in MF8.
  09/08 - Fix NS in MF12 and again ELFS (see above).
  09/11 - Process light charged-particle emission data.
  09/12 - Add total inelastic MT4 as the redundant cross section.
  10/05 - Trivial format change for isomeric states(column alignment)
  10/06 - Change reaction (z,na) to (z,an) in EMTCHR.
  10/08 - Accept reaction (z,na) &  (z,an)  due to change in EMPIRE.
        - Fix cases of undefined variables
  11/01 - Redo complex reaction identification based on new printout
          of population cross sections
  11/02 - Restore printout of pseudo-resonance data.
        - Refine tolerance for matching energies of discrete levels.
        - Fix number of photons in MF14 to match MF12.
  11/04 - Set LRF to MLBW because NJOY does not like anything else
          when energy-dependent scattering radius is given.
        - Update the comments and input instructions.
  11/06 - Fix calculation of outgoing energy when no recoils given
        - Print warning when no recoils given on output
        - Improved identification of insignificant cross sections.
  11/12 - Fix to previous fix when recoils spectra are given.
  12/02 - Output changed - fix search string.
        - Fix processing of ENDF=0 option, recognised by lack of
          spectrum data - except (z,x) (left in by mistake?)
        - Allow incident deuterons, tritons, He-3
  12/03 - Minor corrections to restore fission spectrum formatting.
        - Set LCT flag to LAB for fission spectra.
        - Define proper interpolation rules for fission spectra
          (fission spectrum is interpolated well with lin-lin
           interpolation except in the tails, but only a single
           interpolation range can be defined in ENDF)
        - Reduce emission spectra thinning criterion from 1 to 0.5 %.
  
  Manual for Program EMPEND
  =========================
  
  The EMPIRE output is processed and converted into ENDF format.
  The ENDF formatted output file has to obey the rule of ordering
  the reactions in increasing order by the reaction MT number,
  so several sweeps of the EMPIRE file are made:
   - In the first sweep the cross sections and the corresponding
     reaction Q-values are extracted. All reading is done with
     the REAMF3 routine.
   - In the next sweep all reactions for which particle spectra
     are given are identified. All reading is done with the SCNMF6
     routine.
   - Another sweep is made for each reaction having angular
     distributions. This applies to the elastic and all discrete
     level reactions (inelastic neutron, alpha and proton
     emission).
   - Next follows a sweep for each reaction having energy-angle
     correlated outgoing particle distributions.
   - Finally, a sweep is made for the remaining reactions,
     particularly the (n,gamma) reaction, for which the
     particle distributions are coded in ENDF File-6.
  
  In the first sweep radionuclide production cross sections are
  located and the MT numbers are assigned, when possible.
  Cross sections, which can not be identified uniquely by an MT
  number are assigned MT=10(Z*1000+A)+LFS where LFS is the final
  isomeric state of the nuclide. The spin of the target nucleus,
  the S0-strength function, the average gamma width, the average
  level spacing and the energy-dependent scattering radius are
  also extracted to enable the assembly of the dummy resonance
  parameter file.
    In the second sweep, all reactions that do not have explicitly
  given spectra are added to MT=5. When many exclusive spectra are
  requested in the EMPIRE calculation, there may be cases where
  particle spectra are given but no MT number is assigned. The
  spectra are ignored, the cross sections are added to MT=5 and
  particle production cross sections for this MT are incremented.
    After the second sweep, all necessary information is
  available to write the comments-section (MF=1) and the prompt
  nu-bar (if the nuclide is fissile). For incident neutrons a
  dummy resonance file (MF=2) is constructed.
    The cross section data found on the file are fitted by a
  cubic spline and entered into the output ENDF file on a
  user-defined dense energy grid, thinned to the specified
  tolerance and taking reaction thresholds into account.
  If desired, the spline interpolation may be suppressed and
  the energy points found on the file are entered directly into
  the ENDF formatted file.
  
  The angular distributions for discrete level reactions
  that appear in the ENDF File-4 sections are extracted from
  the spectra on the EMPIRE output file, interpolated to
  the appropriate energy, if necessary. Legendre polynomial
  coefficients in the centre-of-mass are fitted to the
  distributions. For elastic scattering the Legendre
  coefficients are copied directly from the EMPIRE output;
  If more than 64 Legendre coefficients are required, formatting
  switches automatically to pointwise representation.

  The correlated energy-angle distributions for continuum
  reactions that appear in ENDF file-6 sections are entered
  in Legendre polynomial representation in the centre-of-
  mass coordinate system. The maximum Legendre order is
  limited to 64. For reactions with relatively smooth
  angular distributions, the number of coefficients is
  reduced accordingly.

  Photon production information for discrete levels can be stored
  in ENDF files-12 and 14. The spectra for the continuum are
  included in File-6 (rather than file 15). File-12 contains photon
  transition probabilities and photon emission probabilities for
  discrete level reactions, while File 14 contains the corresponding
  angular distributions, which are assumed isotropic. The gamma
  spectra of the (n,gamma) reaction are presently stored in File-6.
  Primary gammas, which are optionally printed in the Empire output
  are not formatted. This option should not be used when ENDF
  formatting is required.

  Instructions:
  The program can be executed interactively from a terminal
  screen. The required input is entered in response to the
  prompts, which are the following:
   - The name of the EMPIRE output file to be processed.
   - The name of the ENDF formatted file to be written.
   - Number of subintervals per incident neutron energy interval
     on the EMPIRE output file. The subintervals define the fine
     energy mesh for the cross sections on the ENDF formatted
     file. The following are applicable:
       0  Only the points on the EMPIRE output are entered to the
          ENDF formatted file.
       1  The points at reaction thresholds are entered. The energy
          points above are as found in the EMPIRE output file.
       n  Threshold points are entered, but in addition, each
          interval on the EMPIRE output is subdivided into "n"
          subintervals. Cross section values at intermediate points
          are defined by a cubic spline fit.
   - Thinning tolerance limit [%] to reduce the number of cross
     section points. Data points which, can be reproduced from the
     neighbouring points by linear interpolation to within the
     specified tolerance, are removed. Entering a negative value
     for the thinning tolerance limit causes thinning to be
     suppressed.
   - ENDF material number identifier.
   - NLIB number assigned to the evaluation (see ENDF-6 manual).
     The parameters are optional.
   - ALAB, EDATE, AUTHOR string, where each of the listed
     parameters occupies 11 columns (see ENDF-6 manual for
     details). The parameters are optional.

   NOTES:
   - Extensive exclusive spectra calculations in EMPIRE
     should be avoided when ENDF formatting is needed, since
     for complex reactions when a residual nuclide can be
     produced from more than one reaction, the assignment of
     spectra can not be done uniquely. It is recommended to
     allow up to 4 emitted neutrons and only a single charged
     particle.
   - All text preceeding the printout for first energy is
     transferred to the comments section in the ENDF file (FM=1,
     MT=451). The easiest way to insert customised comments into
     the ENDF file is to modify (manually) the EMPIRE output.
   - The resonance file (MF=2) that is generated for files
     with incident neutrons is by no means a realistic cross
     section representation. It is given for completeness, when
     no information on the resonances (other than from the
     systematics is available). The code places resonances spaced
     uniformly around the thermal value according to the given
     average level spacing. The neutron width is defined from the
     S0 strength function and the gamma-widths are the average
     gamma widths. The assigned resonance formalism is the
     Multi-level Breit-Wigner formalism with energy-dependent
     scattering radius.

  To monitor the formatting process for quality assurance
  purposes, the EMPEND.LOG file is written in which the
  details of the formatting process are recorded. A limited
  amount of checking is done. An entry to the log file is
  added in the follwing cases:
   - The cross section obtained by integrating the spectrum
     should agree with the value given directly in the
     EMPIRE output file. If the difference exceeds 2%,
     a warning message is written, giving the reaction
     MT number, the incident particle energy, the expected
     cross section (i.e. the value given directly in the
     EMPIRE output file) and the percent difference.
   - The angular distributions are fitted to determine the
     Legendre polynomial expansion coefficients. If the
     distribution reconstructed from the Legendre polynomial
     coefficients differs from the pointwise values on the
     EMPIRE output file by more than 5%, a warning message
     is written, giving the reaction MT number, the outgoing
     particle ZA identifier, the incident and the outgoing
     particle energies and the percent difference in the
     fitted distribution from the pointwise value on the
     file.
  Additional messages monitor the progress of the data
  formatting process.


 Limits on array sizes:
 MXE - Maximum number of incident particle energy points.
 MXT - Maximum number of reactions (including discrete levels).
 MXM - Maximum number of residual nuclei.
 MXR - Lengrh of the real work array RWO.
 MXI - Length of the integer work array IWO.

