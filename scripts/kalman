#! /bin/sh -
#SCRIPT TO RUN KALMAN (COVARIANCE MATRIX DETERMINATION)
file=$1
AMT=$2
MAT=$3
EXPDAT=$4

if [ "$AMT" = "0" ]
   then
   AMT="1 2 4 16 102"
fi
if [ "$EXPDAT" = "" ]
   then
   EXPDAT=1
fi
if [ "$MAT" = "3" ]
   then
   MAT=1111
fi
#
# EXPDAT=1 - OPTION
#
if [ "$EXPDAT" = "1" ]
   then
   for MT in $AMT
     do
       echo "MT= ${MT}"
       work=`pwd`
       rm fort.* 2>/dev/null
       rm MT33 2>/dev/null
       rm SENSITIVITY.INP 2>/dev/null
       rm KALEND.INP 2>/dev/null
       rm KALMAN.INP 2>/dev/null
       rm ENDF.DAT 2>/dev/null
       # Input for c4tokal and kalend
       cat >KALEND.INP <<EOF
$MT $MAT 0 $EXPDAT
EOF
       cp $file-inp.sen SENSITIVITY.INP

       ../util/kalman/genkal.pl $file

       ln -s $file.c4 fort.1

       ../util/kalman/c4tokal<KALEND.INP >KALMAN.INP
       rm fort.1
       # correlations among experimental data
       if [ ! -s $file-expcorr.kal ]; then
          cp fort.12 $file-expcorr.kal  
       else
          cp $file-expcorr.kal fort.12     
       fi
       # correlations among model parameters
       if [ ! -s $file-parcorr.kal ]; then
          cp fort.52 $file-parcorr.kal  
       else
          cp $file-parcorr.kal fort.52     
       fi
       # experimental data
       if [ ! -s $file-expxsc.kal ]; then
          cp fort.10 $file-expxsc.kal  
       else
          cp $file-expxsc.kal fort.10     
       fi
       #
       # RUN OF KALMAN
       #
       echo 'Edit Kalman input'
       emacs KALMAN.INP
       ../util/kalman/kalman3 <KALMAN.INP >$file-out.kal
       mv fort.13 $file-xsc.kal
       mv fort.14 $file-cov.kal
       ln -s $file.endf ENDF.DAT
       # run KALEND
       ../util/kalman/form.pl $MAT $MT >$file-33-$MT.cov
       ../util/kalman/mf33.pl $MT <$file-33-$MT.cov
       ../util/kalman/mf33.pl -$MT <$file-33-$MT.cov >corrplot.dat
       mv fort.18 $file-err-$MT.kal
       gnuplot ../util/kalman/corr.plt
       mv corrplot.dat $file-$MT-cov.gnudat
   done
  #
  # EXPDAT=0 AND 2 - OPTION
  #
else
echo "AMT= ${AMT}, "
       work=`pwd`
       rm fort.* 2>/dev/null
       rm MT33 2>/dev/null
       rm SENSITIVITY.INP 2>/dev/null
       rm KALEND.INP 2>/dev/null
       rm KALMAN.INP 2>/dev/null
       rm ENDF.DAT 2>/dev/null
       # Input for c4tokal and kalend
       cat >KALEND.INP <<EOF
1 $MAT 0 $EXPDAT
EOF
       cp $file-inp.sen SENSITIVITY.INP

       ../util/kalman/genkal.pl $file

       ln -s $file.c4 fort.1

       ../util/kalman/c4tokal<KALEND.INP >KALMAN.INP
       rm fort.1
       # correlations among experimental data
       if [ "$EXPDAT" = "2" ]; then
          if [ ! -s $file-expcorr.kal ]; then
             cp fort.12 $file-expcorr.kal  
          else
              cp $file-expcorr.kal fort.12     
          fi
       fi
       # correlations among model parameters
       if [ ! -s $file-parcorr.kal ]; then
          cp fort.52 $file-parcorr.kal  
       else
          cp $file-parcorr.kal fort.52     
       fi
       # experimental data
       if [ "$EXPDAT" = "2" ]; then
          if [ ! -s $file-expxsc.kal ]; then
             cp fort.10 $file-expxsc.kal  
          else
             cp $file-expxsc.kal fort.10     
          fi
       fi
       ../util/kalman/kalman3 <KALMAN.INP >$file-out.kal
       mv fort.13 $file-xsc.kal
       mv fort.14 $file-cov.kal
       ln -s $file.endf ENDF.DAT
       for MT in $AMT
       do
        echo "MT=${MT}, MAT=${MAT}"
# tmp
#        echo 'Edit Kalman input'
#        emacs KALMAN.INP
# tmp
        cat >KALEND.INP <<EOF
$MT $MAT 0 $EXPDAT
EOF
        ../util/kalman/form.pl $MAT $MT >$file-33-$MT.cov
        ../util/kalman/mf33.pl $MT <$file-33-$MT.cov
        ../util/kalman/mf33.pl -$MT <$file-33-$MT.cov >$work/$file-$MT-cov.gnudat
        mv fort.18 $file-err-$MT.kal
# tmp
#        cp $file-$MT-cov.gnudat corrplot.dat
#        gnuplot ../util/kalman/corr.plt
# tmp
       done
  fi
rm SENSITIVITY.INP
rm KALEND.INP
rm KALMAN.INP
rm ENDF.DAT
rm fort.*


