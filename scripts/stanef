#! /bin/sh -
#script to standardize ENDF formatted file with STAN
# if processing is successful, result is renamed back to $1.endf

if [ -z $EMPIREDIR ]; then
    echo "Please set the 'EMPIREDIR' environment variable."
    echo "See Empire v3 documentation for more information."
    exit
fi

file=$1

if [ "$1" = "" ]; then
	echo 'ENDF files ready to run'
	echo ' '
	ls *endf
	echo ' '
	echo -n 'Choose one of the above (without .endf extention!): '
	read file
fi                          

# STANDARDIZE THE FILE ENSURING UNIX LF AND CUTTING OUT AT 75TH COLUMN

dos2unix $file.endf
cut -c 1-75 $file.endf >cutmp
mv cutmp $file.endf

# RUN STAN

$EMPIREDIR/util/stan/stan -x=1 -f --verbose -cm -o $file.STN $file.endf > $file-log.stan

if [ ! -f $file.STN ]; then
    echo " STAN output file ($file.STN)  was not created."
    echo " Check the input endf file " $file.endf
    echo " Opening log file with less (hit q and enter to exit less)"
    less $file-log.stan
    echo " Hit any button to exit "
    read a
    exit
fi

# CHECK THAT THE testfile CONTAINS FEND RECORD AT THE END AND IS OF NON-TRIVIAL LENGTH (>5 LINES)
# IF SAFE OVERWRITE $file.endf
testfile=$file.STN
if [ ! -f $testfile ]; then
    echo " FATAL ERROR:"
    echo " Output file " $testfile " has not been created."
    echo " Hit any button to exit "
    read a
    exit
fi
fend=`tail -1 $testfile | cut -c 69-70`
nlines=`cat $testfile | wc -l`
echo ' '
echo $testfile ' ends with:' `tail -1 $testfile`
if [ $fend = -1 ]; then
   echo 'ENDF file has ' $nlines ' lines and ends with the FEND record' 
   if [ $nlines > 5 ]; then
      echo $testfile ' assumed correct and will overwrite' $file.endf
      mv $testfile $file.endf  >> $file-log.stan
   else
      echo 'Not enough lines in ' $testfile
      echo 'Processing has failed - EXIT without overwritting ' $file.end
      exit
   fi
else 
   echo 'Not a legal FEND record at the end of ' $testfile
   echo 'Processing has failed - EXIT without overwritting ' $file.endf
fi


exit
