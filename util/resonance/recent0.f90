!=======================================================================
!
!     PROGRAM THERMX (REVISED RECENT)
!
!     MODIFIED TO WRITE THE CROSS SECTION AT SOME DESIRED ENERGIES ONLY
!     THIS PROGRAM :
!      1. DOES NOT WRITE ENDF FILE FOR SPEED-UP
!      2. PRINTS CROSS SECTIONS AT SOME CHOSEN ENERGIES AND THE FIRST FEW RESONANCE ENERGIES
!      3. SUPPORTS BREIT-WIGNER LEVEL DATA ONLY
!     
!
!
!     VERSION 79-1 (OCTOBER 1979)  CDC-7600
!     VERSION 80-1 (MAY 1980)      IBM, CDC AND CRAY VERSION
!     VERSION 80-2 (DECEMBER 1980) IMPROVED TREATMENT OF UNRESOLVED
!                                  REGION TO COMPUTE ALL REACTIONS AT
!                                  THE SAME TIME.
!     VERSION 81-1 (MARCH 1981)  IMPROVED BASED ON USER COMMENTS.
!     VERSION 81-2 (AUGUST 1981) ADDED MONITOR MODE. ADDED SPEED OPTION
!                                TO BYPASS BACKWARDS THINNING IF FILE 3
!                                ALLOWABLE ERROR = 0.0 (NOTE THIS OPTION
!                                WILL RESULT IN ALL TABULATED POINTS
!                                FROM THE EVALUATION BEING KEPT IN THE
!                                OUTPUT FROM THIS PROGRAM).
!     VERSION 82-1 (JANUARY 1982) IMPROVED COMPUTER COMPATIBILITY.
!     VERSION 83-1 (JANUARY 1983)*MAJOR RE-DESIGN.
!                                *PAGE SIZES INCREASED.
!                                *ELIMINATED COMPUTER DEPENDENT CODING.
!                                *NEW, MORE COMPATIBLE I/O UNIT NUMBERS.
!                                *ADDED OPTION TO KEEP ALL RECONSTRUCTED
!                                 AND BACKGROUND ENERGY POINTS.
!                                *ADDED STANDARD ALLOWABLE ERROR OPTIONS
!                                 (CURRENTLY 0.1 PER-CENT RECONSTRUCTION
!                                 AND 0.0 PER-CENT THINNING).
!     VERSION 83-2 (OCTOBER 1983) IMPROVED BASED ON USER COMMENTS.
!     VERSION 84-1 (JANUARY 1984) IMPROVED INTERVAL HALFING CONVERGENCE.
!     VERSION 85-1 (APRIL 1985)  *A BRAND NEW PROGRAM WHICH COMPLETELY
!                                 SUPERCEDES ALL PREVIOUS VERSIONS OF
!                                 THIS PROGRAM.
!                                *UPDATED FOR ENDF/B-VI FORMATS.
!                                *ADDED GENERAL REICH-MOORE FORMALISM
!                                 (WITH TWO FISSION CHANNELS).
!                                *DECREASED RUNNING TIME.
!                                *SPECIAL I/O ROUTINES TO GUARANTEE
!                                 ACCURACY OF ENERGY.
!                                *DOUBLE PRECISION TREATMENT OF ENERGY
!                                 (REQUIRED FOR NARROW RESONANCES).
!     VERSION 85-2 (AUGUST 1985) *FORTRAN-77/H VERSION
!     VERSION 86-1 (JANUARY 1986)*ENERGY DEPENDENT SCATTERING RADIUS
!     VERSION 86-2 (JUNE 1986)   *IF FIRST CHANCE FISSION (MT=19)
!                                 BACKGROUND IS PRESENT ADD RESONANCE
!                                 CONTRIBUTION OF FISSION TO IT.
!     VERSION 86-3 (OCTOBER 1986)*MULTI-LEVEL OR REICH-MOORE..CORRECT
!                                 POTENTIAL SCATTERING CROSS SECTION FOR
!                                 MISSING AND/OR FICTICIOUS (L,J)
!                                 SEQUENCES.
!     VERSION 87-1 (JANUARY 1987)*IMPROVED COMBINING FILE 2+3
!     VERSION 87-2 (MARCH 1987)  *CORRECTED ADLER-ADLER CALCULATIONS.
!     VERSION 88-1 (JULY 1988)   *UPDATED REICH-MOORE ENDF/B-VI FORMAT
!                                 TO BE THE SAME AS REICH-MOORE FORMAT
!                                 IN EARLIER VERSIONS OF ENDF/B FORMAT.
!                                *CHECK FOR PRELIMINARY ENDF/B-VI
!                                 REICH-MOORE FORMAT (NOW ABANDONED)
!                                 AND TERMINATE EXECUTION IF DATA IS
!                                 IN THIS FORMAT.
!                                *CALCULATE CHANNEL RADIUS OR SET IT
!                                 EQUAL TO THE SCATTERING RADIUS.
!                                *IMPLEMENTED HYBRID R-FUNCTION WITH THE
!                                 FOLLOWING RESTRICTIONS
!                                 - ONLY INELASTIC COMPETITION (NO
!                                   CHARGED PARTICLES)
!                                 - NO TABULATED FILE 2 BACKGROUND
!                                 - NO TABULATED OPTICAL MODEL PHASE
!                                   SHIFT
!                                *PROGRAM EXIT IF GENERAL R-MATRIX IN
!                                 THE EVALUATION (THIS FORMALISM WILL
!                                 BE IMPLEMENTED ONLY AFTER THE AUTHOR
!                                 RECEIVES REAL EVALUATIONS WHICH USE
!                                 THIS FORMALISM...UNTIL THEN IT IS
!                                 IMPOSSIBLE TO ADEQUATELY TEST THAT
!                                 THE CODING FOR THIS FORMALISM IS
!                                 CORRECT).
!                                *INCREASED MAXIMUM NUMBER OF RESONANCES
!                                 FROM 1002 TO 4008.
!                                *DOUBLE PRECISION RESONANCE REGION
!                                 LIMITS.
!                                *FILE 2 AND FILE 3 ENERGIES WHICH ARE
!                                 NEARLY EQUAL ARE TREATED AS EQUAL
!                                 (I.E., SAME TO ABOUT 9 DIGITS).
!                                *CHECK FILE 3 BACKGROUND CROSS SECTIONS
!                                 IN EDIT MODE.
!                                *OPTION...INTERNALLY DEFINE FILENAMES
!                                 (SEE SUBROUTINE FILEIO FOR DETAILS).
!     VERSION 89-1 (JANUARY 1989)*PSYCHOANALYZED BY PROGRAM FREUD TO
!                                 INSURE PROGRAM WILL NOT DO ANYTHING
!                                 CRAZY.
!                                *UPDATED TO USE NEW PROGRAM CONVERT
!                                 KEYWORDS.
!                                *CORRECTED MULTILEVEL, REICH-MOORE AND
!                                 HYBRID R-FUNCTION POTENTIAL SCATTER
!                                 TO ACCOUNT FOR REPEATED J-VALUES FOR
!                                 THE SAME TARGET SPIN AND L-VALUE.
!                                *ADDED LIVERMORE CIVIC COMPILER
!                                 CONVENTIONS.
!                                *UPDATED TO USE NEW ENDF/B-VI
!                                 CONVENTION TO ALLOW UNRESOLVED
!                                 RESONANCE CONTRIBUTION TO ALREADY
!                                 BE INCLUDED IN THE FILE 3 CROSS
!                                 SECTIONS (INFINITELY DIULUTE
!                                 CONTRIBUTION).
!     VERSION 90-1 (JUNE 1990)   *UPDATED BASED ON USER COMMENTS
!                                *ADDED FORTRAN SAVE OPTION
!                                *NEW MORE CONSISTENT ENERGY OUTPUT
!                                 ROUTINE
!     VERSION 91-1 (JULY 1991)   *NEW UNIFORM TREATMENT OF ALL RESONANCE
!                                 FORMALISMS (SEE, COMMENTS BELOW)
!                                *NEW REICH-MOORE ALGORITHM
!                                *MORE EXTENSIVE ERROR CHECKING AND
!                                 ERROR MESSAGE EXPLANATIONS
!     VERSION 92-1 (JANUARY 1992)*MAJOR RESTRUCTING TO IMPROVE ACCURACY
!                                 AND COMPUTER INDEPENDENCE.
!                                *INCREASED ENERGY POINT PAGE SIZE FROM
!                                 1002 TO 4008.
!                                *NO MORE THAN 2 ENERGY POINTS WHERE
!                                 CROSS SECTION IS ZERO AT BEGINNING
!                                 OF A SECTION FOR EACH REACTION,E.G.,
!                                 THRESHOLD FISSION.
!                                *PROCESS ONLY A PORTION OF RESONANCE
!                                 REGION - SEE EXPLANATION BELOW
!                                *ALL ENERGIES INTERNALLY ROUNDED PRIOR
!                                 TO CALCULATIONS.
!                                *COMPLETELY CONSISTENT I/O AND ROUNDING
!                                 ROUTINES - TO MINIMIZE COMPUTER
!                                 DEPENDENCE.
!     VERSION 93-1 (MARCH 1993)  *UPDATED REICH-MOORE TREATMENT TO USE
!                                 L DEPENDENT SCATTERING RADIUS (APL)
!                                 RATHER THAN SCATTERING RADIUS (AP)
!                                 (SEE, ENDF/B-VI FORMATS AND
!                                  PROCEDURES MANUAL, PAGE 2.6)
!                                *INCREASED PAGE SIZE FROM 4008 TO
!                                 20040 DATA POINTS.
!                                *INCREASED MAXIMUM NUMBER OF RESONANCES
!                                 FROM 4008 TO 20040.
!     VERSION 94-1 (JANUARY 1994)*VARIABLE ENDF/B DATA FILENAMES
!                                 TO ALLOW ACCESS TO FILE STRUCTURES
!                                 (WARNING - INPUT PARAMETER FORMAT
!                                 HAS BEEN CHANGED).
!                                *CLOSE ALL FILES BEFORE TERMINATING
!                                 (SEE, SUBROUTINE ENDIT)
!     VERSION 94-2 (AUGUST 1994) *CORRECTED ADDJ FOR ENERGY DEPENDENT
!                                 (TABULATED) SCATTERING RADIUS CASE.
!     VERSION 96-1 (JANUARY 1996) *COMPLETE RE-WRITE
!                                 *IMPROVED COMPUTER INDEPENDENCE
!                                 *ALL DOUBLE PRECISION
!                                 *ON SCREEN OUTPUT
!                                 *UNIFORM TREATMENT OF ENDF/B I/O
!                                 *IMPROVED OUTPUT PRECISION
!                                 *ALWAYS INCLUDE THERMAL VALUE
!                                 *DEFINED SCRATCH FILE NAMES
!     VERSION 97-1 (APRIL 1997)   *OPTIONAL MAKE NEGATIVE CROSS
!                                  SECTION = 0 FOR OUTPUT
!                                *INCREASED PAGE SIZE FROM 20040 TO
!                                 120000 DATA POINTS.
!                                *INCREASED MAXIMUM NUMBER OF RESONANCES
!                                 FROM 20040 TO 120000.
!     VERSION 99-1 (MARCH 1999)   *CORRECTED CHARACTER TO FLOATING
!                                  POINT READ FOR MORE DIGITS
!                                 *UPDATED TEST FOR ENDF/B FORMAT
!                                  VERSION BASED ON RECENT FORMAT CHANGE
!                                 *UPDATED CONSTANTS BASED ON CSEWG
!                                  SUBCOMMITTEE RECOMMENDATIONS
!                                 *GENERAL IMPROVEMENTS BASED ON
!                                  USER FEEDBACK
!     VERSION 99-2 (JUNE 1999)    *IMPLEMENTED NEW REICH-MOORE FORMALISM
!                                  TO ALLOW DEFINITION OF (L,J,S) FOR
!                                  EACH SEQUENCE.
!                                 *ASSUME ENDF/B-VI, NOT V, IF MISSING
!                                  MF=1, MT-451.
!     VERS. 2000-1 (FEBRUARY 2000)*GENERAL IMPROVEMENTS BASED ON
!                                  USER FEEDBACK
!
!     OWNED, MAINTAINED AND DISTRIBUTED BY
!     ------------------------------------
!     THE NUCLEAR DATA SECTION
!     INTERNATIONAL ATOMIC ENERGY AGENCY
!     P.O. BOX 100
!     A-1400, VIENNA, AUSTRIA
!     EUROPE
!
!     ORIGINALLY WRITTEN BY
!     ------------------------------------
!     DERMOTT E. CULLEN
!     CURRENT ADDRESS
!     UNIVERSITY OF CALIFORNIA
!     LAWRENCE LIVERMORE NATIONAL LABORATORY
!     L-86
!     P.O. BOX 808
!     LIVERMORE, CA 94550
!     U.S.A.
!     TELEPHONE  925-423-7359
!     E. MAIL    CULLEN1@LLNL.GOV
!     WEBSITE    HTTP://REDDOG1.LLNL.GOV
!
!     ACKNOWLEDGEMENT (VERSION 92-1)
!     ==================================================================
!     THE AUTHOR THANKS SOL PEARLSTEIN (BROOKHAVEN NATIONAL LAB) FOR
!     SIGNIFICANTLY CONTRIBUTING TOWARD IMPROVING THE ACCURACY AND
!     COMPUTER INDEPENDENCE OF THIS CODE - THANKS, SOL
!     ==================================================================
!
!     REPORT UCRL-50400, VOL. 17, PART C (1979)
!            LAWRENCE LIVERMORE LABORATORY
!
!     AUTHORS MESSAGE
!     ==================================================================
!     THE REPORT DESCRIBED ABOVE IS THE LATEST PUBLISHED DOCUMENTATION
!     FOR THIS PROGRAM. HOWEVER, THE COMMENTS BELOW SHOULD BE CONSIDERED
!     THE LATEST DOCUMENTATION INCLUDING ALL RECENT IMPROVEMENTS. PLEASE
!     READ ALL OF THESE COMMENTS BEFORE IMPLEMENTATION, PARTICULARLY
!     THE COMMENTS CONCERNING MACHINE DEPENDENT CODING.
!
!     AT THE PRESENT TIME WE ARE ATTEMPTING TO DEVELOP A SET OF COMPUTER
!     INDEPENDENT PROGRAMS THAT CAN EASILY BE IMPLEMENTED ON ANY ONE
!     OF A WIDE VARIETY OF COMPUTERS. IN ORDER TO ASSIST IN THIS PROJECT
!     IT WOULD BE APPECIATED IF YOU WOULD NOTIFY THE AUTHOR OF ANY
!     COMPILER DIAGNOSTICS, OPERATING PROBLEMS OR SUGGESTIONS ON HOW TO
!     IMPROVE THIS PROGRAM. HOPEFULLY, IN THIS WAY FUTURE VERSIONS OF
!     THIS PROGRAM WILL BE COMPLETELY COMPATIBLE FOR USE ON YOUR
!     COMPUTER.
!
!     PURPOSE
!     ==================================================================
!     THIS PROGRAM IS DESIGNED TO RECONSTRUCT THE RESONANCE CONTRIBUTION
!     TO THE CROSS SECTION IN LINEARLY INTERPOLABLE FORM, ADD IN ANY
!     LINEARLY INTERPOLABLE BACKGROUND CROSS SECTION AND OUTPUT THE
!     RESULT IN THE ENDF/B FORMAT. THE CROSS SECTIONS OUTPUT BY THIS
!     PROGRAM WILL BE LINEARLY INTERPOLABLE OVER THE ENTIRE ENERGY RANGE
!
!     THE RESONANCE CONTRIBUTION IS CALCULATED FOR TOTAL (MT=1),
!     ELASTIC (MT=2), CAPTURE (MT=102) AND FISSION (MT=18), ADDED
!     TO THE BACKGROUND (IF ANY) AND OUTPUT. IN ADDITION, IF THERE
!     IS A FIRST CHANCE FISSION (MT=19) BACKGROUND PRESENT THE RESONANCE
!     CONTRIBUTION OF FISSION WILL BE ADDED TO THE BACKGROUND AND
!     OUTPUT. IF THERE IS NO FIRST CHANCE FISSION (MT=19) BACKGROUND
!     PRESENT THE PROGRAM WILL NOT OUTPUT MT=19.
!
!     IN THE FOLLOWING FOR SIMPLICITY THE ENDF/B TERMINOLOGY--ENDF/B
!     TAPE--WILL BE USED. IN FACT THE ACTUAL MEDIUM MAY BE TAPE, CARDS,
!     DISK OR ANY OTHER MEDIUM.
!
!     PROCESSING DATA IN THE ENDF/B-VI FORMAT
!     ==================================================================
!     IT HAS NOW BEEN CONFIRMED (PRIVATE COMMUNICATION, CHARLES DUNFORD,
!     APRIL, 1991) THAT THE PROPER PROCEDURE TO FOLLOW WHEN THERE ARE
!     MISSING OR DUPLICATE J VALUES IS TO IN ALL CASES ADD A SEQUENCE
!     WITH NO RESONANCES TO ACCOUNT FOR THE CONTRIBUTION OF THE SEQUENCE
!     TO THE POTENTIAL SCATTERING CROSS SECTION.
!
!     THIS IS THE PROCEDURE WHICH WAS FOLLOWED BY ALL VERSIONS OF RECENT
!     SINCE 86-3 AND WILL CONTINUE TO BE THE PROCEDURE.
!
!     INPUT ENDF/B FORMAT AND CONVENTIONS
!     ==================================================================
!     ENDF/B FORMAT
!     -------------
!     THIS PROGRAM ONLY USES THE ENDF/B BCD OR LINE IMAGE FORMAT (AS
!     OPPOSED TO THE BINARY FORMAT) AND CAN HANDLE DATA IN ANY VERSION
!     OF THE ENDF/B FORMAT (I.E., ENDF/B-I, II,III, IV, V OR VI FORMAT).
!
!     IT IS ASSUMED THAT THE DATA IS CORRECTLY CODED IN THE ENDF/B
!     FORMAT AND NO ERROR CHECKING IS PERFORMED. IN PARTICULAR IT IS
!     ASSUMED THAT THE MAT, MF AND MT ON EACH LINE IS CORRECT. SEQUENCE
!     NUMBERS (COLUMNS 76-80) ARE IGNORED ON INPUT, BUT WILL BE
!     CORRECTLY OUTPUT ON ALL CARDS. THE FORMAT OF SECTION MF=1, MT=451
!     AND ALL SECTIONS OF MF=2 AND 3 MUST BE CORRECT. THE PROGRAM COPIES
!     ALL OTHER SECTION OF DATA AS HOLLERITH AND AS SUCH IS INSENSITIVE
!     TO THE CORRECTNESS OR INCORRECTNESS OF ALL OTHER SECTIONS.
!
!     ENDF/B FORMAT VERSION
!     ---------------------
!     THE FORMATS AND CONVENTIONS FOR READING AND INTERPRETING THE DATA
!     VARIES FROM ONE VERSION OF ENDF/B TO THE NEXT. HOWEVER, IF THE
!     HOLLERITH SECTION (MF=1, MT=451) IS PRESENT IT IS POSSIBLE FOR
!     THIS PROGRAM TO DISTINGUISH BETWEEN DATA IN THE ENDF/B-IV, V AND
!     VI FORMATS AND TO USE THE APPROPRIATE CONVENTIONS FOR EACH
!     ENDF/B VERSION (SEE, SUBROUTINE FILE1 FOR A DESCRIPTION OF HOW
!     THIS IS DONE). IF THE HOLLERITH SECTION IS NOT PRESENT THE
!     PROGRAM WILL ASSUME THE DATA IS IN THE ENDF/B-VI FORMAT AND USE
!     ALL CONVENTIONS APPROPRIATE TO ENDF/B-V. USERS ARE ENCOURAGED TO
!     INSURE THAT THE HOLLERITH SECTION (MF=1, MT=451) IS PRESENT IN
!     ALL EVALUATIONS.
!
!     INPUT OF ENERGIES
!     -----------------
!     ALL ENERGIES ARE READ IN DOUBLE PRECISION (BY SPECIAL FORTRAN I/O
!     ROUTINES) AND ARE TREATED IN DOUBLE PRECISION IN ALL CALCULATIONS.
!
!     OUTPUT ENDF/B FORMAT AND CONVENTIONS
!     ==================================================================
!     CONTENTS OF OUTPUT
!     ------------------
!     ENTIRE EVALUATIONS ARE OUTPUT, NOT JUST THE RECONSTRUCTED FILE
!     3 CROSS SECTIONS, E.G. ANGULAR AND ENERGY DISTRIBUTIONS ARE
!     ALSO INCLUDED.
!
!     DOCUMENTATION
!     -------------
!     THE FACT THAT THIS PROGRAM HAS OPERATED ON THE DATA IS DOCUMENTED
!     BY THE ADDITION OF COMMENT CARDS AT THE END OF EACH HOLLERITH
!     SECTION IN THE FORM
!
!     ***************** RECENT (VERSION 2000-1) ***************
!     RESONANCE CONTRIBUTION RECONSTRUCTED TO WITHIN   0.100 PER-CENT
!     COMBINED DATA NOT THINNED (ALL RESONANCE + BACKGROUND DATA KEPT)
!
!     THE ORDER OF ALL SIMILAR COMMENTS (FROM LINEAR, SIGMA1 AND GROUPY)
!     REPRESENTS A COMPLETE HISTORY OF ALL OPERATIONS PERFORMED ON
!     THE DATA, INCLUDING WHICH VERSION OF EACH PROGRAM WAS USED.
!
!     THESE COMMENT CARDS ARE ONLY ADDED TO EXISTING HOLLERITH SECTIONS,
!     I.E., THIS PROGRAM WILL NOT CREATE A HOLLERITH SECTION. THE FORMAT
!     OF THE HOLLERITH SECTION IN ENDF/B-V DIFFERS FROM THE THAT OF
!     EARLIER VERSIONS OF ENDF/B. BY READING AN EXISTING MF=1, MT=451
!     IT IS POSSIBLE FOR THIS PROGRAM TO DETERMINE WHICH VERSION OF
!     THE ENDF/B FORMAT THE DATA IS IN. WITHOUT HAVING A SECTION OF
!     MF=1, MT=451 PRESENT IT IS IMPOSSIBLE FOR THIS PROGRAM TO
!     DETERMINE WHICH VERSION OF THE ENDF/B FORMAT THE DATA IS IN, AND
!     AS SUCH IT IS IMPOSSIBLE FOR THE PROGRAM TO DETERMINE WHAT FORMAT
!     SHOULD BE USED TO CREATE A HOLLERITH SECTION.
!
!     REACTION INDEX
!     --------------
!     THIS PROGRAM DOES NOT USE THE REACTION INDEX WHICH IS GIVEN IN
!     SECTION MF=1, MT=451 OF EACH EVALUATION.
!
!     THIS PROGRAM DOES NOT UPDATE THE REACTION INDEX IN MF=1, MT=451.
!     THIS CONVENTION HAS BEEN ADOPTED BECAUSE MOST USERS DO NOT
!     REQUIRE A CORRECT REACTION INDEX FOR THEIR APPLICATIONS AND IT WAS
!     NOT CONSIDERED WORTHWHILE TO INCLUDE THE OVERHEAD OF CONSTRUCTING
!     A CORRECT REACTION INDEX IN THIS PROGRAM. HOWEVER, IF YOU REQUIRE
!     A REACTION INDEX FOR YOUR APPLICATIONS, AFTER RUNNING THIS PROGRAM
!     YOU MAY USE PROGRAM DICTION TO CREATE A CORRECT REACTION INDEX.
!
!     OUTPUT FORMAT OF ENERGIES
!     -------------------------
!     IN THIS VERSION OF RECENT ALL FILE 3 ENERGIES WILL BE OUTPUT IN
!     F (INSTEAD OF E) FORMAT IN ORDER TO ALLOW ENERGIES TO BE WRITTEN
!     WITH UP TO 9 DIGITS OF ACCURACY. IN PREVIOUS VERSIONS THIS WAS AN
!     OUTPUT OPTION. HOWEVER USE OF THIS OPTION TO COMPARE THE RESULTS
!     OF ENERGIES WRITTEN IN THE NORMAL ENDF/B CONVENTION OF 6 DIGITS
!     TO THE 9 DIGIT OUTPUT FROM THIS PROGRAM DEMONSTRATED THAT FAILURE
!     TO USE THE 9 DIGIT OUTPUT CAN LEAD TO LARGE ERRORS IN THE DATA
!     JUST DUE TO TRANSLATION OF ENERGIES FROM THEIR INTERNAL (BINARY)
!     REPRESENTATION TO THE ENDF/B FORMAT.
!
!     ACCURACY OF ENERGY
!     ------------------
!     IN ORDER TO ALLOW ENERGIES TO BE ACCURATELY OUTPUT TO 9 DIGITS
!     ON SHORT WORD LENGTH COMPUTERS (E.G. IBM) ALL ENERGIES AND
!     ENERGY DEPENDENT TERMS ARE READ AND TREATED IN DOUBLE PRECISION.
!
!     OUTPUT OF RESONANCE PARAMETERS
!     ------------------------------
!     A SPECIAL CONVENTION HAS BEEN INTRODUCED REGARDING RESONANCE
!     PARAMETERS. IN ORDER TO ALLOW THE USER TO DOPPLER BROADEN AND/OR
!     SELF-SHIELD CROSS SECTIONS THE RESONANCE PARAMETERS ARE ALSO
!     INCLUDED IN THE OUTPUT WITH THE EVALUATION. IN ORDER TO AVOID THE
!     POSSIBILITY OF ADDING THE RESONANCE CONTRIBUTION A SECOND TIME
!     TWO CONVENTIONS HAVE BEEN ADOPTED TO INDICATE THAT THE RESONANCE
!     CONTRIBUTION HAS ALREADY BEEN ADDED TO THE FILE 3 CROSS SECTIONS,
!
!     (1) WHEN THE DATA IS PROCESSED BY THIS PROGRAM LRP (IN MF=1,
!     MT=451) IS SET EQUAL TO 2. THIS IS A CONVENTION WHICH HAS BEEN
!     ADOPTED AS A STANDARD CONVENTION IN ENDF/B-VI, BUT IS ONLY TO BE
!     USED FOR PROCESSED DATA, AS OPPOSED TO THE ORIGINAL EVALUATIONS.
!     IN EVALUATIONS WHICH CONTAIN MF=1, MT=451 LRP CAN BE USED TO
!     DETERMINE IF THE MATERIAL HAS BEEN PROCESSED.
!
!     (2) THE LRU FLAG IN EACH SECTION OF FILE 2 DATA IS CHANGED TO
!     LRU=LRU+3. FOR EXAMPLE WHEN READING AN ENDF/B EVALUATION LRU=0
!     (NO RESONANCES), =1 (RESOLVED) OR =2 (UNRESOLVED) INDICATES THAT
!     THE DATA IS IN THE ORIGINAL ENDF/B FORM. LRU=3 (NO RESONANCES),
!     =4 (RESOLVED) OR =5 (UNRESOLVED) INDICATES THAT THE RESONANCE
!     CONTRIBUTION HAS ALREADY BEEN ADDED TO THE FILE 3 DATA. THIS
!     SECOND CONVENTION HAS BEEN ADOPTED AS INSURANCE THAT THE RESONANCE
!     CONTRIBUTION WILL NOT BE ADDED TWICE, EVEN FOR EVALUATIONS WHICH
!     DO NOT CONTAIN MF=1, MT=451 (EVALUATIONS WHICH CONTAIN MF=1,
!     MT=451 ARE COVERED BY CONVENTION (1), DESCRIBED ABOVE).
!
!     UNIFORM TREATMENT OF RESONANCE FORMALISMS
!     ==================================================================
!     NORMALIZATION
!     =============
!     ALL OF THE RESONANCE FORMALISMS INCLUDE A FACTOR OF,
!
!     PI*(FRACTIONAL ABUNDANCE)/(K**2)
!
!     THIS FACTOR HAS BEEN REMOVED FROM THE CALCULATION OF EACH TYPE
!     OF RESONANCE FORMALISM AND IS APPLIED AS A FINAL NORMALIZATION
!     AFTER THE CALCULATION, ONLY ONE PLACE IN THIS PROGRAM.
!
!     FOR SIMPLICITY THIS TERM IS NOT INCLUDED IN THE FOLLOWING
!     DERIVATIONS - IN ALL CASES THE ACTUAL CROSS SECTION IS A PRODUCT
!     OF THE ABOVE FACTOR TIMES THE RESULTS PRESENTED BELOW.
!
!     SIMILARITIES
!     ============
!     FOR THE RESOLVED RESONANCE REGION, EXCEPT FOR SINGLE LEVEL BREIT
!     WIGNER, PARAMETERS ALL OF THE FORMALISMS DEFINE THE CROSS SECTIONS
!     IN AN EQUIVALENT FORM,
!
!     TOTAL    = 2*GJ*REAL(1 - U)
!              = 2*GJ*(1 - REAL(U))
!     ELASTIC  =   GJ*(1 - U)**2
!              =   GJ*((1 - 2*REAL(U)) + (REAL(U)**2 + IM(U)**2))
!              = 2*GJ*(1 - REAL(U)) - GJ*(1 - (REAL(U)**2 + IM(U)**2))
!
!     SINCE THE FIRST TERM IS THE TOTAL, THE SECOND TERM MUST BE
!     ABSORPTION. SO WE FIND,
!
!     ABSORPTION = GJ*(1 - (REAL(U)**2 + IM(U)**2))
!
!     IN ALL CASES U IS DEFINED IN THE FORM,
!
!     U        = EXP(-I*2*PS)*((1-X) - I*Y)
!
!     WHERE (X) AND (Y) ARE RELATED TO THE SYMMETRIC AND ANTI-SYMMETRIC
!     CONTRIBUTIONS OF THE RESONANCES, RESPECTIVELY. ONLY THE DEFINITION
!     OF (X) AND (Y) WILL BE DIFFERENT FOR EACH RESONANCE FORMALISM.
!     BELOW WE WILL SHOW THAT WHAT MIGHT APPEAR TO BE A STRANGE CHOICE
!     OF DEFINITION OF THE SIGN OF (X) AND(Y) HAS BEEN SELECTED SO THAT
!     FOR BREIT-WIGNER PARAMETERS (X) AND (Y) CORRESPOND EXACTLY TO THE
!     SYMMETRIC AND ANTI-SYMMETRIC CONTRIBUTION OF THE RESONANCES.
!
!     U        = (COS(2*PS) - I*SIN(2*PS))*((1-X) - I*Y)
!              =   ((1-X)*COS(2*PS) - Y*SIN(2*PS))
!              =-I*((1-X)*SIN(2*PS) + Y*COS(2*PS))
!
!     REAL(U)  = ((1-X)*COS(2*PS) - Y*SIN(2*PS))
!     IM(U)    =-((1-X)*SIN(2*PS) + Y*COS(2*PS))
!
!     R(U)**2  =((1-X)*COS(2*PS))**2 + (Y*SIN(2*PS))**2
!               -2*(1-X)*Y*COS(2*PS)*SIN(2*PS)
!     I(U)**2  =((1-X)*SIN(2*PS))**2 + (Y*COS(2*PS))**2
!               +2*(1-X)*Y*COS(2*PS)*SIN(2*PS)
!
!     THE TERMS 2*(1-X)*Y*COS(2*PS)*SIN(2*PS) CANCEL AND UPON USING
!     THE IDENTITY COS(2*PS)**2 + SIN(2*PS)**2 = 1,
!
!     SUM      = (1-X)**2 + (Y)**2
!
!     WE NOW HAVE ALL THE QUANTITIES THAT WE NEED TO DEFINE THE CROSS
!     SECTIONS,
!
!     ELASTIC
!     =======
!     ELASTIC  =GJ*(1 - 2*REAL(U) + (REAL(U)**2 + IM(U)**2))
!              =GJ*(1 - 2*((1-X)*COS(2*PS)-Y*SIN(2*PS))+(1-X)**2+(Y)**2)
!
!     THIS CAN BE WRITTEN AS A SUM OF 2 SQUARES,
!
!     ELASTIC  =GJ*(COS(2*PS) - (1-X))**2 + (SIN(2*PS) + Y)**2)
!
!              =GJ*((COS(2*PS))**2 - 2*(1-X)*COS(2*PS) + (1-X)**2) +
!                   (SIN(2*PS))**2 + 2*Y*SIN(2*PS)    + (Y)**2)
!
!     AGAIN USING THE IDENTITY COS(2*PS)**2 + SIN(2*PS)**2 = 1, WE CAN
!     SEE THAT THE DEFINITION AS THE SUM OF 2 SQUARES IS IDENTICAL TO
!     THE PRECEDING DEFINITION OF THE ELASTIC.
!
!     ELASTIC  =GJ*(COS(2*PS) - (1-X))**2 + (SIN(2*PS) + Y)**2)
!              =GJ*((COS(2*PS)-1) + X)**2 + (SIN(2*PS) + Y)**2)
!
!     USING THE IDENTITY (1 - COS(2*PS))) = 2*SIN(PS)**2, WE OBTAIN
!     THE FINAL FORM FOR THE ELASTIC,
!
!     ELASTIC =GJ*(2*SIN(PS)**2 - X)**2 + (SIN(2*PS) + Y)**2)
!
!     ABSORPTION
!     ==========
!     ABSORPTION = GJ*(1 - (REAL(U)**2 + IM(U)**2))
!                = GJ*(1 - ((1-X)**2   + (Y)**2)
!                = GJ*(1 - (1 - 2*X + (X)**2 + (Y)**2)
!                = GJ*(2*X - (X)**2 + (Y)**2)
!
!     SINCE PHYSICALLY THE ABSORPTION CANNOT BE NEGATIVE WE CAN SEE
!     THAT (X) MUST BE POSITIVE AND 2*X MUST BE GREATER THAN
!     (X)**2 + (Y)**2, FOR ALL OF THE FORMALISMS.
!
!     TOTAL
!     =====
!     IN THIS PROGRAM THE TOTAL CROSS SECTION IS ALWAYS DEFINED TO BE
!     THE SUM OF ITS PARTS - SO THE ABOVE DEFINITION IS NEVER EXPLICITLY
!     USED. HOWEVER, WE CAN LEARN SOMETHING BY EXAMINING THE DEFINITION,
!
!     TOTAL    = 2*GJ*REAL(1 - U)
!              = 2*GJ*(1 - (((1-X)*COS(2*PS) - Y*SIN(2*PS)))
!              = 2*GJ*((1 - COS(2*PS))*(1-X) - (1-X) + Y*SIN(2*PS))
!              = 2*GJ*(2*SIN(PS)**2*(1-X)    - (1-X) + Y*SIN(2*PS))
!
!              = 4*GJ*SIN(PS)**2 +
!                2*GJ*((X-1) - 2*X*SIN(PS)**2 +  Y*SIN(2*PS))
!
!     THE IMPORTANT POINT TO NOTE IS THAT THE DEFINITION OF THE TOTAL
!     DOES NOT EXPLICITLY CONTAIN ANY DEPENDENCE ON X**2 AND Y**2 -
!     THE LEVEL-LEVEL INTERFERENCE TERMS.
!
!     THIS IMPLIES THAT IF A GIVEN SET OF RESONANCE PARAMETERS ARE USED
!     WITH THIS DEFINITION THEY WILL PRODUCE EXACTLY THE SAME TOTAL
!     CROSS SECTION - WHETHER WE CLAIM THE PARAMETERS HAVE BEEN
!     PRODUCED USING A SINGLE OR MULTI-LEVEL FIT. THIS RESULT COULD
!     BE VERY MISLEADING, IF THIS RESULT FOR THE TOTAL IS IMPLIED TO
!     MEAN THAT ONE INTERPRETATION OR THE OTHER WILL NOT HAVE ANY
!     EFFECT ON THE INDIVIDUAL CROSS SECTIONS.
!
!     STARTING FROM EXACTLY THE SAME RESONANCE PARAMETERS, RELATIVE TO
!     THE RESULTS OBTAINED USING THE SINGLE LEVEL FORMULA, MULTI-LEVEL
!     RESULTS WILL TEND TO ALWAYS DECREASE THE ABSORPTION AND INCREASE
!     THE ELASTIC. THIS CAN BE IMMEDIATELY SEEN FROM OUR GENERAL
!     MULTI-LEVEL DEFINITION OF ABSORPTION,
!
!     ABSORPTION =GJ*(2*X - ((X)**2 + (Y)**2))
!
!     THE SINGLE LEVEL ABSORPTION IS,
!
!     ABSORPTION =GJ*(2*X)
!
!     THE DIFFERENCE BETWEEN THE TWO IS -2*GJ*(X**2 + Y**2), SO THAT
!     REGARDLESS OF HOW WE DEFINE (X) AND (Y) THE INCLUSION OF THIS
!     TERM WILL ALWAYS DECREASE ABSORPTION. SINCE THE TOTAL CROSS
!     SECTION IS THE SAME IN BOTH CASE, THIS MEANS THAT THE ELASTIC
!     HAS BEEN INCREASED BY THIS AMOUNT.
!
!     AGAIN, THESE RESULTS ARE BASED ON STARTING FROM EXACTLY THE SAME
!     PARAMETERS - IN ANY ACTUAL CASE THE PARAMETERS BASED ON A SINGLE
!     OR MULTI-LEVEL FIT WILL BE QUITE DIFFERENT - THE POINT THAT WE
!     WANT TO STRESS HERE IS THAT YOU SHOULD NEVER USE PARAMETERS
!     WHICH HAVE BEEN DEFINED BY A FIT USING ONE FORMALISM - IN THE
!     EQUATIONS FOR A DIFFERENT FORMALISM - AND ASSUME THAT THE RESULTS
!     WILL BE CONSISTENT - AND NEVER USE THE TOTAL CROSS SECTION TO
!     SEE WHETHER OR NOT A SET OF SINGLE LEVEL PARAMETERS CAN BE USED
!     WITH A MULTI-LEVEL FORMALISM.
!
!     POTENTIAL CROSS SECTION
!     =======================
!     FAR FROM RESONANCES (X) AND (Y) WILL BE SMALL AND THE ELASTIC
!     CROSS SECTION REDUCES TO,
!
!     ELASTIC =GJ*(2*SIN(PS)**2)**2     + (SIN(2*PS))**2
!             =GJ*4*(SIN(PS)**4         + SIN(2*PS)**2
!
!     USING THE IDENTITY SIN(2*PS) = 2*SIN(PS)*COS(PS)
!
!             =4*GJ*(SIN(PS)**4         + (SIN(PS)*COS(PS))**2)
!             =4*GJ*SIN(PS)**2*(SIN(PS)**2 + COS(PS)**2)
!             =4*GJ*SIN(PS)**2
!
!     WHICH IS THE POTENTIAL CROSS SECTION. NOTE THAT THIS RESULT IS
!     INDEPENDENT OF THE FORMALISM USED, AS IT MUST PHYSICALLY BE,
!     AND AS SUCH ALTHOUGH AS YET WE HAVE NOT DEFINED IT, WE CAN
!     NOW SEE THAT IN ALL CASES (PS) MUST BE THE PHASE SHIFT AND FOR
!     CONSISTENCY IT MUST BE DEFINED USING EXACTLY THE SAME DEFINITION
!     IN ALL CASES.
!
!     IN ADDITION SINCE PHYSICALLY FOR EACH L VALUE WE EXPECT TO OBTAIN
!     A POTENTIAL CROSS SECTION,
!
!     4*(2*L+1)*SIN(PS)**2
!
!     OBVIOUSLY FOR CONSISTENCY WE MUST HAVE,
!
!     (2*L+1) = (SUM OVER J) GJ
!
!     ONLY IN THIS CASE WILL THE RESULTS BE CONSISTENT - THIS POINT WILL
!     BE DISCUSSED IN DETAIL BELOW.
!
!     WHAT ARE THIS TERMS (X) AND (Y)
!     ===============================
!     (X) AND (Y) CAN BE EASILY IDENTIFIED BY CONSIDERING THE SINGLE
!     AND MULTI-LEVEL BREIT WIGNER FORMALISMS. IN THESE CASES WE WILL
!     FIND THAT,
!
!     X        = GAM(N)*GAM(T)/2/DEN
!     Y        = GAM(N)*(E-ER)/DEN
!     DEN      = ((E-ER)**2 + (GAM(T)/2)**2)
!
!     EXTREME CARE HAS TO BE USED TO PROPERLY DEFINE (Y) SUCH THAT IT
!     IS NEGATIVE FOR E LESS THAN ER AND POSITIVE FOR E GREATER THAN
!     ER. I WILL MERELY MENTION THAT THE EQUATIONS FOR ALL FORMALISMS
!     IN ENDF-102 DO NOT CONSISTENTLY USE (E - ER) - IN SOME CASES
!     THIS IS WRITTEN AS (ER - E), WHICH CAN LEAD TO AN INCORRECT
!     SIGN IN THE DEFINITION OF THE (Y) THAT WE REQUIRE.
!
!     THE INTERFERENCE TERMS CAN BE WRITTEN IN TERMS OF,
!     1) LEVEL-SELF INTERFERENCE  = THE CONTRIBUTION OF EACH LEVEL
!                                   INTERFERRING WITH ITSELF
!     2) LEVEL-LEVEL INTERFERENCE = THE CONTRIBUTION OF EACH LEVEL
!                                   INTERFERRRING WITH ALL OTHER LEVELS
!
!     WE WILL REFER TO THESE TWO AS (L-S) AND (L-L),
!
!     X**2     = (GAM(N)*(GAM(T)/2)**2/(DEN)**2      + (L-L)
!              = (GAM(N)**2*((GAM(T)/2)**2)/(DEN)**2 + (L-L)
!     Y**2     = (GAM(N))**2*((E-ER))**2/(DEN)**2    + (L-L)
!
!     X**2+Y**2= GAM(N)**2*DEN/(DEN)**2 = GAM(N)**2/DEN + (L-L)
!
!     TO SEE THE EFFECT OF INCLUDING MULTI-LEVEL INTERFERENCE WE CAN
!     CONSIDER OUR GENERAL EXPRESSION FOR ABSORPTION,
!
!     ABSORPTION =GJ*(2*X - ((X)**2 + (Y)**2))
!
!     AND NOTE THAT FOR BOTH SINGLE AND MULTI-LEVEL BREIT WIGNER THE
!     ENDF-102 SAYS TO TREAT ABSORPTION IN A SINGLE LEVEL APPROXIMATION
!     I.E., IGNORE LEVEL-LEVEL INTERFERENCE. IF ALL INTERFERENCE IS
!     IGNORED THIS IS EQUIVALENT TO COMPLETELY IGNORING X**2 + Y**2 AND
!     DEFINING,
!
!     ABSORPTION =GJ*2*X
!                =2*GJ*GAM(N)*GAM(T)/DEN
!
!     WHICH IS INCORRECT - SINCE THIS SEEMS TO INDICATE EVERYTHING IS
!     ABSORBED. IN ORDER TO OBTAIN THE CORRECT EXPRESSION WE CANNOT
!     COMPLETELY IGNORE INTERFERENCE - WE CAN IGNORE LEVEL-LEVEL
!     INTERFERENCE, BUT WE MUST INCLUDE LEVEL-SELF INTERFERENCE,
!
!     X**2+Y**2= GAM(N)**2/DEN
!
!     ABSORPTION =GJ*(2*X - ((X)**2 + (Y)**2))
!                =GJ*GAM(N)*(GAM(T)-GAM(N))/DEN
!                =GJ*GAM(N)*GAM(A)/DEN
!
!     SUMMARY
!     =======
!     AN IMPORTANT POINT TO NOTE IS THE DEFINITION OF (X) AND (Y)
!     WHICH IN ALL CASES WILL CORRESPOND TO THE SYMMETRIC AND
!     ANTI-SYMMETRIC CONTRIBUTION OF THE RESONANCES. IN PARTICULAR
!     DEFINING (U) IN TERMS OF (1-X) INSTEAD OF (X) IS EXTREMELY
!     IMPORTANT. NOTE, THAT THE DEFINITION OF THE ELASTIC AND
!     ABSORPTION ONLY INVOLVE (X), NOT (1-X). FAR FROM RESONANCES
!     (X) CAN BE EXTREMELY SMALL, THEREFORE (1-X) WILL BE VERY CLOSE
!     TO (1). IF THE CALCULATION PROCEEDS BY FIRST CALCULATING (1-X)
!     AND THEN DEFINING (X) BY SUBTRACTING (1), EXTREME ROUND-OFF
!     PROBLEMS CAN RESULT. THESE PROBLEMS CAN BE AVOIDED BY IN ALL
!     CASES DEFINING (X) DIRECTLY, WITHOUT ANY DIFFERENCES.
!
!     IN EACH FORMALISM THE DEFINITION OF (X) AND (Y) MAY BE DIFFERENT
!     BUT ONCE WE HAVE DEFINED (X) AND (Y) WE CAN IMMEDIATELY WRITE
!     THE CROSS SECTIONS USING A UNIFORM DEFINITION,
!
!     ELASTIC =GJ*(2*SIN(PS)**2 - X)**2 + (SIN(2*PS) + Y)**2)
!
!     ABSORPTION =-GJ*(2*X + (X)**2 + (Y)**2)
!
!     AND DEFINE THE TOTAL AS THE SUM OF THESE 2 PARTS.
!
!     RELATIONSHIP TO SINGLE LEVEL
!     ============================
!     HOW DO THE SINGLE AND MULTI-LEVEL FORMALISMS COMPARE. TO SEE,
!     STARTING FROM OUR GENERAL DEFINITION OF THE ELASTIC IN THE FORM,
!
!     ELASTIC =GJ*(2*SIN(PS)**2 + X)**2 + (SIN(2*PS) + Y)**2)
!             =GJ*(4*SIN(PS)**4 - 4*X*SIN(PS)**2 + X**2
!                + SIN(2*PS)**2 + 2*Y*SIN(2*PS)  + Y**2)
!
!             =4*GJ*SIN(PS)**2 +
!                GJ*(X**2 + Y**2
!                   -4*X*SIN(PS)**2
!                   +2*Y*SIN(2*PS))
!
!     AND OUR SPECIFIC DEFINITIONS OF (X) AND (Y) FOR MULTI-LEVEL BREIT-
!     WIGNER PARAMETERS,
!
!     X        = GAM(N)*GAM(T)/2/DEN
!     Y        = GAM(N)*(E-ER)/DEN
!     DEN      = ((E-ER)**2 + (GAM(T)/2)**2)
!
!     X**2+Y**2= GAM(N)**2/DEN + (L-L)
!
!     WE CAN RECOGNIZE X**2 AND Y**2 AS THE INTERFERENCE - (L-S) + (L-L)
!     TERMS IN THE MULTI-LEVEL FORMALISM. IN ORDER TO OBTAIN THE SINGLE
!     LEVEL EQUATION WE CAN ASSUME THAT EACH LEVEL DOES NOT INTERFERE
!     WITH ANY OTHER LEVEL - THEREFORE THE (L-L) CONTRIBUTION IS ZERO.
!
!     ELASTIC =4*GJ*SIN(PS)**2 +
!                GJ*GAM(N)*(GAM(N)
!                           -2*GAM(T)*SIN(PS)**2
!                           +2*(E-ER)*SIN(2*PS))/DEN
!
!     WHICH IS THE FORM THAT IT APPEARS IN ENDF-102, EXCEPT FOR TWO
!     TYPOGRAPHICAL ERRORS IN THE SECOND TERM,
!
!     -2*GAM(T)*SIN(PS)**2
!
!     WHICH IN ENDF-102 IS WRITTEN,
!
!     -2*(GAM(T)-GAM(N))*SIN(2*PS)**2
!
!     PROGRAM CONVENTIONS
!     ==================================================================
!     MINIMUM INPUT DATA
!     ------------------
!     FOR EACH MATERIAL TO BE PROCESSED THE MINIMUM INPUT DATA ARE THE
!     RESONANCE PARAMETERS IN FILE 2. IF THERE ARE NO FILE 2 PARAMETERS
!     IN A GIVEN MATERIAL THE ENTIRE MATERIAL WILL SIMPLY BE COPIED.
!     NEITHER THE HOLLERITH SECTION (MF=1, MT=451) NOR THE BACKGROUND
!     CROSS SECTION (SECTIONS OF MF=3) NEED BE PRESENT FOR THIS PROGRAM
!     TO EXECUTE PROPERLY. HOWEVER, SINCE THE CONVENTIONS USED IN
!     INTERPRETING THE RESONANCE PARAMETERS DEPENDS ON ENDF/B VERSION
!     USERS ARE STRONGLY RECOMMENDED TO INSURE THAT MF=1, MT=451 IS
!     PRESENT IN EACH MATERIAL TO ALLOW THE PROGRAM TO DETERMINE THE
!     ENDF/B FORMAT VERSION.
!
!     RESONANCE PARAMETERS
!     --------------------
!     RESONANCE PARAMETERS MAY BE REPRESENTED USING ANY COMBINATION
!     OF THE REPRESENTATIONS ALLOWED IN ENDF/B,
!     (1) RESOLVED DATA
!         (A) SINGLE LEVEL BREIT-WIGNER
!         (B) MULTI-LEVEL BREIT-WIGNER
!         (C) ADLER-ADLER
!         (D) REICH-MOORE
!         (E) HYBRID R-FUNCTION
!     (2) UNRESOLVED DATA
!         (A) ALL PARAMETERS ENERGY INDEPENDENT
!         (B) FISSION PARAMETERS ENERGY DEPENDENT
!         (C) ALL PARAMETERS ENERGY DEPENDENT
!
!     THE FOLLOWING RESOLVED DATA FORMALISMS ARE NOT TREATED BY THIS
!     VERSION OF THE CODE AND WILL ONLY BE IMPLEMENTED AFTER EVALUATIONS
!     USING THESE FORMALISMS ARE AVAILABLE TO THE AUTHOR OF THIS CODE
!     FOR TESTING IN ORDER TO INSURE THAT THEY CAN BE HANDLED PROPERLY
!         (A) GENERAL R-MATRIX
!
!     CALCULATED CROSS SECTIONS
!     -------------------------
!     THIS PROGRAM WILL USE THE RESONANCE PARAMETERS TO CALCULATE THE
!     TOTAL, ELASTIC, CAPTURE AND POSSIBLY FISSION CROSS SECTIONS. THE
!     COMPETITIVE WIDTH WILL BE USED IN THESE CALCULATIONS, BUT THE
!     COMPETITIVE CROSS SECTION ITSELF WILL NOT BE CALCULATED. THE
!     ENDF/B CONVENTION IS THAT ALTHOUGH A COMPETITIVE WIDTH MAY BE
!     GIVEN, THE COMPETITIVE CROSS SECTION MUST BE SEPARATELY TABULATED
!     AS A SECTION OF FILE 3 DATA.
!
!     RESOLVED REGION
!     ---------------
!     IN THE RESOLVED REGION THE RESOLVED PARAMETERS ARE USED TO
!     CALCULATE COLD (0 KELVIN), LINEARLY INTERPOLABLE, ENERGY DEPENDENT
!     CROSS SECTIONS.
!
!     SCATTERING RADIUS
!     -----------------
!     FOR SINGLE OR MULTI LEVEL BREIT-WIGNER PARAMETERS THE SCATTERING
!     RADIUS MAY BE SPECIFIED IN EITHER ENERGY INDEPENDENT (CONSTANT)
!     OR ENERGY DEPENDENT FORM (A TABLE OF ENERGY VS. RADIUS AND AN
!     ASSOCIATED INTERPOLATION LAW). IN ALL OTHER CASE ONLY AN ENERGY
!     INDEPENDENT SCATTERING RADIUS IS ALLOWED.
!
!     FOR ANY ONE MATERIAL (I.E. MAT) IF ENERGY DEPENDENT SCATTERING
!     RADII ARE GIVEN THE TOTAL NUMBER OF INTERPOLATION REGIONS AND
!     TABULATED VALUES FOR THE ENTIRE MATERIAL CANNOT EXCEED,
!     200 - INTERPOLATION REGIONS
!     500 - TABULATED VALUES
!     IF THESE LIMITS ARE EXCEEDED THE PROGRAM WILL PRINT AN ERROR
!     MESSAGE AND TERMINATE.
!
!     IF YOU REQUIRE A LARGER NUMBER OF INTERPOLATION REGION AND/OR
!     TABULATED VALUES,
!     (1) INTERPOLATION REGIONS - INCREASE THE DIMENSION OF NBTRHO AND
!     INTRHO IN COMMON/TABRHO/ THROUGHOUT THE PROGRAM AND CHANGE MAXINT
!     IN SUBROUTINE RDAP (MAXINT = MAXIMUM NUMBER OF INTERPOLATION
!     REGIONS).
!     (2) TABULATED VALUES - INCREASE THE DIMENSION OF ERHOTB, RHOTAB
!     AND APTAB IN COMMON/TABRHO/ THROUGHOUT THE PROGRAM AND CHANGE
!     MAXTAB IN SUBROUTINE RDAP (MAXTAB = MAXIMUM NUMBER OF TABULATED
!     VALUES).
!
!     RESOLVED REICH-MOORE AND MULTI-LEVEL BREIT-WIGNER PARAMETERS
!     ------------------------------------------------------------
!     CROSS SECTIONS FOR REICH-MOORE PARAMETERS ARE CALCULATED ACCORDING
!     TO THE EQUATION (1) - (8) OF SECTION D.1.3 OF ENDF-102. IN ORDER
!     TO CALCULATE CROSS SECTIONS FROM MULTI-LEVEL PARAMETERS IN A
!     REASONABLE AMOUNT OF TIME THIS PROGRAM EXPRESSES THE CROSS SECTION
!     IN TERMS OF A SINGLE SUM OVER RESONANCES (SEE, ENDF-102, SECTION
!     D.1.2, EQUATIONS 6-7), RATHER THAN AS A DOUBLE SUM (SEE, ENDF-102
!     SECTION D.1.2, EQUATION 1-2). IN ORDER FOR THE ENDF-102 EQUATIONS
!     TO BE CORRECT THE PARAMETERS MUST MEET THE FOLLOWING CONDITIONS,
!
!     (1) FOR EACH L STATE ALL PHYSICALLY POSSIBLE J SEQUENCES MUST BE
!         PRESENT. ONLY IN THIS CASE WILL THE CONTRIBUTIONS OF THE
!         INDIVIDUAL J SEQUENCES ADD UP TO PRODUCE THE CORRECT POTENTIAL
!         SCATTERING CONTRIBUTION FOR THE L STATE (SEE, ENDF-102,
!         SECTION D.1.2, EQUATIONS 6-7). IF ANY J SEQUENCE IS MISSING
!         THE PROGRAM WILL PRINT A WARNING AND ADD THE J SEQUENCE WITH
!         NO RESONANCE PARAMETERS IN ORDER TO ALLOW THE POTENTIAL
!         SCATTERING TO BE CALCULATED CORRECTLY (THIS IS EQUIVALENT TO
!         ASSUMING THAT THE EVALUATOR REALIZES THAT ALL J SEQUENCES MUST
!         BE AND ARE PRESENT AND THAT THE EVALUATION STATES THAT THERE
!         ARE NO RESONANCES WITH CERTAIN PHYSICALLY POSSIBLE J VALUES...
!         IN THIS CASE POTENTIAL CONTRIBUTION MUST STILL BE CONSIDERED).
!
!         EXAMPLE
!         =======
!         AN EXAMPLE OF WHERE THIS OCCURS AND IS IMPORTANT TO CONSIDER
!         IS U-238 IN ENDF/B-IV AND V LIBRARIES WHERE FOR L=1 THERE IS
!         ONLY A J=1/2 SEQUENCE. NOT INCLUDING THE J=3/2 SEQUENCE LEADS
!         TO UNDERESTIMATING THE POTENTIAL SCATTERING AND PRODUCES
!         MINIMA IN THE ELASTIC CROSS SECTION WHICH ARE AN ORDER OF
!         MAGNITUDE LOWER THAN THE CROSS SECTIONS OBTAINED BE INCLUDING
!         THE J=3/2 SEQUENCE.
!
!     (2) FOR A GIVEN TARGET SPIN AND L VALUE THERE MAY BE 2 POSSIBLE
!         MEANS OF OBTAINING THE SAME J VALUE. WHEN THIS OCCURS IN
!         ORDER TO CALCULATE THE CORRECT POTENTIAL SCATTERING CROSS
!         SECTION IT IS IMPORTANT TO INCLUDE THE EFFECT OF BOTH
!         POSSIBLE J SEQUENCES, EVEN THOUGH FROM THE ENDF/B DATA IT IS
!         NOT POSSIBLE TO DETERMINE WHICH OF THE 2 POSSIBLE SEQUENCES
!         ANY GIVEN RESONANCE BELONGS TO. IN THIS CASE THIS PROGRAM
!         TREAT ALL RESONANCES WITH THE SAME J VALUE AS BELONGING TO
!         THE SAME J SEQUENCE (TO ALLOW INTERFERENCE) AND WILL ADD AN
!         ADDITIONAL J SEQUENCE WITH NO RESONANCES IN ORDER TO ALLOW
!         THE POTENTIAL CROSS SECTION TO BE CALCULATED CORRECTLY. WHEN
!         THIS OCCURS A WARNING MESSAGE IS PRINTED, BUT BASED ON THE
!         ENDF/B DATA THERE IS NOTHING WRONG WITH THE DATA AND THERE IS
!         NOTHING THAT THE USER CAN DO TO CORRECT OR IN ANY WAY MODIFY
!         THE DATA TO ELIMINATE THE PROBLEM.
!
!         EXAMPLE
!         =======
!         FOR A TARGET SPIN =1 AND L=1 THE 2 RANGES OF PHYSICALLY
!         POSSIBLE J ARE 1/2, 3/2, 5/2 AND 1/2, 3/2. BY CHECKING THE
!         ENDF/B DATA IT IS POSSIBLE TO INSURE THAT THE 3 POSSIBLE
!         J VALUES (1/2, 3/2, 5/2) ARE PRESENT AND TO INCLUDE ALL 3
!         J SEQUENCES IN THE CALCULATIONS. HOWEVER, UNLESS ALL 5
!         POSSIBLE J SEQUENCES ARE INCLUDED THE STATISTICAL WEIGHTS
!         OF THE J SEQUENCES WILL NOT SUM UP TO 2*L+1 AND THE
!         POTENTIAL CROSS SECTION WILL BE UNDERESTIMATED. IN THIS
!         EXAMPLE THE SUM OF THE 3 J SEQUENCES 1/2, 3/2, 5/2 IS 2,
!         RATHER THAN 3 AS IT SHOULD BE FOR L=1, AND THE CONTRIBUTION
!         OF THE L=1 RESONANCES TO THE POTENTIAL SCATTERING CROSS
!         SECTION WILL ONLY BE 2/3 OF WHAT IT SHOULD BE, UNLESS THE
!         OTHER 2 J SEQUENCES (WITH DUPLICATE J VALUES) ARE INCLUDED
!         IN THE CALCULATION.
!
!     (3) EACH RESONANCE MUST HAVE AN ASSIGNED, PHYSICALLY POSSIBLE
!         J VALUE. PHYSICALLY IMPOSSIBLE OR AVERAGE J VALUES CANNOT BE
!         UNIQUELY INTERPRETED USING THE EQUATIONS IN ENDF-102 AND
!         THEIR USE WILL USUALLY RESULT IN PHYSICALLY UNRELIABLE CROSS
!         SECTIONS. THIS PROGRAM WILL CHECK ALL J VALUES AND IF ANY ARE
!         ARE FOUND TO BE PHYSICALLY IMPOSSIBLE (BASED ON TARGET SPIN
!         AND L VALUE) AN ERROR MESSAGE WILL BE PRINTED TO INDICATE THAT
!         THE RECONSTRUCTED CROSS SECTIONS WILL BE UNRELIABLE AND THE
!         PROGRAM WILL CONTINUE. IN AN ATTEMPT TO CALCULATE THE CORRECT
!         POTENTIAL SCATTERING CROSS SECTION THIS PROGRAM WILL SUBTRACT
!         THE POTENTIAL SCATTERING CONTRIBUTION DUE TO ALL FICTICIOUS J
!         SEQUENCES AND ADD THE CONTRIBUTION OF ALL PHYSICALLY POSSIBLE
!         J SEQUENCES (AS DESCRIBED ABOVE).
!
!         WARNING (LET THE USER BEWARE)
!         =============================
!         (A) IT CANNOT BE STRESSED ENOUGH THAT CROSS SECTIONS OBTAINED
!             USING PHYSICALLY IMPOSSIBLE J VALUES FOR REICH-MOORE AND
!             MULTI-LEVEL BREIT-WIGNER RESONANCE PARAMETERS WILL RESULT
!             IN UNRELIABLE CROSS SECTIONS. THE DECISION TO HAVE THIS
!             PROGRAM CONTINUE TO PROCESS WHEN THIS CONDITION IS FOUND
!             IS BASED ON AN ATTEMPT TO ALLOW THE USER TO AT LEAST HAVE
!             SOME RESULTS (HOWEVER BAD THEY MAY BE) IF THERE IS NO
!             OTHER EVALUATED DATA AVAILABLE.
!         (B) EVEN THOUGH THE REICH-MOORE AND MULTI-LEVEL EQUATIONS ARE
!             DEFINED AS ABSOLUTE OR SQUARED CONTRIBUTIONS WHICH MUST
!             ALL BE PHYSICALLY POSSIBLE, ATTEMPTING TO CORRECT THE
!             POTENTIAL CROSS SECTION (AS DESCRIBED ABOVE) CAN LEAD TO
!             NEGATIVE ELASTIC CROSS SECTIONS. THIS IS BECAUSE BASED ON
!             THE INFORMATION AVAILABLE IN THE EVALUATION IT IS NOT
!             NOT POSSIBLE TO CORRECTLY ACCOUNT FOR THE INTERFERENCE
!             BETWEEN THE RESONANCE AND POTENTIAL CONTRIBUTIONS FOR EACH
!             J SEQUENCE.
!
!     UNRESOLVED RESONANCE REGION
!     ---------------------------
!     IN THE UNRESOLVED RESONANCE REGION THE UNRESOLVED PARAMETERS
!     ARE USED TO CALCULATE INFINITELY DILUTE AVERAGE CROSS SECTIONS.
!     NOTE, IT IS IMPORTANT TO UNDERSTAND THAT FROM THE DEFINITION OF
!     THE UNRESOLVED PARAMETERS IT IS NOT POSSIBLE TO UNIQUELY CALCULATE
!     ENERGY DEPENDENT CROSS SECTIONS. ONLY AVERAGES OR DISTRIBUTIONS
!     MAY BE CALCULATED.
!
!     UNRESOLVED INTERPOLATION
!     ------------------------
!     IN THE UNRESOLVED RESONANCE REGION CROSS SECTIONS AT EACH ENERGY
!     ARE CALCULATED BY INTERPOLATING PARAMETERS. THIS IS THE CONVENTION
!     USED IN ENDF/B-IV AND EARLIER VERSIONS OF ENDF/B. THE ENDF/B-V
!     CONVENTION OF INTERPOLATING CROSS SECTIONS, NOT PARAMETERS, HAS
!     BEEN ABANDONED AS IMPRACTICAL SINCE IT CAN LEAD TO THE SITUATION
!     WHERE EXACTLY THE SAME PHYSICAL DATA CAN LEAD TO DIFFERENT RESULTS
!     DEPENDING ON WHICH OF THE THREE ENDF/B UNRESOLVED PARAMTER FORMATS
!     IS USED. FOR EXAMPLE, GIVEN A SET OF ENERGY INDEPENDENT UNRESOLVED
!     PARAMETERS IT IS POSSIBLE TO CODE THESE PARAMETERS IN EACH OF THE
!     THREE ENDF/B UNRESOLVED PARAMETER FORMATS. SINCE PHYSICALLY WE
!     ONLY HAVE ONE SET OF PARAMETERS WE WOULD EXPECT THE RESULTS TO BE
!     INDEPENDENT OF HOW THEY ARE REPRESENTED IN ENDF/B. UNFORTUNATELY
!     USING THE ENDF/B-V CONVENTION TO INTERPOLATE CROSS SECTIONS CAN
!     LEAD TO THREE COMPLETELY DIFFERENT RESULTS. IN CONTRAST USING THE
!     ENDF/B-IV AND EARLIER CONVENTION OF INTERPOLATING PARAMETERS LEADS
!     TO COMPLETELY CONSISTENT RESULTS.
!
!     INTERNAL REPRESENTATION OF UNRESOLVED PARAMETERS
!     ------------------------------------------------
!     ANY OF THE THREE POSSIBLE REPRESENTATIONS OF UNRESOLVED PARAMETERS
!     CAN BE UNIQUELY REPRESENTED IN THE ALL PARAMETERS ENERGY DEPENDENT
!     REPRESENTATIONS WITH THE APPROPRIATE (ENDF/B VERSION DEPENDENT)
!     INTERPOLATION LAW. THIS IS DONE BY THE PROGRAM WHILE READING THE
!     UNRESOLVED PARAMETERS AND ALL SUBSEQUENT CALCULATIONS NEED ONLY
!     CONSIDER THE ALL PARAMETERS ENERGY DEPENDENT REPRESENTATION.
!
!     RESONANCE RECONSTRUCTION STARTING ENERGY GRID
!     ---------------------------------------------
!     AS IN ANY ITERATIVE METHOD THE WAY TO SPEED CONVERGENCE IS TO TRY
!     TO START CLOSE TO THE ANSWER. THIS PROGRAM ATTEMPTS TO DO THIS BY
!     STARTING FROM AN ENERGY GRID WHICH IS A GOOD APPROXIMATION TO A
!     SIMPLE BREIT-WIGNER LINE SHAPE,
!
!     SIGMA(X)=1.0/(1.0+X*X)
!
!     WHERE X IS THE DISTANCE FROM THE PEAK IN HALF-WIDTHS
!
!     SUBROUTINE SUBINT HAS A BUILT-IN TABLE OF NODES WHICH ARE THE
!     HALF-WIDTH MULTIPLES TO APPROXIMATE THE SIMPLE BREIT-LINE SHAPE
!     TO WITHIN 1 PER-CENT OVER THE ENTIRE INTERVAL 0 TO 500 HALF-WIDTHS
!
!     BETWEEN ANY TWO RESOLVED RESONANCES THE STARTING GRID IS BASED ON
!     THE HALF-WIDTHS OF THE TWO RESONANCES. FROM THE LOWER ENERGY
!     RESONANCE UP TO THE MID-POINT BETWEEN THE RESONANCES (MID-POINT
!     IS DEFINED HERE AS AN EQUAL NUMBER OF HALF-WIDTHS FROM EACH
!     RESONANCE) THE HALF-WIDTH OF THE LOWER ENERGY RESONANCE IS USED.
!     FROM THE MID-POINT UP TO THE HIGHER ENERGY RESONANCE THE HALF-
!     WIDTH OF THE UPPER ENERGY RESONANCE IS USED.
!
!     WITH THIS ALOGORITHM CLOSELY SPACED RESONANCES WILL HAVE ONLY
!     A FEW STARTING NODES PER RESONANCE (E.G. U-235). WIDELY SPACED
!     RESONANCES WILL HAVE MORE NODES PER RESONANCE (E.G. U-238). FOR
!     A MIX OF S, P, D ETC. RESONANCES THIS ALOGORITHM GUARANTEES AN
!     ADEQUTE DESCRIPTION OF THE PROFILE OF EVEN EXTREMELY NARROW
!     RESONANCES (WHICH MAY IMMEDIATELY CONVERGENCE TO THE ACCURACY
!     REQUESTED, THUS MINIMIZING ITERATION).
!
!     BACKGROUND CROSS SECTIONS
!     -------------------------
!     THE PROGRAM WILL SEARCH FOR BACKGROUND CROSS SECTIONS FOR TOTAL
!     (MT=1), ELASTIC (MT=2), FISSION (MT=18), FIRST CHANCE FISSION
!     (MT=19) AND CAPTURE (MT=102).
!
!     (1) THE BACKGROUND CROSS SECTIONS (FILE 3) CAN BE PRESENT OR NOT
!         PRESENT FOR EACH REACTION.
!     (2) IF FOR A GIVEN REACTION THE BACKGROUND CROSS SECTION IS
!         PRESENT, IT WILL BE ADDED TO THE RESONANCE CONTRIBUTION AND
!         THE RESULT WILL BE OUTPUT.
!     (3) IF FOR A GIVEN REACTION THE BACKGROUND IS NOT PRESENT THE
!         PROGRAM WILL,
!         (A) IF THE INPUT TO THE PROGRAM SPECIFIES NO OUTPUT FOR
!             REACTIONS WITH NO BACKGROUND THERE WILL BE NO OUTPUT.
!         (B) IF THE INPUT TO THE PROGRAM SPECIFIES OUTPUT FOR REACTIONS
!             WITH NO BACKGROUND,
!             (I) THE RESONANCE CONTRIBUTION TO TOTAL, ELASTIC OR
!                 CAPTURE WILL BE OUTPUT.
!             (II) IF ALL FISSION RESONANCE PARAMETERS ARE ZERO THE
!                  FISSION CROSS SECTION (MT=18) WILL NOT BE OUTPUT.
!                  OTHERWISE THE RESONANCE CONTRIBUTION OF THE FISSION
!                  (MT=18) WILL BE OUTPUT.
!             (III) THERE WILL BE NO OUTPUT FOR FIRST CHANCE FISSION
!                   (MT=19).
!
!     COMBINING RESONANCES AND BACKGROUND CROSS SECTIONS
!     --------------------------------------------------
!     IN ORDER TO BE COMBINED WITH THE RESONANCE CONTRIBUTION THE
!     BACKGROUND CROSS SECTIONS MUST BE GIVEN AT 0 KELVIN TEMPERATURE
!     AND MUST BE LINEARLY INTERPOLABLE. IF THESE CONDITIONS ARE MET
!     THE RESONANCE AND BACKGROUND CONTRIBUTIONS WILL BE ADDED TOGETHER
!     AND OUTPUT. IF THESE CONDITIONS ARE NOT MET THE BACKGROUND CROSS
!     SECTION WILL BE IGNORED AND ONLY THE RESONANCE CONTRIBUTION WILL
!     BE OUTPUT. IF THE BACKGROUND HAS NOT BEEN ADDED TO THE RESONANCE
!     CONTRIBUTION AFTER THIS PROGRAM FINISHES THE USER CAN MAKE THE
!     RESONANCE AND BACKGROUND CONTRIBUTIONS COMPATIBLE BY,
!
!     (1) IF THE BACKGROUND IS NOT LINEARLY INTERPOABLE, LINEARIZE THE
!         BACKGROUND (E.G., USE PROGRAM LINEAR).
!     (2) IF THE BACKGROUND IS NOT GIVEN AT 0 KELVIN, DOPPLER BROADEN
!         THE RESONANCE (NOT BACKGROUND) CONTRIBUTION TO THE SAME
!         TEMPERATURE AS THE BACKGROUND (E.G., USE PROGRAM SIGMA1).
!
!     ONCE THE RESONANCE AND BACKGROUND CONTRIBUTIONS HAVE BEEN MADE
!     COMPATIBLE THEY CAN BE ADDED TOGETHER (E.G., USE PROGRAM MIXER).
!
!     THE RECONSTRUCTION OF THE RESONANCE CONTRIBUTION TO THE CROSS
!     SECTION CAN BE QUITE EXPENSIVE (IN TERMS OF COMPUTER TIME). SINCE
!     THE RECONSTRUCTION IS PERFORMED BEFORE THE BACKGROUND CROSS
!     SECTIONS ARE READ, THE ABOVE CONVENTIONS HAVE BEEN ADOPTED IN
!     ORDER TO AVOID LOSE OF COMPUTER TIME INVOLVED IN RECONSTRUCTING
!     THE RESONANCE CONTRIBUTION.
!
!     COMMON ENERGY GRID
!     ------------------
!     THIS PROGRAM WILL RECONSTRUCT THE RESONANCE CONTRIBUTION TO THE
!     TOTAL, ELASTIC, FISSION AND CAPTURE CROSS SECTIONS ALL ON THE
!     SAME ENERGY GRID. EACH REACTION WILL THEN BE COMBINED WITH ITS
!     BACKGROUND CROSS SECTION (IF ANY) AND OUTPUT WITHOUT ANY FURTHER
!     THINNING. IF THERE ARE NO BACKGROUND CROSS SECTIONS, OR IF THE
!     BACKGROUND CROSS SECTION FOR ALL FOUR REACTIONS ARE GIVEN ON A
!     COMMON ENERGY GRID, THE OUTPUT FROM THIS PROGRAM WILL BE ON A
!     COMMON ENERGY GRID FOR ALL FOUR REACTIONS.
!
!     THERMAL ENERGY
!     --------------
!     IF THE RESONANCE REGION SPANS THERMAL ENERGY (0.0253 EV) THIS
!     POINT IS ALWAYS INCLUDED IN THE COMMON ENERGY GRID USED FOR ALL
!     REACTIONS AND WILL ALWAYS APPEAR IN THE OUTPUT DATA.
!
!     SECTION SIZE
!     ------------
!     SINCE THIS PROGRAM USES A LOGICAL PAGING SYSTEM THERE IS NO LIMIT
!     TO THE NUMBER OF POINTS IN ANY SECTION, E.G., THE TOTAL CROSS
!     SECTION MAY BE REPRESENTED BY 200,000 DATA POINTS.
!
!     SELECTION OF DATA
!     -----------------
!     THE PROGRAM SELECTS MATERIALS TO BE PROCESSED BASED EITHER ON
!     MAT (ENDF/B MAT NO.) OR ZA. THE PROGRAM ALLOWS UP TO 100 MAT OR
!     ZA RANGES TO BE SPECIFIED. THE PROGRAM WILL ASSUME THAT THE
!     ENDF/B TAPE IS IN EITHER MAT OR ZA ORDER, WHICHEVER CRITERIA IS
!     USED TO SELECT MATERIALS, AND WILL TERMINATE WHEN A MAT OR ZA
!     IS FOUND THAT IS ABOVE THE RANGE OF ALL REQUESTS.
!
!     ALLOWABLE ERROR
!     ---------------
!     THE RECONSTRUCTION OF LINEARLY INTERPOLABLE CROSS SECTIONS FROM
!     RESONANCE PARAMETERS CANNOT BE PERFORMED EXACTLY. HOWEVER IT CAN
!     BE PERFORMED TO VIRTUALLY ANY REQUIRED ACCURACY AND MOST
!     IMPORTANTLY CAN BE PERFORMED TO A TOLERANCE THAT IS SMALL COMPARED
!     TO THE UNCERTAINTY IN THE CROSS SECTIONS THEMSELVES. AS SUCH THE
!     CONVERSION OF CROSS SECTIONS TO LINEARLY INTERPOLABLE FORM CAN BE
!     PERFORMED WITH ESSENTIALLY NO LOSS OF INFORMATION.
!
!     THE ALLOWABLE ERROR MAY BE ENERGY INDEPENDENT (CONSTANT) OR ENERGY
!     DEPENDENT. THE ALLOWABLE ERROR IS DESCRIBED BY A TABULATED
!     FUNCTION OF UP TO 20 (ENERGY,ERROR) PAIRS AND LINEAR INTERPOLATION
!     BETWEEN TABULATED POINTS. IF ONLY ONE TABULATED POINT IS GIVEN THE
!     ERROR WILL BE CONSIDERED CONSTANT OVER THE ENTIRE ENERGY RANGE.
!     WITH THIS ENERGY DEPENDENT ERROR ONE MAY OPTIMIZE THE OUTPUT FOR
!     ANY GIVEN APPLICATION BY USING A SMALL ERROR IN THE ENERGY RANGE
!     OF INTEREST AND A LESS STRINGENT ERROR IN OTHER ENERGY RANGES,
!     E.G., 0.1 PER-CENT FROM 0 UP TO THE LOW EV RANGE AND A LESS
!     STRINGENT TOLERANCE AT HIGHER ENERGIES.
!
!     DEFAULT ALLOWABLE ERROR
!     -----------------------
!     IN ORDER TO INSURE CONVERENCE OF THE RESONANCE RECONSTRUCTION THE
!     ALLOWABLE ERROR MUST BE POSITIVE. IF THE USER INPUTS AN ERROR FOR
!     RESONANCE RECONSTRUCTION THAT IS NOT POSITIVE IT WILL BE SET TO
!     THE DEFAULT VALUE (CURRENTLY 0.1 PER-CENT) AND INDICATED AS SUCH
!     IN THE OUTPUT LISTING.
!
!     INTERVAL HALVING ALGORITHM
!     -------------------------
!     THIS PROGRAM WILL START BY CALCULATING THE CROSS SECTIONS AT THE
!     ENERGIES CORRESPONDING TO THE PEAK OF EACH RESONANCE, AS WELL AS
!     A FIXED NUMBER OF HALF-WIDTHS ON EACH SIDE OF EACH RESONANCE.
!     STARTING FROM THIS BASIC GRID OF POINTS THE PROGRAM WILL CONTINUE
!     TO HALF EACH INTERVAL UNTIL THE CROSS SECTIONS FOR ALL REACTIONS
!     AT THE CENTER OF THE INTERVAL CAN BE DEFINED BY LINEAR
!     INTERPOLATION FROM THE ENDS OF THE INTERVAL TO WITHIN THE USER
!     SPECIFIED ACCURACY CRITERIA.
!
!     DISTANT RESONANCE TREATMENT
!     ---------------------------
!     THE OPTION TO TREAT DISTANT RESONANCES, WHICH WAS AVAILABLE IN
!     EARLIER VERSIONS OF THIS PROGRAM, IS NO LONGER AVAILABLE, BECAUSE
!     IT WAS FOUND TO PRODUCE UNRELIABLE RESULTS. IN THIS VERSION OF
!     THE PROGRAM ALL RESONANCES ARE TREATED EXACTLY.
!
!     PROGRAM OPERATION
!     ==================================================================
!     EDIT MODE
!     ---------
!     IT IS SUGGESTED THAT BEFORE RUNNING THIS PROGRAM TO RECONSTRUCT
!     CROSS SECTIONS FROM RESONANCE PARAMETERS (WHICH CAN BE QUITE
!     EXPENSIVE) THE USER FIRST RUN THE PROGRAM IN THE EDIT MODE (SEE,
!     DESCRIPTION OF INPUT PARAMETERS BELOW). IN THE EDIT MODE THE
!     PROGRAM WILL READ, LIST AND EXTENSIVELY CHECK THE CONSISTENCY OF
!     ALL RESONANCE PARAMETERS AND ENDF/B DEFINED RESONANCE FLAGS. THIS
!     IS A VERY INEXPENSIVE MEANS OF CHECKING ALL DATA BEFORE INVESTING
!     A LARGE AMOUNT OF MONEY IN RECONSTRUCTING CROSS SECTIONS. ANY AND
!     ALL DIGNOSTICS RECEIVED FROM THE EDIT WILL SUGGEST HOW TO CORRECT
!     THE EVALUATED DATA TO MAKE IT CONSISTENT BEFORE RECONSTRUCTING
!     CROSS SECTIONS. IN ORDER TO OBTAIN MEANINGFUL RESULTS FROM THE
!     RECONSTRUCTION ALL SUGGESTED CHANGES TO THE EVALUATION SHOULD BE
!     PERFORMED BEFORE TRYING RECONSTRUCTION (OTHERWISE THE RESULT OF
!     RECONSTRUCTION WILL NOT BE RELIABLE).
!
!     RECONSTRUCTION MODE
!     -------------------
!     FOR EACH REQUESTED MATERIAL
!     ---------------------------
!     IF SECTION MF=1, MT=451 IS PRESENT COMMENTS WILL BE ADD TO
!     DOCUMENT THAT THE MATERIAL HAS BEEN PROCESSED. MF=1, MT=451 WILL
!     ALSO BE USED TO DETERMINE THE VERSION OF THE ENDF/B FORMAT WHICH
!     WILL ALLOW THE PROGRAM TO USE THE APPROPRIATE CONVENTIONS.
!
!     ALL OF THE FILE 2 RESONANCE PARAMETERS ARE FIRST READ AND THE
!     LINEARLY INTERPOLABLE CONTRIBUTION OF THE RESONANCE PARAMETERS
!     TO THE TOTAL, ELASTIC, CAPTURE AND FISSION CROSS SECTIONS IS
!     CALCULATED SIMULTANEOUSLY USING A COMMON ENERGY GRID FOR ALL
!     FOUR REACTIONS.
!
!     AFTER THE RESONANCE CONTRIBUTION HAS BEEN RECONSTRUCTED EACH OF
!     THE FIVE REACTIONS (MT=1, 2, 18, 19, 102) IS CONSIDERED SEPARATELY
!     FOR COMBINATION WILL THE BACKGROUND CROSS SECTION, IF ANY, AS
!     DESCRIBED ABOVE.
!
!     OUTPUT WILL INCLUDE THE ENTIRE EVALUATION, INCLUDING RESONANCES
!     PARAMETERS WITH LRU MODIFIED (AS DESCRIBED ABOVE) TO INDICATE
!     THAT THE RESONANCE CONTRIBUTION HAS ALREADY BEEN ADDED TO THE
!     FILE 3 CROSS SECTIONS.
!
!     THE CYCLE OF RECONSTRUCTING THE RESONANCE CONTRIBUTION AND ADDING
!     THE BACKGROUND WILL BE REPEATED FOR EACH MATERIAL REQUESTED.
!
!     PROCESS ONLY A PORTION OF RESONANCE REGION
!     ==================================================================
!     MODERN EVALUATIONS MAY BE EXTREMELY LARGE AND IT MAY NOT BE
!     POSSIBLE TO PROCESS AN ENTIRE EVALUATION (I.E., ADD THE RESONANCE
!     CONTRIBUTION) DURING A SINGLE COMPUTER RUN.
!
!     ALSO IN THE CASE WHERE YOU ARE ONLY INTERESTED IN THE CROSS
!     SECTIONS OVER A SMALL ENERGY RANGE, YOU MAY NOT WANT TO PROCESS
!     AN ENTIRE EVALUATION, E.G., IF YOU ONLY WANT TO KNOW WHAT THE
!     CROSS SECTIONS ARE NEAR THERMAL ENERGY, 0.0253 EV.
!
!     IN ORDER TO ALLOW AN EVALUATION TO BE PROCESSED USING A NUMBER OF
!     SHORTER COMPUTER RUNS AN OPTION HAS BEEN ADDED TO THIS PROGRAM TO
!     ALLOW THE USER TO SPECIFY THE ENERGY RANGE TO BE PROCESSED.
!
!     USING THIS OPTION YOU MAY START AT THE LOWEST ENERGY (ZERO UP TO
!     SOME ENERGY) AND USE THE RESULTS OF THIS RUN AS INPUT TO THE
!     NEXT RUN, WHERE YOU CAN SPECIFY THE NEXT ENERGY RANGE. THIS
!     CYCLE CAN BE REPEATED UNTIL YOU HAVE PROCESSED THE ENTIRE
!     EVALUATION.
!
!     WARNING - THIS OPTION SHOULD BE USED WITH EXTREME CARE - THIS
!     OPTION HAS BEEN RELUCTANTLY ADDED - RELUCTANTLY BECAUSE IT CAN
!     BE EXTREMELY DANGEROUS TO USE THIS OPTION UNLESS YOU CAREFULLY
!     CHECKED WHAT YOU ARE DOING.
!
!     THE OPTION SHOULD ONLY BE USED AS FOLLOWS,
!     1) YOU MUST PROCESS USING ENERGY RANGES STARTING AT LOW ENERGY
!        AND WORKING YOUR WAY TOWARD HIGH ENERGY, E.G.,
!         0.0   TO  3.0+3
!         3.0+3 TO 10.0+3
!        10.0+3 TO 80.0+3, ETC.
!     2) FOR THE LAST ENERGY RANGE THE LOWER ENERGY LIMIT MUST BE
!        NON-ZERO (WHERE TO START) AND THE UPPER ENERGY LIMIT MUST
!        BE ZERO (NO LIMIT)
!        80.0+3 TO  0.0
!
!     IF YOU ARE ONLY INTERESTED IN THE CROSS SECTION OVER A NARROW
!     ENERGY INTERVAL AND DO NOT INTENT TO MAKE ANY OTHER USE OF THE
!     RESULTS, YOU CAN IGNORE THESE WARNINGS AND MERELY SPECIFY ANY
!     ENERGY INTERVAL OVER WHICH YOU WISH CALCULATIONS TO BE
!     PERFORMED.
!
!     NORMALLY WHEN THIS PROGRAM PROCESSES AN EVALUATION IT WILL SET
!     FLAGS IN THE EVALUATION TO PREVENT THE SAME RESONANCE
!     CONTRIBUTION FROM BEING ADDED TO THE CROSS SECTION MORE THAN
!     ONCE, SHOULD YOU USE THE OUTPUT FROM THIS PROGRAM AS INPUT TO
!     THE PROGRAM.
!
!     WHEN PROCESSING ONLY PORTIONS OF THE RESONANCE REGION THIS
!     PROGRAM CANNOT SET THESE FLAGS TO PROTECT AGAINST ADDING THE
!     RESONANCE CONTRIBUTION MORE THAN ONCE - WHICH MAKES USE OF
!     THIS OPTION EXTREMELY DANGEROUS.
!
!     ONLY YOU CAN CHECK TO MAKE SURE THAT YOU HAVE CORRECTLY
!     INCLUDED EACH ENERGY RANGE ONLY ONCE - SEE THE COMMENT LINES
!     AT THE END OF SECTION, MF=1, MT=451, FOR A COMPLETE RECORD
!     OF EACH RUN USING THIS PROGRAM. THIS SECTION WILL CONTAIN
!     LINES OF THE FORM
!
!     ***************** PROGRAM RECENT (VERSION 2000-1) *************
!     ONLY PROCESS  0.00000+ 0 TO  3.00000+ 3 EV
!     ***************** PROGRAM RECENT (VERSION 2000-1) *************
!     ONLY PROCESS  3.00000+ 3 TO  1.00000+ 4 EV
!     ***************** PROGRAM RECENT (VERSION 2000-1) *************
!     ONLY PROCESS  1.00000+ 4 TO  8.00000+ 4 EV
!     ***************** PROGRAM RECENT (VERSION 2000-1) *************
!     ONLY PROCESS  8.00000+ 4 TO  2.00000+ 7 EV
!
!     YOU SHOULD CHECK TO INSURE THAT THERE ARE NO OVERLAPPING ENERGY
!     RANGES OR MISSING ENERGY RANGES.
!
!     WHEN YOU INDICATE BY INPUT THAT YOU ARE ABOUT TO PROCESS THE
!     LAST ENERGY RANGE (SEE ABOVE, LOWER ENERGY LIMIT = NON-ZERO,
!     UPPER ENERGY LIMIT = ZERO), THIS PROGRAM WILL ASSUME THAT
!     YOU HAVE NOW COMPLETED ALL PROCESSING - AND ONLY THEN WILL
!     IT SET FLAGS IN THE EVALUATION TO PREVENT THE RESONANCE
!     CONTRIBUTION FROM BEING ADDED MORE THAN ONCE. FOR THIS REASON
!     YOU CANNOT PROCESS STARTING WITH ENERGY INTERVALS AT HIGH
!     ENERGY AND WORKING TOWARD LOW ENERGY - YOU MUST START AT LOW
!     ENERGY AND WORK TOWARD HIGH ENERGY.
!
!     I/O FILES
!     ==================================================================
!     INPUT FILES
!     -----------
!     UNIT  DESCRIPTION
!     ----  -----------
!       2   INPUT LINE (BCD - 80 CHARACTERS/RECORD)
!      10   ORIGINAL ENDF/B DATA (BCD - 80 CHARACTERS/RECORD)
!
!     OUTPUT FILES
!     ------------
!     UNIT  DESCRIPTION
!     ----  -----------
!       3   OUTPUT REPORT (BCD - 120 CHARACTERS/RECORD)
!      11   FINAL ENDF/B DATA (BCD - 80 CHARACTERS/RECORD)
!
!     SCRATCH FILES
!     -------------
!     UNIT  DESCRIPTION
!     ----  -----------
!      12   SCRATCH FILE FOR DATA RECONSTRUCTED FROM RESONANCE
!           PARAMETERS (BINARY - 100200 WORDS/RECORD)
!      14   SCRATCH FILE FOR COMBINED FILE 2 AND 3 DATA
!           (BINARY - 40080 WORDS/RECORD)
!
!     OPTIONAL STANDARD FILE NAMES (SEE SUBROUTINE FILEIO)
!     ==================================================================
!     UNIT  FILE NAME
!     ----  ----------
!       2   THERMX.INP
!       3   THERMX.LST
!      10   ENDFB.IN
!      11   ENDFB.OUT
!      12   (SCRATCH)
!      14   (SCRATCH)
!
!     INPUT CARDS
!     ==================================================================
!     LINE  COLS.  FORMAT  DESCRIPTION
!     ----  -----  ------  -----------
!       1    1-11    I11   RETRIEVAL CRITERIA (0=MAT, 1=ZA)
!                          THIS OPTION DEFINED WHETHER COLUMNS 1-22 OF
!                          SUBSEQUENT INPUT CARDS SHOULD BE INTERPRETED
!                          TO BE MAT OR ZA RANGES.
!           12-22   E11.4  FILE 2 MINIMUM ABSOLUTE CROSS SECTION
!                          (IF 1.0E-10 OR LESS IS INPUT THE PROGRAM
!                          WILL USE 1.0E-10)
!           23-33    I11   TREATMENT OF REACTIONS FOR WHICH BACKGROUND
!                          CROSS SECTION IS NOT GIVEN.
!                          = 0 - IGNOR (I.E. NO OUTPUT)
!                          = 1 - OUTPUT RESONANCE CONTRIBUTION.
!                          THIS OPTION IS USEFUL WITH PARTIAL EVALUATION
!                          (E.G. ENDF/B-V DOSIMETRY LIBRARY) WHERE ONLY
!                          ONE OR MORE OF THE REACTIONS ARE OF ACTUAL
!                          INTEREST.
!                          WARNING...THE USE OF THIS FIELD HAS BEEN
!                          CHANGED. THIS FIELD WAS PREVIOUSLY USED TO
!                          DEFINE THE PRECISION OF THE CALCULATION AND
!                          OUTPUT. THE FORMER DEFINITION OF THIS FIELD
!                          WAS...
!                          MINIMUM ENERGY SPACING FLAG
!                          = 0 - 6 DIGIT MINIMUM ENERGY SPACING.
!                                STANDARD 6 DIGIT E11.4 OUTPUT.
!                          = 1 - 9 DIGIT MINIMUM ENERGY SPACING.
!                                STANDARD 6 DIGIT E11.4 OUTPUT.
!                          = 2 - 9 DIGIT MINIMUM ENERGY SPACING.
!                                VARIABLE 9 DIGIT F FORMAT OUTPUT.
!                          FROM EXPERIENCE IT HAS BEEN FOUND THAT
!                          FAILURE TO SET THIS OPTION TO 2 CAN RESULT
!                          IN LARGE ERRORS IN THE FINAL DATA. THEREFORE
!                          INTERNALLY THIS OPTION IS SET TO 2.
!           34-44    I11   OPERATING MODE
!                          = 0 - CACULATE. MINIMUM OUTPUT LISTING
!                          = 1 - CACULATE. LIST ALL RESONANCE PARAMETERS
!                          = 2 - EDIT MODE. NO CALCULATION. LIST ALL
!                                RESONANCE PARAMETERS.
!                          NOTE, THE EDIT MODE (=2) IS THE SUGGESTED
!                          MODE TO FIRST TEST THE CONSISTENCY OF THE
!                          EVALUATED DATA, BEFORE RECONSTRUCTING CROSS
!                          SECTIONS (SEE, COMMENTS ABOVE).
!           45-55    I11   THIS OPTION IS NO LONGER USED. THE PREVIOUS
!                          DEFINITION OF THIS OPTION WAS---DISTANT
!                          RESONANCE TREATMENT.
!                          = 0 - EXACT
!                          = 1 - LINEAR RATIO OVER SUBINTERVAL
!                          = 2 - LINEAR RATIO OVER INTERVAL
!                          ALL RESONANCES ARE TREATED EXACTLY IN THIS
!                          VERSION OF THE CODE.
!           56-66    I11   MONITOR MODE SELECTOR
!                          = 0 - NORMAL OPERATION
!                          = 1 - MONITOR PROGRESS OF RECONSTRUCTION OF
!                                FILE 2 DATA AND COMBINING FILE 2 AND
!                                FILE 3 DATA. EACH TIME A PAGE OF DATA
!                                POINTS IS WRITTEN TO A SCRATCH FILE
!                                PRINT OUT THE TOTAL NUMBER OF POINTS
!                                ON SCRATCH AND THE LOWER AND UPPER
!                                ENERGY LIMITS OF THE PAGE (THIS OPTION
!                                MAY BE USED IN ORDER TO MONITOR THE
!                                EXECUTION SPEED OF LONG RUNNING JOBS).
!       2    1-60    A60   ENDF/B INPUT DATA FILENAME
!                          (STANDARD OPTION = ENDFB.IN)
!       3    1-60    A60   ENDF/B OUTPUT DATA FILENAME
!                          (STANDARD OPTION = ENDFB.OUT)
!     4-N    1-11    I11   MINIMUM MAT OR ZA (SEE COLS. 1-11, LINE 1)
!           12-22    I11   MAXIMUM MAT OR ZA (SEE COLS. 1-11, LINE 1)
!                          UP TO 100 MAT OR ZA RANGES MAY BE SPECIFIED,
!                          ONE RANGE PER LINE. THE LIST IS TERMINATED
!                          BY A BLANK LINE. IF THE THE UPPER LIMIT OF
!                          ANY REQUEST IS LESS THAN THE LOWER LIMIT THE
!                          UPPER LIMIT WILL BE SET EQUAL TO THE LOWER
!                          LIMIT. IF THE FIRST REQUEST LINE IS BLANK IT
!                          WILL TERMINATE THE REQUEST LIST AND CAUSE ALL
!                          DATA TO BE RETRIEVED (SEE EXAMPLE INPUT).
!           23-33   E11.4  LOWER ENERGY LIMIT FOR PROCESSING.
!           34-44   E11.4  UPPER ENERGY LIMIT FOR PROCESSING.
!                         *THE LOWER AND UPPER ENERGY LIMITS MUST BE
!                          ZERO, OR BLANK, UNLESS YOU WISH TO ONLY
!                          PROCESS A PORTION OF RESONANCE REGIONS.
!                         *THESE ENERGY LIMITS ARE ONLY READ FROM THE
!                          FIRST MAT/ZA REQUEST LINE
!                         *IF BOTH ARE ZERO (OR BLANK) THE ENTIRE
!                          RESONANCE REGION FOR EACH MATERIAL WILL BE
!                          PROCESSED
!                         *IF LIMITS ARE INPUT ONLY THAT PORTION OF THE
!                          RESONANCE REGION FOR EACH MATERIAL WHICH
!                          LIES BETWEEN THESE LIMITS WILL BE PROCESSED
!                         *SEE INSTRUCTIONS ABOVE BEFORE USING THIS
!                          OPTION.
!     VARY   1-11   E11.4  ENERGY FOR FILE 2 ERROR LAW     (  SEE   )
!           12-22   E11.4  ERROR FOR FILE 2 ERROR LAW      (COMMENTS)
!                                                          ( BELOW  )
!
!     NOTE, THIS VERSION OF THE PROGRAM DOES NOT THIN THE COMBINED FILE
!     FILE 2 + 3 DATA. AS SUCH THE ERROR LAW FOR COMBINING FILE 2 + 3
!     WHICH WAS REQUIRED IN EARLIER VERSIONS OF THIS CODE ARE NO LONGER
!     REQUIRED.
!
!     THE FILE 2 ERROR LAW MAY BE ENERGY INDEPENDENT (DEFINED BY A
!     SINGLE ERROR) OR ENERGY DEPENDENT (DEFINED BY UP TO 20 ENERGY,
!     ERROR PAIRS). FOR THE ENERGY DEPENDENT CASE LINEAR INTERPOLATION
!     WILL BE USED TO DEFINE THE ERROR AT ENERGIES BETWEEN THOSE AT
!     WHICH THE ERROR IS TABULATED. THE ERROR LAW IS TERMINATED BY A
!     BLANK LINE. IF ONLY ONE ENERGY, ERROR PAIR IS GIVEN THE LAW WILL
!     BE CONSIDERED TO BE ENERGY INDEPENDENT. IF MORE THAN ONE PAIR
!     IS GIVEN IT BE CONSIDERED TO BE ENERGY DEPENDENT (NOTE, THAT
!     FOR A CONSTANT ERROR THE ENERGY INDEPENDENT FORM WILL RUN FASTER.
!     HOWEVER, FOR SPECIFIC APPLICATIONS AN ENERGY DEPENDENT ERROR MAY
!     BY USED TO MAKE THE PROGRAM RUN CONSIDERABLE FASTER).
!
!     ALL ENERGIES MUST BE IN ASCENDING ENERGY ORDER. FOR CONVERGENCE
!     OF THE FILE 2 RECONSTRUCTION ALGORITHM ALL THE ERRORS MUST BE
!     POSITIVE. IF ERROR IS NOT POSITIVE IT WILL BE SET EQUAL TO THE
!     STANDARD OPTION (CURRENTLY 0.001, CORRRESPONDING TO 0.1 PER-CENT).
!     IF THE FIRST LINE OF THE ERROR LAW IS BLANK IT WILL TERMINATE THE
!     ERROR LAW AND THE ERROR WILL BE TREATED AS ENERGY INDEPENDENT,
!     EQUAL TO THE STANDARD OPTION (CURRENTLY, 0.1 PER-CENT). SEE,
!     EXAMPLE INPUT 4.
!
!     EXAMPLE INPUT NO. 1
!     -------------------
!     CONSIDER ALL URANIUM ISOTOPES AND TH-232. CONSIDER CROSS SECTIONS
!     WHICH ARE LARGER THAN 1.0E-8 BARNS IN ABSOLUTE VALUE. ONLY OUTPUT
!     REACTIONS FOR WHICH A BACKGROUND IS GIVEN. LIST ALL PARAMETERS AND
!     CALCULATE CROSS SECTIONS. MONITOR THE EXECUTION PROGRESS OF THE
!     PROGRAM. BETWEEN 0 AND 100 EV USE 0.1 PER-CENT ACCURACY. BETWEEN
!     100 EV AND 1 KEV VARY THE ACCURACY FROM 0.1 TO 1 PER-CENT. ABOVE
!     1 KEV USE 1 PER-CENT ACCURACY.
!
!     EXPLICITLY SPECIFY THE STANDARD FILENAMES.
!
!     THE FOLLOWING 11 INPUT CARDS ARE REQUIRED.
!
!          1 1.00000-08          0          1          0         1
! ENDFB.IN
! ENDFB.OUT
!      92000      92999
!      90232                  (UPPER LIMIT AUTOMATICALLY SET TO 90232)
!                             (END REQUEST LIST)
! 0.00000+ 0 1.00000-03
! 1.00000+02 1.00000-03
! 1.00000+03 1.00000-02
! 1.00000+09 1.00000-02
!                             (END FILE 2 ERROR LAW)
!
!     EXAMPLE INPUT NO. 2
!     -------------------
!     CONSIDER ALL URANIUM ISOTOPES AND TH-232. CONSIDER CROSS SECTIONS
!     WHICH ARE LARGER THAN 1.0E-8 BARNS IN ABSOLUTE VALUE. ONLY OUTPUT
!     REACTIONS FOR WHICH A BACKGROUND IS GIVEN. CROSS SECTIONS WILL BE
!     CALCULATED, BUT PARAMETERS WILL NOT BE LISTED. THE PROGRESS OF THE
!     PROGRAM WILL NOT BE MONITORED. USE 0.1 PER-CENT ACCURACY FOR ALL
!     ENERGIES. SINCE 0.1 PER-CENT IS THE STANDARD OPTION FOR THE ERROR
!     LAW THE FIRST ERROR LAW LINE MAY BE LEFT BLANK.
!
!     LEAVE THE DEFINITION OF THE FILENAMES BLANK - THE PROGRAM WILL
!     THEN USE THE STANDARD FILENAMES.
!
!     THE FOLLOWING 7 INPUT CARDS ARE REQUIRED.
!
!          1 1.00000-08          0          0          0         0
!
!
!      92000      92999
!      90232                  (UPPER LIMIT AUTOMATICALLY SET TO 90232)
!                             (END REQUEST LIST)
!                             (USE STANDARD OPTION FOR ERROR LAW)
!
!     EXAMPLE INPUT NO. 3
!     -------------------
!     THE SAME AS EXAMPLE INPUT NO. 2, ONLY IN THIS CASE ONLY CALCULATE
!     CROSS SECTIONS OVER THE ENERGY RANGE 0.01 TO 0.1 EV - ACROSS THE
!     THERMAL ENERGY RANGE. NOTE, THE ONLY DIFFERENCE BETWEEN THE INPUT
!     PARAMETERS IN THIS CASE AND IN EXAMPLE NO. 2, IS THAT ON THE
!     SECOND INPUT LINE WE HAVE ADDED THE ENERGY RANGE 0.01 TO 0.1 EV.
!     USE \PREPRO94\LINEAR\ENDFB.OUT AS INPUT AND ENDFB.OUT AS OUTPUT -
!     SINCE ENDFB.OUT IS THE STANDARD OUTPUT FILENAME THE NAME CAN BE
!     EITHER INCLUDED IN THE INPUT OR LEFT BLANK.
!
!     THE FOLLOWING 7 INPUT CARDS ARE REQUIRED.
!
!          1 1.00000-08          0          0          0         0
! \PREPRO94\LINEAR\ENDFB.OUT
! ENDFB.OUT
!      92000      92999 1.00000- 2 1.00000- 1
!      90232                  (UPPER LIMIT AUTOMATICALLY SET TO 90232)
!                             (END REQUEST LIST)
!                             (USE STANDARD OPTION FOR ERROR LAW)
!
!     EXAMPLE INPUT NO. 4
!     -------------------
!     RECONSTRUCT ALL DATA. OUTPUT ALL REACTIONS, REGARDING OF WHETHER
!     OR NOT THERE IS A BACKGROUND CROSS SECTION. DO NOT MONITOR THE
!     PROGRESS OF THE PROGRAM. RECONSTRUCT CROSS SECTIONS TO 1 PER-CENT
!     ACCURACY. USE \ENDFB6\LINEAR\ZA092238 AS INPUT AND
!     \ENDFB6\RECENT\ZA092238 AS OUTPUT.
!
!     THE FOLLOWING 6 INPUT CARDS ARE REQUIRED.
!
!          0 0.0                 1          0          0         0
! \ENDFB6\ZA092238
! \ENDFB6\RECENT\ZA092238
!                       (RETRIEVE ALL DATA, END REQUEST LIST)
!            1.00000- 2
!                       (END FILE 2 ERROR LAW)
!
!     EXAMPLE INPUT NO. 5
!     -------------------
!     RECONSTRUCT ALL DATA. ONLY OUTPUT REACTIONS FOR WHICH A BACKGROUND
!     CROSS SECTION IS GIVEN. DO NOT MONITOR THE PROGRESS OF THE PROGRAM
!     RECONSTRUCT CROSS SECTIONS TO 0.1 PER-CENT ACCURACY. USE ENDFB.IN
!     AS INPUT AND ENDFB.OUT AS OUTPUT.
!
!     THIS CORRESPONDS TO USING ALL OF THE STANDARD OPTONS BUILT-IN TO
!     THE PROGRAM AND ALL INPUT CARDS MAY BE BLANK.
!
!     IN THIS CASE THE FOLLOWING 5 INPUT CARDS ARE REQUIRED.
!     (ZEROES ARE INDICATED ON THE FIRST LINE, BELOW, ONLY TO INDICATE
!     WHERE THE LINE IS. THE ACTUAL INPUT LINE CAN BE COMPLETELY BLANK).
!
!          0 0.0                 0          0          0         0
!                       (USE STANDARD INPUT FILENAME = ENDFB.IN)
!                       (USE STANDARD OUTPUT FILENAME = ENDFB.OUT)
!                       (RETRIEVE ALL DATA, END REQUEST LIST)
!                       (0.1 ERROR, END FILE 2 ERROR LAW)
!
!=======================================================================
IMPLICIT DOUBLE PRECISION (A-H, O-Z)
SAVE
INTEGER OUTP, OTAPE
CHARACTER*4 LINE
COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
COMMON/HEADER/C1H, C2H, L1H, L2H, N1H, N2H, MATH, MFH, MTH, NOSEQ
COMMON/MAXIE/MAXSEC, MAXRES, MAXNOD, NEDSEC, NEDRES, NEDNOD
COMMON/PAGER/NPAGE, NPAGP1, NPAGM1
COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
COMMON/COPC/LINE(17)
COMMON/COPI/MFIELD(3)
COMMON/FISSY/LFWX, LFI, MT451
COMMON/MINNIE/EMIN, EMAX, DEMIN
COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
!-----INITIALIZE TIMER
CALL TIMER
!
!     DEFINE ALL I/O UNITS.
!
CALL FILEIO
!-----DEFINE THE NUMBER OF POINTS IN EACH PAGE OF DATA.
NPAGE = 120000
NPAGP1 = NPAGE + 1
NPAGM1 = NPAGE - 1
!-----DEFINE MAXIMUM ALLOWABLE NUMBER OF SECTIONS, RESONANCES AND NODES.
!-----AND INITIALIZE NEEDED VALUES.
MAXSEC = 200
MAXRES = 120000
MAXNOD = 120000
NEDSEC = 0
NEDRES = 0
NEDNOD = 0
!-----DEFINE MINIMUM AND MAXIMUM ENERGIES OF INTEREST AND MINIMUM
!-----ALLOWABLE ENERGY INTERVAL FOR ANY ONE RESONANCE REGION.
EMIN = 1.0D-05
EMAX = 1.0D+10
DEMIN = 1.0D-05
!-----DEFINE COMMONLY USED CONSTANTS.
ZERO = 0.0D+00
HALF = 5.0D-01
ONE = 1.0D+00
TWO = 2.0D+00
THREE = 3.0D+00
FOUR = 4.0D+00
EIGHT = 8.0D+00
PI = DACOS(-1.0D+00)
PI2 = TWO * PI
!-----OUTPUT PROGRAM IDENTIFICATION.
WRITE(OUTP, 150)
WRITE(*, 150)
!-----READ AND CHECK ALL INPUT PARAMETERS.
CALL READIN
!
!     READ, LIST AND OUTPUT ENDF/B TAPE LABEL.
!
CALL COPYL
WRITE(OUTP, 160) LINE, MFIELD(1)
WRITE(*, 160) LINE, MFIELD(1)
!-----INITIALIZE FISSILE FLAG OFF AND MF=1, MT=451 SECTION PRESENT FLAG
!-----TO OFF.
10 LFI = 0
MT451 = 0
!-----FIND NEXT REQUESTED MAT AND TERMINATE IF RETURNED MAT IS NOT
!-----POSITIVE.
CALL NXTMAT
IF(MATH.GT.0) GO TO 50
!-----END OF RUN. TEND LINE HAS ALREADY BEEN OUTPUT.
20 CONTINUE
WRITE(OUTP, 180) MAXSEC, MAXNOD, MAXRES, NEDSEC, NEDNOD, NEDRES
IF(NEDSEC.GT.MAXSEC.OR.NEDNOD.GT.MAXNOD.OR.NEDRES.GT.MAXRES)&
        WRITE(OUTP, 190)
WRITE(OUTP, 200)
WRITE(*, 180) MAXSEC, MAXNOD, MAXRES, NEDSEC, NEDNOD, NEDRES
IF(NEDSEC.GT.MAXSEC.OR.NEDNOD.GT.MAXNOD.OR.NEDRES.GT.MAXRES)&
        WRITE(*, 190)
WRITE(*, 200)
CALL ENDIT
!
!     FIND FILE 1 OR 2.
!
30 CALL CONTI
IF(MTH) 40, 40, 50
40 CALL CONTO
IF(MATH) 20, 10, 30
50 IF(MFH - 1) 90, 60, 70
60 IF(MTH - 451) 80, 130, 90
70 IF(MFH - 2) 90, 140, 110
!-----COPY SECTION.
80 CALL CONTO
CALL COPYS
GO TO 30
!-----COPY FILE.
90 CALL CONTO
100 CALL COPYF
GO TO 30
!-----COPY MAT
110 CALL CONTO
120 CALL COPYM
GO TO 10
!-----MF=1, MT=451 FOUND. ADD COMMENT CARDS AND DEFINE ENDF/B FORMAT
!-----VERSION - TO USE ALL CONVENTIONS ASSOICATED WITH CORRECT FORMAT
!-----VERSION).
130 MT451 = 1
CALL FILE1(IMDONE)
!-----COPY REMAINDER OF MAT IF NO RESONANCE PARAMETERS OR MAT HAS
!-----ALREADY BEEN PROCESSED. OTHERWISE COPY TO END OF FILE 1 (MF=1).
IF(IMEDIT.EQ.2) GO TO 100
IF(IMDONE) 120, 120, 100
!-----FILE 2 FOUND. PRINT WARNING MESSAGE IF NO MF=1, MT=451.
140 IF(MT451.LE.0) WRITE(OUTP, 170)
!-----PROCESS ALL OF FILE 2 (LIST ALL PARAMETERS AND/OR PROCESS INTO
!-----POINTWISE FORM).
CALL CONTO
CALL FILE2
!-----EDIT FILE 3 OR COMBINE FILE 2 AND 3 CONTRIBUTIONS AND OUTPUT.
!-----COPY REMAINDER OF MAT.
CALL FILE3
!-----ENTIRE MATERIAL HAS PROCESSED. PROCEED TO NEXT MAT.
GO TO 10
150 FORMAT(' Calculate Cross Sections from Resonance Parameters', &
        ' (RECENT 2000-1)'/1X, 78('='))
160 FORMAT(1X, 78('=')/' ENDF/B Tape Label'/1X, 78('=')/1X, 16A4, A2, I4)
170 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
        ' No Section MF=1, MT=451.'/&
        ' (1) Cannot Determine ENDF/B Format Version. Will'/&
        '     Assume and Use ALL ENDF/B-VI Conventions.'/&
        ' (2) Cannot Determine if there are Resonance Parameters(LRP).'/&
        ' (3) Cannot Determine if Material is Fissile (LFI).'/&
        ' Will Read Data to Answer Points (2) AND (3).')
180 FORMAT(&
        ' Core Allocation and Requirements'/1X, 78('=')/&
        9X, 'Sections   Nodes Parameter'/28X, 'Storage'/1X, 78('=')/&
        ' Allocated', I7, I8, I10/&
        ' Required ', I7, I8, I10/1X, 78('='))
190 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
        ' WARNING...Before Using this Program to Calculate'/&
        '           Cross Sections the Core Allocation MUST'/&
        '           be Increased to at Least the Requirements'/&
        '           Described Above. Failure to do this Will'/&
        '           Cause the Program to Abort During Eexecution'/&
        1X, 78('='))
200 FORMAT(' End of Run'/1X, 78('='))
END
SUBROUTINE READIN
    !=======================================================================
    !
    !     READ AND CHECK ALL INPUT PARAMETERS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD, NAME1, NAME2, NAME3, NAME4, BLANK
    CHARACTER*4 MESS1, MESS2, MESS3, MESS4, MESS5, MESS6
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/MATZA/MODGET, NMATZA, MATMIN(101), MATMAX(101)
    COMMON/OKERR2/ERRXC2, ERXC20, ENER2(21), ER2(21), MAXER2
    COMMON/FIXPOT/MYPOT
    COMMON/MINSIG/SIGMIN
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/FIELDC/FIELD(11, 12)
    COMMON/PARTN/EPART1, EPART2, NPART
    COMMON/NAMEX/NAME1(60), NAME2(60)
    DIMENSION MESS1(2), MESS2(9, 2), MESS3(10, 3), MESS4(9, 2), &
            MESS5(5, 2), MESS6(2), NAME3(8), NAME4(12)
    DATA EPMAX/2.0D+07/
    !-----DEFINE STANDARD FILENAMES
    DATA NAME3/'E', 'N', 'D', 'F', 'B', '.', 'I', 'N'/
    DATA NAME4/'E', 'N', 'D', 'F', 'B', '.', 'O', 'U', 'T', ' ', ' ', ' '/
    DATA BLANK/' '/
    !-----DEFINE STANDARD MINIMUM ALLOWABLE ERROR (PRESENTLY 0.1 PER-CENT).
    DATA ERRMIN/1.0D-03/
    !-----DEFINE MINIMUM ABSOLUTE CROSS SECTION OF INTEREST (CROSS SECTION
    !-----MAY BE POSITIVE OR NEGATIVE, BUT IF BOTH ENDS OF ANY INTERVAL ARE
    !-----CLOSER TO ZERO THAN SIGLOW THE INTERVAL WILL NOT BE FURTHER
    !-----SUB-DIVIDED).
    DATA SIGLOW/1.0D-10/
    !-----DEFINE ALL OUTPUT MESSAGES.
    DATA MESS1/' MAT', '  ZA'/
    DATA MESS2/&
            '  No', ' Out', 'put ', '    ', '    ', '    ', '    ', '    ', '    ', &
            '    ', ' Out', 'put ', '(Res', 'onan', 'ce C', 'ontr', 'ibut', 'ion)'/
    DATA MESS3/&
            ' Cal', 'cula', 'te. ', 'Mini', 'mum ', 'Outp', 'ut L', 'isti', 'ng. ', &
            '    ', &
            ' Cal', 'cula', 'te. ', 'List', ' Res', 'onan', 'ce P', 'aram', 'eter', &
            'S.  ', &
            ' Edi', 't Mo', 'de. ', 'List', ' Res', 'onan', 'ce P', 'aram', 'eter', &
            'S.  '/
    DATA MESS4/&
            '  No', ' Cha', 'nge ', '(All', 'ow N', 'egat', 'ive ', 'Outp', 'ut) ', &
            '  Ma', 'ke =', ' 0 (', 'No N', 'egat', 'ive ', 'Outp', 'ut) ', '    '/
    DATA MESS5/'(Sta', 'ndar', 'd Op', 'tion', ')   ', &
            '    ', '    ', '    ', '    ', '    '/
    DATA MESS6/' Off', '  On'/
    !-----READ AND PRINT INTERPRETATION OF FIRST LINE OF INPUT PARAMETERS.
    READ(INP, 230) MODGET, SIGMIN, IMBACK, IMEDIT, MAKEPLUS, MONITR
    IF(MODGET.NE.0) MODGET = 1
    IF(IMBACK.NE.0) IMBACK = 1
    IF(MAKEPLUS.NE.0) MAKEPLUS = 1
    !-----INITIALIZE TO ADD MISSING OR DUPLICATE (L,S,J) SEQUENCES.
    MYPOT = 1
    IF(IMEDIT.LT.10) GO TO 10
    !-----AS REQUESTED, TURN ON OVERRIDE NOT TO ADD MISSING OR DUPLICATE
    !-----(L,S,J) SEQUENCES.
    MYPOT = 0
    IMEDIT = IMEDIT - 10 * (IMEDIT / 10)
    10 IF(IMEDIT.LT.0.OR.IMEDIT.GT.2) IMEDIT = 2
    !-----IF IN EDIT MODE SET OTAPE = 0 TO INDICATE NO ENDF/B OUTPUT.
    IF(IMEDIT.EQ.2) OTAPE = 0
    IF(MONITR.LE.0) MONITR = 0
    IF(MONITR.GT.0) MONITR = 1
    MIN = 2
    !***** DEBUG
    !     IF(SIGMIN.GE.SIGLOW) GO TO 20
    IF(SIGMIN.GT.0.0D+0) GO TO 20
    !***** DEBUG
    SIGMIN = SIGLOW
    MIN = 1
    20 CALL OUT9(SIGMIN, FIELD(1, 1), 0)
    WRITE(OUTP, 270) MESS1(MODGET + 1), (FIELD(M, 1), M = 1, 11), &
            (MESS5(J, MIN), J = 1, 5), (MESS2(J, IMBACK + 1), J = 1, 9)
    WRITE(OUTP, 280) (MESS3(J, IMEDIT + 1), J = 1, 10), &
            (MESS4(J, MAKEPLUS + 1), J = 1, 9), &
            MESS6(MONITR + 1)
    WRITE(*, 270) MESS1(MODGET + 1), (FIELD(M, 1), M = 1, 11), &
            (MESS5(J, MIN), J = 1, 5), (MESS2(J, IMBACK + 1), J = 1, 9)
    WRITE(*, 280) (MESS3(J, IMEDIT + 1), J = 1, 10), &
            (MESS4(J, MAKEPLUS + 1), J = 1, 9), &
            MESS6(MONITR + 1)
    !-----PRINT WARNING MESSAGE IF OVERRIDE NOT TO ADD MISSING OR DUPLICATE
    !-----(L,S,J) SEQUENCES HAS BEEN TURNED ON.
    IF(MYPOT.EQ.0) WRITE(OUTP, 410)
    !
    !     READ FILENAMES - IF BLANK USE STANDARD FILENAMES
    !
    !-----INPUT DATA.
    READ(INP, 240) NAME1
    DO 30 I = 1, 60
        IF(NAME1(I).NE.BLANK) GO TO 50
    30 CONTINUE
    DO 40 I = 1, 8
    40 NAME1(I) = NAME3(I)
    !-----OUTPUT DATA.
    50 READ(INP, 240) NAME2
    DO 60 I = 1, 60
        IF(NAME2(I).NE.BLANK) GO TO 80
    60 CONTINUE
    DO 70 I = 1, 12
    70 NAME2(I) = NAME4(I)
    80 WRITE(OUTP, 290) NAME1, NAME2
    WRITE(*, 290) NAME1, NAME2
    !
    !     OPEN ENDF/B DATA FILES
    !
    CALL FILIO2
    !-----READ SELECTION RANGES (EITHER MAT OR ZA). IF MAXIMUM IS LESS
    !-----THAN MINIMUM SET IT EQUAL TO MINIMUM.
    IF(MODGET.EQ.0) WRITE(OUTP, 300)
    IF(MODGET.EQ.1) WRITE(OUTP, 310)
    IF(MODGET.EQ.0) WRITE(*, 300)
    IF(MODGET.EQ.1) WRITE(*, 310)
    READ(INP, 250) MATMIN(1), MATMAX(1), ((FIELD(KK, KKK), KK = 1, 11), &
            KKK = 1, 2)
    !-----CONVERT ENERGY RANGE TO PROCESS FROM CHARACTERS TO FLOATING POINT.
    CALL IN9(EPART1, FIELD(1, 1))
    CALL IN9(EPART2, FIELD(1, 2))
    !-----DEFINE WHETHER ALL OR A PORTION OF THE RESONANCE REGION WILL BE
    !-----PROCESSED.
    NPART = 0
    IF(EPART1.GT.0.0) NPART = 1
    IF(EPART2.GT.0.0) NPART = 2
    IF(EPART2.LE.0.0) EPART2 = EPMAX
    !-----IF NO MAT/ZA RANGE USE STANDARD OPTION = ALL.
    IF(MATMIN(1).GT.0.OR.MATMAX(1).GT.0) GO TO 90
    MATMAX(1) = 9999
    MODGET = 0
    NMATZA = 2
    WRITE(OUTP, 330) MATMIN(1), MATMAX(1)
    WRITE(*, 330) MATMIN(1), MATMAX(1)
    !-----PRINT WARNING IF ONLY A PORTION OF RESONANCE REGION WILL BE
    !-----PROCESSED.
    IF(NPART.LE.0) GO TO 120
    CALL OUT9(EPART1, FIELD(1, 1), 3)
    CALL OUT9(EPART2, FIELD(1, 2), 3)
    WRITE(OUTP, 420) ((FIELD(M, KK), M = 1, 11), KK = 1, 2)
    WRITE(*, 420) ((FIELD(M, KK), M = 1, 11), KK = 1, 2)
    GO TO 120
    90 IF(MATMAX(1).LT.MATMIN(1)) MATMAX(1) = MATMIN(1)
    WRITE(OUTP, 320) MATMIN(1), MATMAX(1)
    WRITE(*, 320) MATMIN(1), MATMAX(1)
    !-----PRINT WARNING IF ONLY A PORTION OF RESONANCE REGION WILL BE
    !-----PROCESSED.
    IF(NPART.LE.0) GO TO 100
    CALL OUT9(EPART1, FIELD(1, 1), 3)
    CALL OUT9(EPART2, FIELD(1, 2), 3)
    WRITE(OUTP, 420) ((FIELD(M, KK), M = 1, 11), KK = 1, 2)
    WRITE(*, 420) ((FIELD(M, KK), M = 1, 11), KK = 1, 2)
    !-----PROCESS REMAINING DATA REQUESTS.
    100 DO 110 NMATZA = 2, 101
        READ(INP, 250) MATMIN(NMATZA), MATMAX(NMATZA)
        IF(MATMIN(NMATZA).LE.0.AND.MATMAX(NMATZA).LE.0) GO TO 120
        IF(MATMAX(NMATZA).LT.MATMIN(NMATZA)) MATMAX(NMATZA) = MATMIN(NMATZA)
        WRITE(OUTP, 320) MATMIN(NMATZA), MATMAX(NMATZA)
        WRITE(*, 320) MATMIN(NMATZA), MATMAX(NMATZA)
    110 CONTINUE
    GO TO 190
    !
    !     READ AND PRINT FILE 2 ERROR LAW. ERROR MUST BE POSITIVE AND
    !     ENERGIES MUST BE IN ASCENDING ORDER. IF ERROR IS ZERO SET TO
    !     STANDARD OPTION. ERROR LAW IS TERMINATED BY BLANK LINE. IF
    !     FIRST LINE IS BLANK TERMINATE ERROR LAW AND SET ERROR TO
    !     ENERGY INDEPENDENT STANDARD OPTION (CURRENTLY 0.1 PER-CENT).
    !
    120 NMATZA = NMATZA - 1
    READ(INP, 260) ENER2(1), ER2(1)
    IF(ENER2(1).LT.0.0) ENER2(1) = 0.0
    CALL OUT9(ENER2(1), FIELD(1, 1), 3)
    IF(ER2(1).GT.0.0) GO TO 130
    ER2(1) = ERRMIN
    PERCNT = 100.0 * ERRMIN
    CALL OUT9(ER2(1), FIELD(1, 2), 0)
    WRITE(OUTP, 360) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
    WRITE(*, 360) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
    IF(ENER2(1).GT.0.0) GO TO 140
    MAXER2 = 2
    GO TO 180
    130 PERCNT = 100.0 * ER2(1)
    CALL OUT9(ER2(1), FIELD(1, 2), 0)
    WRITE(OUTP, 350) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
    WRITE(*, 350) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
    140 DO 170 MAXER2 = 2, 21
        READ(INP, 260) ENER2(MAXER2), ER2(MAXER2)
        IF(ENER2(MAXER2).LE.0.0.AND.ER2(MAXER2).LE.0.0) GO TO 180
        CALL OUT9(ENER2(MAXER2), FIELD(1, 1), 3)
        IF(ER2(MAXER2).LE.0.0) GO TO 150
        PERCNT = 100.0 * ER2(MAXER2)
        CALL OUT9(ER2(MAXER2), FIELD(1, 2), 0)
        WRITE(OUTP, 370) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
        WRITE(*, 370) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
        GO TO 160
        150 ER2(MAXER2) = ERRMIN
        PERCNT = 100.0 * ERRMIN
        CALL OUT9(ER2(MAXER2), FIELD(1, 2), 0)
        WRITE(OUTP, 380) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
        WRITE(*, 380) ((FIELD(M, I), M = 1, 11), I = 1, 2), PERCNT
        160 IF(ENER2(MAXER2).LT.ENER2(MAXER2 - 1)) GO TO 220
    170 CONTINUE
    GO TO 210
    !-----INITIALIZE FILE 2 RECONSTRUCTION LAW INDICES AND ALLOWABLE ERROR.
    180 MAXER2 = MAXER2 - 1
    ERRXC2 = ER2(1)
    ERXC20 = 0.10 * ERRXC2
    RETURN
    !
    !     ERROR MESSAGE SECTION. PRINT ERROR MESSAGE AND TERMINATE.
    !
    !-----OVER 100 MAT OR ZA RANGES.
    190 WRITE(OUTP, 340)
    WRITE(*, 340)
    200 CALL ENDIT
    !-----OVER 20 ENTRIES IN ERROR LAW.
    210 WRITE(OUTP, 390)
    WRITE(*, 390)
    GO TO 200
    !-----ERROR LAW ENERGIES NOT IN ASCENDING ORDER.
    220 WRITE(OUTP, 400)
    WRITE(*, 400)
    GO TO 200
    230 FORMAT(I11, E11.4, 2I11, I11, I11)
    240 FORMAT(60A1)
    250 FORMAT(2I11, 22A1)
    260 FORMAT(2E11.4)
    270 FORMAT(&
            ' Retrieval Criteria-----------', 7X, A4/&
            ' File 2 Mimimum Cross Section-', 11A1, 1X, 5A4/&
            ' Reactions with No Background-', 9A4)
    280 FORMAT(&
            ' Calculate/Edit Mode----------', 1X, 10A4/&
            ' Negative Cross Sections------', 1X, 9A4/&
            ' Monitor Mode-----------------', 7X, A4)
    290 FORMAT(1X, 78('=')/&
            ' ENDF/B Input and Output Data Filenames'/1X, 60A1/&
            1X, 60A1)
    300 FORMAT(1X, 78('=')/' Requested MAT Ranges'/1X, 78('=')/&
            4X, 'Mimimum', 4X, 'Maximum'/1X, 78('='))
    310 FORMAT(1X, 78('=')/' Requested ZA Ranges'/1X, 78('=')/&
            4X, 'Mimimum', 4X, 'Maximum'/1X, 78('='))
    320 FORMAT(2I11)
    330 FORMAT(2I11, ' (Default Option)')
    340 FORMAT(' Over 100 Ranges----Execution Terminated')
    350 FORMAT(1X, 78('=')/' Allowable Uncertainty'/1X, 78('=')/&
            6X, 'Energy', ' Uncertainty', 3X, 'per-cent'/1X, 78('=')/&
            1X, 11A1, 1X, 11A1, F11.3)
    360 FORMAT(1X, 78('=')/' File 2 Reconstruction Error'/1X, 78('=')/&
            6X, 'Energy', 6X, 'Error', 3X, 'per-cent'/1X, 78('=')/&
            1X, 11A1, 1X, 11A1, F11.3, ' (Default Option)')
    370 FORMAT(1X, 11A1, 1X, 11A1, F11.3)
    380 FORMAT(1X, 11A1, 1X, 11A1, F11.3, ' (Default Option)')
    390 FORMAT(' Over 20 Ranges----Execution Terminated')
    400 FORMAT(' Energies MUST be in Ascending Order----', &
            'Execution Terminated')
    410 FORMAT(1X, 78('=')/&
            ' WARNING - You Have Turned on the Override NOT to Add Missing'/&
            ' or Duplicate (L,S,J) Sequences to Account for their Potential'/&
            ' Contribution. This is NOT Recommended, Based on the Decision'/&
            ' of the National Nuclear Data Center, Brookhaven National Lab,'/&
            ' Private Communication, Charles Dunford, (April 1991)'/&
            1X, 78('='))
    420 FORMAT(1X, 78('=')/&
            ' WARNING - You Have Turned on the Override to ONLY Process a'/&
            ' Portion of the Resonance Region ', 11A1, ' to ', 11A1, ' eV.'/&
            1X, 78('='))
END
SUBROUTINE NXTMAT
    !=======================================================================
    !
    !     FIND NEXT REQUESTED MATERIAL BASED EITHER ON ZA OR MAT.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 ZABCD
    CHARACTER*4 FMT5, FMTHOL
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/MATZA/MODGET, NMATZA, MATMIN(101), MATMAX(101)
    COMMON/HEADER/C1H, C2H, L1H, L2H, N1H, N2H, MATH, MFH, MTH, NOSEQ
    COMMON/WHATZA/IZANOW, MATNOW, TEMP3, IVERSE, INT45
    COMMON/HOLFMT/FMTHOL, ZABCD(10)
    DIMENSION IZAMIN(101), IZAMAX(101)
    EQUIVALENCE (MATMIN(1), IZAMIN(1)), (MATMAX(1), IZAMAX(1))
    DATA FMT5/' V'/
    !-----READ NEXT LINE AND CHECK FOR END OF ENDF/B TAPE.
    10 CALL CONTI
    IF(MTH) 20, 20, 30
    20 IF(MATH) 90, 10, 10
    !-----DEFINE FIXED POINT ZA.
    30 IZANOW = C1H
    !-----COMPARE MAT OR ZA TO SELECTION CRITERIA.
    IMHIGH = 0
    DO 80 IMATZA = 1, NMATZA
        IF(MODGET.NE.0) GO TO 50
        IF(MATH - MATMIN(IMATZA)) 70, 100, 40
        40 IF(MATH - MATMAX(IMATZA)) 100, 100, 80
        50 IF(IZANOW - IZAMIN(IMATZA)) 70, 100, 60
        60 IF(IZANOW - IZAMAX(IMATZA)) 100, 100, 70
        70 IMHIGH = 1
    80 CONTINUE
    !-----THIS MATERIAL HAS NOT BEEN REQUESTED. IF BEYOND RANGE OF ALL
    !-----REQUESTS RUN IF COMPLETED. IF NOT SKIP TO NEXT MATERIAL.
    IF(IMHIGH.LE.0) GO TO 90
    !-----SKIP TO MATERIAL END (MEND) LINE.
    CALL SKIPM
    GO TO 10
    !-----END OF RUN. RETURN NEGATIVE MATH AS INDICATOR. OUTPUT TAPE END
    !-----(TEND) RECORD.
    90 MATH = -1
    MFH = 0
    MTH = 0
    CALL OUTT
    WRITE(OUTP, 120)
    WRITE(*, 120)
    RETURN
    !-----THIS MATERIAL REQUESTED. INITIALIZE OUTPUT SEQUENCE NUMBER,
    !-----ENDF/B FORMAT VERSION NUMBER, ASSUME ENDF/B-VI FORMAT AND
    !-----INITIALIZE FILE 3 TEMPERATURE TO ZERO (IF MF=1, MT-451 IS
    !-----PRESENT THE ENDF/B VERSION NUMBER WILL BE RE-DEFINED BASED
    !-----ON THE FORMAT OF MF=1, MT=451).
    100 NOSEQ = 1
    MATNOW = MATH
    FMTHOL = FMT5
    IVERSE = 6
    TEMP3 = 0.0
    INT45 = 2
    !-----DEFINE BCD EQUIVALENT OF ZA.
    CALL ZAHOL(IZANOW, ZABCD)
    !-----IDENTIFY MAT BEING PROCESSED.
    WRITE(OUTP, 110) ZABCD, MATNOW
    WRITE(*, 110) ZABCD, MATNOW
    RETURN
    110 FORMAT(1X, 78('*')/' Processing ', 10A1, ' MAT=', I5/&
            1X, 78('*'))
    120 FORMAT(1X, 78('*')/' End of ENDF/B Input Data'/1X, 78('*'))
END
SUBROUTINE FILE1(IMDONE)
    !=======================================================================
    !
    !     ADD COMMENTS AT THE END OF FILE 1, SECTION 451 TO INDICATE
    !     THAT THIS MATERIAL HAS BEEN PROCESSED BY PROGRAM RECENT AND
    !     TO SPECIFY THE MAXIMUM ALLOWABLE ERROR.
    !
    !     DEFINE FORMAT TO BE ENDF/B-IV, V OR VI.
    !
    !     THE ENDF/B FORMAT CAN BE DETERMINED FROM THE SECOND LINE.
    !     ENDF/B-IV = N1 > 0, N2 = 0,LINE COUNT (POSITIVE)
    !     ENDF/B-V  = N1 = N2 =0
    !     ENDF/B-VI =      N2 = VERSION NUMBER (6 OR MORE)
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 ZABCD, FIELD, PROGDOC1
    CHARACTER*4 FMTHOL, FMTTAB
    CHARACTER*66 PROGDOC
    COMMON/HEADER/C1H, C2H, L1H, L2H, N1H, N2H, MATH, MFH, MTH, NOSEQ
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/MINSIG/SIGMIN
    COMMON/OKERR2/ERRXC2, ERXC20, ENER2(21), ER2(21), MAXER2
    COMMON/WHATZA/IZANOW, MATNOW, TEMP3, IVERSE, INT45
    COMMON/HOLFMT/FMTHOL, ZABCD(10)
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/PARTN/EPART1, EPART2, NPART
    COMMON/FIELDC/FIELD(11, 12)
    DIMENSION FMTTAB(3), PROGDOC(9), PROGDOC1(66, 9)
    EQUIVALENCE (PROGDOC(1), PROGDOC1(1, 1))
    DATA FMTTAB/'IV', ' V', 'VI'/
    !-----DOCUMENTATION TO ADD TO ENDF/B OUTPUT - EACH LINE IS 66
    !-----CHARACTERS LONG - FIELDS 12345678901 ARE FILLED IN WITH
    !-----11 CHARACTERS DURING EXECUTION.
    !               1         2         3         4         5         6
    !       12345678901234567890123456789012345678901234567890123456789012
    !       3456
    DATA PROGDOC/&
            ' ***************** Program RECENT (VERSION 2000-1) ***********', &
            ' Only Process12345678901 to12345678901 eV                     ', &
            ' for All Data Greater than12345678901 barns in Absolute Value ', &
            ' Data Linearized to within an Accuracy of12345678901 per-cent ', &
            ' Data Linearized Using Energy Dependent Uncertainty           ', &
            '      Energy    Accuracy                                      ', &
            '        (eV)  (per-cent)                                      ', &
            ' ----------- -----------                                      ', &
            ' 12345678901 12345678901                                      '/
    !-----FILL IN REMAINDER OF FIRST LINE
    PROGDOC1(63, 1) = '*'
    PROGDOC1(64, 1) = '*'
    PROGDOC1(65, 1) = '*'
    PROGDOC1(66, 1) = '*'
    !-----INITIALIZE MAT ALREADY PROCESSED FLAG TO OFF.
    IMDONE = 1
    !-----SAVE FLAGS WHICH INDICATES WHETHER OR NOT MAT IS FISSIONABLE AND
    !-----IF RESONANCE PARAMETERS ARE PRESENT.
    LRP = L1H
    LFI = L2H
    !-----HEAD LINE OF SECTION HAS BEEN READ. READ SECOND LINE AND TEST
    !-----FOR ENDF/B-IV FORMAT.
    CALL CARDI(C1A, C2A, L1A, L2A, N1A, N2A)
    !-----IV N1 > 0, N2 = 0
    IF(N1A.LE.0.OR.N2A.NE.0) GO TO 40
    !
    !     ENDF/B-IV FORMAT. UPDATE NUMBER OF COMMENT CARDS AND OUTPUT
    !     TWO CARDS SET FLAGS FOR ENDF/B-IV FORMAT.
    !
    !-----IF THERE ARE RESONANCE PARAMETERS AND THEIR CONTRIBUTION HAS NOT
    !-----BEEN ADDED TO THE BACKGROUND SET LRP TO INDICATE THAT IT HAS NOW
    !-----BEEN ADDED. ONLY ADD COMMENT CARDS IF MAT WILL BE PROCESSED.
    IF(LRP.NE.1) GO TO 20
    !-----DO NOT SET LRP IF ONLY PROCESSING A PORTION OF THE RESONANCE
    !-----REGION = ASSUME THAT THIS DATA WILL BE PROCESSED AGAIN.
    IF(NPART.NE.2) GO TO 10
    !-----ONLY ADD PROGRAM I.D. AND ENERGY RANGE PROCESSED.
    N1OUT = N1A + 2
    GO TO 30
    10 L1H = 2
    N1OUT = N1A + 3
    IF(NPART.NE.0) N1OUT = N1OUT + 1
    IF(MAXER2.GT.1) N1OUT = N1OUT + MAXER2 + 3
    GO TO 30
    20 N1OUT = N1A
    30 CALL CONTO
    CALL CARDO(C1A, C2A, L1A, L2A, N1OUT, N2A)
    N1X = N1A
    FMTHOL = FMTTAB(1)
    IVERSE = 4
    INT45 = 5
    GO TO 120
    !-----NOT ENDF/B-IV. READ THIRD LINE AND TEST FOR ENDF/B-V FORMAT.
    40 CALL CARDI(C1B, C2B, L1B, L2B, N1B, N2B)
    IF(N2A.GT.0) GO TO 80
    !
    !     ENDF/B-V FORMAT. UPDATE NUMBER OF COMMENT CARDS AND OUTPUT
    !     THREE CARDS AND SET FLAGS FOR ENDF/B=V FORMAT.
    !
    !-----IF THERE ARE RESONANCE PARAMETERS AND THEIR CONTRIBUTION HAS NOT
    !-----BEEN ADDED TO THE BACKGROUND SET LRP TO INDICATE THAT IT HAS NOW
    !-----BEEN ADDED. ONLY ADD COMMENT CARDS IF MAT WILL BE PROCESSED.
    IF(LRP.NE.1) GO TO 60
    !-----DO NOT SET LRP IF ONLY PROCESSING A PORTION OF THE RESONANCE
    !-----REGION = ASSUME THAT THIS DATA WILL BE PROCESSED AGAIN.
    IF(NPART.NE.2) GO TO 50
    !-----ONLY ADD PROGRAM I.D. AND ENERGY RANGE PROCESSED.
    N1OUT = N1B + 2
    GO TO 70
    50 L1H = 2
    N1OUT = N1B + 3
    IF(NPART.NE.0) N1OUT = N1OUT + 1
    IF(MAXER2.GT.1) N1OUT = N1OUT + MAXER2 + 3
    GO TO 70
    60 N1OUT = N1B
    70 CALL CONTO
    CALL CARDO(C1A, C2A, L1A, L2A, N1A, N2A)
    CALL CARDO(C1B, C2B, L1B, L2B, N1OUT, N2B)
    N1X = N1B
    FMTHOL = FMTTAB(2)
    IVERSE = 5
    INT45 = 2
    GO TO 120
    !
    !     ENDF/B-VI FORMAT. UPDATE NUMBER OF COMMENT CARDS AND OUTPUT
    !     THREE CARDS AND SET FLAGS FOR ENDF/B=VI FORMAT.
    !
    !-----READ FOURTH LINE.
    80 CALL CARDI(C1C, C2C, L1C, L2C, N1C, N2C)
    !-----IF THERE ARE RESONANCE PARAMETERS AND THEIR CONTRIBUTION HAS NOT
    !-----BEEN ADDED TO THE BACKGROUND SET LRP TO INDICATE THAT IT HAS NOW
    !-----BEEN ADDED. ONLY ADD COMMENT CARDS IF MAT WILL BE PROCESSED.
    IF(LRP.NE.1) GO TO 100
    !-----DO NOT SET LRP IF ONLY PROCESSING A PORTION OF THE RESONANCE
    !-----REGION = ASSUME THAT THIS DATA WILL BE PROCESSED AGAIN.
    IF(NPART.NE.2) GO TO 90
    !-----ONLY ADD PROGRAM I.D. AND ENERGY RANGE PROCESSED.
    N1OUT = N1C + 2
    GO TO 110
    90 L1H = 2
    N1OUT = N1C + 3
    IF(NPART.NE.0) N1OUT = N1OUT + 1
    IF(MAXER2.GT.1) N1OUT = N1OUT + MAXER2 + 3
    GO TO 110
    100 N1OUT = N1C
    110 CALL CONTO
    CALL CARDO(C1A, C2A, L1A, L2A, N1A, N2A)
    CALL CARDO(C1B, C2B, L1B, L2B, N1B, N2B)
    N1X = N1C
    FMTHOL = FMTTAB(3)
    IVERSE = 6
    INT45 = 2
    TEMP3 = C1C
    INPART = N1B / 10
    !-----SET DERIVED MATERIAL FLAG.
    IF(NPART.NE.2) L1C = 1
    CALL CARDO(C1C, C2C, L1C, L2C, N1OUT, N2C)
    !-----IF NO RESONANCE PARAMETERS OR THERE CONTRIBUTION HAS ALREADY BEEN
    !-----ADDED TO THE BACKGROUND COPY MAT. OTHERWISE INSERT COMMENTS.
    120 IF(LRP.NE.1) GO TO 170
    !
    !     SKIP OUTPUT IF IN EDIT (I.E. NO OUTPUT) MODE.
    !
    IF(OTAPE.LE.0) GO TO 180
    !-----COPY TO END OF HOLLERITH.
    DO 130 N = 1, N1X
    130 CALL COPY1
    !
    !     ADD COMMENTS TO DOCUMENT WHAT WAS DONE TO DATA
    !
    !-----OUTPUT PROGRAM VERSION I.D.
    CALL HOLLYO(PROGDOC1(1, 1))
    !-----IF ONLY PROCESSING A PORTION OF THE ENERGY RANGE, DEFINE IT.
    IF(NPART.LE.0) GO TO 140
    CALL OUT9(EPART1, PROGDOC1(14, 2), 3)
    CALL OUT9(EPART2, PROGDOC1(28, 2), 3)
    CALL HOLLYO(PROGDOC1(1, 2))
    !-----IF NOT THE END OF THE RESONANCE REGION CALCULATIONS SKIP
    !-----REMAINDER = ASSUME DATA WILL BE PROCESSED AGAIN.
    IF(NPART.EQ.2) GO TO 180
    !
    !     DESCRIBE RESONANCE RECONSTRUCTION CRITERIA.
    !
    !-----OUTPUT MINIMUM CROSS SECTION
    140 CALL OUT9(SIGMIN, PROGDOC1(27, 3), 0)
    CALL HOLLYO(PROGDOC1(1, 3))
    IF(MAXER2.GT.1) GO TO 150
    !-----OUTPUT ENERGY INDEPENDENT ERROR USED FOR RECONSTRCUTION.
    PERCNT = 100.0 * ER2(1)
    CALL OUT9(PERCNT, PROGDOC1(42, 4), 3)
    CALL HOLLYO(PROGDOC1(1, 4))
    GO TO 180
    !-----OUTPUT 4 LINE TITLE
    150 CALL HOLLYO(PROGDOC1(1, 5))
    CALL HOLLYO(PROGDOC1(1, 6))
    CALL HOLLYO(PROGDOC1(1, 7))
    CALL HOLLYO(PROGDOC1(1, 8))
    DO 160 I = 1, MAXER2
        PERCNT = 100.0 * ER2(I)
        CALL OUT9(ENER2(I), PROGDOC1(2, 9), 3)
        CALL OUT9(PERCNT, PROGDOC1(14, 9), 3)
    160 CALL HOLLYO(PROGDOC1(1, 9))
    GO TO 180
    !
    !     END OF HOLLERITH OUTPUT TO FILE1
    !
    !-----INDICATE THAT MAT NEED NOT BE PROCESSED (EITHER NO PARAMETERS OR
    !-----THEIR CONTRIBUTION HAS ALREADY BEEN ADDED TO THE BACKGROUND).
    170 IMDONE = 0
    !-----IDENTIFY ENDF/B FORMAT.
    180 WRITE(OUTP, 200) FMTHOL
    WRITE(*, 200) FMTHOL
    !-----DEFINE WHETHER OR NOT MATERIAL IS FISSILE.
    IF(LFI.EQ.0) WRITE(OUTP, 210)
    IF(LFI.GT.0) WRITE(OUTP, 220)
    IF(LFI.EQ.0) WRITE(*, 210)
    IF(LFI.GT.0) WRITE(*, 220)
    !-----DEFINE WHETHER OR NOT THERE ARE RESONANCE PARAMETERS AND WHETHER
    !-----THERE CONTRIBUTION HAS ALREADY BEEN ADDED TO THE BACKGROUND CROSS
    !-----SECTION.
    IF(LRP.EQ.0) WRITE(OUTP, 230)
    IF(LRP.EQ.1) WRITE(OUTP, 240)
    IF(LRP.EQ.2.AND.IMEDIT.NE.2) WRITE(OUTP, 250)
    IF(LRP.EQ.2.AND.IMEDIT.EQ.2) WRITE(OUTP, 260)
    IF(LRP.EQ.0) WRITE(*, 230)
    IF(LRP.EQ.1) WRITE(*, 240)
    IF(LRP.EQ.2.AND.IMEDIT.NE.2) WRITE(*, 250)
    IF(LRP.EQ.2.AND.IMEDIT.EQ.2) WRITE(*, 260)
    !-----FOR ENDF/B-VI FORMATTED DATA DEFINE PROJECTILE AND BACKGROUND
    !-----TEMPERATURE.
    IF(IVERSE.NE.6) GO TO 190
    IF(INPART.EQ.1) WRITE(OUTP, 270) INPART
    IF(INPART.NE.1) WRITE(OUTP, 280) INPART
    CALL OUT9(TEMP3, FIELD(1, 1), 0)
    WRITE(OUTP, 290) (FIELD(M, 1), M = 1, 11)
    190 RETURN
    200 FORMAT(' Based on the Format and Contents of MF=1, MT=451'/&
            ' (1) ENDF/B-', A2, ' Format.')
    210 FORMAT(' (2) Material is NOT Fissile (LFI=0).')
    220 FORMAT(' (2) Material is Fissile (LFI=1).')
    230 FORMAT(' (3) No Resonance Parameters Given (LRP=0).', &
            ' MAT Copied.')
    240 FORMAT(' (3) Resonance Parameters are Given (LRP=1).')
    250 FORMAT(' (3) Resonance Data Already Added to Background Cross'/&
            '     Section (LRP=2). MAT Copied.')
    260 FORMAT(' (3) Resonance Data Already Added to Background Cross'/&
            '     Section (LRP=2).')
    270 FORMAT(' (4) Projectile ZA =', I7, ' (Neutron).')
    280 FORMAT(' (4) Projectile ZA =', I7, ' (Expect Neutron = 1).')
    290 FORMAT(' (5) Temperature of Background ', 11A1, ' Kelvin.')
END
SUBROUTINE FILE2
    !=======================================================================
    !
    !     READ ALL FILE2 DATA AND PROCESS INTO POINTWISE FORM.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    CHARACTER*1 FIELD
    INTEGER OUTP, OTAPE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/UNITS/ISCR2, ISCR23
    COMMON/SUBS/ESUB(217), ENODP, ENODM, WIDP, WIDM, ISUB, NSUB
    COMMON/PAGER/NPAGE, NPAGP1, NPAGM1
    COMMON/POINTN/NPOINT, KPOINT
    COMMON/OKERR2/ERRXC2, ERXC20, ENER2(21), ER2(21), MAXER2
    COMMON/MINSIG/SIGMIN
    COMMON/MINNIE/EMIN, EMAX, DEMIN
    COMMON/EDGES/ERANGE(50), NODLOW(50), NODHI(50), NRANGE, IRANGE
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/COM5/ESAVE(200), SIGSAV(4, 200)
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION SIGMID(4), ETAB2X(120000), SIG2X(4, 120000)
    EQUIVALENCE (ETAB2(1), ETAB2X(1)), (SIG2(1, 1), SIG2X(1, 1))
    DATA IUSE2/0/
    DATA TINY/1.0D-09/
    PARAMETER (NEGRID = 14)
    DIMENSION EGRID(NEGRID)
    !CHO
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    DATA EGRID/&
            1.0D-5, 1.0D-4, 1.0D-3, 1.0D-2, 2.53D-2, 1.0D-1, 1.0D+0, 1.0D+1, 1.0D+2, &
            1.0D+3, 1.0D+4, 1.0D+5, 1.0D+6, 1.0D+7/
    DIMENSION ENERES(120000), TWIDTH(120000)
    !CHO
    !-----READ ALL FILE 2 PARAMETERS.
    CALL READ2
    !-----INITIALIZE POINT COUNTS
    !-----NPOINT = NUMBER OF POINTS ON SCRATCH. POINT TOTAL AT END.
    !-----KPOINT = NUMBER OF POINTS IN CORE (0 TO 120000).
    !-----KPTP1  = INDEX TO POSITION INTO WHICH NEXT POINT WILL BE STORED.
    !-----NBASE  = NUMBER OF POINTS GENERATED UP TO END OF LAST ENERGY.
    !-----RANGE).
    NPOINT = 0
    KPOINT = 0
    KPTP1 = 1
    NBASE = 0
    !-----IF THERE ARE NO SECTIONS WHOSE RESONANCE CONTRIBUTION MUST BE
    !-----ADDED TO BACKGROUND CROSS SECTION THERE IS NOTHING ELSE TO DO.
    IF(NSECT.GT.0) GO TO 10
    WRITE(OUTP, 390)
    WRITE(*, 390)
    GO TO 320
    !-----IF IN EDIT MODE RETURN AFTER READING ALL FILE 2 DATA.
    10 IF(IMEDIT.EQ.2) GO TO 320
    !
    !     CALCULATE RESONANCE CONTRIBUTION TO CROSS SECTION.
    !
    WRITE(OUTP, 380)
    WRITE(*, 380)
    !-----DEFINE THE NUMBER OF REACTIONS TO CONSIDER (3 IF NO FISSION,
    !-----4 IF FISSION - BASED ON READING FISSION WIDTHS).
    NREACT = 3
    IF(LFWX.GT.0) NREACT = 4
    !-----INITIALIZE SAVED POINT COUNT.
    NSAVE = 0
    !
    !     SET UP LOOP OVER ENERGY RANGES (E.G. RESOLVED AND UNRESOLVED)
    !
    DO 310 IRANGE = 2, NRANGE
        IRM1 = IRANGE - 1
        !-----INITIALIZE FLAG TO DEFINE TYPE OF RANGE (RESOLVED, UNRESOLVED
        !-----OR BOTH).
        IR = 0
        IU = 0
        !-----DEFINE WHICH SECTIONS CONTRIBUTE TO THIS ENERGY RANGE.
        DO 30 I = 1, NSECT
            IF(EL(I).LT.ERANGE(IRANGE).AND.EH(I).GT.ERANGE(IRM1)) GO TO 20
            !-----TURN OFF SECTION.
            MODE(I) = -IABS(MODE(I))
            GO TO 30
            !-----TURN ON SECTION.
            20 MODE(I) = IABS(MODE(I))
            !-----DETERMINE TYPE OF RESONANCE REGION (I.E. RESOLVED, UNRESOLVED,
            !-----BOTH OR NONE).
            IF(MODE(I).LT.8) IR = 1
            IF(MODE(I).GE.8) IU = 1
        30 CONTINUE
        !-----IDENTIFY TYPE OF ENERGY REGION.
        NREG = 1 + IR + 2 * IU
        !CHO
        !      DEFINE OUR OWN ENERGY GRID
        GO TO 7000
        !CHO
        !
        !     SET UP LOOP OVER ENERGY NODES IN CURRENT ENERGY RANGE.
        !
        !-----DEFINE WHICH NODES LIE IN THIS ENERGY RANGE AND SET UP LOOP OVER
        !-----NODES.
        NODE1 = NODLOW(IRANGE) + 1
        NODE2 = NODHI(IRANGE)
        DO 250 KNODE = NODE1, NODE2
            !-----DEFINE INTERVAL END POINTS.
            ENODM = ENODE(KNODE - 1)
            WIDM = WIDNOD(KNODE - 1)
            ENODP = ENODE(KNODE)
            WIDP = WIDNOD(KNODE)
            !-----DEFINE SUB-INTERVALS.
            CALL SUBINT
            !
            !     SPECIAL TREATMENT FOR FIRST ENERGY POINT. IF FIRST RESONANCE
            !     REGION STARTS ABOVE 1.0E-5 EV START TABLE AT LOWER LIMIT OF
            !     RESONANCE REGION WITH ONE POINT WITH ZERO CROSS SECTION FOLLOWED
            !     BY A POINT WITH THE SAME ENERGY AND THE CROSS SECTION CALCULATED
            !     AT THE LOWER LIMIT OF THE RESONANCE REGION. IF FIRST RESONANCE
            !     STARTS AT 1.0E-5 START TABLE WITH CROSS SECTION CALCULATED AT
            !     LOWER ENERGY LIMIT OF RESONANCE REGION.
            !
            IF(KPOINT.LE.0) GO TO 40
            !-----CALCULATE CROSS SECTION AT FIRST POINT OF EACH ENERGY REGION.
            IF(KNODE - NODE1) 60, 60, 70
            !-----INITIALIZE CROSS SECTION TABLE TO ONE POINT WITH ZERO CROSS
            !-----SECTION AT THE BEGINNING OF THE TABLE UNLESS THE TABLE STARTS
            !-----AT 1.0-5 EV OR LESS (IN WHICH CASE TABLE WILL START WITH NON-ZERO
            !-----CROSS SECTIONS).
            40 IF(ERANGE(1).LE.1.001 * EMIN) GO TO 60
            KPOINT = 1
            KPTP1 = 2
            ETAB2(1) = ERANGE(1)
            DO 50 IR = 1, NREACT
            50 SIG2(IR, 1) = 0.0
            !-----INITIALIZE INDEX TO FIRST SUB-INTERVAL AND INDICATE THAT THE
            !-----THE SUB-INTERVAL HAS NOT YET BEEN SUB-DIVIDED.
            60 ISUB = 1
            !-----CALCULATE CROSS SECTION AT NEXT ENERGY (EITHER FIRST OR SECOND
            !-----ENERGY).
            ETAB2(KPTP1) = ESUB(1)
            CALL SIGMA(ETAB2(KPTP1), SIG2(1, KPTP1))
            !-----SAVE STARTING POINT (NO CONVERGENCE TESTS UNTIL SECOND POINT IS
            !-----GENERATED).
            GO TO 160
            !
            !     INTERNAL SUB-INTERVAL. SET UP LOOP OVER SUB-INTERVALS REMAINING
            !     SUB-INTERVALS (NOTE, AT THIS POINT THE ENERGY INTERVAL UP TO AND
            !     INCLUDING THE ENERGY OF THE FIRST SUB-INTERVAL (ISUB=1) HAS
            !     ALREADY BEEN CALCULATED, EITHER BY CALCULATING THE FIRST POINT
            !     OR AS THE LAST POINT OF THE PRECEDING ENERGY INTERVAL).
            !
            !-----INITIALIZE INDEX TO SECOND SUB-INTERVAL AND INDICATE THAT THE
            !-----SUB-INTERVAL HAS NOT YET BEEN SUB-DIVIDED.
            70 ISUB = 2
            !-----CALCULATE CROSS SECTION AT END OF SUB-INTERVAL.
            80 ETAB2(KPTP1) = ESUB(ISUB)
            CALL SIGMA(ETAB2(KPTP1), SIG2(1, KPTP1))
            !
            !     ITERATION AND CONVERGENCE TESTS.
            !
            !-----DEFINE ENERGY AT MIDPOINT AND TEST FOR CONVERGENCE BASED ON SHORT
            !-----ENERGY INTERVAL.
            90 EA = ETAB2(KPOINT)
            EB = ETAB2(KPTP1)
            EMID = HALF * (EA + EB)
            CALL CORE9(EMID, 3)
            IF(EMID.LE.EA.OR.EMID.GE.EB) GO TO 160
            IF((EMID - EA).LE.EA * TINY) GO TO 160
            !-----DEFINE CROSS SECTION AT MIDPOINT.
            CALL SIGMA(EMID, SIGMID)
            !-----IF AN ENERGY DEPENDENT ERROR LAW IS USED DEFINE ERROR AT EMID.
            100 IF(MAXER2.GT.1) CALL ERROK2(EMID)
            !-----DEFINE CONTRIBUTION OF EACH ENDPOINT TO MIDPOINT.
            DE = EB - EA
            WTA = (EB - EMID) / DE
            WTB = (EMID - EA) / DE
            !-----TEST EACH REACTION FOR CONVERGENCE. TO BE ACCEPTABLE ALL REACTIONS
            !-----MUST CONVERGE (I.E., IF EVEN ONE REACTION FAIL ONE CONVEREGENCE
            !-----TEST CONTINUE SUB-DIVIDING AND INTERATING TO CONVERGENCE).
            DO 130 IR = 1, NREACT
                !-----DEFINE EXACT END POINT CROSS SECTIONS.
                SIGA = SIG2(IR, KPOINT)
                SIGB = SIG2(IR, KPTP1)
                !-----CONVERGENCE IF CROSS SECTION AT BOTH ENDS OF INTERVAL ARE LESS
                !-----THAN MINIMUM CROSS SECTION OF INTEREST.
                IF(DABS(SIGA).LE.SIGMIN.AND.DABS(SIGB).LE.SIGMIN) GO TO 130
                !-----TO PREVENT INFINITE ITERATION TOWARD ZERO ONLY APPLY CHANGE TEST
                !-----IF CROSS SECTION AT BOTH ENDS OF INTERVAL ARE POSITIVE.
                IF(SIGA.LE.0.0.OR.SIGB.LE.0.0) GO TO 110
                !-----TEST FOR CROSS SECTION CHANGE.
                IF(SIGA.GT.1.4 * SIGB.OR.SIGB.GT.1.4 * SIGA) GO TO 140
                !-----DEFINE EXACT AND LINEARLY INTERPOLATED MID-POINT CROSS SECTIONS.
                110 SIGM = SIGMID(IR)
                SIGLIN = WTA * SIGA + WTB * SIGB
                !-----TEST FOR ITERATION TOWARD MINIMUM (MINIMUM IS INDICATED IF
                !-----THE EXACT CROSS SECTION AT THE MID-POINT IS LESS THAN THE
                !-----EXACT CROSS SECTION AT BOTH ENDS OF THE INTERVAL).
                IF(SIGM.GE.SIGA.OR.SIGM.GE.SIGB) GO TO 120
                !-----ITERATING TOWARD MINIMUM. USE MORE STRINGENT CONVERGENCE TEST.
                IF(DABS(SIGM - SIGLIN) - DABS(ERXC20 * SIGM)) 130, 130, 140
                !-----NORMAL CONVERGENCE TEST.
                120 IF(DABS(SIGM - SIGLIN) - DABS(ERRXC2 * SIGM)) 130, 130, 140
                !-----END OF CONVERGENCE TEST LOOP. REACTION HAS PASSED ALL TESTS AND
                !-----FOR THIS REACTION MID-POINT IS NOT REQUIRED.
            130 CONTINUE
            !-----CONVERGENCE FOR ALL REACTIONS. KEEP END POINT.
            GO TO 160
            !
            !     NO CONVERGENCE. SAVE VALUE FROM END OF INTERVAL AND SHORTEN
            !     INTERVAL.
            !
            140 IF(NSAVE.LT.200) NSAVE = NSAVE + 1
            ESAVE(NSAVE) = ETAB2(KPTP1)
            ETAB2(KPTP1) = EMID
            DO 150 IR = 1, NREACT
                SIGSAV(IR, NSAVE) = SIG2(IR, KPTP1)
            150 SIG2(IR, KPTP1) = SIGMID(IR)
            GO TO 90
            !
            !     CONVERGENCE.
            !
            !-----SAVE END OF INTERVAL BY INCREASING KPOINT BY ONE. IF IN CORE PAGE
            !-----IS FULL UNLOAD IT TO SCRATCH, MOVE LAST POINT TO TABLE BEGINNING
            !-----AND RE-INITIALIZE IN CORE POINT INDICES.
            160 IF(KPOINT.LT.NPAGE) GO TO 190
            IF(NPOINT.EQ.0.AND.IUSE2.GT.0) REWIND ISCR2
            WRITE(ISCR2) ETAB2X, SIG2X
            NPOINT = NPOINT + NPAGE
            !-----IF REQUESTED PRINT MESSAGE EVERYTIME A PAGE IS OUTPUT TO SCRATCH.
            IF(MONITR.EQ.0) GO TO 170
            CALL OUT9(ETAB2(1), FIELD(1, 1), 3)
            CALL OUT9(ETAB2(NPAGE), FIELD(1, 2), 3)
            WRITE(OUTP, 400) NPOINT, ((FIELD(M, I), M = 1, 11), I = 1, 2)
            WRITE(*, 400) NPOINT, ((FIELD(M, I), M = 1, 11), I = 1, 2)
            170 ETAB2(1) = ETAB2(NPAGP1)
            DO 180 IR = 1, NREACT
            180 SIG2(IR, 1) = SIG2(IR, NPAGP1)
            KPTP1 = 1
            190 KPOINT = KPTP1
            KPTP1 = KPOINT + 1
            !
            !     IF THERE ARE NO REMAINING SAVED POINTS THE CURRENT SUB-INTERVAL
            !     IS NOW FINISHED. IF THERE ARE REMAINING SAVED POINTS USE THEM
            !     TO DEFINE NEXT ITERATION INTERVAL.
            !
            IF(NSAVE - 1) 240, 200, 220
            !-----ONLY 1 POINT SAVED...USE IT TO DEFINE ENDPOINT AND BRANCH BACK
            !-----TO DEFINE MIDPOINT...THEN ITERATE.
            200 ETAB2(KPTP1) = ESAVE(1)
            DO 210 IR = 1, NREACT
            210 SIG2(IR, KPTP1) = SIGSAV(IR, 1)
            NSAVE = 0
            GO TO 90
            !-----MORE THAN 1 POINT SAVED...USE LAST 2 SAVED POINTS TO DEFINE
            !-----MIDPOINT AND ENDPOINT...THEN ITERATE.
            220 NSAVM1 = NSAVE - 1
            ETAB2(KPTP1) = ESAVE(NSAVM1)
            EMID = ESAVE(NSAVE)
            DO 230 IR = 1, NREACT
                SIG2(IR, KPTP1) = SIGSAV(IR, NSAVM1)
            230 SIGMID(IR) = SIGSAV(IR, NSAVE)
            NSAVE = NSAVE - 2
            !-----CONVERGENCE IF ENERGY INTERVAL IS TOO SMALL.
            EA = ETAB2(KPOINT)
            EB = ETAB2(KPTP1)
            IF((EMID - EA).LE.EA * TINY) GO TO 160
            !-----USE 3 CURRENTLY KNOWN POINTS TO TEST FOR CONVERGENCE.
            GO TO 100
            !
            !     END OF SUB-INTERVAL LOOP. CONTINUE UNTIL ALL SUB-INTERVALS HAVE
            !     BEEN USED.
            !
            240 ISUB = ISUB + 1
            IF(ISUB.LE.NSUB) GO TO 80
            !
            !     END OF NODE LOOP.
            !
        250 CONTINUE
        !
        !     END OF 1 RESONANCE REGION. IS THIS THE END OF THE ENTIRE RESONANCE
        !     REGION (E.G., RESOLVED AND UNRESOLVED).
        !
        IF(IRANGE.LT.NRANGE) GO TO 300
        !
        !     END OF ENTIRE RESONANCE REGION. ADD LAST POINT WITH ZERO CROSS
        !     SECTION AND LEAVE DATA IN CORE OR MOVE TO SCRATCH.
        !
        !-----IF IN CORE PAGE IS FULL UNLOAD IT TO SCRATCH.
        IF(KPOINT.LT.NPAGE) GO TO 270
        IF(NPOINT.LE.0.AND.IUSE2.GT.0) REWIND ISCR2
        WRITE(ISCR2) ETAB2X, SIG2X
        NPOINT = NPOINT + NPAGE
        !-----IF REQUESTED PRINT MESSAGE EVERYTIME A PAGE IS OUTPUT TO SCRATCH.
        IF(MONITR.EQ.0) GO TO 260
        CALL OUT9(ETAB2(1), FIELD(1, 1), 3)
        CALL OUT9(ETAB2(NPAGE), FIELD(1, 2), 3)
        WRITE(OUTP, 400) NPOINT, ((FIELD(M, I), M = 1, 11), I = 1, 2)
        WRITE(*, 400) NPOINT, ((FIELD(M, I), M = 1, 11), I = 1, 2)
        260 KPTP1 = 1
        270 KPOINT = KPTP1
        KPTP1 = KPOINT + 1
        ETAB2(KPOINT) = ERANGE(IRANGE)
        DO 280 IR = 1, NREACT
        280 SIG2(IR, KPOINT) = 0.0
        !-----DEFINE TOTAL POINT COUNT.
        NPOINT = NPOINT + KPOINT
        !-----ALL POINTS HAVE BEEN CALCULATED. LEAVE IN CORE OR SAVE ON SCRATCH.
        IF(NPOINT.LE.NPAGE) GO TO 290
        WRITE(ISCR2) ETAB2X, SIG2X
END FILE ISCR2
REWIND ISCR2
IUSE2 = 1
!-----IF REQUESTED PRINT MESSAGE EVERYTIME A PAGE IS OUTPUT TO SCRATCH.
IF(MONITR.EQ.0) GO TO 290
CALL OUT9(ETAB2(1), FIELD(1, 1), 3)
CALL OUT9(ETAB2(KPOINT), FIELD(1, 2), 3)
WRITE(OUTP, 400) NPOINT, ((FIELD(M, I), M = 1, 11), I = 1, 2)
WRITE(*, 400) NPOINT, ((FIELD(M, I), M = 1, 11), I = 1, 2)
!-----SET IN CORE POINT COUNT TO ZERO (NCOUNT IS NOW THE TOTAL POINT
!-----COUNT).
290 KPOINT = 0
!-----PRINT SUMMARY OF ENERGY RANGE.
300 NKPONT = NPOINT + KPOINT
NBASE = NKPONT - NBASE
!CHO
7000 CONTINUE
OPEN(8, FILE = 'ptanal.res', STATUS = 'UNKNOWN')
DO 8001 K = 1, 120000
    READ(8, '(E14.6,E14.6)', END = 8101) ENERES(K), TWIDTH(K)
8001 CONTINUE
8101 CLOSE(8)
NNNRES = K - 1
!     ADD PREDEFINED ENERGY VALUES INTO ENERGY GRID
DO 9101 K = 1, NEGRID
    IF (EGRID(K).GT.ERANGE(2)) GO TO 9102
    ETAB2(K) = EGRID(K)
9101 CONTINUE
9102 KPOINT = K - 1
IF (KPOINT.EQ.0) THEN
    PRINT *, 'STOP **ERROR** UPPER ENERGY LIMIT TOO SMALL'
    STOP
ENDIF
!     ADD THE UPPER ENERGY VALUE INTO ENERGY GRID
IF (ETAB2(KPOINT).NE.ERANGE(2)) THEN
    ETAB2(KPOINT + 1) = ERANGE(2)
    KPOINT = KPOINT + 1
ENDIF
!     ADD RESONACE ENERGY POINTS INTO ENERGY GRID
DO 9201 N = 1, NNNRES
    IF (ENERES(N).GE.ERANGE(2)) THEN
        IF (ENERES(N).EQ.ERANGE(2)) THEN
            ETAB2(KPOINT + 1) = ENERES(N) - TWIDTH(N)
            KPOINT = KPOINT + 1
        ENDIF
        GO TO 9301
    ENDIF
    IF (ENERES(N).LT.0) GO TO 9201
    DO 9202 K = 1, KPOINT
        IF (ENERES(N).EQ.ETAB2(K)) GO TO 9201
    9202  CONTINUE
    !     ADD RESONANCE PEAK ENERGY AND TWO ADDITIONAL POINTS
    ETAB2(KPOINT + 1) = ENERES(N)
    KPOINT = KPOINT + 1
    ETAB2(KPOINT + 1) = ENERES(N) - TWIDTH(N)
    KPOINT = KPOINT + 1
    ETAB2(KPOINT + 1) = ENERES(N) + TWIDTH(N)
    KPOINT = KPOINT + 1
9201 CONTINUE
!     SORT FINAL ENERGY GRID
9301 CALL SORTD(ETAB2, KPOINT)
!     IF THE DUPLICATE ENERGY POINTS EXIST, DELETE ONE OF THEM
!     GO TO 9501
K = 1
9401 IF (K.EQ.KPOINT) GO TO 9501
IF (ETAB2(K).EQ.ETAB2(K + 1)) THEN
    DO 9402 N = K, KPOINT - 1
        ETAB2(N) = ETAB2(N + 1)
    9402   CONTINUE
    KPOINT = KPOINT - 1
ELSE
    K = K + 1
ENDIF
GO TO 9401
9501 CONTINUE
DO 9801 K = 1, KPOINT
    !      SIGMA SHOULD BE CALLED FOR EACH ENERGY
    CALL SIGMA(ETAB2(K), SIG2(1, K))
9801 CONTINUE
NPOINT = KPOINT
NBASE = KPOINT
NKPONT = KPOINT
!CHO
CALL OUT9(ERANGE(IRM1), FIELD(1, 1), 3)
CALL OUT9(ERANGE(IRANGE), FIELD(1, 2), 3)
IF(NREG.EQ.1) WRITE(OUTP, 330)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
IF(NREG.EQ.2) WRITE(OUTP, 340)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
IF(NREG.EQ.3) WRITE(OUTP, 350)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
IF(NREG.EQ.4) WRITE(OUTP, 360)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
IF(NREG.EQ.1) WRITE(*, 330)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
IF(NREG.EQ.2) WRITE(*, 340)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
IF(NREG.EQ.3) WRITE(*, 350)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
IF(NREG.EQ.4) WRITE(*, 360)&
        ((FIELD(M, I), M = 1, 11), I = 1, 2), NBASE
NBASE = NKPONT
!-----END OF ENERGY RANGE LOOP.
310 CONTINUE
!
!     ALL CROSS SECTION POINTS HAVE NOW BEEN CALCULATED. PRINT SUMMARY
!     OF ENTIRE RESONANCE REGION.
!
!-----OUTPUT SUMMARY OF TOTAL NUMBER OF POINTS GENERATED.
WRITE(OUTP, 370) NPOINT
WRITE(*, 370) NPOINT
320 RETURN
330 FORMAT(2X, 22A1, I11, ' Not in Any Resonance Region'/&
        35X, ' (WARNING - Not Expected - Check Data)')
340 FORMAT(2X, 22A1, I11, ' Resolved')
350 FORMAT(2X, 22A1, I11, ' Unresolved')
360 FORMAT(2X, 22A1, I11, ' Overlapping Resolved/Unresolved'/&
        35X, ' (WARNING - This is Illegal in ENDF/B)')
370 FORMAT(1X, 78('=')/' Entire Resonance Region', I11, ' Points'/&
        1X, 78('='))
380 FORMAT(1X, 78('=')/' Reconstructing Cross Sections from', &
        ' Resonance Parameters'/1X, 78('=')/&
        '        E-Low     E-High   Points  ', &
        ' Type of Resonance Region'/&
        '        (eV)       (eV)   Generated', &
        ' Messages'/1X, 78('='))
390 FORMAT(1X, 78('=')/' No Resonance Contribution to Add to', &
        ' Background Cross Section. MAT Copied.')
400 FORMAT(25X, I10, 11A1, ' to', 11A1, ' eV Finished')
END
SUBROUTINE ERROK2(E)
    !=======================================================================
    !
    !     DEFINE ALLOWABLE ERROR FOR RECONSTRUCTION OF ENERGY DEPENDENT
    !     CROSS SECTIONS FROM FILE 2 RESONANCE PARAMETERS. THE ERROR LAW
    !     CAN BE ENERGY INDEPENDENT (CONSTANT) OR ENERGY DEPENDENT
    !     (GIVEN BY A LINEARLY INTERPOLABLE TABLE IN ENERGY VS. ERROR).
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/OKERR2/ERRXC2, ERXC20, ENER2(21), ER2(21), MAXER2
    !-----INITIALIZE INDEX TO INTERPOLATION TABLE.
    DATA MINER2/2/
    !-----INTERPOLATE TO FIND FIRST TABULATED ENERGY ABOVE E.
    IF(E - ENER2(1)) 100, 100, 10
    10 DO 20 NOWER2 = MINER2, MAXER2
        IF(E - ENER2(NOWER2)) 30, 90, 20
    20 CONTINUE
    !-----EXTEND ERROR AS CONSTANT ABOVE TABULATED RANGE.
    GO TO 110
    30 NOWER1 = NOWER2 - 1
    IF(E - ENER2(NOWER1)) 40, 80, 70
    40 DO 50 NOWER2 = 2, MAXER2
        IF(E - ENER2(NOWER2)) 60, 90, 50
    50 CONTINUE
    GO TO 110
    !-----DEFINE INDEX AND INTERPOLATE ERROR.
    60 NOWER1 = NOWER2 - 1
    70 ERRXC2 = ((ENER2(NOWER2) - E) * ER2(NOWER1) + &
            (E - ENER2(NOWER1)) * ER2(NOWER2)) / (ENER2(NOWER2) - ENER2(NOWER1))
    ERXC20 = 0.10 * ERRXC2
    MINER2 = NOWER2
    RETURN
    !-----EXACT MATCH TO TABULATED ENERGY. DEFINE INDEX AND ERROR.
    80 ERRXC2 = ER2(NOWER1)
    ERXC20 = 0.10 * ERRXC2
    MINER2 = NOWER1
    IF(MINER2.LE.1) MINER2 = 2
    RETURN
    !-----EXACT MATCH TO TABULATED ENERGY. DEFINE INDEX AND ERROR.
    90 ERRXC2 = ER2(NOWER2)
    ERXC20 = 0.10 * ERRXC2
    MINER2 = NOWER2
    RETURN
    !-----EXTEND ERROR AS CONSTANT BELOW TABULATED RANGE.
    100 ERRXC2 = ER2(1)
    ERXC20 = 0.10 * ERRXC2
    MINER2 = 2
    RETURN
    !-----EXTEND ERROR AS CONSTANT ABOVE TABULATED RANGE.
    110 ERRXC2 = ER2(MAXER2)
    ERXC20 = 0.10 * ERRXC2
    MINER2 = MAXER2
    RETURN
END
SUBROUTINE READ2
    !=======================================================================
    !
    !     READ ALL FILE2 DATA. DEFINE ENERGY RANGES AND ENERGY NODES WITHIN
    !     EACH ENERGY RANGE.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 ZABCDI, FIELD
    CHARACTER*4 FISLST, REGLST, RTYPE, UTYPE, HOLNRO, HOLNAP
    COMMON/WHATZA/IZANOW, MATNOW, TEMP3, IVERSE, INT45
    COMMON/HEADER/C1H, C2H, L1H, L2H, N1H, N2H, MATH, MFH, MTH, NOSEQ
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/TABRHO/ERHOTB(500), RHOTAB(500), APTAB(500), NRHO(200), &
            NBTRHO(200), INTRHO(200), INXRHO(4, 200), NUMRHO
    COMMON/NAPNRO/NRO, NAPS
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/ETABS/NODES
    COMMON/RANGER/LOW, LHI
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/INDATD/ELX, EHX
    COMMON/MINNIE/EMIN, EMAX, DEMIN
    COMMON/EDGES/ERANGE(50), NODLOW(50), NODHI(50), NRANGE, IRANGE
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/LRUNOW/LRUIN
    COMMON/PARTN/EPART1, EPART2, NPART
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION ZABCDI(10), FISLST(6, 3), REGLST(6, 4), RTYPE(7, 7), &
            UTYPE(7, 4), HOLNRO(6, 3), HOLNAP(6, 3)
    DATA FISLST/&
            ' (No', ' Fis', 'sion', ' Wid', 'ths)', '    ', &
            ' (Fi', 'ssio', 'n Wi', 'dths', ' Giv', 'en) ', &
            ' (ER', 'ROR-', 'MUST', ' be ', '0 or', '1)  ' /
    DATA REGLST/&
            ' (No', ' Par', 'amet', 'ers)', '    ', '    ', &
            ' (Re', 'solv', 'ed R', 'egio', 'n)  ', '    ', &
            ' (Un', 'reso', 'lved', ' Reg', 'ion)', '    ', &
            ' (ER', 'ROR-', 'See ', 'Belo', 'w)  ', '    '/
    DATA RTYPE/&
            ' (Si', 'ngle', ' Lev', 'el B', 'reit', '-Wig', 'ner)', &
            ' (Mu', 'lti-', 'Leve', 'l Br', 'eit-', 'Wign', 'er) ', &
            ' (Re', 'ich-', 'Moor', 'e)  ', '    ', '    ', '    ', &
            ' (Ad', 'ler-', 'Adle', 'r)  ', '    ', '    ', '    ', &
            ' (Ge', 'nera', 'l R-', 'Matr', 'ix) ', '    ', '    ', &
            ' (Hy', 'brid', ' R-F', 'unct', 'ion)', '    ', '    ', &
            ' (ER', 'ROR-', 'see ', 'Belo', 'w)  ', '    ', '    '/
    DATA UTYPE/&
            ' (Al', 'l En', 'ergy', ' Ind', 'epen', 'dent', ')   ', &
            ' (Fi', 'ssio', 'n En', 'ergy', ' Dep', 'ende', 'nt) ', &
            ' (Al', 'l En', 'ergy', ' Dep', 'ende', 'nt) ', '    ', &
            ' (ER', 'ROR-', 'see ', 'Belo', 'w)  ', '    ', '    '/
    DATA HOLNRO/&
            '(Ene', 'rgy ', 'Inde', 'pend', 'ent)', '    ', &
            '(Ene', 'rgy ', 'Depe', 'nden', 't)  ', '    ', &
            '(ERR', 'OR-M', 'UST ', 'be 0', ' or ', '1)  '/
    DATA HOLNAP/&
            '(Cal', 'cula', 'te) ', '    ', '    ', '    ', &
            '(= S', 'catt', 'erin', 'g Ra', 'dius', ')   ', &
            '(ERR', 'OR-M', 'UST ', 'be 0', ' to ', '2)  '/
    !-----DEFINE THERMAL ENERGY FOR INCLUSION AS A NODE IF THE RESONANCE
    !-----REGION SPANS THERMAL ENERGY.
    DATA ETHERM/2.53D-02/
    !-----DEFINE MINIMUM ENERGY OF RESONANCE REGION (ALLOWING FOR ROUNDOFF).
    EMINL = 0.999 * EMIN
    !-----FILE 2 FOUND. DEFINE ZA, AWR AND NIS (NUMBER OF ISOTOPES).
    ZA = C1H
    AWR = C2H
    NIS = N1H
    !-----INITIALIZE FISSILE FLAG OFF (INDICATES ALL FISSION WIDTHS READ SO
    !-----FAR ARE ZERO - IF THIS FLAG IS NOT RESET WHILE READING PARAMETERS
    !-----THE MAT WILL BE CONSIDERED TO BE NON-FISSILE AND FISSION CROSS
    !-----SECTIONS WILL NOT BE OUTPUT).
    LFWX = 0
    !-----PRINT ZA, ATOMIC WEIGHT AND NUMBER OF ISOTOPES.
    IZA = ZA
    CALL ZAHOL(IZA, ZABCDI)
    IF(IMEDIT.EQ.0) GO TO 10
    CALL OUT9(AWR, FIELD(1, 1), 0)
    WRITE(OUTP, 410) ZABCDI, (FIELD(M, 1), M = 1, 11), NIS
    WRITE(*, 410) ZABCDI, (FIELD(M, 1), M = 1, 11), NIS
    !
    !     INITIALIZE RESONANCE PARAMETER TABLE INDICES.
    !
    !-----INITIALIZE SECTION COUNT (A SECTION IS DATA FOR ONE ISOTOPE,
    !-----ENERGY RANGE AND L VALUE) AND THE NUMBER OF ENERGY RANGES WITH
    !-----ENERGY DEPENDENT SCATTERING RADIUS. INITIALIZE ALL SECTION
    !-----INDICES TO INDICATE NO ENERGY DEPENDENT SCATTERING RADIUS.
    10 NSECT = 0
    NUMRHO = 0
    DO 20 I = 1, 200
    20 NRHO(I) = 0
    !-----INITIALIZE COUNT OF ENERGY NODES.
    NODES = 0
    !-----INITIALIZE INDEX TO NEXT RESONANCE TO READ.
    LHI = 0
    !
    !     READ DATA FOR EACH ISOTOPE.
    !
    !-----INITIALIZE SUM OF FRACTIONAL ABUNDANCES.
    ABNSUM = 0.0
    DO 320 IS = 1, NIS
        !-----SAVE CURRENT LFWX FLAG AND SET LFWX=0 FOR EACH ISOTOPE.
        LFWK = LFWX
        LFWX = 0
        !-----DEFINE ISOTOPE ZA, ABUNDANCE, FLAG DEFINING WHETHER OR NOT FISSION
        !-----WIDTHS ARE GIVEN AND NUMBER OF ENERGY RANGES.
        CALL CARDIO(ZAI, ABN, L1, LFW, NER, N2)
        !-----INCREMENT SUM OF FRACTONAL ABUNDANCE.
        ABNSUM = ABNSUM + ABN
        IF(IMEDIT.EQ.0) GO TO 30
        IZAI = ZAI
        CALL ZAHOL(IZAI, ZABCDI)
        LFWO = LFW + 1
        IF(LFW.NE.0.AND.LFW.NE.1) LFWO = 3
        CALL OUT9(ABN, FIELD(1, 1), 0)
        WRITE(OUTP, 460) IS, ZABCDI, (FIELD(M, 1), M = 1, 11), LFW, &
                (FISLST(I, LFWO), I = 1, 6), NER
        WRITE(*, 460) IS, ZABCDI, (FIELD(M, 1), M = 1, 11), LFW, &
                (FISLST(I, LFWO), I = 1, 6), NER
        !
        !     PRINT WARNING IF SUM OF FRACTIONAL ABUNDANCES IS NOT CLOSE TO
        !     1.0
        !
        30 IF(IS.NE.NIS) GO TO 40
        IF(DABS(ABNSUM - 1.0D+00).LE.0.001) GO TO 40
        WRITE(OUTP, 420)
        IF(NIS.EQ.1) WRITE(OUTP, 430) ABNSUM
        IF(NIS.GT.1) WRITE(OUTP, 440) ABNSUM
        WRITE(OUTP, 450)
        WRITE(*, 420)
        IF(NIS.EQ.1) WRITE(*, 430) ABNSUM
        IF(NIS.GT.1) WRITE(*, 440) ABNSUM
        WRITE(*, 450)
        !
        !     READ DATA FOR EACH ENERGY RANGE.
        !
        40 DO 300 IE = 1, NER
            !-----DEFINE ENERGY RANGE, TYPE OF RESONANCE RANGE (NO PARAMETERS/
            !-----RESOLVED/UNRESOLVED) AND TYPE OF PARAMETER.
            CALL CARDI(ELX, EHX, LRUIN, LRF, N1, N2)
            !
            !     IF ENDS OF RESONANCE REGION ARE VERY CLOSE TO THE ENDS OF ANY
            !     OTHER RESONANCE REGION INSURE THEY ARE EXACTLY THE SAME (THIS
            !     PROCEDURE WILL AVOID MICRO OVERLAPS OR HOLES BETWEEN RESONANCE
            !     REGIONS).
            !
            IF(NSECT.LE.0) GO TO 60
            DO 50 MSECT = 1, NSECT
                !-----FIRST CHECK FOR SAME ENERGY REGION (COMPARE LOWER TO LOWER AND
                !-----UPPER TO UPPER ENERGY LIMITS).
                IF(DABS(ELX - EL(MSECT)).LE.DEMIN * EL(MSECT)) ELX = EL(MSECT)
                IF(DABS(EHX - EH(MSECT)).LE.DEMIN * EH(MSECT)) EHX = EH(MSECT)
                !-----NEXT CHECK FOR ADJOINING ENERGY REGIONS (COMPARE LOWER TO UPPER
                !-----AND UPPER TO LOWER ENERGY LIMITS).
                IF(DABS(ELX - EH(MSECT)).LE.DEMIN * EH(MSECT)) ELX = EH(MSECT)
                IF(DABS(EHX - EL(MSECT)).LE.DEMIN * EL(MSECT)) EHX = EL(MSECT)
            50 CONTINUE
            !-----SAVE FLAG TO DETERMINE WHETHER OR NOT SCATTERING RADIUS IS
            !-----ENERGY DEPENDENT (ONLY LEGAL FOR BREIT-WIGNER PARAMETERS).
            60 NRO = N1
            !-----SAVE FLAG TO DETERMINE HOW TO USE THE CHANNEL AND SCATTERING RADII
            NAPS = N2
            !
            !     DEFINE LRU FOR INTERNAL USE
            !     LRUIN=0 -     NO RESONANCE PARAMETERS
            !          =1 -     RESOLVED PARAMETERS.
            !          =2 -     UNRESOLVED PARAMETERS.
            !          =3 - 5 - SAME AS 0 - 2, ONLY THE RESONANCE CONTRIBUTION HAS
            !                   ALREADY BEEN ADDED TO THE FILE 3 CROSS SECTIONS
            !                   (USUALLY INDICATING THAT THIS MAT HAS ALREADY BEEN
            !                   PROCESSED BY THIS OR A SIMILAR PROGRAM).
            !     IF LRUIN IS 3 TO 5 THE PARAMETERS WILL BE READ BUT IGNORED IN ALL
            !     SUBSEQUENT RESONANCE REGION CALCULATIONS.
            !     SAVE LRU AS INPUT (LRUIN), DEFINE LRU FOR OUTPUT INDICATING THAT
            !     THE RESONANCE CONTRIBUTION HAS ALREADY BEEN ADDED TO CROSS SECTION
            !     (LRUOUT) AND DEFINE LRU FOR READING (LRU= 0, 1 OR 2).
            !
            !     PRINT ENERGY LIMITS AND TYPE OF RESONANCE REGION (UNRESOLVED OR
            !     UNRESOLVED).
            !
            LRUOUT = LRUIN
            !-----DO NOT CHANGE PARAMETER TYPE FOR ENDF/B-VI DATA (FILE 1 IS USED
            !-----TO DEFINE THAT MATERIAL HAS BEEN PROCESSED).
            IF(IVERSE.EQ.6) GO TO 70
            !-----DO NOT CHANGE PARAMETER TYPE IF ONLY PROCESSING A PORTION OF THE
            !-----RESONANCE REGION.
            IF(NPART.EQ.2) GO TO 70
            IF(LRUOUT.GE.0.AND.LRUOUT.LE.2) LRUOUT = LRUOUT + 3
            70 LRU = LRUIN
            IF(LRU.GT.2) LRU = LRU - 3
            IF(IMEDIT.EQ.0) GO TO 100
            !-----DEFINE AND PRINT INTERPRETATION OF TYPE OF RESONANCE REGION.
            LRULST = LRUIN + 1
            IF(LRUIN.GE.3.AND.LRUIN.LE.5) LRULST = LRULST - 3
            IF(LRUIN.LT.0.OR.LRUIN.GT.5) LRUIN = 4
            CALL OUT9(ELX, FIELD(1, 1), 3)
            CALL OUT9(EHX, FIELD(1, 2), 3)
            WRITE(OUTP, 470) ((FIELD(M, I), M = 1, 11), I = 1, 2), LRUIN, &
                    (REGLST(I, LRULST), I = 1, 6)
            WRITE(*, 470) ((FIELD(M, I), M = 1, 11), I = 1, 2), LRUIN, &
                    (REGLST(I, LRULST), I = 1, 6)
            !
            !     DEFINE AND PRINT INTERPRETATION OF TYPE OF RESOLVED PARAMETERS.
            !
            IF(LRU.NE.1) GO TO 80
            LRFLST = LRF
            IF(LRF.LT.1.OR.LRF.GT.6) LRFLST = 7
            WRITE(OUTP, 480) LRF, (RTYPE(I, LRFLST), I = 1, 7)
            WRITE(*, 480) LRF, (RTYPE(I, LRFLST), I = 1, 7)
            GO TO 90
            !
            !     DEFINE AND PRINT INTERPRETATION OF TYPE OF UNRESOLVED PARAMETERS.
            !
            80 IF(LRU.NE.2) GO TO 90
            LRFLST = 4
            IF(LRF.EQ.1.AND.LFW.EQ.0) LRFLST = 1
            IF(LRF.EQ.1.AND.LFW.EQ.1) LRFLST = 2
            IF(LRF.EQ.2) LRFLST = 3
            WRITE(OUTP, 490) LRF, (UTYPE(I, LRFLST), I = 1, 7)
            WRITE(*, 490) LRF, (UTYPE(I, LRFLST), I = 1, 7)
            !
            !     PRINT INTERPRETATION OF NRO (ENERGY INDEPENDENT OR DEPENDENT
            !     SCATTERING RADIUS) AND NAPS (CALCULATE CHANNEL RADIUS OR DEFINE
            !     IT AS EQUAL TO THE SCATTERING RADIUS).
            !
            !-----DEFINE WHETHER OR SCATTERING RADIUS IS ENERGY DEPENDENT.
            90 KNRO = NRO + 1
            IF(NRO.LT.0.OR.NRO.GT.1) KNRO = 3
            WRITE(OUTP, 500) NRO, (HOLNRO(I, KNRO), I = 1, 6)
            WRITE(*, 500) NRO, (HOLNRO(I, KNRO), I = 1, 6)
            !-----DEFINE WHETHER CHANNEL RADIUS WILL BE CALCULATED OR SET EQUAL TO
            !-----THE SCATTERING RADIUS.
            KNAPS = NAPS + 1
            IF(KNAPS.EQ.3) KNAPS = 2
            IF(NAPS.LT.0.OR.NAPS.GT.2) KNAPS = 3
            WRITE(OUTP, 510) NAPS, (HOLNAP(I, KNAPS), I = 1, 6)
            WRITE(*, 510) NAPS, (HOLNAP(I, KNAPS), I = 1, 6)
            !-----IF NECESSARY READ ENERGY DEPENDENT SCATTERING RADIUS.
            IF(NRO.EQ.1) CALL RDAP
            !
            !     PRINT WARNING IF RESONANCE CONTRIBUTION HAS ALREADY BEEN ADDED TO
            !     BACKGROUND CROSS SECTIONS.
            !
            100 IF(LRUIN.GE.3.AND.LRUIN.LE.5) WRITE(OUTP, 520) LRUIN
            IF(LRUIN.GE.3.AND.LRUIN.LE.5) WRITE(*, 520) LRUIN
            !
            !     ERROR IF RESONANCE REGION BOUNDARIES ARE NOT IN ASCENDING ENERGY
            !     ORDER OR NOT IN EXPECTED ENERGY RANGE.
            !
            !-----IF RESONANCE REGION BOUNDARIES ARE NOT IN ASCENDING ENERGY ORDER
            !-----PRINT MESSAGE AND TERMINATE.
            IF(ELX.GE.EHX) GO TO 110
            !-----IF RESONANCE REGION BOUNDARIES ARE NOT IN EXPECTED ENERGY RANGE
            !-----PRINT MESSAGE AND TRUNCATE RANGE TO EXPECTED RANGE.
            IF(ELX.GE.EMINL.AND.ELX.LE.EMAX.AND.EHX.GE.EMINL.AND.EHX.LE.EMAX)&
                    GO TO 120
            IF(ELX.LT.EMIN) ELX = EMIN
            IF(ELX.GT.EMAX) ELX = EMAX
            IF(EHX.LT.EMIN) EHX = EMIN
            IF(EHX.GT.EMAX) EHX = EMAX
            CALL OUT9(EMIN, FIELD(1, 1), 3)
            CALL OUT9(EMAX, FIELD(1, 2), 3)
            WRITE(OUTP, 630) ((FIELD(M, I), M = 1, 11), I = 1, 2)
            WRITE(*, 630) ((FIELD(M, I), M = 1, 11), I = 1, 2)
            CALL OUT9(ELX, FIELD(1, 1), 3)
            CALL OUT9(EHX, FIELD(1, 2), 3)
            WRITE(OUTP, 640) ((FIELD(M, I), M = 1, 11), I = 1, 2)
            WRITE(*, 640) ((FIELD(M, I), M = 1, 11), I = 1, 2)
            IF(ELX.LT.EHX) GO TO 120
            110 WRITE(OUTP, 650)
            WRITE(*, 650)
            CALL ENDIT
            !
            !     ERROR STOP IF LRU, LRF OR LRF, LFW COMBINATION IS ILLEGAL.
            !     UNLESS THESE PARAMETERS ARE CORRECT THE PROGRAM CANNOT DETERMINE
            !     THE FORMAT OF THE ENDF/B DATA.
            !
            120 CALL CARDO(ELX, EHX, LRUOUT, LRF, N1, N2)
            !-----TERMINATE IF ILLEGAL LRU.
            IF(LRUIN.GE.0.AND.LRUIN.LE.5) GO TO 130
            WRITE(OUTP, 540) LRUIN
            WRITE(*, 540) LRUIN
            CALL ENDIT
            !-----COPY SECTION WITH NO PARAMETERS.
            130 IF(LRU.EQ.0) GO TO 170
            !-----TERMINATE IF ILLEGAL RESOLVED REGION LRF.
            IF(LRU.NE.1) GO TO 140
            IF(LRF.GE.1.AND.LRF.LE.6) GO TO 150
            WRITE(OUTP, 550) LRF
            WRITE(*, 550) LRF
            CALL ENDIT
            !-----TERMINATE IF ILLEGAL UNRESOLVED LRF, LFW COMBINATION.
            140 IF(LRU.NE.2) GO TO 150
            LRFLST = 4
            IF(LRF.EQ.1.AND.LFW.EQ.0) LRFLST = 1
            IF(LRF.EQ.1.AND.LFW.EQ.1) LRFLST = 2
            IF(LRF.EQ.2) LRFLST = 3
            IF(LRFLST.NE.4) GO TO 150
            WRITE(OUTP, 560) LRF, LFW
            WRITE(*, 560) LRF, LFW
            CALL ENDIT
            !
            !     ERROR IF ILLEGAL VALUE FOR NRO (ENERGY INDEPENDENT OR DEPENDENT
            !     SCATTERING RADIUS) AND/OR NAPS (CALCULATE CHANNEL RADIUS OR SET
            !     IT EQUAL TO THE SCATTERING RADIUS).
            !
            150 IF(KNRO.NE.3) GO TO 160
            !-----ILLEGAL NRO VALUE.
            WRITE(OUTP, 610) NRO
            WRITE(*, 610) NRO
            NRO = 0
            160 IF(KNAPS.NE.3) GO TO 180
            !-----ILLEGAL NAPS VALUE.
            WRITE(OUTP, 620) NAPS
            WRITE(*, 620) NAPS
            NAPS = 0
            GO TO 180
            !
            !     READ AND SAVE ALL PARAMETERS.
            !
            !-----COPY SECTION WITH NO PARAMETERS.
            170 CALL CARDIO(SPI, AP, L1, L2, N1, N2)
            CALL OUT9(SPI, FIELD(1, 1), 0)
            CALL OUT9(AP, FIELD(1, 2), 0)
            WRITE(OUTP, 530) ((FIELD(M, I), M = 1, 2), I = 1, 2)
            WRITE(*, 530) ((FIELD(M, I), M = 1, 2), I = 1, 2)
            GO TO 300
            !-----SAVE INITIAL RESONANCE TABLE PARAMETERS. IF RESONANCE CONTRIBUTION
            !-----FOR THIS SECTION HAS ALREADY BEEN ADDED TO THE FILE 3 CROSS
            !-----SECTION THEY WILL BE RESTORED AFTER THE DATA HAS BEEN READ
            !-----(THIS WILL EFFECTIVELY IGNORE THE SECTION).
            180 NSECTI = NSECT
            NODESI = NODES
            LHII = LHI
            !
            !     IF ONLY PROCESSING A PORTION OF THE RESONANCE REGION DEFINE
            !     RANGE TO PROCESS.
            !
            !-----SAVE RESONANCE REGION BOUNDARIES AS READ.
            ELXIN = ELX
            EHXIN = EHX
            !-----TRUNCATE TO REQUESTED ENERGY RANGE.
            IF(NPART.LE.0) GO TO 190
            IF(ELX.LT.EPART1) ELX = EPART1
            IF(EHX.GT.EPART2) EHX = EPART2
            !-----ARE PARAMETERS RESOLVED OR UNRESOLVED.
            190 IF(LRU.EQ.2) GO TO 250
            !-----READ ALL RESOLVED RESONANCE PARAMETERS.
            GO TO (200, 200, 210, 220, 230, 240), LRF
            200 CALL RDBW
            GO TO 260
            !-----FOR ALL VERSIONS OF ENDF/B FORMAT ASSUME GENERAL REICH-MOORE
            !-----TREATMENT WITH TWO FISSION CHANNELS (NOTE, ENDF/B-VI REICH-MOORE
            !-----FORMAT HAS BEEN UPDATED TO BE EXACTLY THE SAME AS THE FORMAT IN
            !-----EARLIER VERSIONS OF ENDF/B).
            210 CALL RDRM
            GO TO 260
            220 CALL RDAA
            GO TO 260
            230 CALL RDGRM
            GO TO 260
            240 CALL RDHRF
            GO TO 260
            !-----READ UNRESOLVED PARAMETERS (ANY OF THE 3 REPRESENTATIONS).
            250 CALL RDUR
            !
            !     IF RESONANCE CONTRIBUTION OF CURRENT SECTION ALREADY BEEN ADDED
            !     TO CROSS SECTIONS, SKIP THIS SECTION.
            !
            260 IF(LRUIN.NE.1.AND.LRUIN.NE.2) GO TO 280
            !
            !     IF ONLY PROCESSING A PORTION OF RESONANCE REGION EITHER
            !     1) IGNORE THE REGION IF IT IS COMPLETELY OUTSIDE THE RANGE
            !     2) USE ALL OR THE PORTION WITHIN THE REQUESTED RANGE
            !
            IF(NPART.LE.0) GO TO 290
            IF(ELXIN.LT.EPART2.OR.EHXIN.GT.EPART1) GO TO 270
            !-----IGNORE RANGE = COMPLETELY OUTSIDE REQUESTED ENERGY RANGE.
            WRITE(OUTP, 660)
            WRITE(*, 660)
            GO TO 280
            !-----USE ENTIRE RANGE OR TRUNCATE RANGE.
            270 IF(ELXIN.GE.EPART1.AND.EHXIN.LE.EPART2) GO TO 290
            WRITE(OUTP, 670)
            WRITE(*, 670)
            GO TO 290
            !-----RESTORE INITIAL RESONANCE TABLE PARAMETERS (I.E., IGNOR CURRENT
            !-----SECTION).
            280 NSECT = NSECTI
            NODES = NODESI
            LHI = LHII
            GO TO 300
            !-----NO. USE LOWER AND UPPER ENERGY LIMIT AS NODES (USE ZERO WIDTH).
            290 CALL NOODLE(ELX, ZERO, EMIN, EMAX)
            CALL NOODLE(EHX, ZERO, EMIN, EMAX)
            !-----END OF ENERGY RANGE LOOP.
        300 CONTINUE
        !-----END OF ISOTOPE LOOP. TEST CONSISTENCY OF LFW AND LFI FLAGS AND
        !-----FISSION DATA READ.
        IF(LFW.EQ.0.AND.LFWX.GT.0) WRITE(OUTP, 570) LFW
        IF(LFW.GT.0.AND.LFWX.EQ.0) WRITE(OUTP, 580) LFW
        IF(LFW.EQ.0.AND.LFWX.GT.0) WRITE(*, 570) LFW
        IF(LFW.GT.0.AND.LFWX.EQ.0) WRITE(*, 580) LFW
        !-----ONLY CHECK LFI IF SECTION MF=1, MT-451 IS PRESENT (SINCE LFI IS
        !-----DEFINED IN MF=1, MT=451).
        IF(MT451.LE.0) GO TO 310
        IF(LFI.EQ.0.AND.LFWX.GT.0) WRITE(OUTP, 590) LFI
        IF(LFI.GT.0.AND.LFWX.EQ.0) WRITE(OUTP, 600) LFI
        IF(LFI.EQ.0.AND.LFWX.GT.0) WRITE(*, 590) LFI
        IF(LFI.GT.0.AND.LFWX.EQ.0) WRITE(*, 600) LFI
        !-----DEFINE CUMULATIVE LFWX FLAG.
        310 IF(LFWK.GT.0.OR.LFWX.GT.0) LFWX = 1
    320 CONTINUE
    !-----ALL PARAMETERS READ. COPY TO END OF FILE 2.
    CALL COPYF
    !
    !     ALL RESONANCE PARAMETERS HAVE BEEN READ. IF THERE ARE NO SECTIONS
    !     WHOSE RESONANCE CONTRIBUTION MUST BE ADDED TO THE CROSS SECTIONS
    !     THERE IS NOTHING TO DO. OTHERWISE, (1) DEFINE TABLE OF ENERGY
    !     RANGES (USUALLY 1 OR 2, I.E. RESOLVED AND/OR UNRESOLVED), (2)
    !     DEFINE WHICH NODES ARE WITHIN EACH ENERGY RANGE.
    !
    IF(NSECT.LE.0) GO TO 400
    !
    !     DEFINE ENERGY RANGES.
    !
    !-----DEFINE TABLE OF ENDS OF ALL RESONANCE REGIONS.
    IRANGE = 0
    DO 350 IS = 1, NSECT
        ELTNOW = EL(IS)
        EHTNOW = EH(IS)
        IF(ELTNOW.LT.EMIN) ELTNOW = EMIN
        IF(EHTNOW.GT.EMAX) EHTNOW = EMAX
        IF(ELTNOW.GE.EHTNOW) GO TO 350
        !-----IGNOR REPEATED ENERGY RANGES.
        IF(IRANGE.LT.2) GO TO 340
        DO 330 I = 1, IRANGE, 2
            IF(ELTNOW.EQ.ERANGE(I).AND.EHTNOW.EQ.ERANGE(I + 1)) GO TO 350
        330 CONTINUE
        !-----SAVE BOTH ENDS OF ENERGY REGION.
        340 IRANGE = IRANGE + 1
        ERANGE(IRANGE) = ELTNOW
        IRANGE = IRANGE + 1
        ERANGE(IRANGE) = EHTNOW
    350 CONTINUE
    !-----SORT RESONANCE REGION BOUNDARIES INTO ASCENDING SORTS.
    CALL SORTD(ERANGE, IRANGE)
    !-----ELIMINATE DUPLICATE ENERGY LIMITS.
    NRANGE = 1
    DO 360 IS = 2, IRANGE
        IF(DABS(ERANGE(IS) - ERANGE(NRANGE)).LE.DABS(DEMIN * ERANGE(NRANGE)))&
                GO TO 360
        NRANGE = NRANGE + 1
        ERANGE(NRANGE) = ERANGE(IS)
    360 CONTINUE
    !-----ADD THERMAL ENERGY (0.0253 EV) IF RESONANCE REGION SPANS THERMAL
    !-----ENERGY.
    CALL NOODLE(ETHERM, ZERO, ERANGE(1), ERANGE(NRANGE))
    !
    !     DEFINE WHICH NODES CONTRIBUTE TO EACH RESONANCE REGION.
    !
    IN1 = 1
    IN2 = 1
    DO 390 IRANGE = 2, NRANGE
        IF(IN1.GE.NODES) GO TO 380
        DO 370 IN2 = IN1, NODES
            IF(ENODE(IN2) - ERANGE(IRANGE)) 370, 380, 380
        370 CONTINUE
        IN2 = NODES
        380 NODLOW(IRANGE) = IN1
        NODHI(IRANGE) = IN2
    390 IN1 = IN2
    400 RETURN
    410 FORMAT(1X, 78('=')/' Listing of All Resonance Parameters'/&
            1X, 78('=')/&
            ' Element or Material------------------', 10A1/&
            ' Atomic Weight Ratio------------------', 11A1/&
            ' Number of Isotopes-------------------', I11)
    420 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' For ENDF/B Evaluations the Fractional Abundance is Defined'/&
            ' to be the Fraction of Each Isotope in the Evaluation.'/&
            ' It is NOT the Naturally Occurring Isotopic Abundance'/&
            ' Unless the Evaluation Contains Data for ALL Isotopes of'/&
            ' an Element. For Any Evaluation the Sum of the Fractional'/&
            ' Abundances for All Isotopes Included in the Evaluation'/&
            ' Should be 1.0.')
    430 FORMAT(' For this Evaluation there is Only One Isotope'/&
            ' and the Fractional Abundance is', F10.5, ' Rather Than 1.0.')
    440 FORMAT(' For this Evaluation the Sum of the Fractional'/&
            ' Abundances is', F10.5, ' Rather than 1.0.')
    450 FORMAT(&
            ' Either You are Doing this on Purpose for Some Special'/&
            ' Application or Else the ENDF/B Data is Incorrect.'/&
            ' This Program will Continue with the Calculations Asuuming'/&
            ' that the Abundances Read from the Evaluation are Correct.'/&
            ' Check ENDF/B Data and Correct the Fractional Abundances.')
    460 FORMAT(1X, 78('=')/&
            ' Isotope Number-----------------------', I11/&
            ' Isotope------------------------------', 10A1/&
            ' Fractional Abundance-----------------', 11A1/&
            ' LFW (Fission Widths)-----------------', I11, 6A4/&
            ' Number of Energy Ranges--------------', I11)
    470 FORMAT(1X, 78('=')/&
            ' Lower Limit of the Energy Range------', 11A1, ' eV'/&
            ' Upper Limit of the Energy Range------', 11A1, ' eV'/&
            ' LRU (Type of Region)-----------------', I11, 6A4)
    480 FORMAT(' LRF (Type of Resolved Parameters)----', I11, 7A4)
    490 FORMAT(' LRF (Energy Dependence of Widths)----', I11, 7A4)
    500 FORMAT(' NRO (Scattering Radius)--------------', I11, 1X, 6A4)
    510 FORMAT(' NAPS (Channel Radius)----------------', I11, 1X, 6A4)
    520 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' Note, LRU=', I2, ' Indicates that the Resonance Contribution'/&
            ' has Already been Added to the Cross Sections. This Section'/&
            ' will be Read, but Ignored in All Resonance Calculations.')
    530 FORMAT(1X, 78('=')/' No Parameters'/1X, 78('=')/&
            ' Nuclear Spin of Target---------------', 11A1/&
            ' Effective Scattering Radius (A+)-----', 11A1)
    540 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
    23H WARNING - Illegal LRU=, I5, ' (Expect 0 to 5)'/&
            10X,' Cannot Determine Format of ENDF/B Data'/&
            10X, ' Execution Terminated'/1X,78('='))
    550 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - Illegal LRF=', I5, ' (Expect 1 to 4)'/&
            10X, ' Caanot Determine Format of ENDF/B Data'/&
            10X, ' Execution Terminated'/1X, 78('='))
    560 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - Illegal LRF=', I5, ' LFW=', I5, ' Combination'/&
            10X, ' (Expect LRF=1, LFW=0 OR LRF=1, LFW=1 OR LRF=2)'/&
            10X, ' Cannot Determine Format of ENDF/B Data'/&
            10X, ' Execution Terminated'/1X, 78('='))
    570 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - LFW=', I2, ' (Indicates NO Fission Widths Given).'/&
            '           but Fission Data Read are NOT Zero. Will Ignor'/&
            '           LFW and Assume Data Read is Correct.'/1X, 78('='))
    580 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - LFW=', I2, ' (Indicates Fission Widths Given).'/&
            '           but Fission Data Read are ALL Zero. Will Ignor'/&
            '           LFW and Assume Data Read is Correct.'/1X, 78('='))
    590 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - LFI=', I2, ' from MF=1, MT=451 (Indicates Material', &
            ' is NOT Fissile)'/&
            '           but Fission Data Read are NOT Zero. Will Ignor', &
            ' LFI and Assume'/&
            '           Data Read is Correct.'/1X, 78('='))
    600 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - LFI=', I2, ' from MF=1, MT=451 (Indicates Material', &
            ' is Fissile)'/&
            '           but Fission Data Read are ALL Zero. Will Ignor', &
            ' LFI and Assume'/&
            '           Data Read is Correct.'/1X, 78('='))
    610 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - NRO=', I5, ' (Illegal Value)'/&
            10X, ' in Order to Continue this Program will Set NRO=0'/&
            ' WARNING - This May Result in Errors - Check ENDF/B Data.')
    620 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' WARNING - NAPS=', I5, ' (Illegal Value)'/&
            10X, ' In Order to Continue this Program will Set NAPS=0'/&
            ' WARNING - This May Result in Errors - Check ENDF/B Data.')
    630 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
            ' Program Expects Resonance Region Between ', 11A1, ' and', &
            11A1, ' eV.')
    640 FORMAT(&
            ' Program Will Truncate Resonance Region to', 11A1, ' and', &
            11A1, ' eV.'/&
            ' Check Evaluated Data.'/1X, 78('='))
    650 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
            ' Resonance Region Limits MUST be in Ascending Energy Order.'/&
            10X, ' Execution Terminated'/1X, 78('='))
    660 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' The Above Resonance Region is Completely Outside Requested'/&
            ' Energy Range to be Processed - This Region will be Ignored.')
    670 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' The Above Resonance Region Will be Truncated to Requested'/&
            ' Energy Range to be Processed.')
END
SUBROUTINE FILE3
    !=======================================================================
    !
    !     OUTPUT DATA IN ENDF/B FORMAT. ALL SECTIONS OF FILE 3 DATA WILL BE
    !     PROCESSED BY THIS SUBROUTINE. ALL SECTIONS EXCEPT TOTAL, ELASTIC,
    !     FISSION AND CAPTURE WILL BE COPIED BY THIS ROUTINE. FOR TOTAL,
    !     ELASTIC, FISSION AND CAPTURE IF THERE ARE BACKGROUND CROSS SECTION
    !     THE RESONANCE AND BACKGROUND CROSS SECTIONS WILL BE COMBINED AND
    !     OUTPUT. IF THERE IS NO BACKGROUND CROSS SECTION ONLY THE RESONANCE
    !     CONTRIBUTION WILL BE OUTPUT. IN EITHER CASE THE DATA (RESONANCE OR
    !     RESONANCE PLUS BACKGROUND CONTRIBUTIONS) WILL NOT BE THINNED, I.E.
    !     THE OUTPUT ENERGY GRID WILL BE THE UNION OF THE RESONANCE AND
    !     BACKGROUND ENERGY GRIDS.
    !
    !     AFTER ALL OF FILE 3 HAS BEEN PROCESSED THE REMAINDER OF THE MAT
    !     WILL BE COPIED.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    CHARACTER*4 REACTS
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/UNITS/ISCR2, ISCR23
    COMMON/HEADER/C1H, C2H, L1H, L2H, N1H, N2H, MATH, MFH, MTH, NOSEQ
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/POINTN/NPOINT, KPOINT
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/EDGES/ERANGE(50), NODLOW(50), NODHI(50), NRANGE, IRANGE
    COMMON/PAGER/NPAGE, NPAGP1, NPAGM1
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/LASTE/ELAST
    COMMON/FLAGS/MINUS3, IMPLUS
    COMMON/WHATZA/IZANOW, MATNOW, TEMP3, IVERSE, INT45
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION MREACT(5), MTADD(5), NBTO(1), INTO(1), IHEAD(7), ISAVE1(7), &
            ETAB3(120000), SIG3(120000), ETAB23(120000), SIG23(120000), &
            INT(1002), NBT(1002), REACTS(2, 5), ETAB2X(120000), SIG2X(4, 120000), &
            SAVE1(2)
    EQUIVALENCE (ENRES(1), ETAB3(1)), (SHIFT2(1), ETAB23(1)), &
            (RESTAB(1, 1), SIG3(1)), (ENODE(1), SIG23(1)), &
            (ETAB2(1), ETAB2X(1)), (SIG2(1, 1), SIG2X(1, 1)), (IHEAD(1), L1H), &
            (INT(1), RESTAB(1, 1)), (NBT(1), RESTAB(1, 335))
    DATA MREACT/1, 2, 4, 4, 3/
    DATA MTADD/1, 2, 18, 19, 102/
    DATA REACTS/&
            '   T', 'otal', &
            ' Ela', 'stic', &
            ' Fis', 'sion', &
            ' (n,', 'f) 1', &
            ' Cap', 'ture'/
    DATA INTO/2/
    DATA IZERO/0/
    DATA IUSE23/0/
    DATA ISAVE1/0, 0, 0, 0, 0, 0, 0/
    DATA SAVE1/0.0D+00, 0.0D+00/
    DATA OKDIFF/1.0D-09/
    DATA IONE/1/
    DATA ZEROD/0.0D+00/
    DATA ETHERM/2.53D-02/
    !CHO
    DIMENSION SEN(10000), STOTAL(10000), SELAST(10000), SCAPTR(10000)
    !CHO
    !-----IF NO POINTS WERE GENERATED IN THE RESONANCE CALCULATION MERELY
    !-----COPY REMAINDER OF MAT UNLESS IN EDIT MODE.
    IF(IMEDIT.EQ.2) GO TO 10
    IF(NPOINT.LE.0) GO TO 790
    WRITE(OUTP, 810)
    WRITE(*, 810)
    GO TO 20
    10 WRITE(OUTP, 820)
    WRITE(*, 820)
    !-----INITIALIZE END OF FILE 3 FLAG OFF.
    20 MF3END = 0
    !-----LOOP OVER 5 RESONANCE REACTIONS.
    DO 710 IREACT = 1, 5
        !-----DEFINE INDEX TO CURRENT REACTION.
        INDEX = MREACT(IREACT)
        IMESS = 1
        !-----INITIALIZE NEGATIVE CROSS SECTION POINT COUNT.
        MINUS3 = 0
        IMPLUS = 0
        !-----INITIALIZE LAST ENERGY READ FROM FILE 3 FOR ASCENDING ENERGY TEST.
        ELAST = 0.0
        !-----TEST FOR CURRENT STATUS
        !-----MF3END=-1 - STILL IN FILE 3. RESTORE LAST LINE READ.
        !-----      = 0 - STILL IN FILE 3. READ NEXT LINE.
        !-----      = 1 - END OF FILE 3 READ (NO BACKGROUND)
        !-----      = 2 - PAST END OF FILE 3 READ (NO BACKGROUND)
        IF(MF3END) 30, 50, 600
        !-----RESTORE LAST LINE READ.
        30 C1H = SAVE1(1)
        C2H = SAVE1(2)
        DO 40 I = 1, 7
        40 IHEAD(I) = ISAVE1(I)
        MF3END = 0
        GO TO 90
        !-----READ FIRST LINE OF NEXT SECTION OF FILE 3, FEND OR MEND LINE.
        50 CALL CONTI
        IF(MFH - 3) 60, 90, 70
        !-----END OF FILE 3. SET FLAG. IF MEND LINE TREAT AS PAST END OF FILE 3.
        60 IF(MATH.LE.0) GO TO 70
        MF3END = 1
        GO TO 600
        !-----PAST THE END OF FILE 3. SET FLAG AND SAVE LINE.
        70 MF3END = 2
        SAVE1(1) = C1H
        SAVE1(2) = C2H
        DO 80 I = 1, 7
        80 ISAVE1(I) = IHEAD(I)
        GO TO 600
        !
        !     STILL IN FILE 3. SEE IF RESONANCE CONTRIBUTION MUST BE ADDED TO
        !     CURRENT CROSS SECTION. DEPENDING ON CURRENT MT FROM FILE 3
        !     EITHER,
        !     (1) COPY SECTION - NOT UP TO REQUIRED SECTION YET.
        !     (2) COMBINE RESONANCE AND BACKGROUND CONTRBUTION -SECTION MATCH.
        !     (3) OUTPUT RESONANCE CONTRIBUTION - NO BACKGROUND.
        !
        90 CONTINUE
        IF(MTH - MTADD(IREACT)) 100, 110, 580
        !-----COPY SECTION.
        100 CALL CONTO
        CALL COPYS
        GO TO 50
        !
        !     BACKGROUND DATA PRESENT.
        !
        !-----READ SECTION LEADER LINE AND INTERPOLATION LAW.
        110 CALL CARDI(C1, C2, L1, L2, N1, N2)
        CALL TERPI(NBT, INT, N1)
        !-----DEFINE BACKGROUND TEMPERATURE.
        IF(IVERSE.NE.6) GO TO 120
        TEMP = TEMP3
        GO TO 130
        120 TEMP = C1
        IF(MTH.EQ.1) TEMP1 = TEMP
        IF(L2.NE.0) TEMP = TEMP1
        !-----IF BACKGROUND TEMPERATURE IS NOT 0 KELVIN PRINT WARNING MESSAGE
        !-----AND DO NOT COMBINE RESONANCE AND BACKGROUND CONTRIBUTIONS (SKIP
        !-----BACKGROUND AND OUTPUT ONLY THE RESONANCE CONTRIBUTION).
        130 IF(TEMP.LE.0.0) GO TO 140
        IMESS = 2
        CALL SKIPS
        GO TO 620
        !-----CHECK INTERPOLATION LAW.
        140 DO 150 I = 1, N1
            IF(INT(I).NE.2) GO TO 160
        150 CONTINUE
        GO TO 170
        !-----INTERPLATION LAW IS NOT LINEAR-LINEAR. PRINT WARNING MESSAGE
        !-----AND DO NOT COMBINE RESONANCE AND BACKGROUND CONTRIBUTIONS (SKIP
        !-----BACKGROUND AND OUTPUT ONLY THE RESONANCE CONTRIBUTION).
        160 IMESS = 3
        CALL SKIPS
        GO TO 620
        !-----SECTION HEADER AND LEADER CARDS HAVE BEEN READ. TEMPERATURE AND
        !-----INTERPOLATION LAW CHECKED. IF IN EDIT MOODE SKIP SECTION AND
        !-----CONTINUE.
        170 IF(IMEDIT.NE.2) GO TO 180
        WRITE(OUTP, 850) REACTS(1, IREACT), REACTS(2, IREACT), N2
        WRITE(*, 850) REACTS(1, IREACT), REACTS(2, IREACT), N2
        CALL SKIPS
        GO TO 710
        !-----IF ALL FISSION WIDTHS ARE ZERO COPY BACKGROUND (NO RESONANCE
        !-----CONTRIBUTION...BOTH FISSION AND FIRST CHANCE FISSION).
        180 IF(LFWX.NE.0) GO TO 190
        IF(MTH.NE.18.AND.MTH.NE.19) GO TO 190
        WRITE(OUTP, 930) REACTS(1, IREACT), REACTS(2, IREACT), IZERO, N2, N2
        WRITE(*, 930) REACTS(1, IREACT), REACTS(2, IREACT), IZERO, N2, N2
        !-----OUTPUT SECTION HEADER AND LEADER CARDS AND INTERPOLATION LAW.
        CALL CONTO
        CALL CARDO(C1, C2, L1, L2, IONE, N2)
        NBTO(1) = N2
        CALL TERPO(NBTO, INTO, 1)
        !-----COPY REMAINDER OF SECTION.
        CALL COPYS
        GO TO 710
        !
        !     COMBINE RESONANCE AND BACKGROUND CONTRIBUTIONS.
        !
        !-----DEFINE RESONANCE AND TABULATED POINT COUNTS.
        190 NPT2 = NPOINT
        NPT3 = N2
        LEFT2 = NPOINT
        LEFT3 = N2
        !-----INITIALIZE COMBINED POINT COUNTS.
        IPT23 = 0
        NPT23 = 0
        !-----INITIALIZE NON-ZERO CROSS SECTION FLAG.
        KMPLUS = 0
        !-----INITIALIZE RESONANCE AND TABULATED POINT INDICES.
        IPT2 = 1
        IPT3 = 1
        KPT2 = IPT2
        KPT3 = IPT3
        !-----IF REQUIRED POSITION FILE 2 SCRATCH FILE FOR READING.
        IF(NPOINT.GT.NPAGE) REWIND ISCR2
        !-----READ FIRST PAGE OF TABULATED DATA.
        IF(NPT3.GT.NPAGE) NPT3 = NPAGE
        CALL POINTI(ETAB3, SIG3, NPT3)
        LEFT3 = LEFT3 - NPT3
        !-----IF ENTIRE BACKGROUND FITS IN CORE AND IT IS ZERO AT ALL ENERGIES
        !-----SIMPLY ADD END POINT ENERGIES AND OUTPUT (NO NEED TO PERFORM
        !-----ADDITION).
        IF(LEFT3.GT.0) GO TO 270
        DO 200 I = 1, NPT3
            IF(DABS(SIG3(I)).NE.0.0D+00) GO TO 270
        200 CONTINUE
        !
        !     BACKGROUND IS ZERO. ADDITION NOT REQUIRED.
        !
        !-----IF REQUIRED ADD END POINTS.
        NPT23 = NPOINT
        E3LST = ETAB3(1)
        E3 = ETAB3(NPT3)
        IF(E3LST.LT.ERANGE(1)) NPT23 = NPT23 + 1
        IF(E3.GT.ERANGE(NRANGE)) NPT23 = NPT23 + 1
        WRITE(OUTP, 860) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, N2, &
                NPT23
        WRITE(*, 860) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, N2, &
                NPT23
        !-----OUTPUT SECTION HEAD AND LEADER CARDS AND INTERPOLATION LAW.
        CALL CONTO
        CALL CARDO(C1, C2, L1, L2, IONE, NPT23)
        NBTO(1) = NPT23
        CALL TERPO(NBTO, INTO, 1)
        !-----IF NO ADDITIONAL BACKGROUND POINTS OUTPUT RESONANCE CONTRIBUTION.
        IF(NPT23.LE.NPOINT) GO TO 670
        !-----IF REQUIRED INSERT FIRST BACKGROUND POINT.
        IPT23 = 0
        IF(E3LST.GE.ERANGE(1)) GO TO 210
        IPT23 = 1
        ETAB23(1) = E3LST
        SIG23(1) = 0.0
        !-----COPY FILE 2 POINTS TO FILE 3 ARRAYS AND OUTPUT A PAGE AT A TIME.
        210 NPT2 = 1
        220 IPT2 = NPT2 + NPAGM1
        IF(IPT2.GT.NPOINT) IPT2 = NPOINT
        IF(NPOINT.GT.NPAGE) READ(ISCR2) ETAB2X, SIG2X
        JPT2 = (IPT2 - NPT2) + 1
        DO 240 I = 1, JPT2
            IPT23 = IPT23 + 1
            IF(IPT23.LE.NPAGE) GO TO 230
            !-----IF REQUEST MAKE ALL NEGATIVE CROSS SECTIONS = 0
            IF(MAKEPLUS.EQ.1) THEN
                DO KP = 1, NPAGE
                    IF(SIG23(KP).LT.0.0D+00) THEN
                        MINUS3 = MINUS3 + 1
                        SIG23(KP) = 0.0
                    ENDIF
                ENDDO
            ENDIF
            CALL POINTO(ETAB23, SIG23, NPAGE)
            IPT23 = 1
            230 ETAB23(IPT23) = ETAB2(I)
            SIG23(IPT23) = SIG2(INDEX, I)
        240 NPT2 = NPT2 + NPAGE
        IF(NPT2.LE.NPOINT) GO TO 220
        !-----IF REQUIRED INSERT LAST BACKGROUND POINT.
        IF(E3.LE.ERANGE(NRANGE)) GO TO 260
        IPT23 = IPT23 + 1
        IF(IPT23.LE.NPAGE) GO TO 250
        !-----IF REQUEST MAKE ALL NEGATIVE CROSS SECTIONS = 0
        IF(MAKEPLUS.EQ.1) THEN
            DO KP = 1, NPAGE
                IF(SIG23(KP).LT.0.0D+00) THEN
                    MINUS3 = MINUS3 + 1
                    SIG23(KP) = 0.0
                ENDIF
            ENDDO
        ENDIF
        CALL POINTO(ETAB23, SIG23, NPAGE)
        IPT23 = 1
        250 ETAB23(IPT23) = E3
        SIG23(IPT23) = 0.0
        !-----IF REQUEST MAKE ALL NEGATIVE CROSS SECTIONS = 0
        260 IF(MAKEPLUS.EQ.1) THEN
            DO KP = 1, IPT23
                IF(SIG23(KP).LT.0.0D+00) THEN
                    MINUS3 = MINUS3 + 1
                    SIG23(KP) = 0.0
                ENDIF
            ENDDO
        ENDIF
        !-----OUTPUT LAST PAGE OF POINTS.
        CALL POINTO(ETAB23, SIG23, IPT23)
        !-----COPY SEND LINE.
        CALL COPYS
        GO TO 700
        !
        !     RESONANCE AND BACKGROUND CONTRIBUTIONS MUST BE ADDED TOGETHER.
        !
        270 E3= ETAB3(IPT3)
        XC3 = SIG3(IPT3)
        E3LST = E3
        XC3LST = XC3
        !-----INSURE FIRST PAGE OF RESONANCE DATA IS IN CORE AND DEFINE FIRST
        !-----POINT.
        IF(NPOINT.LE.NPAGE) GO TO 280
        NPT2 = NPAGE
        READ(ISCR2) ETAB2X, SIG2X
        280 LEFT2 = LEFT2 - NPT2
        E2 = ETAB2(1)
        XC2 = SIG2(INDEX, 1)
        E2LST = E2
        XC2LST = XC2
        !-----SELECT LOWEST ENERGY.
        290 IF(E2 - E3) 300, 430, 310
        !-----TREAT SMALL DIFFERENCES AS EQUALITY (SAME TO ABOUT 9 DIGITS).
        300 IF(DABS(E2 - E3).LE.OKDIFF * E2) GO TO 430
        GO TO 320
        310 IF(DABS(E3 - E2).LE.OKDIFF * E3) GO TO 420
        GO TO 390
        !
        !     FILE 2 ENERGY IS LOWER. INTERPOLATE FILE 3 DATA, OR DEFINE TO
        !     BE ZERO IF FILE 3 DOES NOT SPAN ENERGY RANGE.
        !
        320 E23 = E2
        IF(KPT3.GT.1) GO TO 330
        XC23 = XC2
        GO TO 350
        330 IF(E3.GT.E3LST) GO TO 340
        XC23 = XC2 + XC3
        GO TO 350
        340 XC23 = XC2 + ((E3 - E2) * XC3LST + (E2 - E3LST) * XC3) / (E3 - E3LST)
        !-----DEFINE NEXT FILE 2 POINT (USE EITHER NEXT POINT - FROM CORE OR
        !-----SCRATCH - OR EXTEND CROSS SECTION BEYOND TABULATED RANGE AS
        !-----ZERO).
        350 E2LST = E2
        XC2LST = XC2
        IPT2 = IPT2 + 1
        KPT2 = KPT2 + 1
        IF(IPT2.LE.NPT2) GO TO 380
        IF(LEFT2.GT.0) GO TO 370
        !-----EXTEND CROSS SECTION AS ZERO (IF CROSS SECTION IS NOT YET ZERO
        !-----SET CROSS SECTION TO ZERO AT CURRENT ENERGY. FOR ALL FOLLOWING
        !-----POINTS LEAVE CROSS SECTION EQUAL TO ZERO AND SET CURRENT ENERGY
        !-----EQUAL TO CURRENT ENERGY FROM FILE 3.)
        IF(XC2.LE.0.0) GO TO 360
        XC2 = 0.0
        GO TO 510
        360 E2 = E3
        GO TO 510
        !-----LOAD NEXT PAGE FROM SCRATCH AND RE-INITIALIZE IN CORE INDEX.
        370 IF(NPT2.GT.LEFT2) NPT2 = LEFT2
        READ(ISCR2) ETAB2X, SIG2X
        LEFT2 = LEFT2 - NPT2
        IPT2 = 1
        !-----USE NEXT POINT FROM CORE.
        380 E2= ETAB2(IPT2)
        XC2 = SIG2(INDEX, IPT2)
        GO TO 510
        !
        !     FILE 3 ENERGY IS LOWER. INTERPOLATE FILE 2 DATA, OR DEFINE TO
        !     BE ZERO IF FILE 2 DOES NOT SPAN ENERGY RANGE.
        !
        390 E23 = E3
        IF(KPT2.GT.1) GO TO 400
        XC23 = XC3
        GO TO 470
        400 IF(E2.GT.E2LST) GO TO 410
        XC23 = XC2 + XC3
        GO TO 470
        410 XC23 = XC3 + ((E2 - E3) * XC2LST + (E3 - E2LST) * XC2) / (E2 - E2LST)
        GO TO 470
        !
        !     ENERGIES ARE VERY CLOSE AND WILL BE TREATED AS EQUAL. SELECT THE
        !     SMALLER ENERGY FOR OUTPUT.
        !
        420 E2 = E3
        !
        !     ENERGIES ARE EQUAL.
        !
        430 E23 = E2
        XC23 = XC2 + XC3
        !-----DEFINE NEXT FILE 2 POINT (USE EITHER NEXT POINT - FROM CORE OR
        !-----SCRATCH - OR EXTEND CROSS SECTION BEYOND TABULATED RANGE AS
        !-----ZERO).
        E2LST = E2
        XC2LST = XC2
        IPT2 = IPT2 + 1
        KPT2 = KPT2 + 1
        IF(IPT2.LE.NPT2) GO TO 460
        IF(LEFT2.GT.0) GO TO 450
        !-----EXTEND CROSS SECTION AS ZERO (IF CROSS SECTION IS NOT YET ZERO
        !-----SET CROSS SECTION TO ZERO AT CURRENT ENERGY. FOR ALL FOLLOWING
        !-----POINTS LEAVE CROSS SECTION EQUAL TO ZERO AND SET CURRENT ENERGY
        !-----EQUAL TO CURRENT ENERGY FROM FILE 3.)
        IF(XC2.LE.0.0) GO TO 440
        XC2 = 0.0
        GO TO 470
        440 E2 = E3
        GO TO 470
        !-----LOAD NEXT PAGE FROM SCRATCH AND RE-INITIALIZE IN CORE INDEX.
        450 IF(NPT2.GT.LEFT2) NPT2 = LEFT2
        READ(ISCR2) ETAB2X, SIG2X
        LEFT2 = LEFT2 - NPT2
        IPT2 = 1
        !-----USE NEXT POINT FROM CORE.
        460 E2= ETAB2(IPT2)
        XC2 = SIG2(INDEX, IPT2)
        !-----DEFINE NEXT FILE 3 POINT (USE EITHER NEXT POINT - FROM CORE OR
        !-----FILE - OR EXTEND CROSS SECTION BEYOND TABULATED RANGE AS ZERO).
        470 E3LST = E3
        XC3LST = XC3
        IPT3 = IPT3 + 1
        KPT3 = KPT3 + 1
        IF(IPT3.LE.NPT3) GO TO 500
        IF(LEFT3.GT.0) GO TO 490
        !-----EXTEND CROSS SECTION AS ZERO (IF CROSS SECTION IS NOT YET ZERO
        !-----SET CROSS SECTION TO ZERO AT CURRENT ENERGY. FOR ALL FOLLOWING
        !-----POINTS LEAVE CROSS SECTION EQUAL TO ZERO AND SET CURRENT ENERGY
        !-----EQUAL TO CURRENT ENERGY FROM FILE 2.)
        IF(XC3.LE.0.0) GO TO 480
        XC3 = 0.0
        GO TO 510
        480 E3 = E2
        GO TO 510
        !-----LOAD NEXT PAGE FROM INPUT FILE AND RE-INITIALIZE IN CORE INDEX.
        490 IF(NPT3.GT.LEFT3) NPT3 = LEFT3
        CALL POINTI(ETAB3, SIG3, NPT3)
        LEFT3 = LEFT3 - NPT3
        IPT3 = 1
        !-----USE NEXT POINT FROM CORE.
        500 E3= ETAB3(IPT3)
        XC3 = SIG3(IPT3)
        !-----STORE COMBINED POINT.
        510 IPT23 = IPT23 + 1
        IF(IPT23.LE.NPAGE) GO TO 530
        IF(NPT23.LE.0.AND.IUSE23.GT.0) REWIND ISCR23
        NPT23 = NPT23 + NPAGE
        WRITE(ISCR23) ETAB23, SIG23
        !-----IF REQUESTED PRINT MESSAGE EVERYTIME A PAGE IS OUTPUT TO SCRATCH.
        IF(MONITR.EQ.0) GO TO 520
        CALL OUT9(ETAB23(1), FIELD(1, 1), 3)
        CALL OUT9(ETAB23(NPAGE), FIELD(1, 2), 3)
        WRITE(OUTP, 960) NPT23, ((FIELD(M, I), M = 1, 11), I = 1, 2)
        WRITE(*, 960) NPT23, ((FIELD(M, I), M = 1, 11), I = 1, 2)
        520 IPT23 = 1
        !
        !     SAVE NEXT COMBINED POINT.
        !
        530 ETAB23(IPT23) = E23
        SIG23(IPT23) = XC23
        !
        !     ONLY ALLOW UP TO 2 ENERGY POINTS WITH ZERO CROSS SECTION AT THE
        !     BEGINNING OF THE TABLE.
        !
        IF(KMPLUS.NE.0) GO TO 550
        IF(XC23.NE.0.0) GO TO 540
        IF(IPT23.LE.2) GO TO 550
        !-----KEEP SHIFTING POINTS FORWARD AND RESETTING POINT COUNT.
        ETAB23(2) = ETAB23(IPT23)
        SIG23(2) = SIG23(IPT23)
        IPT23 = 2
        GO TO 550
        540 KMPLUS = 1
        !-----CONTINUE COMBINING POINTS IF ANYMORE LEFT.
        550 IF(IPT2.LE.NPT2.OR.LEFT2.GT.0) GO TO 290
        !-----WHEN OUT OF FILE 2 POINTS INSURE CURRENT FILE 2 ENERGY (WITH ZERO
        !-----CROSS SECTION) IS EQUAL TO FILE 3 ENERGY. NOTE, WHEN ENERGIES ARE
        !-----EQUAL NEXT E2 IS DEFINED BEFORE NEXT E3. THEREFORE WHEN E2 IS
        !-----BEING EXTEND TO HIGHER ENERGY WITH ZERO CROSS SECTION E2 DEFINED
        !-----ABOVE WILL BE SET EQUAL TO THE PRECEDING E3. THE FOLLOWING
        !-----STATEMENT WILL INSURE THAT IN THIS CASE E2 IS EXTEND AS EQUAL TO
        !-----THE CURRENT E3.
        IF(XC2.EQ.0.0) E2 = E3
        IF(IPT3.LE.NPT3.OR.LEFT3.GT.0) GO TO 290
        !-----END OF SECTION. DEFINE COMBINED POINT COUNT AND IF REQUIRED SET UP
        !-----SCRATCH FILE TO READ.
        NPT23 = NPT23 + IPT23
        IF(NPT23.LE.NPAGE) GO TO 560
        WRITE(ISCR23) ETAB23, SIG23
END FILE ISCR23
REWIND ISCR23
IUSE23 = 1
!-----IF REQUESTED PRINT MESSAGE EVERYTIME A PAGE IS OUTPUT TO SCRATCH.
IF(MONITR.EQ.0) GO TO 560
CALL OUT9(ETAB23(1), FIELD(1, 1), 3)
CALL OUT9(ETAB23(IPT23), FIELD(1, 2), 3)
WRITE(OUTP, 960) NPT23, ((FIELD(M, I), M = 1, 11), I = 1, 2)
WRITE(*, 960) NPT23, ((FIELD(M, I), M = 1, 11), I = 1, 2)
!-----OUTPUT SECTION HEAD AND LEADER CARDS AND INTERPOLATION LAW.
560 WRITE(OUTP, 840) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, N2, &
        NPT23
WRITE(*, 840) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, N2, &
        NPT23
CALL CONTO
CALL CARDO(C1, C2, L1, L2, IONE, NPT23)
NBTO(1) = NPT23
CALL TERPO(NBTO, INTO, 1)
!-----OUTPUT DATA A PAGE AT A TIME.
IPTB = 1
570 IF(NPT23.GT.NPAGE) READ(ISCR23) ETAB23, SIG23
IPT23 = IPTB + NPAGM1
IF(IPT23.GT.NPT23) IPT23 = NPT23
JPT23 = (IPT23 - IPTB) + 1
!-----IF REQUEST MAKE ALL NEGATIVE CROSS SECTIONS = 0
IF(MAKEPLUS.EQ.1) THEN
    DO KP = 1, JPT23
        IF(SIG23(KP).LT.0.0D+00) THEN
            MINUS3 = MINUS3 + 1
            SIG23(KP) = 0.0
        ENDIF
    ENDDO
ENDIF
CALL POINTO(ETAB23, SIG23, JPT23)
IPTB = IPTB + NPAGE
IF(IPTB.LE.NPT23) GO TO 570
!-----COPY SEND LINE.
CALL COPYS
GO TO 700
!-----BEYOND REQUIRED SECTION (I.E. NO BACKGROUND). SAVE CURRENT LINE
!-----AND SET FLAG.
580 SAVE1(1) = C1H
SAVE1(2) = C2H
DO 590 I = 1, 7
590 ISAVE1(I) = IHEAD(I)
MF3END = -1
!
!     NO BACKGROUND. IF FISSION CROSS SECTION AND ALL FISSION WIDTHS
!     ARE ZERO SIMPLY SKIP THE REACTION (I.E., NO OUTPUT). OTHERWISE
!     USE INPUT PARAMETERS TO DECIDE TO EITHER HAVE NO OUTPUT OR TO
!     OUTPUT RESONANCE CONTRIBUTION.
!
!-----DO NOT OUTPUT FISSION CROSS SECTION UNLESS FISSION WIDTHS ARE NOT
!-----ZERO.
600 IF(MTADD(IREACT).EQ.18.AND.LFWX.LE.0) GO TO 710
!-----DO NOT OUTPUT FIRST CHANCE FISSION.
IF(MTADD(IREACT).EQ.19) GO TO 710
!-----IF IN EDIT MODE PRINT MESSAGE AND CONTINUE.
IF(IMEDIT.NE.2) GO TO 610
WRITE(OUTP, 830) REACTS(1, IREACT), REACTS(2, IREACT)
WRITE(*, 830) REACTS(1, IREACT), REACTS(2, IREACT)
GO TO 710
!-----USE INPUT OPTION TO DECIDE WHETHER OR NOT TO OUTPUT SECTION.
610 IF(IMBACK.EQ.1) GO TO 620
!-----NO OUTPUT. PRINT MESSAGE EXPLAINING WHY.
WRITE(OUTP, 910) REACTS(1, IREACT), REACTS(2, IREACT), IZERO, IZERO, &
        IZERO
WRITE(*, 910) REACTS(1, IREACT), REACTS(2, IREACT), IZERO, IZERO, &
        IZERO
GO TO 710
!-----OUTPUT RESONANCE CONTRIBUTION. DEFINE OUTPUT SECTION MAT/MF/MT.
620 MATH = MATNOW
MFH = 3
MTH = MTADD(IREACT)
!-----PRINT DESCRIPTION OF SECTION.
IF(IMESS - 2) 630, 640, 650
!-----SECTION OF O.K. TO BE COMBINED WITH BACKGROUND.
630 WRITE(OUTP, 870) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, IZERO, &
        NPOINT
WRITE(*, 870) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, IZERO, &
        NPOINT
GO TO 660
!-----BACKGROUND TEMPERATURE IS NOT 0 KELVIN.
640 CALL OUT9(TEMP, FIELD(1, 1), 0)
IF(IMEDIT.NE.2)&
        WRITE(OUTP, 880) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, IZERO, &
                NPOINT, (FIELD(M, 1), M = 1, 11)
IF(IMEDIT.NE.2)&
        WRITE(*, 880) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, IZERO, &
                NPOINT, (FIELD(M, 1), M = 1, 11)
IF(IMEDIT.EQ.2)&
        WRITE(OUTP, 970) REACTS(1, IREACT), REACTS(2, IREACT), N2, &
                (FIELD(M, 1), M = 1, 11)
IF(IMEDIT.EQ.2)&
        WRITE(*, 970) REACTS(1, IREACT), REACTS(2, IREACT), N2, &
                (FIELD(M, 1), M = 1, 11)
GO TO 660
!-----INTERPOLATION LAW IS NOT LINEAR.
650 IF(IMEDIT.NE.2)&
        WRITE(OUTP, 890) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, IZERO, &
                NPOINT, (NBT(I), INT(I), I = 1, N1)
IF(IMEDIT.NE.2)&
        WRITE(*, 890) REACTS(1, IREACT), REACTS(2, IREACT), NPOINT, IZERO, &
                NPOINT, (NBT(I), INT(I), I = 1, N1)
IF(IMEDIT.EQ.2)&
        WRITE(OUTP, 980) REACTS(1, IREACT), REACTS(2, IREACT), N2, &
                (NBT(I), INT(I), I = 1, N1)
IF(IMEDIT.EQ.2)&
        WRITE(*, 980) REACTS(1, IREACT), REACTS(2, IREACT), N2, &
                (NBT(I), INT(I), I = 1, N1)
IF(IMEDIT.NE.2) WRITE(OUTP, 900)
IF(IMEDIT.EQ.2) WRITE(OUTP, 990)
IF(IMEDIT.NE.2) WRITE(*, 900)
IF(IMEDIT.EQ.2) WRITE(*, 990)
!-----OUTPUT SECTION HEAD CARDS AND INTERPOLATION LAW.
660 CALL CARDO(ZA, AWR, IZERO, IZERO, IZERO, IZERO)
CALL CARDO(ZEROD, ZEROD, IZERO, IZERO, IONE, NPOINT)
NBTO(1) = NPOINT
CALL TERPO(NBTO, INTO, 1)
!-----RESONANCE CONTRIBUTION A PAGE AT A TIME.
670 IF(NPOINT.GT.NPAGE) REWIND ISCR2
IPOINT = 1
680 IF(NPOINT.GT.NPAGE) READ(ISCR2) ETAB2X, SIG2X
KPOINT = IPOINT + NPAGM1
IF(KPOINT.GT.NPOINT) KPOINT = NPOINT
KOUT = (KPOINT - IPOINT) + 1
DO 690 K = 1, KOUT
690 SIG3(K) = SIG2(INDEX, K)
!-----IF REQUEST MAKE ALL NEGATIVE CROSS SECTIONS = 0
IF(MAKEPLUS.EQ.1) THEN
    DO KP = 1, KOUT
        IF(SIG3(KP).LT.0.0D+00) THEN
            MINUS3 = MINUS3 + 1
            SIG3(KP) = 0.0
        ENDIF
    ENDDO
ENDIF
!CHO
!     FOR CONSTRUCTION OF SENSITIVITY MATRIX,
!     ENERGIES AND CROSS SECTIONS ARE WRITTEN IN SIMPLE FORMAT.
!     IT IS ASSUMED THAT KOUT DOES NOT EXCEED NPAGE.
!     FOR COMPUTING TIME, EACH MF HAS SEPARATE DO LOOP.
IF (MTH.EQ.1) THEN
    DO 691 K = 1, KOUT
        SEN(K) = ETAB2(K)
        STOTAL(K) = SIG3(K)
    691   CONTINUE
ELSEIF (MTH.EQ.2) THEN
    DO 692 K = 1, KOUT
        IF (ETAB2(K).NE.SEN(K)) THEN
            PRINT *, 'STOP **ERROR** ENERGY MISMATCH'
            WRITE(OTAPE, *) 'STOP **ERROR** ENERGY MISMATCH'
            STOP
        ENDIF
        SELAST(K) = SIG3(K)
    692   CONTINUE
ELSEIF (MTH.EQ.102) THEN
    DO 693 K = 1, KOUT
        IF (ETAB2(K).NE.SEN(K)) THEN
            PRINT *, 'STOP **ERROR** ENERGY MISMATCH'
            WRITE(OTAPE, *) 'STOP **ERROR** ENERGY MISMATCH'
            STOP
        ENDIF
        SCAPTR(K) = SIG3(K)
    693   CONTINUE
ENDIF
!CHO
CALL POINTO(ETAB2, SIG3, KOUT)
IPOINT = IPOINT + NPAGE
IF(IPOINT.LE.NPOINT) GO TO 680
!-----ADD SEND LINE.
CALL OUTS(MATH, MFH)
!-----PRINT WARNING IF CROSS SECTION IS NEGATIVE.
700 IF(MINUS3.GT.0) WRITE(OUTP, 940) MINUS3
IF(MINUS3.GT.0) WRITE(*, 940) MINUS3
!-----PRINT WARNING MESSAGE IF CROSS SECTION IS NOT POSITIVE AT ANY ENER
!-----END OF REACTION LOOP.
IF(IMPLUS.LE.0) WRITE(OUTP, 950)
IF(IMPLUS.LE.0) WRITE(*, 950)
710 CONTINUE
!CHO
WRITE(OTAPE, '(A1,2X,A6,9X,A5,7X,A7,6X,A7)') '#', 'ENERGY', &
        'TOTAL', 'ELASTIC', 'CAPTURE'
DO 712 K = 1, KOUT
    WRITE(OTAPE, '(1X,E12.6,1X,E12.6,1X,E12.6,1X,E12.6)') SEN(K), &
            STOTAL(K), SELAST(K), SCAPTR(K)
712 CONTINUE
!CHO
WRITE(OUTP, 920)
WRITE(*, 920)
!
!     ALL RESONANCE REACTIONS HAVE BEEN OUTPUT. TEST FOR CURRENT STATUS
!     MF3END=-1 - STILL IN FILE 3. RESTORE LAST LINE READ, OUTPUT AND
!                 COPY TO END OF FILE 3.
!           = 0 - STILL IN FILE 3. COPY TO END OF FILE 3.
!           = 1 - END OF FILE 3 READ. OUTPUT FEND LINE.
!           = 2 - PAST END OF FILE READ. OUTPUT FEND LINE. RESTORE LAST
!                 LINE AND OUTPUT.
!     IF ALL CASES COPY REMAINDER OF MAT.
!
IF(MF3END) 730, 750, 720
720 IF(MF3END - 1) 750, 760, 770
!-----STILL IN FILE 3. RESTORE LAST LINE READ AND OUTPUT.
730 C1H = SAVE1(1)
C2H = SAVE1(2)
DO 740 I = 1, 7
740 IHEAD(I) = ISAVE1(I)
CALL CONTO
!-----STILL IN FILE 3. COPY TO END OF FILE 3.
750 CALL COPYF
GO TO 790
!-----END OF FILE 3 REACHED. OUTPUT FEND.
760 CALL OUTF(MATH)
GO TO 790
!-----PAST END OF FILE 3. OUTPUT FEND. RESTORE AND OUTPUT LAST LINE.
770 CALL OUTF(MATH)
C1H = SAVE1(1)
C2H = SAVE1(2)
DO 780 I = 1, 7
780 IHEAD(I) = ISAVE1(I)
CALL CONTO
!-----IF LAST LINE WAS MEND THERE IS NOTHING ELSE TO DO.
IF(MATH.LE.0) GO TO 800
!-----COPY REMAINDER OF MAT.
790 CALL COPYM
!-----PRINT RUNNING TIME
800 CALL TIMER
RETURN
810 FORMAT(' Combining File 2 and File 3 Data'/1X, 78('=')/&
        ' Reaction  File 2  File 3  Combined'/&
        '           Points  Points    Points Comments'/1X, 78('='))
820 FORMAT(1X, 78('=')/' Edit of File 3 Data'/1X, 78('=')/&
        ' Reaction  File 3'/&
        '           Points Comments'/1X, 78('='))
830 FORMAT(1X, 2A4, 8X, ' No Background.')
840 FORMAT(1X, 2A4, 2I8, I10)
850 FORMAT(1X, 2A4, I8)
860 FORMAT(1X, 2A4, 2I8, I10, ' Background is Zero at ALL Energies.')
870 FORMAT(1X, 2A4, 2I8, I10, ' No Background. Output Resonance Part.')
880 FORMAT(1X, 2A4, 2I8, I10, ' Background T=', 11A1, ' Kelvin.'/&
        1X, 7('WARNING...'), 'WARNING'/&
        35X, ' Cannot Combine 0 Kelvin Resonance and Hot Background.'/&
        35X, ' Will Only Output Resonance Contribution.')
890 FORMAT(1X, 2A4, 2I8, I10, ' Background NOT Linear-Linear'/&
        35X, '   NBT   INT'/(35X, 2I6))
900 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
        35X, ' Cannot Combine Resonance and Background.'/&
        35X, ' Background MUST be Linearized.'/&
        35X, ' Will ONLY Output Resonance Contribution.')
910 FORMAT(1X, 2A4, 2I8, I10, ' No Background. No Output (as per Input', &
        ' Parameter)')
920 FORMAT(1X, 78('='))
930 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
        1X, 2A4, 2I8, I10, ' All Fission Widths are Zero.'/&
        35X, ' WilL Output Background Cross Section.')
940 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
        35X, ' Above Cross Section is Negative at', I6, ' Energies.')
950 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
        35X, ' Above Cross Section is NOT Positive at ANY Energy')
960 FORMAT(25X, I10, 11A1, ' to', 11A1, ' eV Finished')
970 FORMAT(1X, 2A4, I8, ' Background Temperature=', 11A1, &
        ' Kelvin.'/&
        1X, 7('WARNING...'), 'WARNING'/&
        35X, ' Cannot Combine 0 Kelvin Resonance and Hot Background.'/&
        35X, ' Will Only Output Resonance Contribution.')
980 FORMAT(1X, 2A4, I8, ' Background NOT Linear-Linear'/&
        15X, '   NBT   INT'/(15X, 2I6))
990 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
        35X, ' Cannot Combine Resonance and Background.'/&
        35X, ' Background MUST be Linearized.'/&
        35X, ' Will ONLY Output Resonance Contribution.')
END
SUBROUTINE RDBW
    !=======================================================================
    !
    !     READ BREIT-WIGNER SINGLE OR MULTI LEVEL DATA FOR ONE ENERGY RANGE.
    !     EACH L STATE WILL BE TREATED AS A SEPERATE SECTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    CHARACTER*4 COMHOL
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/TABRHO/ERHOTB(500), RHOTAB(500), APTAB(500), NRHO(200), &
            NBTRHO(200), INTRHO(200), INXRHO(4, 200), NUMRHO
    COMMON/NAPNRO/NRO, NAPS
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/RANGER/LOW, LHI
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/INDATD/ELX, EHX
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION COMHOL(7, 3)
    DATA COMHOL/&
            '(No ', 'Comp', 'etit', 'ive ', 'Widt', 'hs) ', '    ', &
            '(Com', 'peti', 'tive', ' Wid', 'ths ', 'Give', 'n)  ', &
            '(ERR', 'OR-M', 'UST ', 'be 0', ' or ', '1)  ', '    '/
    DATA C3/1.23D-01/
    DATA C5/8.0D-02/
    !-----UPDATED NOV. 12, 1998 AS PER CSEWG SUBCOMMITTEE RECOMMENDATION
    DATA C4/1.008664904D+00/
    DATA C6/2.196807122623D-03/
    !-----DEFINE TARGET SPIN, SPIN UP SCATTERING RADIUS AND NUMBER OF L
    !-----STATES.
    CALL CARDIO(SPI, AP, L1, L2, NLS, N2)
    IF(IMEDIT.EQ.0) GO TO 20
    CALL OUT9(SPI, FIELD(1, 1), 0)
    IF(NRO.EQ.0) GO TO 10
    WRITE(OUTP, 160) (FIELD(M, 1), M = 1, 11), NLS
    WRITE(*, 160) (FIELD(M, 1), M = 1, 11), NLS
    GO TO 20
    10 CALL OUT9(AP, FIELD(1, 2), 0)
    WRITE(OUTP, 170) ((FIELD(M, I), M = 1, 11), I = 1, 2), NLS
    WRITE(*, 170) ((FIELD(M, I), M = 1, 11), I = 1, 2), NLS
    !
    !     L STATE LOOP.
    !
    20 DO 150 IL = 1, NLS
        !-----DEFINE ATOMIC WEIGHT RATIO, Q VALUE FOR COMPETITIVE REACTION,
        !-----L VALUE, COMPETITIVE REACTION FLAG AND NUMBER OF RESONANCES.
        CALL CARDIO(AWRI, QX, LNOW, LRX, NRS6X, NRS)
        IF(IMEDIT.EQ.0) GO TO 30
        LRXOUT = LRX + 1
        IF(LRX.LT.0.OR.LRX.GT.1) LRXOUT = 3
        CALL OUT9(AWRI, FIELD(1, 1), 0)
        CALL OUT9(QX, FIELD(1, 2), 0)
        WRITE(OUTP, 180) ((FIELD(M, I), M = 1, 11), I = 1, 2), &
                LNOW, LRX, (COMHOL(K, LRXOUT), K = 1, 7), NRS
        WRITE(*, 180) ((FIELD(M, I), M = 1, 11), I = 1, 2), &
                LNOW, LRX, (COMHOL(K, LRXOUT), K = 1, 7), NRS
        !
        !     CONSTRUCT TABLE OF PERMISSIBLE J-VALUES
        !     (THIS TABLE WILL BE USED TO CHECK FOR MISSING OR ILLEGAL J-VALUES)
        !
        30 CALL SETJ(LNOW)
        !-----INITIALIZE FLAGS TO CHECK COMPETITIVE WIDTHS.
        LRXIN = 0
        LRXNEG = 0
        !-----INCREMENT SECTION COUNT AND INDICES TO RESONANCE PARAMETER TABLE.
        CALL LIMIT1(1)
        !-----DEFINE ALL PARAMETERS FOR A SECTION.
        AWRICM = AWRI / (AWRI + ONE)
        !-----EITHER CALCULATE CHANNEL RADIUS OR DEFINE TO BE EQUAL TO THE
        !-----SCATTERING RADIUS.
        IF(NAPS.NE.0) GO TO 40
        APX = C3 * ((C4 * AWRI)**(ONE / THREE)) + C5
        GO TO 50
        40 APX = AP
        50 AK1 = C6 * AWRICM
        AK2 = AK1 * AK1
        BETA(NSECT) = PI * ABN / AK2
        RHOX2(NSECT) = APX * APX * AK2
        RHOP1(NSECT) = AP * AK1
        EL(NSECT) = ELX
        EH(NSECT) = EHX
        EXCITE(1, NSECT) = QX / AWRICM
        NLOW(NSECT) = LOW
        NHIGH(NSECT) = LHI
        LVALUE(NSECT) = LNOW
        LRXTAB(NSECT) = LRX
        NAPTAB(NSECT) = NAPS
        MODE(NSECT) = LRF
        !-----IF ENERGY DEPENDENT SCATTERING RADIUS DEFINE INDEX TO TABULATED
        !-----DATA (OTHERWISE INDEX HAS ALREADY BEEN INITIALIZED TO 0).
        !-----CALCULATE ENERGY DEPENDENT RHOP FROM SCATTERING RADII.
        IF(NRO.EQ.0) GO TO 70
        NRHO(NSECT) = NUMRHO
        INX3 = INXRHO(3, NUMRHO)
        INX4 = INXRHO(4, NUMRHO)
        DO 60 I = INX3, INX4
        60 RHOTAB(I) = APTAB(I) * AK1
        !
        !     READ RESONANCE PARAMETERS (6 PER RESONANCE).
        !
        !     (1) ENERGY
        !     (2) J
        !     (3) TOTAL WIDTH
        !     (4) NEUTRON WIDTH
        !     (5) CAPTURE WIDTH
        !     (6) FISSION WIDTH
        !
        !     SOME OF THESE PARAMETERS WILL BE CONVERTED TO THE FORM REQUIRED
        !     FOR CALCULATIONS.
        !
        !     (2) STATISTICAL WEIGHT, GJ (J NOT NEEDED)
        !     (3) COMPETITIVE WIDTH DIVIDED BY PENETRATION FACTOR (TOTAL WIDTH
        !         NOT NEEDED)
        !     (4) NEUTRON WIDTH DIVIDED BY PENETRATION FACTOR (NEUTRON WIDTH IS
        !         ONLY USED IN A FORM DIVIVED BY THE PENETRATION FACTOR).
        !
        70 CALL LISPAR(LOW, NRS6X, 6)
        IF(IMEDIT.EQ.0) GO TO 80
        IF(LRF.EQ.1) WRITE(OUTP, 190)
        IF(LRF.EQ.2) WRITE(OUTP, 200)
        IF(LRF.EQ.1) WRITE(*, 190)
        IF(LRF.EQ.2) WRITE(*, 200)
        !-----FOR EACH SECTION (ISOTOPE, ENERGY RANGE, L VALUE) SORT
        !-----RESONANCES IN ASCENDING (J, E) ORDER.
        80 CALL ORDER(LOW, LHI)
        AJNOW = RESTAB(2, LOW)
        !-----CHECK FOR LEGAL J-VALUE AND DEFINE STATISTICAL WEIGHT.
        CALL CHECKJ(AJNOW, LNOW, GJ, LRF)
        DO 140 JR = LOW, LHI
            !-----IF FISSION WIDTH IS NOT ZERO TURN ON FISSILE FLAG.
            IF(DABS(RESTAB(6, JR)).NE.0.0) LFWX = 1
            !-----INSERT DIVIDING LINE BETWEEN DIFFERENT J VALUES.
            IF(DABS(AJNOW - RESTAB(2, JR)).LE.0.01) GO TO 90
            AJNOW = RESTAB(2, JR)
            !-----CHECK FOR LEGAL J-VALUE AND DEFINE STATISTICAL WEIGHT.
            CALL CHECKJ(AJNOW, LNOW, GJ, LRF)
            IF(IMEDIT.NE.0) WRITE(OUTP, 220)
            !-----SEE IF TOTAL EQUALS ELASTC + CAPTURE + FISSION.
            90 GAMC = RESTAB(3, JR) - (RESTAB(4, JR) + RESTAB(5, JR) + RESTAB(6, JR))
            !-----IF DIFFERENCE IS VERY SMALL COMPARED TO TOTAL SET IT TO ZERO.
            IF(DABS(GAMC).LE.0.00001 * RESTAB(3, JR)) GAMC = 0.0
            !-----CHECK FOR NEGATIVE DIFFERENCES AND SIGNIFICANT POSITIVE DIFFERENCE
            IF(GAMC.LT.0.0) LRXNEG = LRXNEG + 1
            IF(GAMC.NE.0.0) LRXIN = LRXIN + 1
            !-----LIST RESONANCE PARAMETERS.
            IF(IMEDIT.EQ.0) GO TO 110
            II3 = 3
            DO 100 I = 1, 6
                CALL OUT9(RESTAB(I, JR), FIELD(1, I), II3)
            100 II3 = 0
            CALL OUT9(GAMC, FIELD(1, 7), 0)
            WRITE(OUTP, 210) (FIELD(M, 1), M = 1, 11), RESTAB(2, JR), &
                    ((FIELD(M, I), M = 1, 11), I = 3, 7)
            !-----REPLACE J VALUE BY STATISTICAL WEIGHT.
            110 RESJTAB(JR) = RESTAB(2, JR)
            RESTAB(2, JR) = GJ
            !-----DEFINE COMPETITIVE WIDTH DIVIDED BY PENETRATION FACTOR.
            !-----(WILL REPLACE TOTAL WIDTH IN RESTAB).
            IF(LRX.LE.0) GO TO 120
            !-----IF NEGATIVE OR ZERO COMPETITIVE WIDTH SET IT TO ZERO.
            IF(GAMC.LE.0.0) GO TO 120
            RHOC2 = DABS(RESTAB(1, JR) + EXCITE(1, NSECT)) * RHOX2(NSECT)
            CALL FACTS2(LVALUE(NSECT), RHOC2, SHIFT2(JR), PENFAC)
            RESTAB(3, JR) = GAMC / PENFAC
            GO TO 130
            120 RESTAB(3, JR) = 0.0
            !-----DEFINE NEUTRON WIDTH DIVIDED BY PENETRATION FACTOR.
            130 RHO2X = DABS(RESTAB(1, JR)) * RHOX2(NSECT)
            CALL FACTS2(LVALUE(NSECT), RHO2X, SHIFT2(JR), PENFAC)
            RESTAB(4, JR) = RESTAB(4, JR) / PENFAC
        140 CONTINUE
        !-----PRINT ERROR MESSAGES IF WIDTHS DO NOT ADD UP OR COMPETITIVE
        !-----WIDTHS ARE NEGATIVE, OR LRX=0 AND ALL COMPETITIVE WIDTHS ARE
        !-----ZERO.
        IF(LRX.EQ.0.AND.LRXIN.GT.0) WRITE(OUTP, 230) LRXIN
        IF(LRX.EQ.1.AND.LRXNEG.GT.0) WRITE(OUTP, 240) LRXNEG
        IF(LRX.EQ.1.AND.LRXIN.EQ.0) WRITE(OUTP, 250)
        !-----IF NO POSITIVE COMPETITIVE WIDTHS SET FLAG OFF.
        IF(LRXIN.EQ.0) LRXTAB(NSECT) = 0
        !
        !     FOR MULTI-LEVEL PARAMETERS PRINT WARNING IF ANY J SEQUENCES ARE
        !     MISSING AND ADD MISSING J SEQUENCE WITH NO RESONANCES IN ORDER TO
        !     ALLOW POTENTIAL SCATTERING TO BE CORRECTLY CALCULATED.
        !
        IF(LRF.EQ.2) CALL ADDJ(LNOW)
        !-----END OF L STATE LOOP.
    150 CONTINUE
    RETURN
    160 FORMAT(1X, 78('=')/&
            ' Nuclear Spin of Target---------------', 11A1/&
            ' Energy Dependent Scattering Radius---(LISTED ABOVE)'/&
            ' Number of L Values-------------------', I11)
    170 FORMAT(1X, 78('=')/&
            ' Nuclear Spin of Target---------------', 11A1/&
            ' Effective Scattering Radius (A+)-----', 11A1/&
            ' Number of L Values-------------------', I11)
    180 FORMAT(1X, 78('=')/&
            ' Atomic Weight Ratio of Isotope-------', 11A1/&
            ' Competitive Reaction Q Value---------', 11A1, ' eV'/&
            ' Angular Momentum (L)-----------------', I11/&
            ' LRX (Competitive Widths)-------------', I11, 1X, 7A4/&
            ' Number of Resonances-----------------', I11)
    190 FORMAT(1X, 78('=')/' Single Level Breit-Wigner', &
            ' Resonance Parameters'/1X, 78('=')/&
            '      Energy  J Value      Total    Neutron', &
            '    Capture    Fission Competition'/&
            8X, '(eV)', 9X, 4(7X, '(eV)'), 8X, '(eV)'/1X, 78('='))
    200 FORMAT(1X, 78('=')/' Multi-Level Breit-Wigner', &
            ' Resonance Parameters'/1X, 78('=')/&
            '      Energy  J Value      Total    Neutron', &
            '    Capture    Fission Competition'/&
            8X, '(eV)', 9X, 4(7X, '(eV)'), 8X, '(eV)'/1X, 78('='))
    210 FORMAT(1X, 11A1, F7.2, 2X, 44A1, 1X, 11A1)
    220 FORMAT(1X, 78('-'))
    230 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' LRX=0 IndicateS ALL Competitive Widths Should be Zero and'/&
            ' Data Should have Total Width = (Elastic+Capture+Fission).'/&
            I5, ' Resonances do NOT Satisfy this Condition.'/&
            ' This Program will Assume that LRX is Correct and that ALL'/&
            ' Competitive Widths are Zero and will Define the Total Width'/&
            ' to be the Sum of Elastic+Capture+Fission for ALL Resonances.'/&
            ' Check Evaluated Data. Correct Either Sum of Widths or LRX.')
    240 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' LRX=1 Indicates Competitive Widths Present.'/&
            I5, ' Competitive Widths are Negative.'/&
            ' Will Set ALL Negative Competitive Widths Equal to Zero.'/&
            ' Check Evaluated Data. Correct Either Sum of Widths or LRX.')
    250 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' LRX=1 Indicates Competitive Widths Present.'/&
            ' There are NO Positive Competitive Widths.'/&
            ' Will Assume Competitive Widths are ALL Zero.'/&
            ' Check Evaluated Data. Correct Either Sum of Widths or LRX.')
END
SUBROUTINE GJWAIT(SPI, AJ, GJ)
    !=======================================================================
    !
    !     DEFINE STATISTICAL WEIGHT BASED ON S AND J.
    !
    !     NOTE - THIS SHOULD BE THE ONLY PLACE IN THE PROGRAM THAT DEFINES
    !            STATISTICAL WEIGHTS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    GJ = (TWO * AJ + ONE) / (FOUR * SPI + TWO)
    RETURN
END
SUBROUTINE SETJ(LNOW)
    !=======================================================================
    !
    !     USE CHANNEL SPIN AND L VALUE TO DEFINE TABLE OF LEGAL J VALUES
    !     AND STATISTICAL WEIGHTS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/JFIX/GJSET(50), GJBAD, TABJ(50), JOK(50), JMISS, NUMJ, IGJBAD
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    !-----INITIALIZE SUM OF STATISTICAL WEIGHTS.
    CALL SUMJ(GJBAD, LNOW, 1)
    !-----CHANNEL SPIN I+0.5 FIRST
    NUMJ = 1
    ELL = LNOW
    CHSPIN = SPI + 0.5D+00
    TABJ(NUMJ) = DABS(CHSPIN - ELL)
    ENDJ = CHSPIN + ELL
    10 IF(TABJ(NUMJ).EQ.ENDJ) GO TO 20
    TABJ(NUMJ + 1) = TABJ(NUMJ) + 1.0D+00
    NUMJ = NUMJ + 1
    GO TO 10
    !-----CHANNEL SPIN I-0.5 NEXT.
    20 IF(SPI.EQ.0.0) GO TO 40
    NUMJ = NUMJ + 1
    CHSPIN = DABS(SPI - 0.5D+00)
    TABJ(NUMJ) = DABS(CHSPIN - ELL)
    ENDJ = CHSPIN + ELL
    30 IF(TABJ(NUMJ).EQ.ENDJ) GO TO 40
    TABJ(NUMJ + 1) = TABJ(NUMJ) + 1.0
    NUMJ = NUMJ + 1
    GO TO 30
    !-----SORT J VALUES INTO ASCENDING ORDER, ELIMINATE DUPLICATES AND
    !-----DEFINE STATISTIC WEIGHTS.
    40 IF(NUMJ.GT.1) CALL SORTS(TABJ, NUMJ)
    NUMIN = 0
    !-----INITIALIZE ERROR MESSAGE COUNT
    MYERROR = 0
    DO 80 I = 1, NUMJ
        IF(I.EQ.1) GO TO 60
        DO 50 II = 1, NUMIN
            IF(DABS(TABJ(II) - TABJ(I)).LT.0.01) GO TO 70
        50 CONTINUE
        60 NUMIN = NUMIN + 1
        TABJ(NUMIN) = TABJ(I)
        JOK(NUMIN) = 0
        !-----DEFINE STATISTICAL WEIGHT.
        AJ = TABJ(NUMIN)
        CALL GJWAIT(SPI, AJ, GJSET(NUMIN))
        GO TO 80
        !-----DUPLICATE J VALUE. ONLY ADD POTENTIAL IF OPTION IS TURNED ON
        !-----AND THESE ARE NOT SINGLE LEVEL PARAMETERS.
        70 IF(LRF.EQ.1) GO TO 80
        !-----PRINT WARNING BEFORE FIRST ERROR MESSAGE
        IF(MYERROR.EQ.0) WRITE(OUTP, 90)
        MYERROR = MYERROR + 1
        WRITE(OUTP, 100) LNOW, TABJ(I)
    80 CONTINUE
    !-----PRINT FINAL LINE IF ANY ERROR MESSAGES
    IF(MYERROR.GT.0) WRITE(OUTP, 110)
    NUMJ = NUMIN
    RETURN
    90 FORMAT(1X, 78('-')/1X, 7('WARNING...'), 'WARNING')
    100 FORMAT(&
            ' L=', I2, ' J =', F7.3, ' Corresponds to 2 Resonance Sequences.')
    110 FORMAT(1X, 78('-'))
END
SUBROUTINE SUMJ(GJNOW, LNOW, MYWAY)
    !=======================================================================
    !
    !     EITHER,
    !     MYWAY = 1 - INITIALIZE SUM OF STATISICAL WEIGHTS (GJ)
    !           = 2 - ADD GJ TO SUM
    !           = 3 - COMPARE SUM TO (2*L+1) AND PRINT WARNING IF THEY
    !                 DO NOT AGREE.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/FIXPOT/MYPOT
    COMMON/JFIX/GJSET(50), GJBAD, TABJ(50), JOK(50), JMISS, NUMJ, IGJBAD
    GO TO (10, 20, 30), MYWAY
    !-----INITIALIZE SUM.
    10 GJSUM = 0.0
    RETURN
    !-----ADD TO SUM
    20 GJSUM = GJSUM + GJNOW
    RETURN
    !-----COMPARE SUM TO (2*L+1). PRINT ERROR MESSAGE IF MORE THAN 1
    !-----PER-CENT DISAGREEMENT.
    30 GJWANT = 2 * LNOW + 1
    IF(DABS(GJWANT - GJSUM).LE.0.01 * GJWANT) GO TO 50
    WRITE(OUTP, 60) LNOW, GJWANT, GJSUM
    !-----IF REQUESTED ADD MISSING SEQUENCES
    IF(MYPOT.EQ.0) GO TO 40
    WRITE(OUTP, 70)
    IGJBAD = 1
    GJBAD = GJWANT - GJSUM
    RETURN
    !-----OTHERWISE, DO NOT ADD SEQUENCES
    40 WRITE(OUTP, 80)
    50 IGJBAD = 0
    GJBAD = 0.0
    RETURN
    60 FORMAT(1X, 78('-')/1X, 7('WARNING...'), 'WARNING'/&
            ' FOR L =', I3, ' Expect Sum of Statistical Weights (GJ) to Equal'/&
            ' (2*L + 1) =', F7.3/&
            ' Found     =', F7.3)
    70 FORMAT(&
            ' Corrective Action Will be Taken to Correctly Calculate'/&
            ' the Potential Scattering Cross Section - This Procedure is'/&
            ' Based on the Decision of the National Nuclear Data Center,'/&
            ' Brookhaven National Laboratory, Private Communication,'/&
            ' Charles Dunford, (April 1991)')
    80 FORMAT(&
            ' No Corrective Action Taken - Based on Input Parameter')
END
SUBROUTINE CHECKJ(AJNOW, LNOW, GJ, MYWAY)
    !=======================================================================
    !
    !     DEFINE GJ AND CHECK J VALUE AGAINST TABLE OF LEGAL VALUES.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/JFIX/GJSET(50), GJBAD, TABJ(50), JOK(50), JMISS, NUMJ, IGJBAD
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/FIXPOT/MYPOT
    !-----99/06/18 - UPDATED FOR NEW REICH-MOORE CONVENTION
    AJPLUS = DABS(AJNOW)
    !-----DEFINE STATISTICAL WEIGHT.
    CALL GJWAIT(SPI, AJPLUS, GJ)
    !-----ADD TO SUM OF WEIGHTS.
    CALL SUMJ(GJ, LNOW, 2)
    !
    !     DO NOT CHECK SINGLE LEVEL J VALUE - AVERAGE J VALUE ALLOWED.
    !
    IF(MYWAY.NE.2) GO TO 30
    !-----CHECK J VALUE.
    DO 10 I = 1, NUMJ
        IF(DABS(AJPLUS - TABJ(I)).LE.0.01) GO TO 20
    10 CONTINUE
    WRITE(OUTP, 40) LNOW, AJPLUS
    !-----ONLY CORRECT POTENTIAL IF OPTION IS ON
    IF(MYPOT.LE.0) GO TO 30
    GO TO 30
    !-----INDICATE THAT J SEQUENCE HAS BEEN FOUND.
    20 JOK(I) = 1
    30 RETURN
    40 FORMAT(1X, 78('-')/1X, 7('WARNING...'), 'WARNING'/&
            ' Based on Target Spin and L=', I2, ' J =', F7.3, &
            ' is NOT Physically Possible.'/&
            ' The Use of Fictitious J Values is NOT Allowed in ENDF/B.'/&
            ' Cross Sections Obtained from these Parameters will be', &
            ' Unreliable.'/&
            ' Correct Evaluation Before Attempting Reconstruction.'/&
            1X, 78('-'))
END
SUBROUTINE ADDJ(LNOW)
    !=======================================================================
    !
    !     IF NECESSARY ADD SECTION FOR MISSING J VALUES, ONLY IF
    !     MYPOT = 1
    !
    !     CHECK SUM OF STATISTICAL WEIGHTS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/JFIX/GJSET(50), GJBAD, TABJ(50), JOK(50), JMISS, NUMJ, IGJBAD
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/FIXPOT/MYPOT
    COMMON/TABRHO/ERHOTB(500), RHOTAB(500), APTAB(500), NRHO(200), &
            NBTRHO(200), INTRHO(200), INXRHO(4, 200), NUMRHO
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    JMISS = 0
    DO 20 J = 1, NUMJ
        IF(JOK(J).GT.0) GO TO 20
        !-----PRINT TITLE BEFORE FIRST MISSING J VALUE.
        IF(JMISS.GT.0) GO TO 10
        JMISS = 1
        WRITE(OUTP, 50) LNOW
        !-----MISSING J-VALUE. INCREMENT BAD J SEQUENCE COUNT AND ADD
        !-----STATISTICAL WEIGHT.
        10 WRITE(OUTP, 60) TABJ(J)
        !-----ONLY IF OPTION IS ON.
        IF(MYPOT.LE.0) GO TO 20
    20 CONTINUE
    IF(JMISS.LE.0) GO TO 30
    WRITE(OUTP, 70)
    30 CALL SUMJ(GJNOW, LNOW, 3)
    IF(IGJBAD.EQ.0.OR.MYPOT.LE.0) GO TO 40
    !-----MISSING OR ILLEGAL J SEQUENCES. ADD ADDITIONAL SECTION WITH NO
    !-----RESONANCES TO ALLOW POTENTIAL CROSS SECTION TO BE CORRECTLY
    !-----CALCULATED.
    NRS = 1
    CALL LIMIT1(1)
    RESJTAB(LHI) = -1000.0
    RESTAB(2, LHI) = -1.0
    RESTAB(3, LHI) = GJBAD
    GJTAB(NSECT) = -1.0
    NLOW(NSECT) = LOW
    NHIGH(NSECT) = LHI
    !-----ALL REMAINING SECTION PARAMETERS ARE IDENTICAL TO PRECEDING
    !-----SECTION.
    NSM1 = NSECT - 1
    BETA(NSECT) = BETA(NSM1)
    RHOX2(NSECT) = RHOX2(NSM1)
    RHOP1(NSECT) = RHOP1(NSM1)
    EL(NSECT) = EL(NSM1)
    EH(NSECT) = EH(NSM1)
    LVALUE(NSECT) = LVALUE(NSM1)
    NAPTAB(NSECT) = NAPTAB(NSM1)
    MODE(NSECT) = MODE(NSM1)
    !-----VERSION 94-2 - ADDED MISSING SECTION PARAMETERS.
    EXCITE(1, NSECT) = EXCITE(1, NSM1)
    LRXTAB(NSECT) = LRXTAB(NSM1)
    NRHO(NSECT) = NRHO(NSM1)
    40 RETURN
    50 FORMAT(1X, 78('-')/1X, 7('WARNING...'), 'WARNING'/&
            ' for L=', I2, ' The Following J Sequences are Missing.')
    60 FORMAT(' J =', F8.2)
    70 FORMAT(1X, 78('-'))
END
SUBROUTINE RDAP
    !=======================================================================
    !
    !     READ, WRITE AND SAVE ENERGY DEPENDENT SCATTERING RADIUS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    CHARACTER*4 TYPINT
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/TABRHO/ERHOTB(500), RHOTAB(500), APTAB(500), NRHO(200), &
            NBTRHO(200), INTRHO(200), INXRHO(4, 200), NUMRHO
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/LASTE/ELAST
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/FIELDC/FIELD(11, 12)
    DIMENSION TYPINT(4, 6)
    !-----DEFINE SIZE OF INTERPOLATION LAW AND TABULATED DATA ARRAYS.
    DATA MAXINT/200/
    DATA MAXTAB/500/
    DATA TYPINT/&
            '(His', 'togr', 'am) ', '    ', &
            '(Lin', ' X-L', 'in Y', ')   ', &
            '(Log', ' X-L', 'in Y', ')   ', &
            '(Lin', ' X-L', 'og Y', ')   ', &
            '(Log', ' X-L', 'og Y', ')   ', &
            '(ERR', 'OR) ', '    ', '    '/
    !-----READ TAB1 LEADER LINE AND INTERPOLATION LAW.
    CALL CARDI(C1, C2, L1, L2, N1, N2)
    CALL CARDO(C1, C2, L1, L2, N1, N2)
    !-----INCREMENT NUMBER OF ENERGY RANGES WITH ENERGY DEPENDENT SCATTERING
    !-----RADIUS AND DEFINE INDICES TO INTERPOLATION LAW AND TABULATED DATA.
    NUMRHO = NUMRHO + 1
    IF(NUMRHO.GT.1) GO TO 10
    INXRHO(1, 1) = 1
    INXRHO(3, 1) = 1
    GO TO 20
    10 INXRHO(1, NUMRHO) = INXRHO(2, NUMRHO - 1) + 1
    INXRHO(3, NUMRHO) = INXRHO(4, NUMRHO - 1) + 1
    20 INXRHO(2, NUMRHO) = INXRHO(1, NUMRHO) + N1 - 1
    INXRHO(4, NUMRHO) = INXRHO(3, NUMRHO) + N2 - 1
    INX1 = INXRHO(1, NUMRHO)
    INX2 = INXRHO(2, NUMRHO)
    INX3 = INXRHO(3, NUMRHO)
    INX4 = INXRHO(4, NUMRHO)
    !-----TEST FOR TABLE OVERFLOW.
    IF(INX2.LE.MAXINT.AND.INX4.LE.MAXTAB) GO TO 30
    WRITE(OUTP, 190) INX2, MAXINT, INX4, MAXTAB
    CALL ENDIT
    !-----READ AND CHECK INTERPOLATION LAW.
    30 CALL TERPI(NBTRHO(INX1), INTRHO(INX1), N1)
    CALL TERPO(NBTRHO(INX1), INTRHO(INX1), N1)
    !-----PRINT TITLE IN EDIT MODE.
    IF(IMEDIT.GT.0) WRITE(OUTP, 120) N1, N2
    IF(N1.LE.0) GO TO 80
    NBTLST = 0
    IERAP = 0
    DO 70 I = INX1, INX2
        II = INTRHO(I)
        IF(II.LT.1.OR.II.GT.5) GO TO 40
        IF(NBTRHO(I) - NBTLST) 50, 50, 60
        40 II = 6
        50 IERAP = 1
        60 IF(IMEDIT.GT.0) WRITE(OUTP, 130) I, NBTRHO(I), II, &
                (TYPINT(J, II), J = 1, 4)
    70 NBTLST = NBTRHO(I)
    IF(IERAP.EQ.0.AND.N2.GT.1.AND.NBTRHO(INX2).EQ.N2) GO TO 90
    !-----ERROR IN SCATTERING RADIUS INTERPOLATION LAW.
    80 WRITE(OUTP, 140)
    IF(IMEDIT.EQ.0) WRITE(OUTP, 150)
    CALL ENDIT
    !-----READ AND CHECK TABULATED ENERGY DEPENDENT SCATTERING RADIUS.
    90 ELAST = 0.0
    CALL POINTI(ERHOTB(INX3), APTAB(INX3), N2)
    CALL POINTO(ERHOTB(INX3), APTAB(INX3), N2)
    IF(IMEDIT.GT.0) WRITE(OUTP, 160)
    IERAP = 0
    DO 100 I = INX3, INX4
        IF(APTAB(I).LE.0.0) IERAP = 1
        IF(IMEDIT.EQ.0) GO TO 100
        CALL OUT9(ERHOTB(I), FIELD(1, 1), 3)
        CALL OUT9(APTAB (I), FIELD(1, 2), 0)
        WRITE(OUTP, 170) I, ((FIELD(M, J), M = 1, 11), J = 1, 2)
    100 CONTINUE
    IF(IERAP.EQ.0) GO TO 110
    WRITE(OUTP, 180)
    CALL ENDIT
    110 RETURN
    120 FORMAT(1X, 78('=')/&
            ' Energy Dependent Scattering Radius Interpolation Law'/&
            1X, 78('=')/&
            I5, ' Interpolation Ranges'/&
            I5, ' Tabulated Values'/&
            1X, 78('=')/' Interpolation Law'/1X, 78('=')/&
            ' Index  Boundary       Law'/1X, 78('='))
    130 FORMAT(I6, 2I10, 1X, 4A4)
    140 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Energy Dependent Scattering Radius Interpolation Law Error'/&
            1X, 78('=')/&
            ' Number of Regions (N1) MUST be Positive'/&
            ' Number of Energies (N2) MUST be 2 or More'/&
            ' Interpolation Region Boundaries MUST be in Ascending Order'/&
            ' Interpolation Law MUST be 1 to 5'/&
            ' Last Region Boundary MUST be Equal to the Number of Points', &
            ' (N2)'/1X, 78('=')/' Execution Terminated.')
    150 FORMAT(//' Suggest You Re-Run in Edit Mode to Determine Error')
    160 FORMAT(1X, 78('=')/&
            ' Energy Dependent Scattering Radius'/1X, 78('=')/&
            ' Index      Energy      Radius'/&
            '             (eV)      (Fermi)'/1X, 78('='))
    170 FORMAT(I6, 1X, 11A1, 1X, 11A1)
    180 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Energy Dependent Scattering Law Error.'/&
            1X, 78('=')/&
            ' Energies MUST be Monotonically Increasing.'/&
            ' Scattering Radius MUST be Positive.'/&
            1X, 78('=')/' Execution Terminated.')
    190 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Energy Dependent Scattering Radius Table Overflow'/1X, 78('=')/&
            ' Interpolation Regions---', I6, ' (Cannot Exceed', I6, ')'/&
            ' Tabulated Energies------', I6, ' (Cannot Exceed', I6, ')'/&
            ' Increase Dimension in COMMON/TABRHO/ and Re-Run'/1X, 78('=')/&
            ' Execution Terminated.'/1X, 78('='))
END
SUBROUTINE RDRM
    !=======================================================================
    !
    !     READ REICH-MOORE DATA FOR ONE ENERGY RANGE.
    !     EACH L STATE WILL BE TREATED AS A SEPERATE SECTION.
    !
    !     THIS ROUTINE USES THE GENERAL REICH-MOORE FORMALISM WITH TWO
    !     FISSION CHANNELS AS DEFINED IN ENDF/B-IV. THIS ROUTINE WILL BE
    !     USED TO READ DATA IN ANY VERSION OF THE ENDF/B FORMAT (NOTE,
    !     THE ENDF/B-VI REICH-MOORE FORMAT HAS NOW BEEN UPDATED TO BE
    !     EXACTLY THE SAME AS EARLIER VERSIONS OF THE ENDF/B FORMAT).
    !
    !     CHECK FOR PRELIMINARY ENDF/B-VI FORMAT(NOW ABONDONED). TERMINATE
    !     EXECUTION IF DATA IS IN PRELIMINARY ENDF/B-VI FORMAT.
    !
    !     FIELD DEFINITIONS FOR EACH RESONANCE
    !
    !     FIELD          PRELIMINARY          CURRENT
    !                    ENDF/B-VI FORMAT     ENDF/B-VI FORMAT
    !     =====          ================     ================
    !       1            ENERGY               ENERGY
    !       2            J                    J
    !       3            TOTAL WIDTH          ELASTIC WIDTH
    !       4            ELASTIC WIDTH        CAPTURE WIDTH
    !       5            CAPTURE WIDTH        FISSION WIDTH 1
    !       6            NOT USED             FISSION WIDTH 2
    !                    (FISSION NOT
    !                    ALLOWED)
    !
    !     IF THIRD FIELD (PRELIMINARY TOTAL) IS EQUAL TO THE SUM OF THE
    !     FOURTH (PRELIMINARY ELASTIC) AND FIFTH (PRELIMINARY CAPTURE)
    !     AND SIXTH FIELD IS ZERO (FISSION NOT ALLOWED IN PRELIMINARY
    !     FORMAT) FOR ALL RESONANCES THIS PROGRAM WILL ASSUME THAT THE
    !     DATA IS IN THE PRELIMINARY REICH-MOORE FORMAT AND TERMINATE
    !     EXECUTION WITH A WARNING MESSAGE THAT THE DATA MUST BE CONVERTED
    !     TO THE CURRENT REICH-MOORE FORMAT BEFORE IT CAN BE PROCESSED.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/NAPNRO/NRO, NAPS
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/RANGER/LOW, LHI
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/INDATD/ELX, EHX
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DATA C3/1.23D-01/
    DATA C5/8.0D-02/
    !-----UPDATED NOV. 12, 1998 AS PER CSEWG SUBCOMMITTEE RECOMMENDATION
    DATA C4/1.008664904D+00/
    DATA C6/2.196807122623D-03/
    !-----DEFINE CONSTANT TO ALLOW UP TO 1 PER-CENT DIFFERENCE BETWEEN
    !-----TOTAL AND ELASTIC PLUS CAPTURE FOR TEST OF PRELIMINARY ENDF/B-VI
    !-----FORMAT.
    DATA ALLOW/0.01/
    !-----INITIALIZE FLAG TO INDICATE THAT DATA IS IN THE PRELIMINARY
    !-----ENDF/B-VI FORMAT.
    IMOLD = 1
    !-----DEFINE TARGET SPIN, SCATTERING RADIUS AND NUMBER OF L STATES.
    CALL CARDIO(SPI, AP, L1, L2, NLS, N2)
    IF(IMEDIT.EQ.0) GO TO 10
    CALL OUT9(SPI, FIELD(1, 1), 0)
    CALL OUT9(AP, FIELD(1, 2), 0)
    WRITE(OUTP, 140) ((FIELD(M, I), M = 1, 11), I = 1, 2), NLS
    WRITE(*, 140) ((FIELD(M, I), M = 1, 11), I = 1, 2), NLS
    !
    !     L STATE LOOP.
    !
    10 DO 120 IL = 1, NLS
        !-----DEFINE ATOMIC WEIGHT RATIO, L DEPENDENT SCATTERING RADIUS, L VALUE
        !-----AND NUMBER OF RESONANCES.
        CALL CARDIO(AWRI, APL, LNOW, L2, NRS6X, NRS)
        IF(IMEDIT.EQ.0) GO TO 20
        CALL OUT9(AWRI, FIELD(1, 1), 0)
        CALL OUT9(APL, FIELD(1, 2), 0)
        WRITE(OUTP, 150) ((FIELD(M, I), M = 1, 11), I = 1, 2), LNOW, NRS
        WRITE(*, 150) ((FIELD(M, I), M = 1, 11), I = 1, 2), LNOW, NRS
        !-----PRINT WARNING IF L DEPENDENT SCATTERING RADIUS IS NOT POSITIVE.
        20 IF(APL.GT.0.0) GO TO 30
        !-----IF L DEPENDENT RADIUS IS NOT POSITIVE USE SCATTERING RADIUS.
        !-----(SEE, ENDF/B-VI FORMATS AND PROCEDURES MANUAL).
        APL = AP
        WRITE(OUTP, 160)
        WRITE(*, 160)
        !
        !     CONSTRUCT TABLE OF PERMISSIBLE J-VALUES
        !     (THIS TABLE WILL BE USED TO CHECK FOR MISSING OR ILLEGAL J-VALUES)
        !
        30 CALL SETJ(LNOW)
        !-----INCREMENT SECTION COUNT AND INDICES TO RESONANCE PARAMETER TABLE.
        CALL LIMIT1(1)
        !-----DEFINE ALL PARAMETERS FOR A SECTION.
        !-----EITHER CALCULATE CHANNEL RADIUS OR DEFINE TO BE EQUAL TO THE
        !-----SCATTERING RADIUS.
        IF(NAPS.NE.0) GO TO 40
        APX = C3 * ((C4 * AWRI)**(ONE / THREE)) + C5
        GO TO 50
        40 APX = APL
        !
        !     APX = IS USED IN PENETRABILITIES AND SHIFT FACTORS.
        !         = EITHER BASED ON FORMULA OR EQUAL TO APL, DEPENDING ON NAPS.
        !     APL = IS USED IN THE HARD SPHERE PHASE SHIFTS.
        !     (SEE, ENDF/B-VI FORMATS AND PROCEDURES MANUAL, PAGE 2.6)
        !
        50 AK1 = C6 * AWRI / (AWRI + ONE)
        AK2 = AK1 * AK1
        BETA(NSECT) = PI * ABN / AK2
        RHOX2(NSECT) = APX * APX * AK2
        RHOP1(NSECT) = APL * AK1
        EL(NSECT) = ELX
        EH(NSECT) = EHX
        NLOW(NSECT) = LOW
        NHIGH(NSECT) = LHI
        LVALUE(NSECT) = LNOW
        MODE(NSECT) = LRF
        !
        !     READ RESONANCE PARAMETERS (6 PER RESONANCE).
        !
        !     (1) ENERGY
        !     (2) J
        !     (3) NEUTRON WIDTH
        !     (4) CAPTURE WIDTH
        !     (5) FIRST FISSION WIDTH
        !     (6) SECOND FISSION WIDTH
        !
        !     SOME OF THESE PARAMETERS WILL CONVERTED TO THE FORM REQUIRED
        !     FOR CALCULATIONS.
        !
        !     (2) STATISTICAL WEIGHT, GJ (J IS NOT NEEDED)
        !     (3) 1/2 NEUTRON WIDTH DIVIDED BY PENETRATION FACTOR (NEUTRON WIDTH
        !         IS ONLY USED DIVIDED BY THE PENETRATION FACTOR)
        !     (4) 1/2 THE CAPTURE WIDTH (THIS IS THE ONLY FORM IN WHICH THE
        !         CAPTURE WIDTH IS USED)
        !     (5) SIGNED SQUARE ROOT OF 1/2 FIRST FISSION WIDTH (ONLY FORM USED)
        !     (6) SIGNED SQUARE ROOT OF 1/2 SECOND FISSION WIDTH (ONLY FORM USED
        !
        CALL LISPAR(LOW, NRS6X, 6)
        IF(IMEDIT.NE.0) WRITE(OUTP, 170)
        !-----FOR EACH SECTION (ISOTOPE, ENERGY RANGE, L VALUE) SORT
        !-----RESONANCES IN ASCENDING (J, E) ORDER.
        CALL ORDER(LOW, LHI)
        AJNOW = RESTAB(2, LOW)
        !-----CHECK FOR LEGAL J-VALUE AND DEFINE STATISTICAL WEIGHT.
        CALL CHECKJ(AJNOW, LNOW, GJ, 2)
        DO 110 JR = LOW, LHI
            !-----INSERT DIVIDING LINE BETWEEN DIFFERENT J VALUES.
            IF(DABS(AJNOW - RESTAB(2, JR)).LE.0.01) GO TO 60
            AJNOW = RESTAB(2, JR)
            !-----CHECK FOR LEGAL J-VALUE AND DEFINE STATISTICAL WEIGHT.
            CALL CHECKJ(AJNOW, LNOW, GJ, 2)
            IF(IMEDIT.NE.0) WRITE(OUTP, 190)
            !-----LIST RESONANCE PARAMETERS.
            60 IF(IMEDIT.EQ.0) GO TO 80
            II3 = 3
            DO 70 I = 1, 6
                CALL OUT9(RESTAB(I, JR), FIELD(1, I), II3)
            70 II3 = 0
            WRITE(OUTP, 180) (FIELD(M, 1), M = 1, 11), RESTAB(2, JR), &
                    ((FIELD(M, I), M = 1, 11), I = 3, 6)
            !-----CHECK FOR PRELIMINARY ENDF/B-VI FORMAT.
            80 IF(IMOLD.LE.0) GO TO 100
            !-----NOT PRELIMINARY FORMAT IF THIRD FIELD IS NOT THE SUM OF THE
            !-----FOURTH AND FIFTH FIELDS.
            IF(DABS(RESTAB(3, JR) - (RESTAB(4, JR) + RESTAB(5, JR))).GT.&
                    DABS(ALLOW * RESTAB(3, JR))) GO TO 90
            !-----NOT PRELIMINARY FORMAT IF SIXTH FIELD IS NOT ZERO.
            IF(DABS(RESTAB(6, JR)).EQ.0.0) GO TO 100
            !-----DATA IS NOT IN THE PRELIMINARY ENDF/B-VI FORMAT. TURN OFF FLAG
            !-----AND STOP TESTING FOR PRELIMINARY FORMAT.
            90 IMOLD = 0
            !-----REPLACE J VALUE BY STATISTICAL WEIGHT.
            100 RESJTAB(JR) = RESTAB(2, JR)
            RESTAB(2, JR) = GJ
            !-----DEFINE SIGNED SQUARE ROOT OF 1/2 FISSION WIDTHS.
            GAMF1 = DSQRT(DABS(0.5 * RESTAB(5, JR)))
            IF(RESTAB(5, JR).LT.0.0) GAMF1 = -GAMF1
            RESTAB(5, JR) = GAMF1
            GAMF2 = DSQRT(DABS(0.5 * RESTAB(6, JR)))
            IF(RESTAB(6, JR).LT.0.0) GAMF2 = -GAMF2
            RESTAB(6, JR) = GAMF2
            !-----IF FISSION WIDTHS ARE NOT ZERO TURN ON FISSILE FLAG.
            IF(GAMF1.NE.0.0.OR.GAMF2.NE.0.0) LFWX = 1
            !-----DEFINE 1/2 NEUTRON WIDTH DIVIDED BY PENETRATION FACTOR.
            RHO2X = DABS(RESTAB(1, JR)) * RHOX2(NSECT)
            CALL FACTS2(LVALUE(NSECT), RHO2X, SHIFT2(JR), PENFAC)
            RESTAB(3, JR) = 0.5 * RESTAB(3, JR) / PENFAC
            !-----DEFINE 1/2 CAPTURE WIDTH.
            RESTAB(4, JR) = 0.5 * RESTAB(4, JR)
        110 CONTINUE
        !
        !     PRINT WARNING IF ANY J SEQUENCES ARE MISSING AND ADD MISSING J
        !     SEQUENCE WITH NO RESONANCES IN ORDER TO ALLOW POTENTIAL SCATTERING
        !     TO BE CORRECTLY CALCULATED.
        !
        CALL ADDJ(LNOW)
        !-----END OF L STATE LOOP.
    120 CONTINUE
    !-----TERMINATE EXECUTION IF DATA IS IN THE PRELIMINARY ENDF/B-VI
    !-----FORMAT.
    IF(IMOLD.LE.0) GO TO 130
    WRITE(OUTP, 200)
    CALL ENDIT
    130 RETURN
    140 FORMAT(1X, 78('=')/&
            ' Nuclear Spin of Target---------------', 11A1/&
            ' Scattering Radius--------------------', 11A1/&
            ' Number of L Values-------------------', I11)
    150 FORMAT(1X, 78('=')/&
            ' Atomic Weight Ratio of Isotope-------', 11A1/&
            ' L Dependent Scattering Radius--------', 11A1/&
            ' Angular Momentum (L)-----------------', I11/&
            ' Number of Resonances-----------------', I11)
    160 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
            ' L Dependent Scattering Radius in the Evaluation is Zero.'/&
            ' Have Defined it to be Equal to the Scattering Radius.'/&
            ' (see, ENDF/B-VI Formats and Procedures Manual, page 2.11)')
    170 FORMAT(1X, 78('=')/' Reich-Moore Resonance Parameters'/1X, 78('=')/&
            '      Energy  J Value    Neutron    Capture  Fission-1', &
            '  Fission-2'/8X, '(eV)', 9X, 4(7X, '(eV)')/1X, 78('='))
    180 FORMAT(1X, 11A1, F7.2, 2X, 44A1)
    190 FORMAT(1X, 78('-'))
    200 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
            ' Data are in the Preliminary ENDF/B-VI Format, which is No'/&
            ' Longer Used. Data MUST be Reformated to Comform to the'/&
            ' Current ENDF/B-VI Reich-Moore Format Before it can be'/&
            ' Processed by this Program. Execution Terminated.')
END
SUBROUTINE RDAA
    !=======================================================================
    !
    !     READ ADLER-ADLER DATA FOR ONE ENERGY RANGE.
    !     SINCE ADLER-ADLER PARAMETERS ARE INDEPENDENT OF L AND J THE
    !     ENTIRE ENERGY RANGE WILL BE TREATED AS ONE SECTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    CHARACTER*4 REACTR
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/RANGER/LOW, LHI
    COMMON/WHATZA/IZANOW, MATNOW, TEMP3, IVERSE, INT45
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/INDATD/ELX, EHX
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION REACTR(2, 3)
    DATA REACTR/&
            'Tota', 'l   ', &
            'Fiss', 'ion ', &
            'Capt', 'ure '/
    !-----UPDATED NOV. 12, 1998 AS PER CSEWG SUBCOMMITTEE RECOMMENDATION
    DATA C6/2.196807122623D-03/
    !-----DEFINE TARGET SPIN, SPIN UP SCATTERING RADIUS AND NUMBER OF L
    !-----STATES.
    CALL CARDIO(SPI, AP, L1, L2, NLS, N2)
    IF(IMEDIT.EQ.0) GO TO 10
    CALL OUT9(SPI, FIELD(1, 1), 0)
    CALL OUT9(AP, FIELD(1, 2), 0)
    WRITE(OUTP, 310) ((FIELD(M, I), M = 1, 11), I = 1, 2), NLS
    WRITE(*, 310) ((FIELD(M, I), M = 1, 11), I = 1, 2), NLS
    !-----DEFINE ATOMIC WEIGHT RATIO, TYPE AND NUMBER OF BACKGROUND
    !-----PARAMETERS.
    10 CALL CARDIO(AWRI, XN, LI, L2, NRS6X, NRS)
    IF(IMEDIT.EQ.0) GO TO 20
    CALL OUT9(AWRI, FIELD(1, 1), 0)
    WRITE(OUTP, 320) (FIELD(M, 1), M = 1, 11), LI, NRS
    WRITE(*, 320) (FIELD(M, 1), M = 1, 11), LI, NRS
    !-----INCREMENT SECTION COUNT AND INDICES TO RESONANCE PARAMETER TABLE
    !-----(RESONANCE TABLE INDICES WILL ONLY REFER TO BACKGROUND).
    20 CALL LIMIT1(1)
    !-----DEFINE ALL PARAMETERS FOR A SECTION.
    AK1 = C6 * AWRI / (AWRI + ONE)
    BETA(NSECT) = PI * ABN / (AK1 * AK1)
    RHOP1(NSECT) = TWO * AP * AK1
    EL(NSECT) = ELX
    EH(NSECT) = EHX
    NLOW(NSECT) = LOW
    !-----MODE DEPENDS ON VERSION OF ENDF/B FORMAT.
    MODE(NSECT) = 4
    IF(IVERSE.GE.5) MODE(NSECT) = 5
    LVALUE(NSECT) = LI
    !
    !     READ BACKGROUND CROSS SECTIONS.
    !
    CALL LISTIO(RESTAB(1, LOW), NRS6X)
    !
    !     FOR CONVENIENCE ALWAYS ALLOW ROOM FOR 3 SETS OF BACKGROUND
    !     CROSS SECTIONS AND POSITION BACKGROUND CROSS SECTIONS TO
    !     STANDARD POSITIONS (TOTAL, FISSION AND CAPTURE, IN THAT ORDER).
    !
    LHI = LOW + 2
    IF(NRS.EQ.3) GO TO 220
    GO TO (30, 50, 90, 110, 140, 170, 210), LI
    !-----ONLY TOTAL. ZERO OUT FISSION AND CAPTURE.
    30 LOWP1 = LOW + 1
    DO 40 JR = LOWP1, LHI
        DO 40 K = 1, 6
        40 RESTAB(K, JR) = 0.0
    GO TO 220
    !-----ONLY FISSION. IF ONLY ONE SET OF BACKGROUNDS MOVE FISSION TO
    !-----SECOND LOCATION.
    50 IF(NRS.GT.1) GO TO 70
    LOWP1 = LOW + 1
    DO 60 K = 1, 6
    60 RESTAB(K, LOWP1) = RESTAB(K, LOW)
    !-----ZERO OUT TOTAL AND CAPTURE.
    70 DO 80 JR = LOW, LHI, 2
        DO 80 K = 1, 6
        80 RESTAB(K, JR) = 0.0
    GO TO 220
    !-----TOTAL AND FISSION. ZERO OUT CAPTURE.
    90 DO 100 K = 1, 6
    100 RESTAB(K, LHI) = 0.0
    GO TO 220
    !-----ONLY CAPTURE. MOVE LAST SET OF BACKGROUND CROSS SECTIONS TO
    !-----CAPTURE (THIRD) POSITION.
    110 DO 120 K = 1, 6
    120 RESTAB(K, LHI) = RESTAB(K, LOW)
    !-----ZERO OUT TOTAL AND FISSION.
    LHIM1 = LHI - 1
    DO 130 JR = LOW, LHIM1
        DO 130 K = 1, 6
        130 RESTAB(K, JR) = 0.0
    GO TO 220
    !-----TOTAL AND CAPTURE. MOVE CAPTURE TO THIRD POSITION.
    140 LOWP1 = LOW + 1
    DO 150 K = 1, 6
    150 RESTAB(K, LHI) = RESTAB(K, LOWP1)
    !-----ZERO OUT AND FISSION (SECOND POSITION).
    LHIM1 = LHI - 1
    DO 160 K = 1, 6
    160 RESTAB(K, LOWP1) = 0.0
    GO TO 220
    !-----FISSION AND CAPTURE. MOVE BOTH BACK ONE POSITION.
    170 LOWP1 = LOW + 1
    DO 180 K = 1, 6
    180 RESTAB(K, LHI) = RESTAB(K, LOWP1)
    DO 190 K = 1, 6
    190 RESTAB(K, LOWP1) = RESTAB(K, LOW)
    !-----ZERO OUT AND TOTAL (FIRST POSITION).
    DO 200 K = 1, 6
    200 RESTAB(K, LOW) = 0.0
    GO TO 220
    !-----TOTAL, FISSION AND CAPTURE. NOTHING TO D0.
    210 CONTINUE
    !
    !     LIST BACKGROUND CROSS SECTIONS IN STANDARD POSITION.
    !
    220 IF(IMEDIT.NE.0) WRITE(OUTP, 330)
    INDEX = 1
    DO 250 JR = LOW, LHI
        II3 = 3
        DO 240 I = 1, 6
            !-----IF FISSION BACKGROUND IS NOT ZERO TURN ON FISSILE FLAG.
            IF(INDEX.NE.2) GO TO 230
            IF(DABS(RESTAB(I, JR)).NE.0.0) LFWX = 1
            230 IF(IMEDIT.EQ.0) GO TO 240
            CALL OUT9(RESTAB(I, JR), FIELD(1, I), II3)
        240 II3 = 0
        IF(IMEDIT.EQ.0) GO TO 250
        WRITE(OUTP, 340) (REACTR(J, INDEX), J = 1, 2), &
                ((FIELD(M, I), M = 1, 11), I = 1, 6)
    250 INDEX = INDEX + 1
    !
    !     L STATE LOOP.
    !
    DO 300 IL = 1, NLS
        !-----READ L VALUE AND NUMBER OF J STATES.
        CALL CARDIO(XN, XN, LNOW, L2, NJS, N2)
        IF(IMEDIT.NE.0) WRITE(OUTP, 380) LNOW, NJS
        !
        !     J STATE LOOP.
        !
        DO 300 IJ = 1, NJS
            !-----READ J VALUE AND NUMBER OF RESONANCES
            CALL CARDIO(AJ, C2, L1, L2, NRS12, NRS)
            IF(IMEDIT.EQ.0) GO TO 260
            WRITE(OUTP, 390) AJ, NRS
            !-----EACH ADLER-ADLER RESONANCE WILL OCCUPY 2 RESONANCE POSITIONS
            !-----IN TABLE (I.E. 12 PARAMETERS PER RESONANCE).
            260 NRS = 2 * NRS
            !-----INCREMENT INDICES TO RESONANCE PARAMETER TABLE.
            CALL LIMIT1(2)
            !-----READ RESONANCE PARAMETERS.
            CALL LISPAR(LOW, NRS12, 12)
            IF(IMEDIT.NE.0) WRITE(OUTP, 350)
            DO 290 JR = LOW, LHI, 2
                !-----IF FISSION WIDTHS ARE NOT ZERO TURN ON FISSILE FLAG (ONLY TEST
                !-----SYMMETRICAL AND ASYMMETRICAL WIDTHS).
                IF(DABS(RESTAB(1, JR + 1)).NE.0.0.OR.DABS(RESTAB(2, JR + 1)).NE.0.0)&
                        LFWX = 1
                !-----LIST RESONANCE PARAMETERS (12 RESONANCE PARAMETERS ARE STORED IN
                !-----2 SUCCESSIVE LOCATIONS OF THE RESONANCE TABLE, CORRESPONDING TO
                !-----THE INDICES JR AND JR+1).
                IF(IMEDIT.EQ.0) GO TO 290
                JRR = JR
                II = 0
                DO 280 LOOPAA = 1, 3
                    DO 270 I = 1, 4
                        II = II + 1
                        IF(II.LE.6) GO TO 270
                        II = 1
                        JRR = JRR + 1
                    270 CALL OUT9(RESTAB(II, JRR), FIELD(1, I), 0)
                280 WRITE(OUTP, 360)&
                        REACTR(1, LOOPAA), REACTR(2, LOOPAA), ((FIELD(M, I), M = 1, 11), I = 1, 4)
                WRITE(OUTP, 370)
            290 CONTINUE
            !-----END OF L AND J STATE LOOPS.
        300 CONTINUE
    !-----DEFINE UPPER INDEX TO RESONANCE TABLE.
    NHIGH(NSECT) = LHI
    RETURN
    310 FORMAT(1X, 78('=')/&
            ' Nuclear Spin of Target---------------', 11A1/&
            ' Effective Scattering Radius (A+)-----', 11A1/&
            ' Number of L Values-------------------', I11)
    320 FORMAT(1X, 78('=')/&
            ' Atomic Weight Ratio of Isotope-------', 11A1/&
            ' LI-----------------------------------', I11/&
            ' Number of Background Sets------------', I11)
    330 FORMAT(1X, 78('=')/' Adler-Adler Resonance Parameters'/1X, 78('=')/&
            ' Background'/1X, 78('=')/' Reaction', &
            '         A1         A2         A3         A4         B1', &
            '         B2'/1X, 78('='))
    340 FORMAT(1X, 2A4, 66A1)
    350 FORMAT(1X, 78('=')/' Resonance Parameters'/1X, 78('=')/' Reaction', &
            '  Resonance Half-Width  Symmetric Asymmetric'/&
            9X, '   Energy     (eV)      Parameter Parameter'/&
            9X, '    (eV)                  (GRT)     (GIT)  '/1X, 78('='))
    360 FORMAT(1X, 2A4, 44A1)
    370 FORMAT(1X, 78('='))
    380 FORMAT(1X, 78('=')/&
            ' L Value------------------------------', I11/&
            ' Number of J Values-------------------', I11)
    390 FORMAT(' J Value------------------------------', 5X, F6.2/&
            ' Number of Resonances-----------------', I11)
END
SUBROUTINE RDHRF
    !=======================================================================
    !
    !     READ HYBRID R-FUNCTION DATA FOR ONE ENERGY RANGE.
    !     EACH (L,S,J) STATE WILL BE TREATED AS A SEPARATE SECTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    CHARACTER*4 MTHOL, ANSWER
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/NAPNRO/NRO, NAPS
    COMMON/RANGER/LOW, LHI
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/INDATD/ELX, EHX
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/HRFTAB/QHRF(4), MTHRF(4), NHRF
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION MTOK(9), MTHOL(3, 10), ANSWER(3, 2)
    DATA ANSWER/' (No', ')   ', &
            ' (Ye', 's)  ', &
            ' (ER', 'ROR)'/
    !-----DEFINE ALLOWED INELASTIC AND CHARGED PARTICLE MT NUMBERS.
    DATA MTOK/51, 52, 53, 54, 103, 104, 105, 106, 107/
    DATA MTHOL/&
            'Inel', 'asti', 'c   ', &
            'Inel', 'asti', 'c   ', &
            'Inel', 'asti', 'c   ', &
            'Inel', 'asti', 'c   ', &
            'n,p ', '    ', '    ', &
            'n,d ', '    ', '    ', &
            'n,t ', '    ', '    ', &
            'n,He', '-3  ', '    ', &
            'n,Al', 'pha ', '    ', 'NOT ', 'Allo', 'wed '/
    DATA SFC/0.0D+00/
    DATA C3/1.23D-01/
    DATA C5/8.0D-02/
    !-----UPDATED NOV. 12, 1998 AS PER CSEWG SUBCOMMITTEE RECOMMENDATION
    DATA C4/1.008664904D+00/
    DATA C6/2.196807122623D-03/
    !-----DEFINE TARGET SPIN, SPIN UP SCATTERING RADIUS AND NUMBER OF L
    !-----STATES.
    CALL CARDIO(SPI, C2, L1, L2, NLS, N2)
    IF(IMEDIT.EQ.0) GO TO 10
    CALL OUT9(SPI, FIELD(1, 1), 0)
    WRITE(OUTP, 230) (FIELD(M, 1), M = 1, 11), NLS
    WRITE(*, 230) (FIELD(M, 1), M = 1, 11), NLS
    !-----DEFINE NUMBER OF EACH KIND OF REACTION.
    10 CALL CARDIO(C1, C2, NGRE, NFRE, NIRE, NCRE)
    IF(IMEDIT.NE.0) WRITE(OUTP, 240) NGRE, NFRE, NIRE, NCRE
    IF(IMEDIT.NE.0) WRITE(*, 240) NGRE, NFRE, NIRE, NCRE
    !-----CHECK FOR ALLOWABLE VALUES.
    IF(NGRE.LT.0.OR.NGRE.GT.1) GO TO 20
    IF(NFRE.LT.0.OR.NFRE.GT.1) GO TO 20
    IF(NIRE.LT.0.OR.NIRE.GT.4) GO TO 20
    IF(NCRE.LT.0.OR.NCRE.GT.4) GO TO 20
    NHRF = NIRE + NCRE
    IF(NHRF.LE.4) GO TO 30
    20 WRITE(OUTP, 250)
    WRITE(*, 250)
    CALL ENDIT
    !-----DEFINE KIND OF REACTION.
    30 CALL CARDIO(C1, C2, MTHRF(1), MTHRF(2), MTHRF(3), MTHRF(4))
    !-----READ Q-VALUES.
    CALL CARDIO(C1, C2, L1, L2, N1, N2)
    CALL LISTIO(QHRF, N1)
    !-----LIST MT NUMBERS AND Q-VALUES.
    IF(NHRF.LE.0) GO TO 80
    IF(IMEDIT.NE.0) WRITE(OUTP, 260)
    !-----CHECK AND LIST MT NUMBERS AND Q-VALUES.
    IERR = 0
    DO 60 I = 1, NHRF
        DO 40 J = 1, 9
            IF(MTHRF(I).EQ.MTOK(J)) GO TO 50
        40 CONTINUE
        J = 10
        IERR = 1
        !-----TEMPORARILY ONLY ALLOW INELASTIC REACTIONS.
        50 IF(J.GT.4.AND.J.LE.9) IERR = 2
        CALL OUT9(QHRF(I), FIELD(1, 1), 0)
        IF(IMEDIT.NE.0) WRITE(OUTP, 270) MTHRF(I), &
                (FIELD(M, 1), M = 1, 11), (MTHOL(K, J), K = 1, 3)
        !-----FROM HERE ON TREAT ALL INELASTIC AS THE SAME MT NUMBER (MT=51).
        IF(MTHRF(I).GE.51.AND.MTHRF(I).LE.54) MTHRF(I) = 51
    60 CONTINUE
    !
    !     TERMINATED EXECUTION IF REACTION IS NOT ALLOWED.
    !
    IF(IERR.EQ.0) GO TO 80
    IF(IERR.EQ.2) GO TO 70
    !-----ILLEGAL MT NUMBER.
    WRITE(OUTP, 280)
    WRITE(*, 280)
    CALL ENDIT
    !-----CHARGED PARTICLE REACTION (TEMPORARILY NOT ALLOWED)
    70 WRITE(OUTP, 290)
    WRITE(*, 290)
    CALL ENDIT
    !
    !     L STATE LOOP.
    !
    80 DO 220 IL = 1, NLS
        !-----DEFINE ATOMIC WEIGHT RATIO, L VALUE AND NUMBER OF S-VALUES
        !-----(CHANNEL SPINS).
        CALL CARDIO(AWRI, C1, LNOW, L2, NSS, N2)
        !-----DEFINE ATOMIC WEIGHT DEPENDENT QUANTITIES.
        AWRICM = AWRI / (AWRI + ONE)
        !-----INITIALIZE CHANNEL RADIUS TO CALCULATED VALUE (MAY BE CHANGED
        !-----LATER AFTER SCATTERING RADIUS IS READ).
        APX = C3 * ((C4 * AWRI)**(ONE / THREE)) + C5
        AK1 = C6 * AWRICM
        AK2 = AK1 * AK1
        IF(IMEDIT.EQ.0) GO TO 90
        CALL OUT9(AWRI, FIELD(1, 1), 0)
        WRITE(OUTP, 300) (FIELD(M, 1), M = 1, 11), LNOW, NSS
        !
        !     CONSTRUCT TABLE OF PERMISSIBLE J-VALUES
        !     (THIS TABLE WILL BE USED TO CHECK FOR MISSING OR ILLEGAL J-VALUES)
        !
        90 CALL SETJ(LNOW)
        !
        !     S-VALUE LOOP.
        !
        DO 210 IS = 1, NSS
            !-----DEFINE S-VALUE AND NUMBER OF J-VALUES.
            CALL CARDIO(AS, C2, L1, L2, NJS, N2)
            IF(IMEDIT.EQ.0) GO TO 100
            CALL OUT9(AS, FIELD(1, 1), 0)
            WRITE(OUTP, 310) (FIELD(M, 1), M = 1, 11), NJS
            !
            !     J STATE LOOP.
            !
            100 DO 210 IJ = 1, NJS
                !-----DEFINE J-VALUE, CHANNEL RADIUS, FLAGS FOR BACKGROUND AND OPTICAL
                !-----MODEL PHASE SHIFTS AND THE NUMBER OF RESONANCES.
                CALL CARDIO(AJ, AC, LBK, LPS, NLSJ12, NLSJ)
                !-----CHECK FOR LEGAL J-VALUE AND DEFINE STATISTICAL WEIGHT.
                CALL CHECKJ(AJ, LNOW, GJ, 2)
                !-----IF REQUESTED SET CHANNEL RADIUS EQUAL TO SCATTERING RADIUS.
                IF(NAPS.NE.0) APX = AC
                LBKIN = LBK + 1
                IF(LBK.LT.0.OR.LBK.GT.1) LBKIN = 3
                LPSIN = LPS + 1
                IF(LPS.LT.0.OR.LPS.GT.1) LPSIN = 3
                IF(IMEDIT.EQ.0) GO TO 110
                CALL OUT9(AJ, FIELD(1, 1), 0)
                CALL OUT9(AC, FIELD(1, 2), 0)
                WRITE(OUTP, 320) ((FIELD(M, I), M = 1, 11), I = 1, 2), LBK, &
                        ANSWER(1, LBKIN), ANSWER(2, LBKIN), LPS, ANSWER(1, LPSIN), &
                        ANSWER(2, LPSIN), NLSJ
                !-----CHECK FOR ILLEGAL BACKGROUND OR OPTICAL MODEL PHASE SHIFT FLAG.
                110 IF(LBKIN.NE.2.AND.LPSIN.NE.2) GO TO 120
                WRITE(OUTP, 330)
                CALL ENDIT
                !-----TEMPORARILY DO NOT ALLOW TABULATED BACKGROUND OR OPTICAL MODEL
                !-----PHASE SHIFT.
                120 IF(LBK.EQ.0.AND.LPS.EQ.0) GO TO 130
                WRITE(OUTP, 340)
                CALL ENDIT
                !-----ALLOW SPACE FOR 12 PARAMETERS PER RESONANCE.
                130 NRS = 2 * NLSJ
                !-----INCREMENT SECTION COUNT AND INDICES TO RESONANCE PARAMETER TABLE.
                CALL LIMIT1(1)
                !-----DEFINE ALL PARAMETERS FOR A SECTION.
                BETA(NSECT) = PI * ABN / AK2
                RHOX2(NSECT) = APX * APX * AK2
                RHOP1(NSECT) = AC * AK1
                EL(NSECT) = ELX
                EH(NSECT) = EHX
                GJTAB(NSECT) = GJ
                NLOW(NSECT) = LOW
                NHIGH(NSECT) = LHI
                LVALUE(NSECT) = LNOW
                LRXTAB(NSECT) = NHRF
                MODE(NSECT) = 7
                !-----DEFINE EXCITATION ENERGIES.
                IF(NHRF.LE.0) GO TO 150
                DO 140 I = 1, NHRF
                140 EXCITE(I, NSECT) = QHRF(I) / AWRICM
                !
                !     READ RESONANCE PARAMETERS (12 PER RESONANCE).
                !
                !     (1) ENERGY
                !     (2) NEUTRON WIDTH
                !     (3) CAPTURE WIDTH
                !     (4) FISSION WIDTH
                !     (5) FIRST COMPETITIVE WIDTH
                !     (6) SECOND COMPETITIVE WIDTH
                !     (7) THIRD COMPETITIVE WIDTH
                !     (8) FOURTH COMPETITIVE WIDTH
                !     (9) FIRST EXIT CHANNEL L-VALUE
                !    (10) SECOND EXIT CHANNEL L-VALUE
                !    (11) THIRD EXIT CHANNEL L-VALUE
                !    (12) FOURTH EXIT CHANNEL L-VALUE
                !
                !     SOME OF THESE PARAMETERS WILL BE CONVERTED TO THE FORM REQUIRED
                !     FOR CALCULATIONS.
                !
                !     (2) NEUTRON WIDTH DIVIDED BY PENETRATION FACTOR
                !   (5-8) INELASTIC WIDTH DIVIDED BY PENETRATION FACTOR
                !
                150 CALL LISPAR(LOW, NLSJ12, 12)
                IF(IMEDIT.NE.0) WRITE(OUTP, 350)
                DO 200 JR = LOW, LHI, 2
                    JRP1 = JR + 1
                    !-----LIST RESONANCE PARAMETERS.
                    IF(IMEDIT.EQ.0) GO TO 170
                    LOUT1 = RESTAB(3, JRP1)
                    LOUT2 = RESTAB(4, JRP1)
                    LOUT3 = RESTAB(5, JRP1)
                    LOUT4 = RESTAB(6, JRP1)
                    II3 = 3
                    DO 160 I = 1, 6
                        CALL OUT9(RESTAB(I, JR), FIELD(1, I), II3)
                    160 II3 = 0
                    CALL OUT9(RESTAB(1, JRP1), FIELD(1, 7), 0)
                    CALL OUT9(RESTAB(2, JRP1), FIELD(1, 8), 0)
                    WRITE(OUTP, 360) ((FIELD(M, I), M = 1, 11), I = 1, 8), LOUT1, LOUT2, &
                            LOUT3, LOUT4
                    !-----DEFINE NEUTRON WIDTH DIVIDED BY PENETRATION FACTOR.
                    170 RHO2X = DABS(RESTAB(1, JR)) * RHOX2(NSECT)
                    CALL FACTS2(LVALUE(NSECT), RHO2X, SHIFT2(JR), PENFAC)
                    RESTAB(2, JR) = RESTAB(2, JR) / PENFAC
                    !-----DEFINE INELASTIC WIDTHS DIVIDED BY PENETRATION FACTOR.
                    IF(NHRF.LE.0) GO TO 200
                    !-----INITIALIZE INDICES TO WIDTH AND EXIT CHANNEL L-VALUE.
                    JRX1 = JR
                    JJ1 = 4
                    JRX2 = JR + 1
                    JJ2 = 2
                    DO 190 IHRF = 1, NHRF
                        JJ1 = JJ1 + 1
                        JJ2 = JJ2 + 1
                        IF(JJ1.LE.6) GO TO 180
                        JRX1 = JRX2
                        JJ1 = 1
                        180 IF(MTHRF(IHRF).NE.51) GO TO 190
                        RHOC2 = DABS(RESTAB(1, JR) + EXCITE(IHRF, NSECT)) * RHOX2(NSECT)
                        LCOM = RESTAB(JJ2, JRX2)
                        CALL FACTS2(LCOM, RHOC2, SFC, PENFAC)
                        RESTAB(JJ1, JRX1) = RESTAB(JJ1, JRX1) / PENFAC
                    190 CONTINUE
                    !-----END OF RESONANCE LOOP.
                200 CONTINUE
                !-----END OF S AND J LOOPS.
            210 CONTINUE
            !
            !     PRINT WARNING IF ANY J SEQUENCES ARE MISSING AND ADD MISSING J
            !     SEQUENCE WITH NO RESONANCES IN ORDER TO ALLOW POTENTIAL
            !     SCATTERING TO BE CORRECTLY CALCULATED.
            !
            CALL ADDJ(LNOW)
            !-----END OF L LOOP.
            220 CONTINUE
            RETURN
            230 FORMAT(1X, 78('=')/&
                    ' Nuclear Spin of Target---------------', 11A1/&
                    ' Number of L Values-------------------', I11)
            240 FORMAT(1X, 78('=')/&
                    ' Number of Capture Reactions----------', I11, ' (0 TO 1)'/&
                    ' Number of Fission Reactions----------', I11, ' (0 TO 1)'/&
                    ' Number of Inelastic Reactions--------', I11, ' (0 TO 4)'/&
                    ' Number of Charged Particle Reactions-', I11, ' (0 TO 4)')
            250 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
                    ' Illegal Number of Reactions. Execution Terminated.')
            260 FORMAT(1X, 78('='))
            270 FORMAT(' MT and Q-Value (eV)------------------', I11, 11A1, 1X, 3A4)
            280 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
                    ' Illegal MT Number. Execution Terminated.')
            290 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
                    ' Currently Program Does NOT Allow Charged Particle Reactions.'/&
                    ' Execution Terminated.')
            300 FORMAT(1X, 78('=')/&
                    ' Atomic Weight Ratio of Isotope-------', 11A1/&
                    ' L-Value------------------------------', I11/&
                    ' Number of S-Values (Channel Spin)----', I11)
            310 FORMAT(1X, 78('=')/&
                    ' S-Value------------------------------', 11A1/&
                    ' Number of J-Values-------------------', I11)
            320 FORMAT(1X, 78('=')/&
                    ' J-Value------------------------------', 11A1/&
                    ' Channel Radius (10E-12 cm)-----------', 11A1/&
                    ' Background Tabulated-----------------', I11, 2A4/&
                    ' Optical Model Phase SshiftTabulated--', I11, 2A4/&
                    ' Number of Resonances-----------------', I11)
            330 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
                    ' Background and Optical Phase Shift Flags MUST be 0 or 1.'/&
                    ' Execution Terminated.')
            340 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
                    ' Currently Program Does NOT Allow Tabulated Background or'/&
                    ' Optical Phase Shift. Execution Terminated.')
            350 FORMAT(1X, 112('=')/' Hybrid R-Function Resonance Parameters'/&
                    1X, 112('=')/&
                    '                                              Competitive', &
                    ' Widths                          Exit Channel'/&
                    '      Energy    Neutron    Capture    Fission Reaction-1', &
                    ' Reaction-2 Reaction-3 Reaction-4 L-Values'/&
                    '        (eV)       (eV)       (eV)       (eV)       (eV)', &
                    '       (eV)       (eV)       (eV) L-1 L-2 L-3 L-4'/&
                    1X, 112('='))
            360 FORMAT(1X, 88A1, 4I4)
END
SUBROUTINE RDGRM
    !=======================================================================
    !
    !     GENERAL R-MATRIX TREATMENT IS NOT YET INCLUDED.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    WRITE(OUTP, 10)
    WRITE(*, 10)
    CALL ENDIT
    10 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' General R-Matrix Parameters are NOT Yet Treated by this'/&
            ' Program....Execution Terminated.'/1X, 78('=')/&
            ' In Order to Demonstrate that this Formalism is Generally'/&
            ' Useful the Author of this Code Asks that Evaluators Send'/&
            ' Him Evaluations Using this Formalism and Their Calculated'/&
            ' Cross Sections for Comparison.'/1X, 78('=')/&
            ' Until Parameters and Calculated Cross Sections Using this'/&
            ' Formalism are Available it is NOT Possible to Verify the'/&
            ' Accuracy of Any Results Calculated by this Code.'/1X, 78('='))
END
SUBROUTINE RDUR
    !=======================================================================
    !
    !     READ UNRESOLVED RESONANCE PARAMETERS. THIS ROUTINE HANDLES ALL
    !     POSSIBLE REPRESENTATIONS OF UNRESOLVED PARAMETERS,
    !     (1) NO FISSION WIDTHS, ALL PARAMETERS ENERGY INDEPENDENT
    !     (2) FISSION WIDTHS GIVEN, ONLY FISSION WIDTHS ENERGY DEPENDENT
    !     (3) FISSION WIDTHS GIVEN, ALL PARAMETERS ENERGY DEPENDENT
    !
    !     FOR SIMPLICITY IN LATER CALCULATIONS ALL INPUT REPRESENTATIONS
    !     ARE INTERNALLY CONVERTED TO THE ALL PARAMETERS ENERGY DEPENDENT
    !     FORM TREATING EACH (L, J) STATE AS A SEPARATE SECTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    CHARACTER*4 TYPINT
    COMMON/LEADER/C1, C2, L1, L2, N1, N2, MAT, MF, MT
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/NAPNRO/NRO, NAPS
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/RANGER/LOW, LHI
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/INDATD/ELX, EHX
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/WHATZA/IZANOW, MATNOW, TEMP3, IVERSE, INT45
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON/LRUNOW/LRUIN
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON/PARTN/EPART1, EPART2, NPART
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION DUMSET(6), DUMBO(6), TYPINT(4, 6)
    EQUIVALENCE (DUMSET(1), DX), (DUMSET(2), AJ), (DUMSET(3), AMUN), &
            (DUMSET(4), GNO), (DUMSET(5), GG)
    DATA TYPINT/&
            '(His', 'togr', 'am) ', '    ', &
            '(Lin', ' X-L', 'in Y', ')   ', &
            '(Log', ' X-L', 'in Y', ')   ', &
            '(Lin', ' X-L', 'og Y', ')   ', &
            '(Log', ' X-L', 'og Y', ')   ', &
            '(ERR', 'OR) ', '    ', '    '/
    DATA DUMSET/6*0.0D+00/
    DATA DUMBO/6*0.0D+00/
    DATA C3/1.23D-01/
    DATA C5/8.0D-02/
    !-----UPDATED NOV. 12, 1998 AS PER CSEWG SUBCOMMITTEE RECOMMENDATION
    DATA C4/1.008664904D+00/
    DATA C6/2.196807122623D-03/
    !-----PRINT TITLE FOR OUTPUT LISTING.
    IF(IMEDIT.EQ.0) GO TO 10
    IF(LRF.EQ.1.AND.LFW.EQ.0) WRITE(OUTP, 270)
    IF(LRF.EQ.1.AND.LFW.EQ.1) WRITE(OUTP, 280)
    IF(LRF.EQ.2) WRITE(OUTP, 290)
    IF(LRF.EQ.1.AND.LFW.EQ.0) WRITE(*, 270)
    IF(LRF.EQ.1.AND.LFW.EQ.1) WRITE(*, 280)
    IF(LRF.EQ.2) WRITE(*, 290)
    !
    !     READ BEGINNING OF EACH TYPE OF REPRESENTATION AND DEFINE ALL
    !     COMMON TERMS.
    !
    !-----DEFINE TARGET SPIN, SPIN UP SCATTERING RADIUS AND,
    !-----(LRF=1, LFW=1) - NUMBERS OF ENERGIES AT WHICH FISSION WIDTHS ARE
    !-----                 GIVEN AND NUMBER OF L VALUES, OR
    !-----(OTHERWISE)    - NUMBER OF L VALUES.
    !
    !     FOR ENDF/B-VI FORMATS CHECK L1 FIELD (LSSF) TO SEE IF THE
    !     UNRESOLVED INFINITELY DILUTE CROSS SECTION HAS ALREADY BEEN
    !     INCLUDED IN THE FILE 3 CROSS SECTIONS. IF IT HAS CHANGE LRUIN
    !     TO EFFECTIVELY IGNORE SECTION WHILE CALCULATING RESONANCE
    !     CONTRIBUTION TO THE FILE 3 CROSS SECTIONS.
    !
    10 CALL CARDI(SPI, AP, LSSF, L2, NE, NLS)
    !-----FOR ENDF/B-VI SAVE LSSF IS READ AND CHANGE TO =1 FOR OUTPUT
    !-----TO INDICATE RESONANCE CONTRIBUTION IS ALREADY INCLUDED IN
    !-----THE FILE 3 CROSS SECTIONS (AFTER THIS CALCULATION).
    IF(IVERSE.NE.6) GO TO 20
    LSSFIN = LSSF
    !-----DO NOT CHANGE LSSF IF ONLY PROCESSING A PORTION OF THE RESONANCE
    !-----REGION.
    IF(NPART.NE.2) LSSF = 1
    20 CALL CARDO(SPI, AP, LSSF, L2, NE, NLS)
    IF(LFW.NE.1.OR.LRF.NE.1) NLS = NE
    !-----LIST SPIN AND SPIN UP SCATTERING.
    IF(IMEDIT.EQ.0) GO TO 40
    CALL OUT9(SPI, FIELD(1, 1), 0)
    CALL OUT9(AP, FIELD(1, 2), 0)
    WRITE(OUTP, 330) ((FIELD(M, I), M = 1, 11), I = 1, 2)
    WRITE(*, 330) ((FIELD(M, I), M = 1, 11), I = 1, 2)
    !-----FOR ENDF/B-VI PRINT INTERPRETATION OF LSSF.
    IF(IVERSE.NE.6) GO TO 30
    IF(LSSFIN.EQ.0) WRITE(OUTP, 310) LSSFIN
    IF(LSSFIN.EQ.1) WRITE(OUTP, 320) LSSFIN
    IF(LSSFIN.EQ.0) WRITE(*, 310) LSSFIN
    IF(LSSFIN.EQ.1) WRITE(*, 320) LSSFIN
    !-----LIST NUMBER OF L VALUES.
    30 WRITE(OUTP, 340) NLS
    WRITE(*, 340) NLS
    !
    !     FOR ENDF/B-VI IF LRUIN INDICATES THAT CROSS SECTIONS NOT YET
    !     ADDED TO FILE 3, BUT LSSFIN INDICATES THAT THEY HAVE PRINT
    !     WARNING AND CHANGE LRUIN TO IGNORE THIS SECTION.
    !
    40 IF(IVERSE.NE.6.OR.LRUIN.EQ.5.OR.LSSFIN.EQ.0) GO TO 50
    WRITE(OUTP, 300) LSSFIN
    WRITE(*, 300) LSSFIN
    LRUIN = 5
    !
    !     IF ONLY FISSION WIDTH ARE ENERGY DEPENDENT READ ENERGIES AT WHICH
    !     FISSION WIDTHS ARE GIVEN.
    !
    50 IF(LRF.NE.1.OR.LFW.NE.1) GO TO 70
    !-----INCREMENT SECTION COUNT (ALLOWING ROOM TO INSERT THE DEGREES OF
    !-----FREEDOM BEFORE THE ENERGIES).
    NRS = NE + 1
    CALL LIMIT1(1)
    LOWP1 = LOW + 1
    !-----READ ENERGIES AT WHICH FISSION WIDTHS ARE GIVEN AND MOVE THEM
    !-----INTO THE 1-ST POSITION FOR EACH RESONANCE.
    JRC = (LHI - LOWP1) + 1
    CALL LISTIO(ENRES(LOWP1), JRC)
    DO 60 JR1 = LOWP1, LHI
        CALL NOODLE(ENRES(JR1), ZERO, ELX, EHX)
    60 RESTAB(1, JR1) = ENRES(JR1)
    !-----SAVE INDEX TO FIRST ENERGY TO ALLOW COPY OF ENERGIES FOR EACH
    !-----SECTION.
    LOWP1X = LOWP1
    !
    !     L STATE LOOP.
    !
    70 DO 260 IL = 1, NLS
        !-----DEFINE ATOMIC WEIGHT RATIO, L VALUE AND NUMBER OF J STATES.
        CALL CARDIO(AWRI, C2, LNOW, L2, NJS, NJSX)
        IF(LRF.EQ.1.AND.LFW.EQ.0) NJS = NJSX
        IF(IMEDIT.EQ.0) GO TO 80
        CALL OUT9(AWRI, FIELD(1, 1), 0)
        WRITE(OUTP, 350) (FIELD(M, 1), M = 1, 11), LNOW, NJS
        WRITE(*, 350) (FIELD(M, 1), M = 1, 11), LNOW, NJS
        !-----DEFINE COMMON PARAMETERS FOR ALL SECTIONS WITH SAME L VALUE.
        !-----EITHER CALCULATE CHANNEL RADIUS OR DEFINE TO BE EQUAL TO THE
        !-----SCATTERING RADIUS.
        80 IF(NAPS.NE.0) GO TO 90
        APX = C3 * ((C4 * AWRI)**(ONE / THREE)) + C5
        GO TO 100
        90 APX = AP
        100 AK1 = C6 * AWRI / (AWRI + ONE)
        BETAD = PI * ABN / (AK1 * AK1)
        RHOX2D = (APX * AK1)**2
        RHOP1D = AP * AK1
        !
        !     J STATE LOOP.
        !
        DO 260 IJ = 1, NJS
            !-----READ NEXT LINE FOR (LRF=1, LFW=1 OR LRF=2, ANY LFW...NOTHING TO
            !-----READ FOR LRF=1, LFW=0).
            IF(LRF.NE.2) GO TO 110
            !-----DEFINE J VALUE, INTERPOLATION LAW AND NUMBER OF ENERGIES.
            CALL CARDIO(AJ, C2, INT, L2, NET6P6, NE)
            !-----DEFINE THE NUMBER OF RESONANCE LOCATIONS WHICH WILL BE USED
            !-----ALLOWING FOR THE PRECEDING DEGREES OF FREEDOM.
            NRS = NE + 1
            GO TO 130
            110 IF(LFW.EQ.0) GO TO 120
            !-----DEFINE THE NUMBER OF DEGREES OF FREEDOM FOR FISSION (ASSUME THE
            !-----SAME NUMBER OF ENERGIES, I.E. NEED NOT RE-DEFINE NE OR NRS AT
            !-----THIS POINT).
            CALL CARDIO(C1, C2, L1, MUF, NEP6, N2)
            IF(IL.EQ.1.AND.IJ.EQ.1) GO TO 140
            GO TO 130
            !-----INDICATE 3 LOCATIONS PER (L, J) STATE (FIRST LOCATION CONTAINS
            !-----PARAMETERS AND DEGREES OF FREEDOM, THE SECOND AND THIRD CONTAIN
            !-----ENERGY POINTS AT THE LOWER AND UPPER ENERGY LIMITS OF UNRESOLVED
            !-----REGION.
            120 NRS = 3
            !-----INCREMENT SECTION COUNT AND INDICES TO RESONANCE PARAMETER TABLE
            130 CALL LIMIT1(1)
            140 LOWP1 = LOW + 1
            !-----DEFINE ALL PARAMETERS FOR A SECTION.
            BETA(NSECT) = BETAD
            RHOX2(NSECT) = RHOX2D
            RHOP1(NSECT) = RHOP1D
            EL(NSECT) = ELX
            EH(NSECT) = EHX
            NLOW(NSECT) = LOW
            NHIGH(NSECT) = LHI
            LVALUE(NSECT) = LNOW
            MODE(NSECT) = 8
            !
            !     SELECT PARAMETER REPRESENTATION.
            !
            !-----ARE ALL WIDTHS ENERGY DEPENDENT.
            IF(LRF.EQ.2) GO TO 200
            !-----ARE FISSION WIDTHS GIVEN.
            IF(LFW.NE.0) GO TO 160
            !
            !     ALL PARAMETERS ARE ENERGY INDEPENDENT. CONVERT TO ENERGY DEPENDENT
            !     FORM USING INTERPOLATION LAW 1 (HISTOGRAM).
            !
            !-----READ LEVEL SPACING, J, NEUTRON DEGREES OF FREEDOM, NEUTRON AND
            !-----CAPTURE WIDTHS (SEE, ABOVE EQUIVALENCE TO MEMBERS OF DUMSET).
            CALL LISTIO(DUMSET, 6)
            !-----DEFINE INTERPOLATION LAW TO BE HISTOGRAM.
            INT = 1
            !-----DEFINE NUMBER OF DEGREES OF FREEDOM FOR COMPETITION, CAPTURE
            !-----AND FISSION (10) AND ELASTIC (AS INPUT).
            RESTAB(3, LOW) = 10.0
            RESTAB(4, LOW) = AMUN
            RESTAB(5, LOW) = 10.0
            RESTAB(6, LOW) = 10.0
            !-----COPY PARAMETERS AS CONSTANT BETWEEN LOWER AND UPPER ENERGY LIMITS
            !-----OF THE UNRESOLVED REGION.
            ENRES(LOWP1) = ELX
            ENRES(LHI) = EHX
            RESTAB(1, LOWP1) = ELX
            RESTAB(1, LHI) = EHX
            DO 150 I = LOWP1, LHI
                RESTAB(2, I) = DX
                RESTAB(3, I) = 0.0
                RESTAB(4, I) = GNO
                RESTAB(5, I) = GG
            150 RESTAB(6, I) = 0.0
            GO TO 210
            !
            !     ENERGY DEPENDENT FISSION WIDTHS, ALL OTHER PARAMETERS ARE ENERGY
            !     INDEPENDENT. TREAT EACH (L, J) STATE AS A SECTION AND CONVERT
            !     DATA TO ALL PARAMETERS ENERGY DEPENDENT FORM USING IMPLIED ENDF/B
            !     VERSION DEPENDENT INTERPOLATION LAW.
            !
            !-----READ LEVEL SPACING, J, NEUTRON DEGREES OF FREEDOM, NEUTRON AND
            !-----CAPTURE WIDTHS (SEE, ABOVE EQUIVALENCE TO MEMBERS OF DUMSET).
            160 CALL LISTIO(DUMSET, 6)
            !-----READ ENERGY DEPENDENT FISSION WIDTHS UP TO 6 AT A TIME AND THEN
            !-----MOVE THEM INTO THE 6-TH POSITION FOR EACH RESONANCE.
            JR = LOWP1
            DO 180 JR1 = LOWP1, LHI, 6
                JR2 = JR1 + 5
                IF(JR2.GT.LHI) JR2 = LHI
                JR3 = (JR2 - JR1) + 1
                CALL LISTIO(DUMBO, JR3)
                DO 170 K = 1, JR3
                    RESTAB(6, JR) = DUMBO(K)
                170 JR = JR + 1
            180 CONTINUE
            !-----DEFINE INTERPOLATION LAW BASED ON ENDF/B FORMAT VERSION (E.G.,
            !-----ENDF/B-IV = LOG-LOG, ENDF/B-V = LINEAR-LINEAR).
            INT = INT45
            !-----DEFINE NUMBER OF DEGREES OF FREEDOM FOR COMPETITION AND CAPTURE
            !-----(10) AND ELASTIC AND FISSION (AS INPUT).
            RESTAB(3, LOW) = 10.0
            RESTAB(4, LOW) = AMUN
            RESTAB(5, LOW) = 10.0
            RESTAB(6, LOW) = MUF
            !-----COPY ENERGIES AT WHICH FISSION WIDTHS ARE GIVEN FROM FIRST SECTION
            !-----COPY SPACING, COMPETITIVE, NEUTRON AND CAPTURE WIDTHS AS CONSTANTS
            JRX = LOWP1X
            DO 190 JR = LOWP1, LHI
                ENRES(JR) = ENRES(JRX)
                RESTAB(1, JR) = RESTAB(1, JRX)
                RESTAB(2, JR) = DX
                RESTAB(3, JR) = 0.0
                RESTAB(4, JR) = GNO
                RESTAB(5, JR) = GG
            190 JRX = JRX + 1
            GO TO 210
            !
            !     ALL WIDTHS ARE ENERGY DEPENDENT.
            !
            !-----READ NUMBER OF DEGREES OF FREEDOM FOLLOWED BY ALL RESONANCE
            !-----PARAMETERS.
            200 CALL LISTIO(RESTAB(1, LOW), 6)
            CALL LISPAR(LOW + 1, 6 * (NRS - 1), 6)
            !
            !     LIST DATA CONVERTED TO ALL PARAMETERS ENERGY DEPENDENT FORM.
            !
            !-----SAVE INTERPOLATION LAW AND DEFINE STATISTICAL WEIGHT (THESE 2
            !-----QUANTITIES ARE SAVED IN THE 2 UNUSED LOCATIONS PRECEDING THE
            !-----NUMBER OF DEGREES OF FREEDOM FOR EACH REACTION).
            210 RESTAB(1, LOW) = INT
            CALL GJWAIT(SPI, AJ, GJ)
            RESTAB(2, LOW) = GJ
            !-----LIST INTERPOLATION LAW, J AND DEGREES OF FREEDOM.
            IF(IMEDIT.EQ.0) GO TO 220
            LSTINT = 6
            IF(INT.GE.1.AND.INT.LE.5) LSTINT = INT
            WRITE(OUTP, 360) INT, (TYPINT(I, LSTINT), I = 1, 4), AJ, &
                    (RESTAB(K, LOW), K = 3, 6)
            IF(IMEDIT.NE.2) GO TO 220
            !-----IN EDIT MODE IF INTERPOLATION LAW IS INCORRECT PRINT WARNING.
            IF(LSTINT.EQ.6) WRITE(OUTP, 390) INT
            GO TO 230
            !-----IN CALCULATION MODE IF INTERPOLATION LAW IS INCORRECT PRINT
            !-----WARNING AND TERMINATE.
            220 IF(INT.GE.1.AND.INT.LE.5) GO TO 230
            WRITE(OUTP, 380) INT
            CALL ENDIT
            !-----LIST PARAMETERS.
            230 DO 250 JR = LOWP1, LHI
                !-----IF FISSION WIDTH IS NOT ZERO TURN ON FISSILE FLAG.
                IF(DABS(RESTAB(6, JR)).NE.0.0) LFWX = 1
                IF(IMEDIT.EQ.0) GO TO 250
                II3 = 3
                DO 240 I = 1, 6
                    CALL OUT9(RESTAB(I, JR), FIELD(1, I), II3)
                240 II3 = 0
                GAMT = RESTAB(3, JR) + RESTAB(4, JR) + RESTAB(5, JR) + RESTAB(6, JR)
                CALL OUT9(GAMT, FIELD(1, 7), 0)
                WRITE(OUTP, 370) ((FIELD(M, I), M = 1, 11), I = 1, 7)
            250 CONTINUE
            !-----END OF L AND J STATE LOOPS.
        260 CONTINUE
    RETURN
    270 FORMAT(1X, 78('=')/' Energy Independent Unresolved Parameters')
    280 FORMAT(1X, 78('=')/' Unresolved Fission Widths Energy Dependent')
    290 FORMAT(1X, 78('=')/' All Unresolved Parameters Energy Dependent')
    300 FORMAT(1X, 78('=')/ 1X, 7('WARNING...'), 'WARNING'/&
            ' Note, LSSF=', I2, ' Indicates that the Resonance Contribution'/&
            ' has Already been Added to the Cross Sections. This Section'/&
            ' will be Read, but Ignored in ALL Resonance Calculations.')
    310 FORMAT(' LSSF---------------------------------', I11, &
            ' (Add to File 3)')
    320 FORMAT(' LSSF---------------------------------', I11, &
            ' (Included in File 3)')
    330 FORMAT(1X, 78('=')/&
            ' Nuclear Spin of Target---------------', 11A1/&
            ' Effective Scattering Radius (A+)-----', 11A1)
    340 FORMAT(' Number of L Values-------------------', I11)
    350 FORMAT(1X, 78('=')/&
            ' Atomic Weight Ratio of Isotope-------', 11A1/&
            ' L Value------------------------------', I11/&
            ' Number of J Values-------------------', I11)
    360 FORMAT(1X, 78('=')/32X, ' Degrees of Freedom'/1X, 78('=')/&
            '   Interpolation  J Value  Competition    Neutron   Capture ', &
            '    Fission'/7X, ' Law'/1X, 78('=')/I2, 1X, 3A4, A1, &
            F9.2, 6X, F6.2, 1X, 3(5X, F6.2)/&
            1X, 78('=')/' Resonance Parameters'/1X, 78('=')/'      Energy', &
            '     Level Competition    Neutron    Capture    Fission', &
            '      Total'/&
            12X, '    Spacing', 5(6X, 'Width')/1X, 7(7X, '(eV)')/1X, 78('='))
    370 FORMAT(1X, 77A1)
    380 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Unresolved Interpolation Law=', I5, &
            ' (MUST be 1 to 5). Cannot Interpolate Unresolved Data.'/&
            ' Execution Terminated'/1X, 78('='))
    390 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Unresolved Interpolation Law=', I5, &
            ' (MUST be 1 to 5). Cannot Interpolate Unresolved Data.'/&
            ' Correct Evaluated Data Before Using it for Calculations.'/&
            ' If Data is NOT Corrected this Program will Abort During', &
            ' Calculations.'/' Execution Terminated'/1X, 78('='))
END
SUBROUTINE LIMIT1(IPATH)
    !=======================================================================
    !
    !     CORE ALLOCATION.
    !
    !     INCREMENT SECTION COUNT AND LOWER AND/OR UPPER INDICES TO
    !     RESONANCE PARAMETER TABLE.
    !
    !     IF AVAILABLE CORE ALLOCATION IS EXCEEDED TERMINATE UNLESS PROGRAM
    !     IS IN THE EDIT MODE.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE, ADDSEC, ADDRES
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/MAXIE/MAXSEC, MAXRES, MAXNOD, NEDSEC, NEDRES, NEDNOD
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    DATA ADDSEC/0/
    DATA ADDRES/0/
    !-----SELECT PATH.
    IF(IPATH.EQ.2) GO TO 20
    !-----INCREMENT SECTION COUNT AND INSURE THAT CORE ALLOCATION WILL NOT
    !-----BE EXCEEDED.
    NSECT = NSECT + 1
    IF((NSECT + ADDSEC).GT.NEDSEC) NEDSEC = NSECT + ADDSEC
    IF(NSECT.LE.MAXSEC) GO TO 20
    !-----AVAILABLE CORE EXCEEDED. TERMINATE UNLESS IN EDIT MODE.
    IF(IMEDIT.NE.2) GO TO 10
    ADDSEC = MAXSEC
    NSECT = 1
    GO TO 20
    10 WRITE(OUTP, 50) MAXSEC
    WRITE(*, 50) MAXSEC
    CALL ENDIT
    !
    !     INCREMENT LOWER AND UPPER INDICES TO RESONANCE PARAMETER TABLE.
    !     PARAMETER TABLE.
    !
    !-----DEFINE INDICES FOR NEXT SET OF RESONANCES TO READ AND INSURE THAT
    !-----CORE ALLOCATION WILL NOT BE EXCEEDED.
    20 LOW = LHI + 1
    LHI = LHI + NRS
    IF((LHI + ADDRES).GT.NEDRES) NEDRES = LHI + ADDRES
    IF(LHI.LE.MAXRES) GO TO 40
    !-----AVAILABLE CORE EXCEEDED. TERMINATE UNLESS IN EDIT MODE.
    IF(IMEDIT.NE.2) GO TO 30
    ADDRES = ADDRES + (LOW - 1)
    LOW = 1
    LHI = NRS
    GO TO 40
    30 WRITE(OUTP, 60) MAXRES
    WRITE(*, 60) MAXRES
    CALL ENDIT
    40 RETURN
    50 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' More than', I6, ' Sections'/&
            ' Re-Run Program in Edit Mode to Determine Memory Requirements'/&
            1X, 78('=')/' Execution Terminated'/1X, 78('='))
    60 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' More than', I6, ' Resonances'/&
            ' Re-Run Program in Edit Mode to Determine Memory Requirements'/&
            1X, 78('=')/' Execution Terminated'/1X, 78('='))
END
SUBROUTINE SIGMA(E, SIGNOW)
    !=======================================================================
    !
    !     CALCULATE CONTRIBUTION FROM ALL SECTIONS.
    !
    !     NOTE - THE ALGORITHMS FOR ALL POSSIBLE TYPES OF RESONANCE
    !            PARAMETERS HAVE BEEN WRITTEN IN A FORM TO REMOVE A
    !            COMMON FACTOR OF,
    !
    !            PI*ABUNDANCE/(LAMBDA**2)
    !
    !            AFTER CALCULATING THE CONTRIBUTION FROM ANY TYPE OF
    !            RESONANCE PARAMETER THIS FACTOR IS USED TO MULTIPLY
    !            THE RESULT TO DEFINE THE FINAL CROSS SECTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/TABRHO/ERHOTB(500), RHOTAB(500), APTAB(500), NRHO(200), &
            NBTRHO(200), INTRHO(200), INXRHO(4, 200), NUMRHO
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    DIMENSION SIGNOW(4)
    !-----IF ANY SECTIONS HAVE ENERGY DEPENDENT SCATTERING RADIUS DEFINE
    !-----RADIUS AT ENERGY E.
    IF(NUMRHO.GT.0) CALL SETRHO(E)
    !-----INITIALIZE SUM CROSS SECTIONS.
    DO 10 J = 2, 4
    10 SIGNOW(J) = 0.0
    !-----ADD CONTRIBUTION FROM EACH SECTION.
    DO 120 ISECT = 1, NSECT
        !-----SELECT PARAMETER TYPE.
        MODE1 = MODE(ISECT)
        !-----SKIP SECTION IF IT DOES NOT CONTRIBUTE TO THIS ENERGY RANGE.
        IF(MODE1.LE.0) GO TO 120
        !-----DEFINE INDICES FOR CURRENT SECTION OF RESONANCES.
        LOW = NLOW(ISECT)
        LHI = NHIGH(ISECT)
        !-----INITIALIZE CONTRIBUTION OF SECTION TO SUM.
        SIGNTI = 0.0
        SIGNNI = 0.0
        SIGNGI = 0.0
        SIGNFI = 0.0
        GO TO (20, 30, 40, 50, 60, 70, 80, 90, 100), MODE1
        !-----SINGLE LEVEL BREIT-WIGNER.
        20 CALL SIGBW1(E)
        GO TO 110
        !-----MULTI-LEVEL BREIT-WIGNER.
        30 CALL SIGBWM(E)
        GO TO 110
        !-----REICH-MOORE.
        40 CALL SIGRM(E)
        GO TO 110
        !-----ADLER-ADLER (ENDF/B-IV AND EARLIER).
        50 CALL SIGAA4(E)
        GO TO 110
        !-----ADLER-ADLER (ENDF/B-V AND LATER).
        60 CALL SIGAA5(E)
        GO TO 110
        !-----GENERAL R-MATRIX.
        70 CALL SIGGRM(E)
        GO TO 110
        !-----HYBRID R-FUNCTION.
        80 CALL SIGHRF(E)
        GO TO 110
        !-----UNRESOLVED (INTERPOLATE PARAMETERS).
        90 CALL SIGURP(E)
        GO TO 110
        !-----UNRESOLVED (INTERPOLATE CROSS SECTIONS).
        100 CALL SIGURS(E)
        !-----MULTIPLY CONTRIBUTION OF SECTION BY PI*ABUNDANCE/(LAMBDA**2)
        !-----(WHICH IS BETAE) AND ADD TO SUM.
        110 BETAE = BETA(ISECT) / E
        SIGNOW(2) = SIGNOW(2) + SIGNNI * BETAE
        SIGNOW(3) = SIGNOW(3) + SIGNGI * BETAE
        SIGNOW(4) = SIGNOW(4) + SIGNFI * BETAE
        !-----END OF SECTION LOOP.
    120 CONTINUE
    !-----DEFINE TOTAL TO EQUAL SUM OF PARTS.
    SIGNOW(1) = SIGNOW(2) + SIGNOW(3) + SIGNOW(4)
    RETURN
END
SUBROUTINE SETRHO(E)
    !=======================================================================
    !
    !     FOR ALL SECTIONS WHICH HAVE AN ENERGY DEPENDENT SCATTERING RADIUS
    !     INTERPOLATE TABULATED VALUES TO DEFINE SCATTERINMG RADIUS AT E.
    !     STORE INTERPOLATED VALUES IN THE ARRAY RHOP1 (THE REMAINDER OF
    !     THE CALCULATIONS CAN THEN PROCEED IGNORING ENERGY DEPENDENCE OF
    !     THE SCATTERING RADIUS).
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/TABRHO/ERHOTB(500), RHOTAB(500), APTAB(500), NRHO(200), &
            NBTRHO(200), INTRHO(200), INXRHO(4, 200), NUMRHO
    !-----SELECT SECTIONS WITH ENERGY DEPENDENT SCATTERING RADIUS.
    DO 70 KSECT = 1, NSECT
        IF(NRHO(KSECT).EQ.0) GO TO 70
        !-----DEFINE INDICES TO INTERPOLATION LAW AND TABULATED DATA.
        LNX = NRHO(KSECT)
        INX1 = INXRHO(1, LNX)
        INX2 = INXRHO(2, LNX)
        INX3 = INXRHO(3, LNX)
        INX4 = INXRHO(4, LNX)
        !-----FIND ENERGY OR ENERGY RANGE WHERE RADII ARE GIVEN.
        DO 10 L = INX3, INX4
            IF(E - ERHOTB(L)) 20, 50, 10
        10 CONTINUE
        !-----EXTEND RADIUS AS CONSTANT OUTSIDE TABULATED ENERGY RANGE.
        L = INX4
        GO TO 50
        20 IF(L.EQ.INX3) GO TO 50
        !-----E IS BETWEEN ERHOTB(L-1) AND ERHOTB(L).
        L = L - 1
        !-----DEFINE INTERPOLATION LAW. DEFINE TRUE POINT INDEX.
        INX5 = L - INX3 + 1
        DO 30 J = INX1, INX2
            IF(INX5.GT.NBTRHO(J)) GO TO 40
        30 CONTINUE
        J = INX2 + 1
        !-----POINT IS IN INTERPOLATION REGION J-1.
        40 J = J - 1
        !-----INTERPOLATE RADIUS TO ENERGY E.
        CALL RHOINT(E, RHOP1(KSECT), ERHOTB(L), RHOTAB(L), INTRHO(J))
        GO TO 60
        !-----DEFINE RADIUS SET AT E (E IS AN ENERGY AT WHICH RADIUS IS
        !-----TABULATED OR E IS OUTSIDE TABULATED RANGE AND WILL BE EXTENDED
        !-----AS CONSTANT).
        50 RHOP1(KSECT) = RHOTAB(L)
        !-----IF REQUESTED SET CHANNEL RADIUS EQUAL TO SCATTERING RADIUS.
        60 IF(NAPTAB(KSECT).EQ.1) RHOX2(KSECT) = RHOP1(KSECT)**2
    70 CONTINUE
    RETURN
END
SUBROUTINE RHOINT(E, RHOP1, ERHOTB, RHOTAB, INT)
    !=======================================================================
    !
    !     INTERPOLATE ENERGY DEPENDENT SCATTERING RADIUS.
    !
    !     THIS ROUTINE HAS BEEN RECODED IN ORDER TO AVOID ROUND-OFF
    !     PROBLEMS ON SHORT WORD LENGTH COMPUTERS, E.G. IBM-360, 370, ETC.
    !     THIS ROUTINE IS NOW SLIGHTLY LESS EFFICIENT THAN IN ITS PREVIOUS
    !     FORM. HOWEVER ALL INTERPOLATION IS NOW DEFINED AS A WEIGHTED SUM
    !     OF TERMS, AS OPPOSED TO THE PREVIOUS FORM WHICH USED DIFFERENCES.
    !
    !     AN ILLEGAL INTERPOLATION CODE OR A NON-POSITIVE ENERGY WHERE LOG
    !     ENERGY INTERPOLATION IS REQUIRED INDICATES EITHER AN ERROR IN THE
    !     DATA AS IT APPEARS IN THE ENDF/B FORMAT, OR AN ERROR IN THIS
    !     PROGRAM. THEREFORE ERRORS OF THIS TYPE WILL CAUSE THE PROGRAM TO
    !     PRINT A WARNING MESSAGE AND TERMINATE EXECUTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/FIELDC/FIELD(11, 12)
    DIMENSION ERHOTB(2), RHOTAB(2)
    !-----CHECK INTERPOLATION CODE.
    IF(INT.LT.1.OR.INT.GT.5) GO TO 60
    !-----DEFINE ENERGIES AT THE 2 ENDS OF THE INTERVAL.
    E1 = ERHOTB(1)
    E2 = ERHOTB(2)
    !-----CHECK FOR ZERO LENGTH INTERVAL.
    DE12 = E2 - E1
    IF(DE12.EQ.0.0) GO TO 90
    !-----SELECT INTERPOLATION LAW.
    GO TO (10, 20, 30, 40, 50), INT
    !
    !     HISTOGRAM. CONSTANT EQUAL TO VALUE AT LOWER ENERGY LIMIT.
    !
    10 RHOP1 = RHOTAB(1)
    RETURN
    !
    !     LINEAR X AND LINEAR Y.
    !
    20 WT2 = (E - E1) / DE12
    WT1 = ONE - WT2
    RHOP1 = WT1 * RHOTAB(1) + WT2 * RHOTAB(2)
    RETURN
    !
    !     LOG X AND LINEAR Y.
    !
    !-----INSURE ALL X VALUES ARE POSITIVE FOR LOG.
    30 IF(E1.LE.0.0.OR.E2.LE.0.0.OR.E.LE.0.0) GO TO 80
    WT2 = DLOG(E / E1) / DLOG(E2 / E1)
    WT1 = ONE - WT2
    RHOP1 = WT1 * RHOTAB(1) + WT2 * RHOTAB(2)
    RETURN
    !
    !     LINEAR X AND LOG Y.
    !
    40 WT2 = (E - E1) / DE12
    WT1 = ONE - WT2
    RHOP1 = DEXP(WT1 * DLOG(RHOTAB(1)) + WT2 * DLOG(RHOTAB(2)))
    RETURN
    !
    !     LOG X AND LOG Y.
    !
    50 IF(E1.LE.0.0.OR.E2.LE.0.0.OR.E.LE.0.0) GO TO 80
    WT2 = DLOG(E / E1) / DLOG(E2 / E1)
    WT1 = ONE - WT2
    RHOP1 = DEXP(WT1 * DLOG(RHOTAB(1)) + WT2 * DLOG(RHOTAB(2)))
    RETURN
    !-----ILLEGAL INTERPOLATE CODE.
    60 WRITE(OUTP, 100) INT
    !-----TERMINATE DUE TO PARAMETER ERROR.
    70 WRITE(OUTP, 130)
    CALL ENDIT
    !-----ILLEGAL LOG ENERGY INTERPOLATION WITH NEGATIVE VALUES.
    80 CALL OUT9(E1, FIELD(1, 1), 3)
    CALL OUT9(E2, FIELD(1, 2), 3)
    CALL OUT9(E, FIELD(1, 3), 3)
    WRITE(OUTP, 110) ((FIELD(M, J), M = 1, 11), J = 1, 3)
    GO TO 70
    !-----ZERO LENGTH ENERGY INTERVAL.
    90 CALL OUT9(E1, FIELD(1, 1), 3)
    CALL OUT9(E2, FIELD(1, 2), 3)
    WRITE(OUTP, 120) ((FIELD(M, J), M = 1, 11), J = 1, 2)
    GO TO 70
    100 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Interpolating Scattering Radius.'/&
            ' Illegal Interpolation Code =', I5, ' (MUST be 1 to 5).'/&
            ' Correct Evaluated Data and Re-Run Program.')
    110 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Interpolating Scattering Radius.'/&
            ' Illegal Log Energy Interpolation Using Negative Energy.'/&
            ' Interpolation Code=', I5, ' (Cannot be 3 or 5).'/&
            ' E1,E2,E=', 3(11A1, 1X)/&
            ' Correct Evaluated Data and Re-Run Program.')
    120 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Interpolating Scattering Radius.'/&
            ' Illegal Interpolation Over Zero Length Interval.'/&
            'E1,E2=', 11A1, 1X, 11A1/&
            ' Correct Evaluated Data and Rr-Run Program.')
    130 FORMAT(1X, 78('=')/' Execution Terminated'/1X, 78('='))
END
SUBROUTINE SIGBW1(E)
    !=======================================================================
    !
    !     ADD CONTRIBUTION OF ONE SECTION OF SINGLE LEVEL BREIT-WIGNER
    !     PARAMETERS.
    !
    !     DEFINITIONS FROM ENDF-102 FORMATS AND PROCEDURES MANUAL
    !     =======================================================
    !     ELASTIC
    !     =======
    !     THE DEFINITION OF SINGLE LEVEL ELASTIC SCATTERING IN ENDF-102 IS
    !     INCORRECT. HERE WE USE THE CORRECT DEFINITION,
    !
    !     ELASTIC = (2*L + 1)*SIN(PS)**2 +
    !
    !       GJ*GAM(N)*(GAM(N) - 2*GAM(T)*SIN(PS)**2 + 2*DE*SIN(2*PS))/DEN
    !
    !     CAPTURE
    !     =======
    !     CAPTURE = GAM(N)*GAM(C)/DEN
    !
    !     FISSION
    !     =======
    !     FISSION = GAM(N)*GAM(F)/DEN
    !
    !     DE  = (E - ER)
    !     DEN = ((DE)**2 + (GAM(T)/2)**2)
    !
    !     SUMMED OVER ALL RESONANCES WITH THE SAME L VALUE. NOTE, THE
    !     POTENTIAL CONTRIBUTION IS INCLUDED ONLY ONCE FOR EACH L VALUE
    !     AND THE TERMS GJ, 2*SIN(PS)**2, 2*SIN(2*PS) ARE THE SAME FOR
    !     ALL RESONANCES WITH THE SAME (L,J) VALUE. THEREFORE THE ROUTINE
    !     WILL DEFINE 3 SEPERATE SUMS,
    !
    !     1) GAM(N)*GAM(N)/DEN
    !     2) GAM(N)*GAM(T)/DEN
    !     3) GAM(N)*DE/DEN
    !
    !     ONLY AFTER SUMMING THESE EXPRESSIONS OVER ALL RESONANCES WILL
    !     THEY BE MULTIPLIER BY THE RESONANCE INDEPENDENT FACTORS TO
    !     DEFINE THE CROSS SECTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DATA SFC/0.0D+00/
    !
    !     DEFINE RESONANCE INDEPENDENT QUANTITIES.
    !
    RHO2 = E * RHOX2(ISECT)
    RHOP = RHOP1(ISECT) * DSQRT(E)
    AL = LVALUE(ISECT)
    !-----DEFINE PENETRATION FACTOR, SHIFT FACTOR, PHASE SHIFT.
    CALL FACTS2(LVALUE(ISECT), RHO2, SF2, PF)
    CALL FACPHI(LVALUE(ISECT), RHOP, PS)
    COSPS = DCOS(PS)
    SINPS = DSIN(PS)
    !-----DEFINE SIN(2*PS) AND 2*SIN(PS)**2
    SIN2PS = TWO * SINPS * COSPS
    SINPS2 = TWO * SINPS * SINPS
    !-----DEFINE PENETRATION FACTOR FOR COMPETITIVE WIDTH.
    IF(LRXTAB(ISECT).LE.0) GO TO 10
    RHOC2 = (E + EXCITE(1, ISECT)) * RHOX2(ISECT)
    CALL FACTS2(LVALUE(ISECT), RHOC2, SFC, PFC)
    GO TO 20
    10 PFC = 0.0
    !
    !     J VALUE LOOP.
    !
    !-----DEFINE STATISTICAL WEIGHT FOR ALL RESONANCES WITH THE SAME (L,J).
    20 GJ = RESTAB(2, LOW)
    AJNOW = RESJTAB(LOW)
    !-----INITIALIZE CONTRIBUTION OF (L,J) SEQUENCE.
    SIGNN1 = ZERO
    SIGNN2 = ZERO
    SIGNN3 = ZERO
    SIGNGJ = ZERO
    SIGNFJ = ZERO
    !
    !     RESONANCE LOOP. ADD CONTRIBUTION OF ALL RESONANCES WITH SAME (L,J)
    !
    DO 30 JR = LOW, LHI
        !-----ONLY USE RESONANCES WITH SAME J VALUE.
        IF(DABS(AJNOW - RESJTAB(JR)).GT.0.01) GO TO 40
        ER = ENRES(JR)
        GAMC = PFC * RESTAB(3, JR)
        GN = RESTAB(4, JR)
        GAMN = PF * GN
        GAMG = RESTAB(5, JR)
        GAMF = RESTAB(6, JR)
        GAMT = GAMN + GAMG + GAMF + GAMC
        GAMT2 = HALF * GAMT
        DE = E - (ER + GN * (SHIFT2(JR) - SF2))
        DEN = DE * DE + GAMT2 * GAMT2
        COMFAC = GAMN / DEN
        SIGNN1 = SIGNN1 + COMFAC * GAMN
        SIGNN2 = SIGNN2 + COMFAC * GAMT
        SIGNN3 = SIGNN3 + COMFAC * DE
        SIGNGJ = SIGNGJ + COMFAC * GAMG
        SIGNFJ = SIGNFJ + COMFAC * GAMF
        !-----END OF RESONANCE LOOP.
    30 CONTINUE
    JR = LHI + 1
    !-----MULTIPLY CONTRIBUTION OF (L,J) SEQUENCE BY STATISTICAL WEIGHT
    !-----AND ADD TO SUM...NOTE, SINPS2 IS 2*SIN(PS)**2
    40 SIGNNI = SIGNNI + GJ * (SIGNN1 - SIGNN2 * SINPS2 + TWO * SIGNN3 * SIN2PS)
    SIGNGI = SIGNGI + GJ * SIGNGJ
    SIGNFI = SIGNFI + GJ * SIGNFJ
    !-----TEST FOR ANOTHER J VALUE.
    LOW = JR
    IF(LOW.LE.LHI) GO TO 20
    !
    !     ADD POTENTIAL SCATTERING CONTRIBUTION FOR L VALUE.
    !
    !-----ADD 4*(2*L+1)*SIN(PS)**2 (NOTE, SINPS2 IS 2*SIN(PS)**2)
    SIGNNI = SIGNNI + (FOUR * AL + TWO) * SINPS2
    RETURN
END
SUBROUTINE SIGBWM(E)
    !=======================================================================
    !
    !     ADD CONTRIBUTION OF ONE SECTION OF MULTI-LEVEL BREIT-WIGNER
    !     PARAMETERS.
    !
    !     DEFINITIONS FROM ENDF-102 FORMATS AND PROCEDURES MANUAL
    !     =======================================================
    !     CAPTURE AND FISSION CROSS SECTIONS ARE CALCULATED EXACTLY AS IN
    !     THE CASE OF SINGLE LEVEL BREIT-WIGNER RESONANCES (FOR DETAILS
    !     SEE, SUBROUTINE SIGBW1). HERE WE WILL ONLY CONSIDER THE ELASTIC
    !     CROSS SECTION.
    !
    !     THE ELASTIC CROSS SECTION IS DEFINED TO BE,
    !
    !     ELASTIC = GJ*(1 - U(N,N))**2
    !
    !                                     I*GAM(N)
    !     U(N,N)= EXP(-I*2*PS)*(I + ====================)
    !                               ((ER-E)-I*GAM(T)/2)
    !
    !                                I*GAM(N)*((ER-E)+I*GAM(T)/2)
    !           = EXP(-I*2*PS)*(I + =======================================)
    !                               ((ER-E)-I*GAM(T)/2)*((ER-E)+I*GAM(T)/2)
    !
    !                                I*GAM(N)*((ER-E)-GAM(N)*GAM(T)/2)
    !           = EXP(-I*2*PS)*(I + =======================================)
    !                               ((ER-E)**2+(GAM(T)/2)**2)
    !
    !     U(N,N) = (COS(2*PS) - I*SIN(2*PS))*((1 - R) - I*S)
    !
    !     R      = GAM(N)*GAM(T)/2/DEN
    !     S      = GAM(N)*DE/DEN
    !     GAM(N) = NEUTRON WIDTH
    !     GAM(R) = TOTAL WIDTH
    !     DE     = E - ER
    !     DEN    = ((E - ER)**2 + GAM(T)**2)
    !
    !     SUMMED OVER RESONANCES FOR EACH (L,J) SEQUENCE.
    !
    !     FROM OUR DEFINITION OF A UNIFORM TREATMENT OF ALL FORMALISMS WE
    !     CAN IMMEDIATELY IDENTIFY,
    !
    !     X =  R
    !     Y =  S
    !
    !     AND SUBSTITUTE INTO OUR GENERAL EXPRESSION,
    !
    !     ELASTIC =GJ*(2*SIN(PS)**2 - R)**2 + (SIN(2*PS) + S)**2)
    !
    !     ABSORPTION (CAPTURE AND FISSION) ARE TREATED IN A SINGLE LEVEL
    !     APPROXIMATION,
    !
    !     CAPTURE =GJ*GAM(N)*GAM(G)/DEN
    !
    !     FISSION =GJ*GAM(N)*GAM(F)/DEN
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DATA SFC/0.0D+00/
    !
    !     DEFINE RESONANCE INDEPENDENT QUANTITIES.
    !
    RHO2 = E * RHOX2(ISECT)
    RHOP = RHOP1(ISECT) * DSQRT(E)
    !-----DEFINE PENETRATION FACTOR, SHIFT FACTOR, PHASE SHIFT.
    CALL FACTS2(LVALUE(ISECT), RHO2, SF2, PF)
    CALL FACPHI(LVALUE(ISECT), RHOP, PS)
    COSPS = DCOS(PS)
    SINPS = DSIN(PS)
    !-----DEFINE SIN(2*PS) AND 2*SIN(PS)**2
    SIN2PS = TWO * SINPS * COSPS
    SINPS2 = TWO * SINPS * SINPS
    !-----DEFINE PENETRATION FACTOR FOR COMPETITIVE WIDTH.
    IF(LRXTAB(ISECT).LE.0) GO TO 10
    RHOC2 = (E + EXCITE(1, ISECT)) * RHOX2(ISECT)
    CALL FACTS2(LVALUE(ISECT), RHOC2, SFC, PFC)
    GO TO 20
    10 PFC = 0.0
    !
    !     J VALUE LOOP.
    !
    !-----DEFINE STATISTICAL WEIGHT FOR ALL RESONANCES WITH THE SAME (L,J).
    20 GJ = RESTAB(2, LOW)
    AJNOW = RESJTAB(LOW)
    !
    !     FOR MISSING AND ILLEGAL J SEQUENCES (INDICATED BY NEGATIVE GJ)
    !     ADD (OR SUBTRACT) POTENTIAL CONTRIBUTION TO ELASTIC CROSS SECTION.
    !
    IF(GJ.GT.0.0) GO TO 30
    !-----ADD 4*GJ*SIN(PS)**2 (NOTE, SINPS2 IS 2*SIN(PS)**2)
    SIGNNI = SIGNNI + TWO * RESTAB(3, LOW) * SINPS2
    LOW = LOW + 1
    GO TO 60
    !-----INITIALIZE CONTRIBUTION OF (L,J) SEQUENCE.
    30 SIGNN1 = ZERO
    SIGNN2 = ZERO
    SIGNGJ = ZERO
    SIGNFJ = ZERO
    !
    !     RESONANCE LOOP. ADD CONTRIBUTION OF ALL RESONANCES WITH SAME (L,J)
    !
    DO 40 JR = LOW, LHI
        !-----ONLY USE RESONANCES WITH SAME J VALUE.
        IF(DABS(AJNOW - RESJTAB(JR)).GT.0.01) GO TO 50
        ER = ENRES(JR)
        GAMC = PFC * RESTAB(3, JR)
        GN = RESTAB(4, JR)
        GAMN = PF * GN
        GAMG = RESTAB(5, JR)
        GAMF = RESTAB(6, JR)
        DE = E - (ER + GN * (SHIFT2(JR) - SF2))
        GAMT2 = HALF * (GAMN + GAMG + GAMF + GAMC)
        DEN = DE * DE + GAMT2 * GAMT2
        COMFAC = GAMN / DEN
        SIGNN1 = SIGNN1 + COMFAC * GAMT2
        SIGNN2 = SIGNN2 + COMFAC * DE
        SIGNGJ = SIGNGJ + COMFAC * GAMG
        SIGNFJ = SIGNFJ + COMFAC * GAMF
        !-----END OF RESONANCE LOOP.
    40 CONTINUE
    JR = LHI + 1
    !-----DEFINE NEUTRON CROSS SECTION, MULTIPLY BY STATISTICAL WEIGHT AND
    !-----ADD CONTRIBUTION OF (L,J) SEQUENCE TO SUM.
    50 SIGNNI = SIGNNI + GJ * ((SINPS2 - SIGNN1)**2 + (SIN2PS + SIGNN2)**2)
    SIGNGI = SIGNGI + GJ * SIGNGJ
    SIGNFI = SIGNFI + GJ * SIGNFJ
    !-----TEST FOR ANOTHER J VALUE.
    LOW = JR
    60 IF(LOW.LE.LHI) GO TO 20
    RETURN
END
SUBROUTINE SIGRM(E)
    !=======================================================================
    !
    !     ADD CONTRIBUTION OF ONE SECTION OF REICH-MOORE PARAMETERS.
    !
    !     DEFINITIONS FROM ENDF-102 FORMATS AND PROCEDURES MANUAL
    !     =======================================================
    !     THE CROSS SECTIONS ARE DEFINED TO BE,
    !
    !     TOTAL        =2*GJ*REAL(I - U(N,N))
    !     ABSORPTION   =4*GJ*(REAL(RHO(N,N)) - RHO(N,N)**2)
    !                  =  GJ*(I - U(N,N)**2)
    !     ELASTIC      =  GJ*(I - U(N,N))**2
    !     FISSION      =4*GJ*(SUM OVER C)(RHO(N,C)**2)
    !     CAPTURE      = ABSORPTION - FISSION
    !
    !     WHICH ARE COMPLETELY DEFINED IN TERMS OF U(N,N) AND RHO(N,C),
    !
    !     RHO(N,C)     =I - INVERSE(I - K)
    !     U(N,N)       =EXP(-I*2*PS)*(2*INVERSE(I - K) - I)
    !                  =(COS(2*PS) - I*SIN(2*PS))*(2*INVERSE(I - K) - I)
    !                  =(COS(2*PS) - I*SIN(2*PS))*(1 - 2*RHO(N,N))
    !
    !                  =COS(2*PS)*(I-2*REAL(RHO)) - I*2*SIN(2*PS)*IM(RHO)
    !
    !     REAL(U(N,N)) =   COS(2*PS)*(I-2*REAL(RHO))
    !     IM(U(N,N))   =-2*SIN(2*PS)*IM(RHO)
    !
    !     MATRIX ELEMENTS
    !     =======================================================
    !
    !                     I*SQRT(GAM(C)/2*GAM(C*)/2)
    !     (I - K)    =I - ==============================================
    !                     ((ER-E) -I*(GAM(R)/2)
    !
    !                      I*SQRT(GAM(C)/2*GAM(C*)/2)*((ER-E) + I*(GAM(R)/2)
    !                =I - ==================================================
    !                     ((ER-E) -I*(GAM(R)/2)*((ER-E) + I*(GAM(R)/2)
    !
    !                     SQRT(GAM(C)/2*GAM(C*)/2)*(GAM(R)/2)
    !                =I + ==============================================
    !                     ((ER-E)**2 + (GAM(R)/2)**2)
    !
    !                     SQRT(GAM(C)/2*GAM(C*)/2)*(ER-E)
    !                =  - ==============================================
    !                     ((ER-E)**2 + (GAM(R)/2)**2)
    !
    !     (I - K)      = (R + I) - I*S
    !
    !     R            = SQRT(GAM(C)/2*GAM(C*)/2)*(GAM/2)/DEN
    !     S            = SQRT(GAM(C)/2*GAM(C*)/2)*(ER-E)/DEN
    !     GAM(R)       = ELIMINATED RADIATIVE WIDTH
    !     GAM(C)       = PARTIAL WIDE FOR CHANNEL C FOR A RESONANCE
    !     DEN          = ((ER - E)**2 + (GAM/2)**2)
    !
    !     SUMMED OVER RESONANCES FOR EACH (L,J) SEQUENCE.
    !
    !     PHYSICALLY (R) IS THE SYMMETRIC CONTRIBUTION OF THE RESONANCES
    !     AND IS ALWAYS POSITIVE. SIMILARLY (S) IS THE ANTI-SYMMETRIC
    !     CONTRIBUTION OF THE RESONANCES AND IS NEGATIVE FOR ENERGIES
    !     LESS THAN THE RESONANCE AND POSITIVE FOR ENERGIES GREATER THAN
    !     THE RESONANCE.
    !
    !     NOTE, IN ENDF-102 THE 2 VARIABLES DESCRIBED CORRESPOND TO (R+I)
    !     AND (S). IN ORDER TO IMPROVE NUMERICAL STABILITY AND SIMPLIFY
    !     THE RESULTS THE FOLLOWING EQUATIONS WILL BE DEFINED IN TERMS OF
    !     (R) AND (S), SO THAT THE SOLUTION CAN BE DEFINED DIRECTLY IN
    !     TERMS OF THE SYMMETRIC AND ANTI-SYMMETRIC RESONANCE CONTRIBUTIONS.
    !
    !     SQUARES, SUCH AS RHO(N,N)**2 AND (I - U(N,N))**2, MUST BE
    !     EVALUATED IN TERMS OF THE VARIABLE AND COMPLEX CONGEGATE, E.G.,
    !     F(X)    =  A + B*I
    !     F(X)**2 = (A + B*I)*(A - B*I) = A**2 + B**2
    !
    !     SO THAT,
    !     RHO(N,N)**2     = (REAL(RHO(N,N))**2 + (IM(RHO(N,N))**2
    !     (1 - U(N,N))**2 = (REAL(I - U(N,N))**2) + (IM(U(N,N))**2
    !                     = I - 2*REAL(U(N,N))
    !                     + (REAL(U(N,N))**2)+(IM(U(N,N))**2)
    !                     = I - 2*REAL(U(N,N)
    !                     + (U(N,N))**2
    !     SOLUTION
    !     =======================================================
    !     INVERTING THE MATRIX
    !     =======================================================
    !     STARTING FROM THE COMPLEX MATRIX,
    !     (I - K)        = (R + I) - I*S
    !     WE WILL DEFINE ITS INVERSE
    !     INVERSE(I - K) = (RI + I) - I*SI
    !     BY DEFINITION,
    !     I = ((R + I) - I*S)*((RI + I) - I*SI)
    !
    !     FROM THIS WE OBTAIN 2 REAL MATRIX EQUATIONS,
    !     I = (R + I)*(RI + I) - S*SI
    !     0 = S*(RI + I) + (R + I)*SI
    !
    !     I - (R + I) = (R + I)*RI - S*SI
    !     -S          =       S*RI + (R + I)*SI
    !
    !     -R          = (R + I)*RI - S*SI
    !     -S          =       S*RI + (R + I)*SI
    !
    !     IF THERE IS NO FISSION THEN R, S, RI AND SI ARE MERELY SCALARS
    !     AND THE INVERSION IS ACCOMPLISHED AS DESCRIBED HERE.
    !
    !     IF THERE IS FISSION R, S, RI AND SI ARE 3 X 3 MATRICES AND THE
    !     INVERSION IS ACCOMPLISHED BY MATRIX INVERSION.
    !
    !     IN EITHER CASE THE ABOVE RELATIONSHIPS ARE AT LEAST SYMBOLICALLY
    !     CORRECT AND CAN BE USED TO DEFINE USEFUL PROPERTIES OF THE
    !     INVERSE MATRIX. AT LEAST SYMBOLICALLY WE CAN TREAT THESE TERMS
    !     AS A LINEAR SYSTEM OF 2 EQUATIONS IN 2 UNKNOWNS AND IMMEDIATELY
    !     WRITE THE SOLUTION IN THE FORM,
    !
    !     RI      = -(R*(R+I)+S*S)/((R+I)*(R+I)+S*S)
    !     SI      =  ((R+I)*S - S*R)/((R+I)*(R+I)+S*S)
    !             = -S/((R+I)*(R+I)+S*S)
    !
    !     DEFINITION OF TERMS APPEARING IN THE CROSS SECTIONS
    !     =======================================================
    !     RHO(N,C)       =I - INVERSE(I - K)
    !                    =I - ((RI+I)-I*SI)
    !                    =-(RI - I*SI)
    !     REAL(RHO(N,C)) =-RI
    !     IM(RHO(N,C))   = SI
    !     RHO(N,C)**2    =(RI)**2 + (SI)**2
    !
    !     U(N,N)         =(COS(2*PS) - I*SIN(2*PS))*(2*INVERSE(I - K) - I)
    !                    =(COS(2*PS)-I*SIN(2*PS))*(2*INVERSE(I-K)-1) + I)
    !                    =(COS(2*PS)-I*SIN(2*PS))*(1 - 2*RHO(N,N))
    !                    =(COS(2*PS)-I*SIN(2*PS))*(1 + 2*RI - I*2*SI)
    !
    !                    =COS(2*PS)*(1 + 2*RI) + SIN(2*PS)*2*SI
    !                    -I*(COS(2*PS)*2*SI - SIN(2*PS)*(1 + 2*RI))
    !
    !     REAL(U(N,N))   =COS(2*PS)*(1 + 2*RI) + SIN(2*PS)*2*SI
    !     IM(U(N,N))     =-(2*COS(2*PS)*SI - SIN(2*PS)*(1 + 2*RI))
    !     (U(N,N))**2    =REAL(U(N,N))**2 + IM(U(N,N))**2
    !     REAL(U(N,N))**2=(COS(2*PS)**2)*(((1 + 2*RI)**2)
    !                    +4*(SIN(2*PS)**2)*(SI**2)
    !                    +4*COS(2*PS)*SIN(2*PS)*(1 + 2*RI)*SI
    !     IM(U(N,N))**2  =(SIN(2*PS)**2)*(((1 + 2*RI)**2)
    !                    +4*(COS(2*PS)**2)*(SI**2)
    !                    -4*COS(2*PS)*SIN(2*PS)*(1 + 2*RI)*SI
    !
    !     NOTE,           4*COS(2*PS)*SIN(2*PS)*(1 + 2*RI)*SI CANCELS OUT
    !                     AND COS(2*PS)**2 + SIN(2*PS)**2 = 1
    !
    !     (U(N,N))**2    =((1 + 2*RI)**2 +4*(SI**2)
    !                    = 1 + 4*(RI + RI**2 +SI**2)
    !
    !     DEFINITION OF THE CROSS SECTIONS
    !     =======================================================
    !     TOTAL
    !     =======================================================
    !     IN THIS PROGRAM THE TOTAL IS DEFINED TO BE THE SUM OF ITS PART,
    !
    !     TOTAL = ELASTIC + ABSORPTION
    !
    !     HOWEVER FOR COMPLETENESS WE WILL DEFINE IT HERE.
    !
    !     TOTAL        =2*GJ*REAL(1 - U(N,N))
    !                  =2*GJ*(1 -((COS(2*PS)*(2*RI+1)+SIN(2*PS)*2*SI)))
    !                  =2*GJ*(1 - COS(2*PS)-2*(COS(2*PS)*RI-SIN(2*PS)*SI))
    !                  =4*GJ*(SIN(PS)**2 - (COS(2*PS)*RI-SIN(2*PS)*SI))
    !
    !     HERE WE HAVE USED THE IDENTITY 1 - COS(2*PS) = 2*SIN(PS)**2
    !
    !     ABSORPTION
    !     =======================================================
    !     ABSORPTION   =4*GJ*(REAL(RHO(N,N) - RHO(N,N)**2)
    !                  =4*GJ*(-RI           - (RI**2 + SI**2))
    !                  =-4*GJ*(RI + RI**2 + SI**2))
    !
    !     FISSION
    !     =======================================================
    !     FISSION      =SUM RHO(N,C)**2
    !
    !     WHERE RHO(N,C) ARE THE OFF DIAGONAL TERMS OF THE MATRICES.
    !     WRITTEN EXPLIVITLY,
    !
    !     FISSION      =RHO(1,2)**2 + RHO(1,3)**2
    !                  =RI(1,2)**2 + RI(1,3)**2 + SI(1,2)**2 + SI(1,3)**2
    !
    !     CAPTURE
    !     =======================================================
    !     CAPTURE IS DEFINED TO BE,
    !
    !     CAPTURE      = ABSORPTION - FISSION
    !
    !     WHEN THERE IS NO FISSION CAPTURE IS EQUAL TO ABSORPTION.
    !
    !     ELASTIC
    !     =======================================================
    !     ELASTIC      =  GJ*(1 - U(N,N))**2
    !
    !     NOTE THAT THIS DEFINITION IS EXACTLY THE SAME AS IN THE CASE
    !     OF MULTI-LEVEL BREIT-WIGNER RESONANCES, IF WE USE (RI) AND (SI)
    !     INSTEAD OF (R) AND (S) (SEE, SUBROUTINE SIGBWM FOR DETAILS).
    !     THEREFORE WE SHOULD NOT BE SURPRISED TO FIND A SIMILAR
    !     EXPRESSION FOR THE ELASTIC CROSS SECTION,
    !
    !     ELASTIC=GJ*(1 - U(N,N))**2
    !            =GJ*(1-2*REAL(U(N,N))+(REAL(U(N,N))**2+IM(U(N,N))**2)
    !            =GJ*(1-2*(COS(2*PS)*(RI+1)-SIN(2*PS)*SI)+(RI+1)**2+SI**2)
    !            =GJ*(1-2*(COS(2*PS)*(RI+1)-SIN(2*PS)*SI)+(RI+1)**2+SI**2)
    !
    !     BY ADDING AND SUBTRACTING TERMS THIS CAN BE WRITTEN AS THE SUM OF
    !     THE SQUARE OF 2 TERMS,
    !
    !     ELASTIC=GJ*((COS(2*PS)-(RI+1))**2 + (SIN(2*PS)+SI)**2)
    !
    !            =GJ*(COS(2*PS)**2 -2*(RI+1)*COS(2*PS) + (RI+1)**2
    !                +SIN(2*PS)**2 +2*SI*SIN(2*PS)     + SI**2)
    !             ========================================================
    !            =GJ*(1-2*(COS(2*PS)*(RI+1)-SIN(2*PS)*SI)+(RI+1)**2+SI**2)
    !
    !     HERE WE HAVE USED THE IDENTITY COS(2*PS)**2+SIN(2*PS)**2 = 1
    !
    !     THIS FORM CAN BE FURTHER SIMPLIFIED TO AVOID ROUND-OFF,
    !
    !     (COS(2*PS)-(RI+1))**2 = ((COS(2*PS)-1)-RI)**2
    !                          = (-2*SIN(PS)**2-RI)**2
    !                          = (2*SIN(PS)**2+RI)**2
    !     TO FIND,
    !
    !     ELASTIC  = GJ*(2*SIN(PS)**2+RI)**2 + (SIN(2*PS)+SI)**2)
    !
    !    THIS IS THE FORM IN WHICH THE ELASTIC CROSS SECTION IS CALCULATED,
    !
    !    POTENTIAL CROSS SECTION
    !    =======================
    !    FAR FROM RESONANCES AND FOR (L,J) SEQUENCES WHICH DO NOT HAVE ANY
    !    RESONANCES (RI) AND (SI) WILL BE SMALL OR ZERO AND WE FIND THAT THE
    !    ELASTIC CROSS SECTION REDUCES TO THE POTENTIAL CROSS SECTION,
    !
    !    ELASTIC  =GJ*(4*SIN(PS)**4 + SIN(2*PS)**2)
    !
    !    USING THE IDENTITY SIN(2*PS) = 2*SIN(PS)*COS(PS)
    !
    !             =GJ*(4*SIN(PS)**4 + 4*(SIN(PS)*COS(PS))**2)
    !             =4*GJ*SIN(PS)**2*(SIN(PS)**2 + COS(PS)**2)
    !
    !    BUT SIN(PS)**2 + COS(PS)**2 = 1, TO FIND,
    !
    !    ELASTIC  =4*GJ*SIN(PS)**2
    !
    !    IT IS IMPORTANT TO REALIZE THAT EVEN IN THE CASE WHERE THERE ARE
    !    NO RESONANCES SPECIFIED FOR A (L,J) SEQUENCE THE CROSS SECTION
    !    DOES NOT BECOME ZERO, SINCE THERE IS STILL A CONTRIBUTION TO THE
    !    POTENTIAL CROSS SECTION.
    !
    !     NUMERICAL STABILITY
    !     =======================================================
    !     OBVIOUSLY, PHYSICALLY THE TOTAL, ELASTIC AND ABSORPTION CANNOT
    !     BE NEGATIVE, AND ALL OF THE ABOVE EQUATIONS REFLECT THIS FACT.
    !     HOWEVER, CARE MUST BE USED TO AVOID NUMERICAL INSTABILITY.
    !
    !     FROM THE DEFINITION OF ABSORPTION,
    !
    !     ABSORPTION   =-4*GJ*(RI + RI**2 + SI**2)
    !
    !     BUT BY THE ABOVE DEFINITIONS,
    !
    !     RI      = -(R*(R+I)+S*S)/((R+I)*(R+I)+S*S)
    !     SI      = -S/((R+I)*(R+I)+S*S)
    !
    !     RI      = -((R+I)*(R+I)+S*S - (R+I))/((R+I)*(R+I)+*S*S)
    !             = (R+I)/((R+I)*(R+I)+S*S) - I
    !     RI**2   = (R+I)**2/((R+I)**2+S**2)**2)-2*(R+I)/((R+I)**2+S**2)+1
    !     SI**2   =     S**2/((R+I)**2+S**2)**2)
    !
    !     RI**2+SI**2 = (I - 2*(R+I) + ((R+I)**2+S**2))/((R+I)**2+S**2)
    !     RI          = (  +   (R+I) - ((R+I)**2+S**2))/((R+I)**2+S**2)
    !     =============================================================
    !     SUM         = (I -   (R+I)                  )/((R+I)**2+S**2)
    !                 =-R/((R+I)**2+S**2)
    !
    !     ABSORPTION  =4*GJ*R/((R+I)*(R+I)+S*S)
    !
    !     FROM THE DEFINITION OF R WE CAN SEE THAT THIS IS MERELY THE
    !     SYMMETRIC CONTRIBUTION OF THE RESONANCES, WHICH IS INHERENTLY
    !     POSITIVE AND NOT SUBJECT TO ROUND-OFF ERROR. THEREFORE THIS
    !     DEFINITION OF THE ABSORPTION WILL BE INHERENTLY STABLE IF WE
    !     AVOID PROBLEMS BY INITIALLY DEFINING (R) RATHER THAN (R+I) AND
    !     USE THIS QUANTITY TO DEFINE THE ABSORPTION (NOTE, IF WE FIRST TRY
    !     TO DEFINE (R+I) IT INVOLVES ADDING I WHICH INTRODUCES ROUND-OFF
    !     ERROR FAR FROM RESONANCES - IF WE SUBSEQUENTLY TRY TO DEFINE R
    !     BY SUBTRACTING I WE CAN MERELY INTRODUCE MORE ROUND-OFF - HOWEVER
    !     IF WE DEFINE THE QUANTITY (R) DIRECTLY WE DO NOT INTRODUCE ANY
    !     ROUND-OFF).
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/FISSY/LFWX, LFI, MT451
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION R(3, 3), S(3, 3), RI(3, 3), SI(3, 3)
    EQUIVALENCE (RI(1, 1), RI11), (SI(1, 1), SI11), (RI(1, 2), RI12), &
            (SI(1, 2), SI12), (RI(1, 3), RI13), (SI(1, 3), SI13)
    !
    !     DEFINE RESONANCE INDEPENDENT QUANTITIES.
    !
    RHO2 = E * RHOX2(ISECT)
    RHOP = RHOP1(ISECT) * DSQRT(E)
    !-----DEFINE PENETRATION FACTOR, SHIFT FACTOR, PHASE SHIFT.
    CALL FACTS2(LVALUE(ISECT), RHO2, SF2, PF)
    CALL FACPHI(LVALUE(ISECT), RHOP, PS)
    COSPS = DCOS(PS)
    SINPS = DSIN(PS)
    !-----DEFINE SIN(2*PS) AND 2*SIN(PS)**2
    SIN2PS = TWO * SINPS * COSPS
    SINPS2 = TWO * SINPS * SINPS
    !-----IS MATERIAL FISSIONABLE.
    IF(LFWX.NE.0) GO TO 60
    !
    !     NO FISSION.
    !
    !     J VALUE LOOP.
    !
    !-----DEFINE STATISTICAL WEIGHT FOR ALL RESONANCES WITH THE SAME (L,J).
    10 GJ = RESTAB(2, LOW)
    AJNOW = RESJTAB(LOW)
    !
    !     FOR ILLEGAL OR MISSING J SEQUENCES (INDICATED BY NEGATIVE GJ)
    !     ADD (OR SUBTRACT) POTENTIAL CONTRIBUTION TO TOTAL AND ELASTIC
    !     CROSS SECTIONS.
    !
    IF(GJ.GT.0.0) GO TO 20
    !-----ADD 4*GJ*SIN(PS)**2 (NOTE, SINPS2 IS 2*SIN(PS)**2)
    SIGNNI = SIGNNI + TWO * RESTAB(3, LOW) * SINPS2
    LOW = LOW + 1
    GO TO 50
    !-----INITIALIZE ELEMENTS.
    20 R(1, 1) = ZERO
    S(1, 1) = ZERO
    !
    !     RESONANCE LOOP. ADD CONTRIBUTION OF ALL RESONANCES WITH SAME (L,J)
    !
    DO 30 JR = LOW, LHI
        !-----ONLY USE RESONANCES WITH SAME STATISTICAL WEIGHT, I.E. J VALUE.
        IF(DABS(AJNOW - RESJTAB(JR)).GT.0.01) GO TO 40
        DE = ENRES(JR) - E
        GAMN = PF * RESTAB(3, JR)
        GAMNG2 = RESTAB(4, JR)
        DEN = DE * DE + GAMNG2 * GAMNG2
        DE2 = DE / DEN
        GAMNG4 = GAMNG2 / DEN
        !-----DEFINE TERMS IN UPPER TRIANGLE OF MATRIX.
        R(1, 1) = R(1, 1) + GAMNG4 * GAMN
        S(1, 1) = S(1, 1) + DE2 * GAMN
        !-----END OF RESONANCE LOOP.
    30 CONTINUE
    JR = LHI + 1
    !-----ADD IDENTITY TO REAL PART.
    40 R11P1 = R(1, 1) + ONE
    !-----DEFINE DETERMINANT.
    DET = R11P1 * R11P1 + S(1, 1) * S(1, 1)
    !-----DEFINE,
    !----- SI     = -S/((R+I)*(R+I)+S*S)
    !----- RI     = -(R+R**2+S**2)/((R+I)*(R+I)+S*S)
    !-----DEFINE INVERSES...WARNING...THIS IS REALLY -SI11 AND -RI11.
    !-----THE MINUS HAS BEEN DROPPED HERE AND IN THE DEFINITION OF THE
    !-----ELASTIC CROSS SECTION (SIGNNI), BELOW, TO SIMPLY AVOID TAKING
    !-----MINUS TWICE.
    !-----WE ONLY NEED RI11 AND SI11
    SI11 = -S(1, 1) / DET
    RI11P1 = R11P1 / DET
    RI11 = RI11P1 - ONE
    !
    !     ADD CONTRIBUTION OF CURRENT (L,J) SEQUENCE TO SUM.
    !
    !-----ABSORPTION (IN THIS CASE ONLY CAPTURE).
    SIGNG1 = -FOUR * GJ * (RI11 + (RI11**2 + SI11**2))
    !-----ELASTIC.
    SIGNNI = SIGNNI + GJ * ((SINPS2 + TWO * RI11)**2 + (SIN2PS + TWO * SI11)**2)
    !-----CAPTURE (ABSORPTION).
    SIGNGI = SIGNGI + SIGNG1
    !-----TEST FOR ANOTHER J VALUE.
    LOW = JR
    50 IF(LOW.LE.LHI) GO TO 10
    RETURN
    !
    !     FISSION
    !
    !     J VALUE LOOP.
    !
    !-----DEFINE STATISTICAL WEIGHT FOR ALL RESONANCES WITH THE SAME (L,J).
    60 GJ = RESTAB(2, LOW)
    AJNOW = RESJTAB(LOW)
    !
    !     FOR ILLEGAL OR MISSING J SEQUENCES (INDICATED BY NEGATIVE GJ)
    !     ADD (OR SUBTRACT) POTENTIAL CONTRIBUTION TO TOTAL AND ELASTIC
    !     CROSS SECTIONS.
    !
    IF(GJ.GT.0.0) GO TO 70
    !-----ADD 4*GJ*SIN(PS)**2 (NOTE, SINPS2 IS 2*SIN(PS)**2)
    SIGNNI = SIGNNI + TWO * RESTAB(3, LOW) * SINPS2
    LOW = LOW + 1
    GO TO 110
    !-----INITIALIZE MATRICES.
    70 DO 80 I = 1, 3
        DO 80 J = 1, 3
            S(I, J) = ZERO
        80 R(I, J) = ZERO
    !
    !     RESONANCE LOOP. ADD CONTRIBUTION OF ALL RESONANCES WITH SAME (L,J)
    !
    DO 90 JR = LOW, LHI
        !-----ONLY USE RESONANCES WITH SAME STATISTICAL WEIGHT, I.E. J VALUE.
        IF(DABS(AJNOW - RESJTAB(JR)).GT.0.01) GO TO 100
        DE = ENRES(JR) - E
        GAMN = PF * RESTAB(3, JR)
        GAMN2 = DSQRT(GAMN)
        GAMNG2 = RESTAB(4, JR)
        GAMFA2 = RESTAB(5, JR)
        GAMFA = GAMFA2 * GAMFA2
        GAMFB2 = RESTAB(6, JR)
        GAMFB = GAMFB2 * GAMFB2
        DEN = DE * DE + GAMNG2 * GAMNG2
        DE2 = DE / DEN
        GAMNG4 = GAMNG2 / DEN
        GAMNFA = GAMN2 * GAMFA2
        GAMNFB = GAMN2 * GAMFB2
        GAMFAB = GAMFA2 * GAMFB2
        !-----DEFINE TERMS IN UPPER TRIANGLE OF MATRIX.
        R(1, 1) = R(1, 1) + GAMNG4 * GAMN
        R(1, 2) = R(1, 2) + GAMNG4 * GAMNFA
        R(1, 3) = R(1, 3) + GAMNG4 * GAMNFB
        R(2, 2) = R(2, 2) + GAMNG4 * GAMFA
        R(2, 3) = R(2, 3) + GAMNG4 * GAMFAB
        R(3, 3) = R(3, 3) + GAMNG4 * GAMFB
        S(1, 1) = S(1, 1) + DE2 * GAMN
        S(1, 2) = S(1, 2) + DE2 * GAMNFA
        S(1, 3) = S(1, 3) + DE2 * GAMNFB
        S(2, 2) = S(2, 2) + DE2 * GAMFA
        S(2, 3) = S(2, 3) + DE2 * GAMFAB
        S(3, 3) = S(3, 3) + DE2 * GAMFB
        !-----END OF RESONANCE LOOP.
    90 CONTINUE
    JR = LHI + 1
    !-----MAKE MATRICES SYMMETRIC.
    100 R(2, 1) = R(1, 2)
    S(2, 1) = S(1, 2)
    R(3, 1) = R(1, 3)
    S(3, 1) = S(1, 3)
    R(3, 2) = R(2, 3)
    S(3, 2) = S(2, 3)
    !-----INVERT COMPLEX MATRIX.
    CALL FROBNS(R, S, RI, SI)
    !
    !     ADD CONTRIBUTION OF CURRENT (L,J) SEQUENCE TO SUM.
    !
    !-----(SEE, EQULVALENCE FOR DEFINITION OF RI11, SI11, RI12, SI12, RI13,
    !----- SI13).
    GJ4 = FOUR * GJ
    !-----ABSORPTION (IN THIS CASE CAPTURE + FISSION).
    SIGNG1 = -GJ4 * (RI11 + (RI11**2 + SI11**2))
    !-----ELASTIC.
    SIGNNI = SIGNNI + GJ * ((SINPS2 + TWO * RI11)**2 + (SIN2PS + TWO * SI11)**2)
    !-----FISSION.
    SIGNF1 = GJ4 * (RI12**2 + RI13**2 + SI12**2 + SI13**2)
    !-----CAPTURE (ABSORPTION - FISSION).
    SIGNGI = SIGNGI + (SIGNG1 - SIGNF1)
    !-----FISSION.
    SIGNFI = SIGNFI + SIGNF1
    !-----TEST FOR ANOTHER J VALUE.
    LOW = JR
    110 IF(LOW.LE.LHI) GO TO 60
    RETURN
END
SUBROUTINE SIGAA4(E)
    !=======================================================================
    !
    !     ADD CONTRIBUTION OF ONE SECTION OF ADLER-ADLER PARAMETERS.
    !     THIS WILL INCLUDE THE BACKGROUND CROSS SECTION PLUS ALL
    !     RESONANCES, FOR ALL VALUES OF L AND J.
    !
    !     THIS ROUTINE USES THE ENDF/B-IV AND EARLIER DEFINITIONS OF THE
    !     ADLER-ADLER PARAMETERS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DATA COMFC1/0.0D+00/
    !-----DEFINE ARITHMETIC STATEMENT FUNCTION FOR CALCULATION OF BACKGROUND
    BACKGR(JR) = ((((RESTAB(4, JR) / E + RESTAB(3, JR)) / E + RESTAB(2, JR)) / E + &
            RESTAB(1, JR)) + (RESTAB(6, JR) * E + RESTAB(5, JR)) * E)
    !-----DEFINE ARITHMETIC STATEMENT FUNCTION FOR CALCULATION OF RESONANCE.
    RESER(GR, GI) = COMFC1 * (GR * COSPS + GI * SINPS) + COMFC2 * (GI * COSPS - GR * SINPS)
    !
    !     DEFINE RESONANCE INDEPENDENT QUANTITIES.
    !
    ESQRT = DSQRT(E)
    !-----TYPE OF BACKGROUND (NOT L VALUE).
    LI = LVALUE(ISECT)
    !-----ADLER-ADLER PARAMETERS ARE ONLY DEFINED FOR L=0, IN WHICH CASE
    !-----THE PHASE SHIFT IS EQUAL TO RHO (NO NEED TO CALL FACPHI).
    RHOP = RHOP1(ISECT) * DSQRT(E)
    COSPS = DCOS(RHOP)
    SINPS = DSIN(RHOP)
    !
    !     DEFINE BACKGROUND CROSS SECTIONS.
    !
    GO TO (10, 20, 30, 40, 50, 60, 70), LI
    10 SIGNTI = BACKGR(LOW)
    GO TO 80
    20 SIGNFI = BACKGR(LOW)
    GO TO 80
    30 SIGNTI = BACKGR(LOW)
    SIGNFI = BACKGR(LOW + 1)
    GO TO 80
    40 SIGNGI = BACKGR(LOW)
    GO TO 80
    50 SIGNTI = BACKGR(LOW)
    SIGNGI = BACKGR(LOW + 1)
    GO TO 80
    60 SIGNFI = BACKGR(LOW)
    SIGNGI = BACKGR(LOW + 1)
    GO TO 80
    70 SIGNTI = BACKGR(LOW)
    SIGNFI = BACKGR(LOW + 1)
    SIGNGI = BACKGR(LOW + 2)
    !
    !     RESONANCE LOOP.
    !
    !-----DEFINE BASE ADDRESS FOR RESONANCE PARAMETERS.
    80 LOW = LOW + 3
    DO 90 JR = LOW, LHI, 2
        JRP1 = JR + 1
        !-----CONSTRAIN FIT TO USE SAME RESONANCE ENERGY AND TOTAL WIDTH FOR
        !-----ALL REACTIONS (SEE ENDF/B-102 PROCEDURES MANUAL).
        DET = ENRES(JR) - E
        DWT = RESTAB(2, JR)
        DEN = DET * DET + DWT * DWT
        COMFC1 = DWT / DEN
        COMFC2 = DET / DEN
        SIGNTI = SIGNTI + RESER(RESTAB(3, JR), RESTAB(4, JR))
        SIGNFI = SIGNFI + RESER(RESTAB(1, JRP1), RESTAB(2, JRP1))
        SIGNGI = SIGNGI + RESER(RESTAB(5, JRP1), RESTAB(6, JRP1))
        !-----END OF RESONANCE LOOP.
    90 CONTINUE
    !-----MULTIPLY ALL BY THE SQUARE ROOT OF E AND ADD TERM TO TOTAL.
    SIGNTI = ESQRT * SIGNTI + TWO * (ONE - COSPS)
    SIGNFI = ESQRT * SIGNFI
    SIGNGI = ESQRT * SIGNGI
    !-----DEFINE ELASTIC BY SUBTRACTION.
    SIGNNI = SIGNTI - (SIGNFI + SIGNGI)
    RETURN
END
SUBROUTINE SIGAA5(E)
    !=======================================================================
    !
    !     ADD CONTRIBUTION OF ONE SECTION OF ADLER-ADLER PARAMETERS.
    !     THIS WILL INCLUDE THE BACKGROUND CROSS SECTION PLUS ALL
    !     RESONANCES, FOR ALL VALUES OF L AND J.
    !
    !     THIS ROUTINE USES THE ENDF/B-V AND VI DEFINITIONS OF THE
    !     ADLER-ADLER PARAMETERS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    !-----DEFINE ARITHMETIC STATEMENT FUNCTION FOR CALCULATION OF BACKGROUND
    BACKGR(JR) = ((((RESTAB(4, JR) / E + RESTAB(3, JR)) / E + RESTAB(2, JR)) / E + &
            RESTAB(1, JR)) + (RESTAB(6, JR) * E + RESTAB(5, JR)) * E)
    !
    !     DEFINE RESONANCE INDEPENDENT QUANTITIES.
    !
    ESQRT = DSQRT(E)
    !-----TYPE OF BACKGROUND (NOT L VALUE).
    LI = LVALUE(ISECT)
    !-----ADLER-ADLER PARAMETERS ARE ONLY DEFINED FOR L=0, IN WHICH CASE
    !-----THE PHASE SHIFT IS EQUAL TO RHO (NO NEED TO CALL FACPHI).
    RHOP = RHOP1(ISECT) * ESQRT
    COSPS = DCOS(RHOP)
    SINPS = DSIN(RHOP)
    !-----INITIALIZE SUMS.
    SIGNT1 = ZERO
    SIGNT2 = ZERO
    SIGNT3 = ZERO
    SIGNT4 = ZERO
    SIGNF1 = ZERO
    SIGNF2 = ZERO
    SIGNG1 = ZERO
    SIGNG2 = ZERO
    !
    !     DEFINE BACKGROUND CROSS SECTIONS.
    !
    GO TO (10, 20, 30, 40, 50, 60, 70), LI
    10 SIGNTI = BACKGR(LOW)
    GO TO 80
    20 SIGNFI = BACKGR(LOW)
    GO TO 80
    30 SIGNTI = BACKGR(LOW)
    SIGNFI = BACKGR(LOW + 1)
    GO TO 80
    40 SIGNGI = BACKGR(LOW)
    GO TO 80
    50 SIGNTI = BACKGR(LOW)
    SIGNGI = BACKGR(LOW + 1)
    GO TO 80
    60 SIGNFI = BACKGR(LOW)
    SIGNGI = BACKGR(LOW + 1)
    GO TO 80
    70 SIGNTI = BACKGR(LOW)
    SIGNFI = BACKGR(LOW + 1)
    SIGNGI = BACKGR(LOW + 2)
    !
    !     RESONANCE LOOP.
    !
    !-----DEFINE BASE ADDRESS FOR RESONANCE PARAMETERS.
    80 LOW = LOW + 3
    DO 90 JR = LOW, LHI, 2
        JRP1 = JR + 1
        !-----CONSTRAIN FIT TO USE SAME RESONANCE ENERGY AND TOTAL WIDTH FOR
        !-----ALL REACTIONS (SEE ENDF/B-102 PROCEDURES MANUAL).
        DET = ENRES(JR) - E
        DWT = RESTAB(2, JR)
        GRT = RESTAB(3, JR)
        GIT = RESTAB(4, JR)
        DEN = DET * DET + DWT * DWT
        COMFC1 = DWT / DEN
        COMFC2 = DET / DEN
        SIGNT1 = SIGNT1 + COMFC1 * GRT
        SIGNT2 = SIGNT2 + COMFC1 * GIT
        SIGNT3 = SIGNT3 + COMFC2 * GIT
        SIGNT4 = SIGNT4 + COMFC2 * GRT
        SIGNF1 = SIGNF1 + COMFC1 * RESTAB(1, JRP1)
        SIGNF2 = SIGNF2 + COMFC2 * RESTAB(2, JRP1)
        SIGNG1 = SIGNG1 + COMFC1 * RESTAB(5, JRP1)
        SIGNG2 = SIGNG2 + COMFC2 * RESTAB(6, JRP1)
        !-----END OF RESONANCE LOOP.
    90 CONTINUE
    !-----ADD POTENTIAL TO TOTAL, MULTIPLY BY THE SQUARE ROOT OF E.
    SIGNTI = TWO * (ONE - COSPS) + ESQRT * (SIGNTI + &
            (SIGNT1 + SIGNT3) * COSPS + (SIGNT2 - SIGNT4) * SINPS)
    SIGNFI = ESQRT * (SIGNFI + SIGNF1 + SIGNF2)
    SIGNGI = ESQRT * (SIGNGI + SIGNG1 + SIGNG2)
    !-----DEFINE ELASTIC BY SUBTRACTION.
    SIGNNI = SIGNTI - (SIGNFI + SIGNGI)
    RETURN
END
SUBROUTINE SIGHRF(E)
    !=======================================================================
    !
    !     ADD CONTRIBUTION OF ONE SECTION (L,S,J) OF HYBRID R-FUNCTION
    !     PARAMETERS.
    !
    !     EACH (L,S,J) STATE WILL BE TREATED AS A SEPARATE SECTION.
    !
    !     THE EQUATIONS DEFINED IN ENDF-102 SAY TO USE R-MATRIX FOR THE
    !     ELASTIC AND EXACTLY SINGLE LEVEL BREIT-WIGNER FOR ALL OTHER
    !     REACTIONS. THIS LEADS TO AN ODD MIXTURE TO EQUATIONS IN THE
    !     FOLLOWING TREATMENT.
    !
    !     CAPTURE AND FISSION CROSS SECTIONS ARE CALCULATED EXACTLY AS IN
    !     THE CASE OF SINGLE LEVEL BREIT-WIGNER RESONANCES (FOR DETAILS
    !     SEE, SUBROUTINE SIGBW1). HERE WE WILL ONLY CONSIDER THE ELASTIC
    !     CROSS SECTION.
    !
    !     TERMS USED TO DEFINE ELASTIC CROSS SECTION
    !     ==========================================
    !     WE DEFINE,
    !
    !     RP   = RLSJ*PLSJ
    !     RR0P = RR0LSJ*PLSJ
    !     RI0P = RI0LSJ*PLSJ
    !
    !            GAM(N)
    !     RP   = ========================        + (RR0P + I*RI0P)
    !            2*((ER-E) - I*(GAM(R)/2)
    !
    !            GAM(N)*(((ER-E)+I*GAM(R)/2)
    !          = ===========================     + (RR0P + I*RI0P)
    !            2*((ER-E)**2+(GAM(R)/2)**2)
    !
    !            GAM(N)*(ER-E)+I*GAM(N)*GAM(R)/2
    !          = =============================== + (RR0P + I*RI0P)
    !            2*((ER-E)**2+(GAM(R)/2)**2)
    !
    !     RP   = RRP   + I*RIP
    !
    !     RRP  =(GAM(N)*(ER-E))/DEN1         + RR0P
    !     RIP  =(GAM(N)*GAM(R)/2)/DEN1       + RI0P
    !     DEN1 =2*((ER-E)**2+(GAM(R)/2)**2)
    !
    !     SUMMED OVER RESONANCES FOR EACH (L,S,J) SEQUENCE. FOLLOWING THE
    !     SUM OVER RESONANCES WE DEFINE,
    !
    !            1 + I*PLSJ*RLSJ   1 + I*RP   (1 - RIP) + I*RRP
    !     XLSJ = =============== = ========   =================
    !            1 - I*PLSJ*RLSJ   1 - I*RP   (1 + RIP) - I*RRP
    !
    !            ((1 - RIP) + I*RRP)*((1 + RIP) + I*RRP)
    !          = =======================================
    !            ((1 + RIP)**2 + (RRP)**2)
    !
    !            1 - RIP**2 - RRP**2 + I*2*RRP
    !          = =============================
    !            ((1 + RIP)**2 + (RRP)**2)
    !
    !                  2*(RIP+ RIP**2 + RRP**2 - I*RRP)
    !          = 1 -  =================================
    !                 ((1 + RIP)**2 + (RRP)**2)
    !
    !     XLSJ = (1 - R) - I*IS
    !
    !     R    = 2*(RIP+((RIP)**2+(RRP)**2)/DEN2
    !     S    =-2*RRP/DEN2
    !     DEN2 =(1 + RIP)**2 + (RRP)**2
    !
    !     DEFINITION OF THE ELASTIC CROSS SECTION
    !     =======================================
    !     THE ELASTIC CROSS SECTION IS DEFINED TO BE,
    !
    !     ELASTIC      = GJ*(1 - ULSJ)**2
    !
    !     ULSJ         = EXP(-I*2*PS)*XLSJ
    !                  = (COS(2*PS) - I*SIN(2*PS))*((R + 1) - I*S)
    !
    !     ELASTIC  = GJ*((2*SIN(PS)**2+R)**2 + (SIN(2*PS)+S)**2)
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    !-----TEMPORARILY DEFINE REAL AND IMAGINARY BACKGROUND TO BE ZERO.
    DATA SFC/0.0D+00/
    DATA R0R/0.0D+00/
    DATA R0I/0.0D+00/
    !
    !     DEFINE RESONANCE INDEPENDENT QUANTITIES.
    !
    GJ = GJTAB(ISECT)
    RHO2 = E * RHOX2(ISECT)
    RHOP = RHOP1(ISECT) * DSQRT(E)
    !-----DEFINE PENETRATION FACTOR, SHIFT FACTOR, PHASE SHIFT.
    CALL FACTS2(LVALUE(ISECT), RHO2, SF2, PF)
    CALL FACPHI(LVALUE(ISECT), RHOP, PS)
    COSPS = DCOS(PS)
    SINPS = DSIN(PS)
    !-----DEFINE SIN(2*PS) AND 2*SIN(PS)**2
    SIN2PS = TWO * SINPS * COSPS
    SINPS2 = TWO * SINPS * SINPS
    !
    !     FOR MISSING AND ILLEGAL J SEQUENCES (INDICATED BY NEGATIVE GJ)
    !     ADD (OR SUBTRACT) POTENTIAL CONTRIBUTION TO ELASTIC CROSS SECTION.
    !
    IF(GJ.GT.0.0) GO TO 10
    !-----ADD 4*GJ*SIN(PS)**2 (NOTE, SINPS2 = 2*SIN(PS)**2)
    SIGNNI = SIGNNI + TWO * RESTAB(3, LOW) * SINPS2
    GO TO 60
    !-----DEFINE PENETRATION FACTORS FOR COMPETITIVE WIDTHS, IF ANY.
    10 LRX = LRXTAB(ISECT)
    !-----INITIALIZE CONTRIBUTION OF (L,S,J) SEQUENCE.
    RR = PF * R0R
    RI = PF * R0I
    SIGNGJ = ZERO
    SIGNFJ = ZERO
    !
    !     RESONANCE LOOP. ADD CONTRIBUTION OF ALL RESONANCES WITH SAME
    !     (L,S,J).
    !
    DO 50 JR = LOW, LHI, 2
        ER = ENRES(JR)
        !-----DEFINE NEUTRON, CAPTURE AND FISSION WIDTHS. INITIALIZE ELIMINATED
        !-----WIDTH TO CAPTURE (COMPETING REACTIONS, IF ANY, WILL BE ADDED
        !-----BELOW).
        GN = RESTAB(2, JR)
        GAMN = PF * GN
        GAMG = RESTAB(3, JR)
        GAMF = RESTAB(4, JR)
        GAMER = GAMG
        !-----DEFINE COMPETITIVE WIDTHS, IF ANY AND ADD TO ELIMINATED WIDTH.
        IF(LRX.LE.0) GO TO 40
        !-----INITIALIZE INDEX TO WIDTH AND EXIT CHANNEL L-VALUE.
        JRX1 = JR
        LL1 = 4
        JRX2 = JR + 1
        LL2 = 2
        !-----DEFINE COMPETITIVE WIDTHS AND ADD TO ELIMINATED WIDTH.
        DO 30 I = 1, LRX
            LL1 = LL1 + 1
            LL2 = LL2 + 1
            LCOM = RESTAB(LL2, JRX2)
            RHOC2 = (E + EXCITE(I, ISECT)) * RHOX2(ISECT)
            CALL FACTS2(LCOM, RHOC2, SFC, PFC)
            IF(LL1.LE.6) GO TO 20
            JRX1 = JRX2
            LL1 = 1
            20 GAMC = PFC * RESTAB(LL1, JRX1)
        30 GAMER = GAMER + GAMC
        !-----ADD CONTRIBUTION OF RESONANCE.
        40 GAMER2 = HALF * GAMER
        DE = E - (ER + GN * (SHIFT2(JR) - SF2))
        !-----R-MATRIX TREATMENT FOR ELASTIC.
        DEN = DE * DE + GAMER2 * GAMER2
        COMFAC = GAMN / DEN
        RR = RR + COMFAC * DE
        RI = RI + COMFAC * GAMER
        !-----BREIT-WIGNER TREATMENT FOR CAPTURE AND FISSION.
        GAMT = GAMER + GAMN + GAMF
        GAMT2 = HALF * GAMT
        DEN = DE * DE + GAMT2 * GAMT2
        COMFAC = GAMN / DEN
        SIGNGJ = SIGNGJ + COMFAC * GAMG
        SIGNFJ = SIGNFJ + COMFAC * GAMF
        !-----END OF RESONANCE LOOP.
    50 CONTINUE
    !-----DEFINE 2 TERMS FOR UNIFORM TREATMENT.
    DEN2 = (ONE + RI)**2 + RR**2
    RI = TWO * (RI + RI**2 + RR**2) / DEN2
    RR = -TWO * RR / DEN2
    !-----MULTIPLY CONTRIBUTION OF (L,S,J) SEQUENCE BY STATISTICAL WEIGHT
    !-----AND ADD TO SUM (NOTE, SINPS2 = 2*SIN(PS)**2).
    SIGNNI = SIGNNI + GJ * ((SINPS2 + RI)**2 + (SIN2PS + RR)**2)
    SIGNGI = SIGNGI + GJ * SIGNGJ
    SIGNFI = SIGNFI + GJ * SIGNFJ
    60 RETURN
END
SUBROUTINE SIGGRM(E)
    !=======================================================================
    !
    !     GENERAL R-MATRIX FORMALISM
    !     ==========================
    !
    !     GENERAL R-MATRIX FORMALISM HAS NOT YET BEEN IMPLEMENTED.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    DATA IMOK/0/
    IF(IMOK.NE.0) GO TO 20
    E = 0.0
    WRITE(OUTP, 10)
    WRITE(*, 10)
    CALL ENDIT
    10 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
            ' General R-Matrix Formalism has NOT yet been Implemented'/&
            ' Execution Terminated')
    20 RETURN
END
SUBROUTINE SIGURP(E)
    !=======================================================================
    !
    !     DEFINE CROSS SECTIONS FOR A SECTION OF UNRESOLVED RESONANCE
    !     (LRU=2), ENERGY DEPENDENT PARAMETERS (LRF=2).
    !
    !     CROSS SECTIONS ARE DEFINED BY INTERPOLATING PARAMETERS (NOT CROSS
    !     SECTIONS).
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SECTON/BETA(200), RHOX2(200), RHOP1(200), EL(200), EH(200), &
            GJTAB(200), EXCITE(4, 200), NLOW(200), NHIGH(200), LVALUE(200), &
            LRXTAB(200), NAPTAB(200), MODE(200), ISECT, NSECT
    COMMON/RANGER/LOW, LHI
    COMMON/PARAMS/RHO2, RHOP, BETAE, AL, SF2, PF, PS, COSPS, SINPS, SIGNTI, &
            SIGNNI, SIGNGI, SIGNFI
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION DUMSET(6)
    EQUIVALENCE (DUMSET(2), DX), (DUMSET(3), GXX), (DUMSET(4), GNOX), &
            (DUMSET(5), GGX), (DUMSET(6), GFX)
    !-----DEFINE L VALUE.
    LNOW = LVALUE(ISECT)
    !-----DEFINE INTERPOLATION LAW, STATISTICAL WEIGHT AND DEGREES OF
    !-----FREEDOM FOR EACH REACTION (CAPTURE DEGREES OF FREEDOM IS ASSUMED
    !-----TO BE INFINITY).
    INT = RESTAB(1, LOW)
    GJ = RESTAB(2, LOW)
    MUX = RESTAB(3, LOW)
    MUN = RESTAB(4, LOW)
    MUF = RESTAB(6, LOW)
    AMUN = MUN
    !-----FIND ENERGY OR ENERGY RANGE WHERE PARAMETERS ARE GIVEN.
    LOWP1 = LOW + 1
    DO 10 L = LOWP1, LHI
        IF(E - ENRES(L)) 20, 30, 10
    10 CONTINUE
    !-----EXTEND PARAMETERS AS CONSTANT OUTSIDE THEIR TABULATED ENERGY
    !-----RANGE.
    L = LHI
    GO TO 30
    20 IF(L.EQ.LOWP1) GO TO 30
    !-----INTERPOLATE PARAMETERS TO ENERGY E.
    CALL TERPUP(E, DUMSET, L, INT)
    GO TO 40
    !-----DEFINE PARAMETER SET AT E (E IS AN ENERGY AT WHICH PARAMETERS
    !-----IS TABULATED).
    30 DX = RESTAB(2, L)
    GXX = RESTAB(3, L)
    GNOX = RESTAB(4, L)
    GGX = RESTAB(5, L)
    GFX = RESTAB(6, L)
    !-----CALCULATE PENETRABILITY (VL) AND PHASE SHIFT(PS)
    40 E2= DSQRT(E)
    RHO2 = E * RHOX2(ISECT)
    RHOC = E2 * RHOP1(ISECT)
    CALL UNFAC(LNOW, RHO2, RHOC, AMUN, VL, PS)
    !-----DEFINE NEUTRON WIDTH.
    GNX = GNOX * VL * E2
    !-----CALCULATE FLUCTUATION INTEGRALS (RN, RC AND RF).
    CALL GNRL3(GNX, GGX, GFX, GXX, MUN, MUF, MUX, RN, RC, RF)
    !-----DEFINE COMMON FACTOR FOR ALL REACTIONS.
    TEMP = PI2 * GJ * GNX / DX
    !-----DEFINE CROSS SECTIONS FOR THIS (L, J) STATE.
    SIGNNI = (RN * GNX - TWO * (DSIN(PS)**2)) * TEMP
    SIGNGI = RC * GGX * TEMP
    SIGNFI = RF * GFX * TEMP
    !-----ADD L COMPONENT OF POTENTIAL SCATTERING DURING PASS THROUGH
    !-----FIRST J STATE OF EACH L VALUE (INDICATED BY EITHER A NEW MODE
    !-----MODE=RESONANCE REPRESENTATION, OR NEW L VALUE).
    IF(ISECT.EQ.1) GO TO 50
    IF(MODE(ISECT - 1).EQ.MODE(ISECT).AND.&
            LVALUE(ISECT - 1).EQ.LVALUE(ISECT)) GO TO 60
    50 SIGNNI = SIGNNI + (EIGHT * FLOAT(LNOW) + FOUR) * ((DSIN(PS))**2)
    60 RETURN
END
SUBROUTINE SIGURS(E)
    !=======================================================================
    !
    !     CROSS SECTIONS ARE DEFINED BY INTERPOLATING CROSS SECTIONS (NOT
    !     PARAMETERS). THIS ROUTINE IS PRESENTLY NOT IMPLEMENTED.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    DATA IMOK/0/
    IF(IMOK.NE.0) GO TO 20
    E = 0.0
    WRITE(OUTP, 10)
    WRITE(*, 10)
    CALL ENDIT
    10 FORMAT(1X, 7('WARNING...'), 'WARNING'/&
            ' Unresolved Parameter Interpolation has NOT been Implemented'/&
            ' Execution Terminated')
    20 RETURN
END
SUBROUTINE FROBNS(AM1, B, CM1, D)
    !=======================================================================
    !
    !     STARTING FROM THE COMPLEX MATRIX (A+I)+I*B, WHERE A AND B ARE
    !     SYMMETRIC, INVERT THE COMPLEX MATRIX TO DEFINE INVERSE (C+I)+I*D.
    !
    !     THE FROBENIUS-SCHUR METHOD IS USED TO INVERT THE COMPLEX MATRIX.
    !
    !     STARTING FROM THE DEFINITION OF THE COMPLEX MATRIX AND ITS INVERSE
    !
    !     IDENTITY = ((A+I)+I*B)*((C+I)+I*D)
    !
    !     WE OBTAIN 2 REAL MATRIX EQUATIONS
    !
    !     I       = (A+I)*(C+I)-B*D
    !     0       = B*(C+I)+(A+I)*D
    !
    !    -A       = (A+I)*C-B*D
    !    -B       = B*C+(A+I)*D
    !
    !     FROM THE SECOND EQUATION,
    !
    !     (A+I)*D = -(B+B*C) = -B*(C+I)
    !     D       =-INVERSE((A+I))*(B*(C+I))
    !
    !     SUBSTITUTING THIS EXPRESSION FOR (D) INTO THE FIRST EQUATION.
    !
    !    -A       = (A+I)*C+B*INVERSE((A+I))*(B*(C+I))
    !    -A       =((A+I)+B*INVERSE((A+I))*B)*C+B*INVERSE((A+I))*B
    !
    !     C       =-INVERSE((A+I)+B*INVERSE((A+I))*B)*(A+B*INVERSE((A+I))*B)
    !     D       =-INVERSE((A+I))*B*(C+I)
    !
    !     THIS METHOD REQUIRES ONLY 2 MATRIX INVERSIONS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    DIMENSION A(3, 3), B(3, 3), C(3, 3), D(3, 3), AI(3, 3), AIB(3, 3), AM1(3, 3), &
            CM1(3, 3), C2(3, 3), C3(3, 3)
    !-----DEFINE A = (A-I)+I
    DO 20 I = 1, 3
        DO 10 J = 1, 3
        10 A(I, J) = AM1(I, J)
    20 A(I, I) = A(I, I) + ONE
    !-----DEFINE THE INVERSE OF A.
    CALL COFACT(A, AI)
    !-----DEFINE INVERSE(A)*B
    DO 40 I = 1, 3
        DO 40 J = 1, 3
            SUM = ZERO
            DO 30 K = 1, 3
            30 SUM = SUM + AI(I, K) * B(K, J)
        40 AIB(I, J) = SUM
    !-----STORE A+B*INVERSE(A)*B IN C AND A'+B*INVERSE(A)*B IN C2.
    DO 60 I = 1, 3
        DO 60 J = 1, 3
            SUM = ZERO
            DO 50 K = 1, 3
            50 SUM = SUM + B(I, K) * AIB(K, J)
            C(I, J) = A(I, J) + SUM
        60 C2(I, J) = AM1(I, J) + SUM
    !-----DEFINE THE INVERSE OF A+B*INVERSE(A)*B
    CALL COFACT(C, C3)
    !-----DEFINE C' AND C = C' + I
    DO 90 I = 1, 3
        DO 80 J = 1, 3
            SUM = ZERO
            DO 70 K = 1, 3
            70 SUM = SUM + C3(I, K) * C2(K, J)
            C(I, J) = -SUM
        80 CM1(I, J) = -SUM
    90 C(I, I) = C(I, I) + ONE
    !-----DEFINE D.
    DO 110 I = 1, 3
        DO 110 J = 1, 3
            SUM = ZERO
            DO 100 K = 1, 3
            100 SUM = SUM + AIB(I, K) * C(K, J)
        110 D(I, J) = -SUM
    RETURN
END
SUBROUTINE COFACT(A, AI)
    !=======================================================================
    !
    !     USE METHOD OF COFACTORS TO INVERT SYMMETRIC 3 X 3 MATRIX (A).
    !     SINCE (A) IS SYMMETRIC, ITS INVERSE (AI) WILL ALSO BE
    !     SYMMETRIC.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    DIMENSION A(3, 3), AI(3, 3)
    !-----DEFINE DETERMINANT (ASSUMING SYMMETRIC).
    DET1 = A(2, 2) * A(3, 3) - A(2, 3) * A(3, 2)
    DET2 = A(2, 3) * A(3, 1) - A(2, 1) * A(3, 3)
    DET3 = A(2, 1) * A(3, 2) - A(2, 2) * A(3, 1)
    DET = A(1, 1) * DET1 + A(1, 2) * DET2 + A(1, 3) * DET3
    !-----DEFINE INVERSE (ASSUMING SYMMETRIC).
    AI(1, 1) = DET1 / DET
    AI(2, 1) = DET2 / DET
    AI(3, 1) = DET3 / DET
    AI(1, 2) = AI(2, 1)
    AI(2, 2) = (A(1, 1) * A(3, 3) - A(3, 1) * A(1, 3)) / DET
    AI(3, 2) = (A(1, 2) * A(3, 1) - A(1, 1) * A(3, 2)) / DET
    AI(1, 3) = AI(3, 1)
    AI(2, 3) = AI(3, 2)
    AI(3, 3) = (A(1, 1) * A(2, 2) - A(1, 2) * A(2, 1)) / DET
    RETURN
END
SUBROUTINE ORDER(LOW, LHI)
    !=======================================================================
    !
    !     FOR EACH SECTION (I.E., SAME ISOTOPE, ENERGY RANGE, L VALUE) SORT
    !     RESONANCES INTO ASCENDING (J, E) ORDER.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER SWITCH
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    !-----SORT IS NOT REQUIRED IF ONLY 1 RESONANCE.
    IF(LOW.EQ.LHI) GO TO 60
    LTOP = LHI
    LOWP1 = LOW + 1
    !
    !     J, E SORT.
    !
    DO 50 IR = LOWP1, LHI
        JRM1 = LOW
        SWITCH = 0
        DO 40 JR = LOWP1, LTOP
            IF(RESTAB(2, JRM1) - RESTAB(2, JR)) 40, 10, 20
            10 IF(ENRES(JRM1) - ENRES(JR)) 40, 40, 20
            !-----EXCHANGE RESONANCES INTO J, E ORDER.
            20 SWITCH = 1
            DRES = ENRES(JRM1)
            ENRES(JRM1) = ENRES(JR)
            ENRES(JR) = DRES
            DO 30 I = 1, 6
                A = RESTAB(I, JRM1)
                RESTAB(I, JRM1) = RESTAB(I, JR)
            30 RESTAB(I, JR) = A
        40 JRM1 = JR
        !-----STOP SORT IF ALL RESONANCES ARE ALREADY IN J, E ORDER.
        IF(SWITCH.LE.0) GO TO 60
        !-----RESONANCE WITH LARGEST J, E IS NOW IN LAST LOCATION (LTOP).
        !-----SHORTEN LENGTH OF TABLE TO CONTINUE SORT OF REMAINING RESONANCES.
    50 LTOP = LTOP - 1
    60 RETURN
END
SUBROUTINE SORTS(X, LX)
    !=======================================================================
    !
    !     SORT AN ARRAY INTO ASCENDING FLOATING POINT ORDER.
    !
    !     ARGUMENTS
    !     ---------
    !     X      = ARRAY TO SORT (DIMENSION LX)
    !     LX     = NUMBER OF ELEMENTS TO SORT
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER SWITCH
    DIMENSION X(LX)
    !-----IF LESS THAN TWO (2) ELEMENTS NO SORT IS REQUIRED.
    IF(LX.LT.2) RETURN
    !-----SET INNER LOOP INDICES
    LTOP = LX + 1
    !-----SET UP OUTER LOOP
    DO 30 IN = 2, LX
        !-----INITIALIZE EXCHANGE SWITCH OFF.
        SWITCH = 0
        !-----SET UPPER INDEX TO INNER LOOP
        LTOP = LTOP - 1
        !-----SET LARGEST ELEMENT INDICATOR TO FIRST ELEMENT
        LBIG = 1
        !-----SET UP INNER LOOP
        DO 20 J = 2, LTOP
            !-----COMPARE ELEMENTS
            IF(X(LBIG).GT.X(J)) GO TO 10
            !-----ELEMENTS ARE IN NUMERICAL ORDER. RESET INDEX TO LARGER ELEMENT.
            LBIG = J
            GO TO 20
            !-----ELEMENTS ARE NOT IN NUMERICAL ORDER. SET INTERCHANGE SWITCH.
            10 SWITCH = 1
            !-----END OF INNER LOOP
        20 CONTINUE
        !-----ARE ALL ELEMENTS ALREADY IN ORDER......
        IF(SWITCH.LE.0) RETURN
        !-----NO. MOVE LARGEST ELEMENT TO TOP OF REMAINING TABLE
        DUMMY = X(LBIG)
        X(LBIG) = X(LTOP)
        X(LTOP) = DUMMY
    30 CONTINUE
    RETURN
END
SUBROUTINE SORTD(X, LX)
    !=======================================================================
    !
    !     SORT AN ARRAY INTO ASCENDING DOUBLE PRECISION ORDER.
    !
    !     ARGUMENTS
    !     ---------
    !     X      = ARRAY TO SORT (DIMENSION LX)
    !     LX     = NUMBER OF ELEMENTS TO SORT
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER SWITCH
    DIMENSION X(LX)
    !-----IF LESS THAN TWO (2) ELEMENTS NO SORT IS REQUIRED.
    IF(LX.LT.2) RETURN
    !-----SET INNER LOOP INDICES
    LTOP = LX + 1
    !-----SET UP OUTER LOOP
    DO 30 IN = 2, LX
        !-----INITIALIZE EXCHANGE SWITCH OFF.
        SWITCH = 0
        !-----SET UPPER INDEX TO INNER LOOP
        LTOP = LTOP - 1
        !-----SET LARGEST ELEMENT INDICATOR TO FIRST ELEMENT
        LBIG = 1
        !-----SET UP INNER LOOP
        DO 20 J = 2, LTOP
            !-----COMPARE ELEMENTS
            IF(X(LBIG).GT.X(J)) GO TO 10
            !-----ELEMENTS ARE IN NUMERICAL ORDER. RESET INDEX TO LARGER ELEMENT.
            LBIG = J
            GO TO 20
            !-----ELEMENTS ARE NOT IN NUMERICAL ORDER. SET INTERCHANGE SWITCH.
            10 SWITCH = 1
            !-----END OF INNER LOOP
        20 CONTINUE
        !-----ARE ALL ELEMENTS ALREADY IN ORDER......
        IF(SWITCH.LE.0) RETURN
        !-----NO. MOVE LARGEST ELEMENT TO TOP OF REMAINING TABLE
        DUMMY = X(LBIG)
        X(LBIG) = X(LTOP)
        X(LTOP) = DUMMY
    30 CONTINUE
    RETURN
END
SUBROUTINE SUBINT
    !=======================================================================
    !
    !     DEFINE SUBINTERVALS BETWEEN NODES ACCORDING TO THE WIDTH OF
    !     THE TWO ADJACENT RESONANCES. THIS ROUTINE HAS A BUILT-IN TABLE
    !     OF MULTIPLES OF HALF-WIDTHS REQUIRED TO FIT A SIMPLE BREIT-WIGNER
    !     LINE SPACE TO WITHIN 1.0 PER-CENT ACCURACY OVER THE RANGE 0 TO
    !     500 HALF-WIDTHS,
    !
    !     SIGMA(X)=1.0/(1.0+X*X)
    !
    !     WHERE X IS THE DISTANCE PEAK IN HALF-WIDTHS
    !
    !     STARTING FROM THE LOWER ENERGY END OF AN INTERVAL AND USING
    !     SUB-INTERVALS BASED UPON THE WIDTH AT THE LOWER ENERGY END, NODES
    !     ARE INSERTED AT SUCESSIVELY HIGHER ENERGIES UNTIL A NODE IS
    !     CLOSER (IN HALF-WIDTH UNITS) TO THE UPPER ENERGY END OF THE
    !     INTERVAL. THEN USING SUB-INTERVALS BASED UPON THE WIDTH AT THE
    !     UPPER ENERGY, NODES ARE INSERTED UP TO THE UPPER ENERGY END OF
    !     THE INTERVAL.
    !
    !     WITH THIS ALOGORITHM CLOSELY SPACED RESONANCES WILL HAVE ONLY
    !     A FEW SUB-INTERVALS PER INTERVAL (E.G. U-235). WIDELY SPACED
    !     RESONANCES WILL HAVE MORE SUB-INTERVALS PER INTERVAL (E.G. U-238).
    !     FOR A MIX OF S, P, D ETC. RESONANCES THIS ALOGORITHM GUARANTEES
    !     AN ADEQUTE DESCRIPTION OF THE PROFILE OF EVEN EXTREMELY NARROW
    !     RESONANCES (WHICH MAY IMMEDIATELY CONVERGENCE TO THE ACCURACY
    !     REQUESTED, THUS MINIMIZING ITERATION).
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/SUBS/ESUB(217), ENODP, ENODM, WIDP, WIDM, ISUB, NSUB
    DIMENSION TIMES(108)
    !-----DEFINE NUMBER OF HALF WIDTH SPACINGS.
    DATA ITIMES/108/
    !-----DEFINE HALF WIDTH SPACINGS OF SUBINTERVALS.
    DATA TIMES/&
            0.000D+00, 1.000D-01, 2.000D-01, 3.000D-01, 4.000D-01, 4.500D-01, &
            5.000D-01, 5.500D-01, 6.000D-01, 7.000D-01, 8.000D-01, 9.000D-01, &
            1.000D+00, 1.200D+00, 1.400D+00, 1.600D+00, 1.800D+00, 2.000D+00, &
            2.200D+00, 2.400D+00, 2.600D+00, 2.800D+00, 3.000D+00, 3.200D+00, &
            3.400D+00, 3.600D+00, 3.800D+00, 4.000D+00, 4.200D+00, 4.400D+00, &
            4.600D+00, 4.800D+00, 5.200D+00, 5.600D+00, 6.000D+00, 6.500D+00, &
            7.000D+00, 7.500D+00, 8.000D+00, 8.500D+00, 9.000D+00, 9.500D+00, &
            1.000D+01, 1.050D+01, 1.100D+01, 1.150D+01, 1.200D+01, 1.250D+01, &
            1.300D+01, 1.350D+01, 1.400D+01, 1.450D+01, 1.500D+01, 1.550D+01, &
            1.600D+01, 1.700D+01, 1.800D+01, 1.900D+01, 2.000D+01, 2.100D+01, &
            2.200D+01, 2.300D+01, 2.400D+01, 2.500D+01, 2.600D+01, 2.700D+01, &
            2.800D+01, 2.900D+01, 3.000D+01, 3.100D+01, 3.200D+01, 3.300D+01, &
            3.400D+01, 3.600D+01, 3.800D+01, 4.000D+01, 4.200D+01, 4.400D+01, &
            4.600D+01, 4.800D+01, 5.000D+01, 5.300D+01, 5.600D+01, 5.900D+01, &
            6.200D+01, 6.600D+01, 7.000D+01, 7.400D+01, 7.800D+01, 8.200D+02, &
            8.600D+01, 9.000D+01, 9.400D+01, 9.800D+01, 1.020D+02, 1.098D+02, &
            1.232D+02, 1.382D+02, 1.550D+02, 1.739D+02, 1.951D+02, 2.189D+02, &
            2.456D+02, 2.756D+02, 3.092D+02, 3.469D+02, 3.892D+02, 4.367D+02/
    !
    !     LOWER ENERGY END OF INTERVAL.
    !
    !-----START FIRST SUBINTERVAL AT BEGINNING OF INTERVAL.
    NSUB = 1
    ESUB(1) = ENODM
    !-----IF LOWER WIDTH IS ZERO DO NOT INSERT ANY MORE SUB-INTERVALS NEAR
    !-----LOWER ENERGY END OF INTERVAL.
    IF(WIDM) 10, 10, 40
    !-----IF UPPER WIDTH IS ZERO DO NOT INSERT ANY MORE SUB-INTERVALS NEAR
    !-----UPPER ENERGY END OF INTERVAL (START ITERATION FROM LOWER AND UPPER
    !-----ENERGY LIMITS...UNRESOLVED RESONANCE REGION).
    10 IF(WIDP) 20, 20, 30
    20 NSUB = 2
    ESUB(2) = ENODP
    RETURN
    !-----LOWER WIDTH IS ZERO BUT UPPER LIMIT IS NOT. DEFINE INDEX TO INSERT
    !-----AS MANY SUB-INTERVALS AS POSSIBLE.
    30 ISUB = ITIMES
    GO TO 130
    !-----LOWER WIDTH IS NOT ZERO. IF UPPER WIDTH IS ZERO, SET MIDPOINT TO
    !-----BE EXACTLY EQUAL TO UPPER LIMIT (AVOID ROUND-OFF IN DEFINITION).
    40 IF(WIDP) 50, 50, 60
    50 EMID = ENODP
    GO TO 70
    60 EMID = (WIDM * ENODP + WIDP * ENODM) / (WIDM + WIDP)
    CALL CORE9(EMID, 3)
    !-----INSERT SUBINTERVALS FROM LOWER ENERGY LIMIT UP TO MIDPOINT
    !-----BETWEEN RESONANCES (BASED ON HALF-WIDTH UNITS).
    70 DO 100 ISUB = 2, ITIMES
        ENOW = ENODM + TIMES(ISUB) * WIDM
        CALL CORE9(ENOW, 3)
        IF(ENOW - EMID) 80, 110, 110
        80 IF(ENOW - ESUB(NSUB)) 100, 100, 90
        90 NSUB = NSUB + 1
        ESUB(NSUB) = ENOW
    100 CONTINUE
    ISUB = ITIMES
    !-----ADD MIDPOINT AS NODE.
    110 NSUB = NSUB + 1
    ESUB(NSUB) = EMID
    !
    !     UPPER ENERGY END OF INTERVAL.
    !
    !-----IF UPPER WIDTH IS ZERO USE END POINT AS LAST NODE (EITHER ADD
    !-----AN ADDITIONAL NODE OR SET LAST NODE ENERGY TO END POINT ENERGY).
    IF(WIDP) 120, 120, 130
    120 IF(ENODP - ESUB(NSUB)) 180, 180, 170
    !-----INSERT SUBINTERVALS FROM MIDPOINT UP TO NEXT RESONANCE.
    130 IISUB = ISUB
    DO 160 K = 2, ISUB
        ENOW = ENODP - TIMES(IISUB) * WIDP
        CALL CORE9(ENOW, 3)
        IF(ENOW - ENODP) 140, 170, 170
        140 IF(ENOW - ESUB(NSUB)) 160, 160, 150
        150 NSUB = NSUB + 1
        ESUB(NSUB) = ENOW
    160 IISUB = IISUB - 1
    !-----ADD ENDPOINT AS NODE.
    170 NSUB = NSUB + 1
    180 ESUB(NSUB) = ENODP
    RETURN
END
SUBROUTINE NOODLE(ERES, WID, ELOW, EHIGH)
    !=======================================================================
    !
    !     CORE ALLOCATION FOR NODES.
    !
    !     SAVE ENERGY (ERES) AND WIDTH (WID) AS NODE IN ASCENDING ENERGY
    !     ORDER IF IT IS IN THE ENERGY RANGE (ELOW,EHIGH). OTHERWISE IGNOR.
    !
    !     IF CORE ALLOCATION IS EXCEEDED TERMINATE UNLESS IN EDIT MODE.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE, ADDNOD
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/ETABS/NODES
    COMMON/MAXIE/MAXSEC, MAXRES, MAXNOD, NEDSEC, NEDRES, NEDNOD
    COMMON/IWATCH/IMEDIT, MAKEPLUS, MONITR, IMBACK
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DATA ADDNOD/0/
    !-----ONLY USE NODES IN RESONANCE REGION.
    IF(ERES.LT.ELOW.OR.ERES.GT.EHIGH) GO TO 90
    !-----IF NO OTHER NODES YET SAVE FIRST NODE.
    IF(NODES.LE.0) GO TO 50
    !-----COMPARE TO ALL NODES SAVED SO FAR.
    DO 20 I = 1, NODES
        IF(ERES - ENODE(I)) 30, 10, 20
        !-----SAME AS PREVIOUS ENERGY. ADD WIDTHS AND RETURN.
        10 WIDNOD(I) = WIDNOD(I) + WID
        GO TO 90
    20 CONTINUE
    !-----NEW NODE TO ADD TO END OF TABLE.
    GO TO 50
    !-----MOVE ALL FOLLOWING NODES BACK ONE LOCATION IN TABLE AND INSERT
    !-----NODE IN ENERGY ORDER.
    30 NN = NODES + 1
    IF((NN + ADDNOD).GT.NEDNOD) NEDNOD = NN + ADDNOD
    IF(NN.GT.MAXNOD) GO TO 70
    DO 40 J = I, NODES
        ENODE(NN) = ENODE(NN - 1)
        WIDNOD(NN) = WIDNOD(NN - 1)
    40 NN = NN - 1
    ENODE(I) = ERES
    WIDNOD(I) = WID
    NODES = NODES + 1
    GO TO 90
    !-----ADD NEW NODE TO END OF TABLE.
    50 NODES = NODES + 1
    IF((NODES + ADDNOD).GT.NEDNOD) NEDNOD = NODES + ADDNOD
    IF(NODES.GT.MAXNOD) GO TO 70
    60 ENODE(NODES) = ERES
    WIDNOD(NODES) = WID
    GO TO 90
    !-----TOO MANY NODES. PRINT ERROR MESSAGE AND TERMINATE UNLESS IN EDIT
    !-----MODE.
    70 IF(IMEDIT.NE.2) GO TO 80
    ADDNOD = ADDNOD + MAXNOD
    NODES = 1
    GO TO 60
    80 WRITE(OUTP, 100) MAXNOD
    WRITE(*, 100) MAXNOD
    CALL ENDIT
    90 RETURN
    100 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' More than', I5, ' Nodes'/&
            ' Re-Run Program in Edit Mode to Determine Memory Requirements'/&
            1X, 78('=')/' Execution Terminated'/1X, 78('='))
END
SUBROUTINE FACTS2(L, RHO2, SF2, PF)
    !=======================================================================
    !
    !     CALCULATE 1/2 THE SHIFT FACTOR (SF2) AND PENETRATION FACTOR (PF)
    !     FROM L VALUE AND RHO2 (RHO2=RHO*RHO).
    !
    !     THE SHIFT FACTOR IS USED TO DEFINE THE ENERGY DEPENDENT RESONANCE
    !     PEAK ENERGY IN THE FORM
    !
    !     ERP=ER+0.5*GAMN*(SF(ABS(ER))-SF(E))
    !
    !     IN ORDER TO AVOID HAVING TO MULTIPLY BY 0.5 EVERYTIME THE SHIFT
    !     FACTOR IS USED THIS ROUTINE WILL RETURN 1/2 THE SHIFT FACTOR.
    !     THIS IS DONE SIMPLY BY DEFINING ALL CONSTANTS WHICH ARE USED TO
    !     DERIVE THE SHIFT FACTOR TO BE 1/2 THERE NORMAL DEFINITION (THUS
    !     COMPLETELY AVOIDING THE MULTIPLICATION BY 1/2).
    !
    !     FOR NEGATIVE ENERGY PENETRATION AND SHIFT FACTORS ARE SET EQUAL
    !     TO ZERO (SEE SUMMARY OF CSEWG MEETING, MAY 16-17, 1979
    !     RESONANCE SUB-COMMITTEE REPORT). THIS CAN OCCUR FOR THE
    !     COMPETITIVE WIDTH AT ENERGIES BELOW THE COMPETITIVE THRESHOLD.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    DATA DNINE/9.0D+00/
    DATA CA/1.5D+00/
    DATA CB/2.25D+02/
    DATA C3/4.5D+01/
    DATA C4/6.0D+00/
    DATA C5/3.375D+02/
    DATA C6/3.0D+00/
    DATA C7/1.1025D+04/
    DATA C8/1.575D+03/
    DATA C9/1.35D+02/
    DATA C10/1.0D+01/
    DATA C11/2.2050D+04/
    DATA C12/2.3625D+03/
    DATA C13/1.35D+02/
    DATA C14/5.0D+00/
    DATA C15/8.93025D+05/
    DATA C16/9.9225D+04/
    DATA C17/6.3D+03/
    DATA C18/3.15D+02/
    DATA C19/1.5D+01/
    DATA C20/2.2325625D+06/
    DATA C21/1.9845D+05/
    DATA C22/9.45D+03/
    DATA C23/3.15D+02/
    DATA C24/7.5D+00/
    IF(RHO2.GT.ZERO) GO TO 10
    SF2 = ZERO
    PF = ZERO
    RETURN
    10 LL = L + 1
    RHO = DSQRT(RHO2)
    GO TO (20, 30, 40, 50, 60, 70), LL
    !-----S-WAVE
    20 SF2 = ZERO
    PF = RHO
    RETURN
    !-----P-WAVE
    30 DEN = ONE + RHO2
    PF = RHO2 * RHO / DEN
    SF2 = -HALF / DEN
    RETURN
    !-----D-WAVE (L=2)
    40 RHO4 = RHO2 * RHO2
    DEN = THREE * RHO2 + RHO4 + DNINE
    PF = RHO4 * RHO / DEN
    SF2 = -(DNINE + CA * RHO2) / DEN
    RETURN
    !-----F-WAVE (L=3)
    50 RHO4 = RHO2 * RHO2
    RHO6 = RHO4 * RHO2
    DEN = CB + C3 * RHO2 + C4 * RHO4 + RHO6
    PF = RHO6 * RHO / DEN
    SF2 = -(C5 + C3 * RHO2 + C6 * RHO4) / DEN
    RETURN
    !-----G-WAVE (L=4)
    60 RHO4 = RHO2 * RHO2
    RHO6 = RHO4 * RHO2
    RHO8 = RHO4 * RHO4
    DEN = C7 + C8 * RHO2 + C9 * RHO4 + C10 * RHO6 + RHO8
    PF = RHO8 * RHO / DEN
    SF2 = -(C11 + C12 * RHO2 + C13 * RHO4 + C14 * RHO6) / DEN
    RETURN
    !-----(L=5)
    70 RHO4 = RHO2 * RHO2
    RHO6 = RHO4 * RHO2
    RHO8 = RHO4 * RHO4
    RHO10 = RHO4 * RHO6
    DEN = C15 + C16 * RHO2 + C17 * RHO4 + C18 * RHO6 + C19 * RHO8 + RHO10
    PF = RHO10 * RHO / DEN
    SF2 = -(C20 + C21 * RHO2 + C22 * RHO4 + C23 * RHO6 + C24 * RHO8) / DEN
    RETURN
END
SUBROUTINE FACPHI(L, RHOP, PS)
    !=======================================================================
    !
    !     CALCULATE PHASE SHIFT (PS) FROM L VALUE AND RHOP.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    DATA PHIMIN/1.0D-06/
    DATA CA/1.5D+01/
    DATA CB/6.0D+00/
    DATA C3/1.05D+02/
    DATA C4/1.0D+01/
    DATA C5/4.5D+01/
    DATA C6/9.45D+02/
    DATA C7/4.2D+02/
    LL = L + 1
    GO TO (10, 20, 30, 40, 50, 60), LL
    !-----S-WAVE (L=0)
    10 PS = RHOP
    GO TO 90
    !-----P-WAVE (L=1)
    20 PS = RHOP - DATAN(RHOP)
    GO TO 80
    !-----D-WAVE (L=2)
    30 RATIO = THREE / (THREE - RHOP * RHOP)
    GO TO 70
    !-----F-WAVE (L=3)
    40 RHOP2 = RHOP * RHOP
    RATIO = (CA - RHOP2) / (CA - CB * RHOP2)
    GO TO 70
    !-----G-WAVE (L=4)
    50 RHOP2 = RHOP * RHOP
    RATIO = (C3 - C4 * RHOP2) / (C3 - (C5 - RHOP2) * RHOP2)
    GO TO 70
    !-----(L=5)
    60 RHOP2 = RHOP * RHOP
    RATIO = (C6 - (C3 - RHOP2) * RHOP2) / (C6 - (C7 - CA * RHOP2) * RHOP2)
    70 PS = RHOP - DATAN(RATIO * RHOP)
    80 IF(DABS(PS / RHOP).LT.PHIMIN) PS = 0.0
    90 RETURN
END
SUBROUTINE UNFAC(L, RHO2, RHOC, AMUN, VL, PS)
    !=======================================================================
    !
    !     CALCULATE THE PENETRABILITY FACTOR (VL) AND PHASE SHIFT (PS)
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    DATA DNINE/9.0D+00/
    LL = L + 1
    GO TO (10, 20, 30), LL
    !-----S-WAVE
    10 VL = AMUN
    PS = RHOC
    GO TO 40
    !-----P-WAVE
    20 VL = AMUN * RHO2 / (ONE + RHO2)
    PS = RHOC - DATAN(RHOC)
    GO TO 40
    !-----D-WAVE
    30 RHO4 = RHO2 * RHO2
    VL = AMUN * RHO4 / (DNINE + THREE * RHO2 + RHO4)
    PS = RHOC - DATAN(THREE * RHOC / (THREE - RHOC * RHOC))
    40 RETURN
END
SUBROUTINE GNRL3(GNX, GGX, GFX, GXX, MUN, MUF, MUX, RN, RC, RF)
    !=======================================================================
    !
    !     CALCULATE UNRESOLVED RESONANCE FLUCTUATION FUNCTION
    !     (ORIGINAL CODING FROM AVERAGE4 BY MULKI BHAT)
    !     (NEW WEIGHTING SCHEME FROM MC SQUARED)
    !
    !     THIS ROUTINE HAS BEEN MODIFIED TO CALCULATE ELASTIC, CAPTURE
    !     AND FISSION FLUCTUATION FUNCTIONS ALL DURING ONE CALL (AS
    !     OPPOSED TO THE ORIGINAL VERSION WHICH CALCULATED EACH REACTION
    !     SEPARATELY).
    !
    !     GNX, GGX, GFX AND GXX ARE THE WIDTHS FOR ELASTIC, CAPTURE,
    !     FISSION AND COMPETITION. MUN, MUF AND MUX ARE THE NUMBER OF
    !     DEGREES OF FREEDOM FOR ELASTIC, FISSION AND COMPETITION (INFINITE
    !     NUMBER OF DEGREES ASSUMED FOR CAPTURE). RN, RC AND RF ARE THE
    !     CALCULATED FLUCTUATION INTEGRALS FOR ELASTIC, CAPTURE AND FISSION
    !
    !     THE NUMBER OF DEGREES OF FREEDOM FOR EACH DISTRIBUTION (ELASTIC,
    !     FISSION OR COMPETITION) MAY BE 1 TO 4. IF THE NUMBER OF DEGREES
    !     OF FREEDOM FOR ANY DISTRIBUTION IS LESS THAN 1 OR MORE THAN 4
    !     IT WILL BE TREATED AS AN INFINITE NUMBER OF DEGREES OF FREEDOM
    !     (WHICH INFERS THAT THE WIDTHS ARE NOT DISTRIBUTED, BUT ARE RATHER
    !     ALL EQUAL TO THE AVERAGE VALUE). THIS LAST CASE IS SIMULATED BY
    !     DEFINING AN ADDITIONAL 10 POINT QUADRATURE IN WHICH THE WEIGHT
    !     FOR ONE POINT IS 1.0 AND THE WEIGHT FOR ALL OTHER POINTS IS ZERO.
    !     FOR THE ONE POINT OF WEIGHT 1.0 THE AVERAGE WIDTH WILL BE USED.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    DIMENSION XX(5, 10), WW(5, 10)
    DATA XX/&
            3.0013465D-03, 1.3219203D-02, 1.0004488D-03, 1.3219203D-02, 1.0D+0, &
            7.8592886D-02, 7.2349624D-02, 2.6197629D-02, 7.2349624D-02, 0.0D+0, &
            4.3282415D-01, 1.9089473D-01, 1.4427472D-01, 1.9089473D-01, 0.0D+0, &
            1.3345267D+00, 3.9528842D-01, 4.4484223D-01, 3.9528842D-01, 0.0D+0, &
            3.0481846D+00, 7.4083443D-01, 1.0160615D+00, 7.4083443D-01, 0.0D+0, &
            5.8263198D+00, 1.3498293D+00, 1.9421066D+00, 1.3498293D+00, 0.0D+0, &
            9.9452656D+00, 2.5297983D+00, 3.3150885D+00, 2.5297983D+00, 0.0D+0, &
            1.5782128D+01, 5.2384894D+00, 5.2607092D+00, 5.2384894D+00, 0.0D+0, &
            2.3996824D+01, 1.3821772D+01, 7.9989414D+00, 1.3821772D+01, 0.0D+0, &
            3.6216208D+01, 7.5647525D+01, 1.2072069D+01, 7.5647525D+01, 0.0D+0/
    DATA WW/&
            1.1120413D-01, 3.3773418D-02, 3.3376214D-04, 1.7623788D-03, 1.0D+0, &
            2.3546798D-01, 7.9932171D-02, 1.8506108D-02, 2.1517749D-02, 0.0D+0, &
            2.8440987D-01, 1.2835937D-01, 1.2309946D-01, 8.0979849D-02, 0.0D+0, &
            2.2419127D-01, 1.7652616D-01, 2.9918923D-01, 1.8797998D-01, 0.0D+0, &
            1.0967668D-01, 2.1347043D-01, 3.3431475D-01, 3.0156335D-01, 0.0D+0, &
            3.0493789D-02, 2.1154965D-01, 1.7766657D-01, 2.9616091D-01, 0.0D+0, &
            4.2930874D-03, 1.3365186D-01, 4.2695894D-02, 1.0775649D-01, 0.0D+0, &
            2.5827047D-04, 2.2630659D-02, 4.0760575D-03, 2.5171914D-03, 0.0D+0, &
            4.9031965D-06, 1.6313638D-05, 1.1766115D-04, 8.9630388D-10, 0.0D+0, &
            1.4079206D-08, 0.0000000D+00, 5.0989546D-07, 0.0000000D+00, 0.0D+0/
    !-----INITIALIZE FLUCTUATION INTEGRALS FOR ELASTIC, CAPTURE AND FISSION.
    RN = 0.0
    RC = 0.0
    RF = 0.0
    !-----INTEGRALS ARE ZERO IF NEUTRON AND CAPTURES WIDTHS ARE NOT
    !-----POSITIVE.
    IF(GNX.LE.0.0.OR.GGX.LE.0.0) RETURN
    !-----INSURE NUMBER OF DEGREES OF FREEDOM FOR ELASTIC WIDTHS IN O.K.
    IF(MUN.LT.1.OR.MUN.GT.4) MUN = 5
    !-----IS THERE FISSION.
    IF(GFX) 130, 10, 60
    !
    !     NOT FISSILE.
    !
    !-----NO FISSION. IS THERE A COMPETITIVE WIDTH.
    10 IF(GXX.GT.0.0) GO TO 30
    !-----NO COMPETITIVE WIDTH. 1-D QUADRATURE.
    DO 20 J = 1, 10
        XJ = XX(MUN, J)
        FACTOR = WW(MUN, J) * XJ / (GNX * XJ + GGX)
        RN = RN + XJ * FACTOR
    20 RC = RC + FACTOR
    RETURN
    !-----COMPETITIVE WIDTH. 2-D QUADRATURE. INSURE NUMBER OF DEGREES OF
    !-----FREEDOM FOR COMPETITIVE WIDTH IS O.K.
    30 IF(MUX.LT.1.OR.MUX.GT.4) MUX = 5
    DO 50 J = 1, 10
        XJ = XX(MUN, J)
        WJXJ = WW(MUN, J) * XJ
        EFFJ = GNX * XJ + GGX
        DO 40 K = 1, 10
            XK = XX(MUX, K)
            FACTOR = WW(MUX, K) * WJXJ / (EFFJ + GXX * XK)
            RN = RN + XJ * FACTOR
        40 RC = RC + FACTOR
    50 CONTINUE
    RETURN
    !
    !     FISSILE.
    !
    !-----FISSION PRESENT. INSURE NUMBER OF DEGREES OF FREEDOM FOR FISSION
    !-----IS O.K.
    60 IF(MUF.LT.1.OR.MUF.GT.4) MUF = 5
    !-----IS THERE A COMPETITIVE WIDTH.
    IF(GXX.GT.0.0) GO TO 90
    !-----NO COMPETITIVE WIDTH. 2-D QUADRATURE.
    DO 80 J = 1, 10
        XJ = XX(MUN, J)
        WJXJ = WW(MUN, J) * XJ
        EFFJ = GNX * XJ + GGX
        DO 70 K = 1, 10
            XK = XX(MUF, K)
            FACTOR = WW(MUF, K) * WJXJ / (EFFJ + GFX * XK)
            RN = RN + XJ * FACTOR
            RC = RC + FACTOR
        70 RF = RF + XK * FACTOR
    80 CONTINUE
    RETURN
    !-----COMPETITIVE WIDTH. 3-D QUADRATURE. INSURE NUMBER OF DEGREES OF
    !-----FREEDOM FOR COMPETITIVE WIDTH IS O.K.
    90 IF(MUX.LT.1.OR.MUX.GT.4) MUX = 5
    DO 120 J = 1, 10
        XJ = XX(MUN, J)
        WJXJ = WW(MUN, J) * XJ
        EFFJ = GNX * XJ + GGX
        DO 110 K = 1, 10
            XK = XX(MUF, K)
            WKWJXJ = WW(MUF, K) * WJXJ
            EFFJK = EFFJ + GFX * XK
            DO 100 I = 1, 10
                XL = XX(MUX, I)
                FACTOR = WW(MUX, I) * WKWJXJ / (EFFJK + GXX * XL)
                RN = RN + XJ * FACTOR
                RC = RC + FACTOR
            100 RF = RF + XK * FACTOR
        110 CONTINUE
    120 CONTINUE
    130 RETURN
END
SUBROUTINE TERPUP(E, DUMSET, L, INT)
    !=======================================================================
    !
    !     INTERPOLATE UNRESOLVED RESONANCE PARAMETERS. RESONANCE SPACING,
    !     COMPETITIVE, NEUTRON, CAPTURE AND FISSION WIDTHS ARE ALL
    !     INTERPOLATED AT THE SAME TIME AND RETURNED IN LOCATIONS DUMSET(2)
    !     THROUGH DUMSET(6), RESPECTIVELY.
    !
    !     THIS ROUTINE HAS BEEN RECODED IN ORDER TO AVOID ROUND-OFF
    !     PROBLEMS ON SHORT WORD LENGTH COMPUTERS, E.G. IBM-360, 370, ETC.
    !     THIS ROUTINE IS NOW SLIGHTLY LESS EFFICIENT THAN IN ITS PREVIOUS
    !     FORM. HOWEVER ALL INTERPOLATION IS NOW DEFINED AS A WEIGHTED SUM
    !     OF TERMS, AS OPPOSED TO THE PREVIOUS FORM WHICH USED DIFFERENCES.
    !
    !     THIS ROUTINE IS ONLY USED TO INTERPOLATE PARAMETERS IN THE
    !     UNRESOLVED RESONANCE REGION. IN ORDER TO INSURE THAT IN ALL CASES
    !     INTERPOLATION CAN BE PERFORMED, IF THE PARAMETER IS NOT POSITIVE
    !     AND LOG INTERPOLATION OF THE CROSS SECTION IS SPECIFIED (I =4 OR
    !     5), THE INTERPOLATION OF THE CROSS SECTION WILL BE SWITCHED TO
    !     LINEAR (I=2 OR 3) AND A WARNING MESSAGE WILL BE PRINTED.
    !
    !     AN ILLEGAL INTERPOLATION CODE OR A NON-POSITIVE ENERGY WHERE LOG
    !     ENERGY INTERPOLATION IS REQUIRED INDICATES EITHER AN ERROR IN THE
    !     DATA AS IT APPEARS IN THE ENDF/B FORMAT, OR AN ERROR IN THIS
    !     PROGRAM. THEREFORE ERRORS OF THIS TYPE WILL CAUSE THE PROGRAM TO
    !     PRINT A WARNING MESSAGE AND TERMINATE EXECUTION.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 FIELD
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/CONJOB/PI, PI2, ZERO, HALF, ONE, TWO, THREE, FOUR, EIGHT
    COMMON/FIELDC/FIELD(11, 12)
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION DUMSET(6)
    !-----CHECK INTERPOLATION CODE.
    IF(INT.LT.1.OR.INT.GT.5) GO TO 170
    !-----DEFINE INDEX TO LOWER ENERGY LIMIT.
    LM1 = L - 1
    !-----DEFINE ENERGIES AT THE 2 ENDS OF THE INTERVAL.
    E1 = ENRES(LM1)
    E2 = ENRES(L)
    !-----CHECK FOR ZERO LENGTH INTERVAL.
    DE12 = E2 - E1
    IF(DE12.EQ.0.0) GO TO 200
    !-----SELECT INTERPOLATION LAW.
    GO TO (10, 110, 140, 30, 70), INT
    !
    !     HISTOGRAM. CONSTANT EQUAL TO VALUE AT LOWER ENERGY LIMIT.
    !
    10 DO 20 I = 2, 6
    20 DUMSET(I) = RESTAB(I, LM1)
    RETURN
    !
    !     LINEAR X AND LOG Y.
    !
    30 WT2 = (E - E1) / DE12
    WT1 = ONE - WT2
    DO 60 I = 2, 6
        !-----IF Y IS NOT POSITIVE OR CONSTANT SET FLAG AND USE LINEAR Y
        !-----INTERPOLATION.
        IF(RESTAB(I, LM1).GT.0.0.AND.RESTAB(I, L).GT.0.0) GO TO 40
        IF(RESTAB(I, LM1).EQ.RESTAB(I, L)) GO TO 50
        !-----LOG INTERPOLATION OF PARAMETERS IS NOT POSSIBLE. SWITCH TO LINEAR.
        GO TO 120
        40 DUMSET(I) = DEXP(WT1 * DLOG(RESTAB(I, LM1)) + WT2 * DLOG(RESTAB(I, L)))
        GO TO 60
        50 DUMSET(I) = RESTAB(I, LM1)
    60 CONTINUE
    RETURN
    !
    !     LOG X AND LOG Y.
    !
    70 IF(E1.LE.0.0.OR.E2.LE.0.0.OR.E.LE.0.0) GO TO 190
    WT2 = DLOG(E / E1) / DLOG(E2 / E1)
    WT1 = ONE - WT2
    DO 100 I = 2, 6
        !-----IF Y IS NOT POSITIVE OR CONSTANT SET FLAG AND USE LINEAR Y
        !-----INTERPOLATIOM.
        IF(RESTAB(I, LM1).GT.0.0.AND.RESTAB(I, L).GT.0.0) GO TO 80
        IF(RESTAB(I, LM1).EQ.RESTAB(I, L)) GO TO 90
        !-----LOG INTERPOLATION OF PARAMETERS IS NOT POSSIBLE. SWITCH TO LINEAR.
        GO TO 150
        80 DUMSET(I) = DEXP(WT1 * DLOG(RESTAB(I, LM1)) + WT2 * DLOG(RESTAB(I, L)))
        GO TO 100
        90 DUMSET(I) = RESTAB(I, LM1)
    100 CONTINUE
    RETURN
    !
    !     LINEAR X AND LINEAR Y.
    !
    110 WT2 = (E - E1) / DE12
    WT1 = ONE - WT2
    120 DO 130 I = 2, 6
    130 DUMSET(I) = WT1 * RESTAB(I, LM1) + WT2 * RESTAB(I, L)
    RETURN
    !
    !     LOG X AND LINEAR Y.
    !
    !-----INSURE ALL X VALUES ARE POSITIVE FOR LOG.
    140 IF(E1.LE.0.0.OR.E2.LE.0.0.OR.E.LE.0.0) GO TO 190
    WT2 = DLOG(E / E1) / DLOG(E2 / E1)
    WT1 = ONE - WT2
    150 DO 160 I = 2, 6
    160 DUMSET(I) = WT1 * RESTAB(I, LM1) + WT2 * RESTAB(I, L)
    RETURN
    !-----ILLEGAL INTERPOLATE CODE.
    170 WRITE(OUTP, 210) INT
    180 WRITE(OUTP, 240)
    CALL ENDIT
    !-----ILLEGAL LOG ENERGY INTERPOLATION WITH NEGATIVE VALUES.
    190 CALL OUT9(E1, FIELD(1, 1), 3)
    CALL OUT9(E2, FIELD(1, 2), 3)
    CALL OUT9(E, FIELD(1, 3), 3)
    WRITE(OUTP, 220) ((FIELD(M, J), M = 1, 11), J = 1, 3)
    GO TO 180
    !-----ZERO LENGTH ENERGY INTERVAL.
    200 CALL OUT9(E1, FIELD(1, 1), 3)
    CALL OUT9(E2, FIELD(1, 2), 3)
    WRITE(OUTP, 230) ((FIELD(M, J), M = 1, 11), J = 1, 2)
    GO TO 180
    210 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Interpolating Unresolved Parameters.'/&
            ' Illegal Interpolation Code =', I5, ' (MUST be 1 to 5).'/&
            ' Correct Evaluated Data and Re-Run Program.')
    220 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Interpolating Unresolved Parameters.'/&
            ' Illegal Log Energy Interpolation Using Negative Energy.'/&
            ' Interpolation Code=', I5, ' (Cannot be 3 or 5).'/&
            ' E1,E2,E=', 3(11A1, 1X)/&
            ' Correct Evaluated Data and Re-Run Program.')
    230 FORMAT(1X, 78('=')/1X, 7('WARNING...'), 'WARNING'/&
            ' Interpolating Unresolved Parameters.'/&
            ' Illegal Interpolation Over Zero Length Interval.'/&
            'E1,E2=', 11A1, 1X, 11A1/&
            ' Correct Evaluated Data and Re-Run Program.')
    240 FORMAT(1X, 78('=')/' Execution Terminated'/1X, 78('='))
END
SUBROUTINE LISPAR(IXLOW, IX, IXD)
    !=======================================================================
    !
    !     READ AND LIST ALL RESONANCE PARAMETERS
    !
    !     PARAMETERS ARE READ IN DOUBLE PRECISION.
    !     THE ENERGY AND WIDTH ARE SAVED IN DOUBLE PRECISION TO DEFINE THE
    !     ENERGY GRID.
    !     ALL PARAMETERS ARE THEN SAVED IN SINGLE PRECISION.
    !
    !     IXLOW   = STARTING INDEX TO RESONANCE PARAMETER TABLE
    !     IX      = NUMBER OF WORDS TO READ
    !     IXD     = NUMBER OF WORDS PER RESONANCE (6 OR 12)
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    COMMON/INDATS/ZA, AWR, ZAI, ABN, SPI, AP, AWRI, QX, NRS, NIS, LFW, NER, &
            LRU, LRF, NLS
    COMMON/INDATD/ELX, EHX
    COMMON ENRES(120000), SHIFT2(120000), ENODE(120000), WIDNOD(120000), &
            ETAB2(120001), RESTAB(6, 120000), SIG2(4, 120001), RESJTAB(120000)
    DIMENSION XD(6, 2)
    DATA ZEROD/0.0D+00/
    !
    !     READ PARAMETERS FOR EACH RESONANCE.
    !
    !-----DEFINE NUMBER OF LINES TO READ - 6 PARAMETERS PER LINE.
    KLINE = IXD / 6
    KXLOW = IXLOW - 1
    DO 90 I1 = 1, IX, IXD
        !-----READ IN DOUBLE PRECISION.
        CALL LISTIO(XD, IXD)
        !-----COPY TO SINGLE PRECISION PARAMETER ARRAY.
        DO 10 K = 1, KLINE
            KXLOW = KXLOW + 1
            ENRES(KXLOW) = XD(1, K)
            DO 10 I = 1, 6
            10 RESTAB(I, KXLOW) = XD(I, K)
        !
        !     SAVE RESONANCE ENERGY AS A NODE.
        !
        IF(LRU.EQ.2) GO TO 80
        !-----RESOLVED.
        GO TO (20, 20, 30, 40, 50, 60), LRF
        !-----BREIT-WIGNER.
        20 WIDTOT = XD(3, 1)
        GO TO 70
        !-----REICH-MOORE
        30 WIDTOT = XD(3, 1) + XD(4, 1) + DABS(XD(5, 1)) + DABS(XD(6, 1))
        GO TO 70
        !-----ADLER-ADLER
        40 WIDTOT = XD(2, 1)
        GO TO 70
        !-----GENERAL-R-MATRIX (NOT IMPLEMENTED).
        50 WIDTOT = ZEROD
        GO TO 70
        !-----HYBRID-R-MATRIX
        60 WIDTOT = XD(2, 1) + XD(3, 1) + XD(4, 1) + XD(5, 1) + XD(6, 1) + XD(1, 2) + XD(2, 2)
        !-----DEFINE RESOLVED REGION NODE.
        70 CALL NOODLE(XD(1, 1), WIDTOT, ELX, EHX)
        GO TO 90
        !-----DEFINE UNRESOLVED REGION NODE.
        80 CALL NOODLE(XD(1, 1), ZEROD, ELX, EHX)
    90 CONTINUE
    RETURN
END
SUBROUTINE FILEIO
    !=======================================================================
    !
    !     DEFINE ALL I/O UNITS.
    !
    !=======================================================================
    IMPLICIT DOUBLE PRECISION (A-H, O-Z)
    SAVE
    INTEGER OUTP, OTAPE
    CHARACTER*1 NAME1, NAME2
    CHARACTER*60 NAME1X, NAME2X
    COMMON/ENDFIO/INP, OUTP, ITAPE, OTAPE
    COMMON/UNITS/ISCR2, ISCR23
    COMMON/NAMEX/NAME1(60), NAME2(60)
    EQUIVALENCE (NAME1X, NAME1(1)), (NAME2X, NAME2(1))
    !-----DEFINE ALL I/O UNITS.
    INP = 2
    OUTP = 3
    ITAPE = 10
    OTAPE = 11
    ISCR2 = 12
    ISCR23 = 14
    !-----DEFINE ALL FILE NAMES.
    OPEN(INP, FILE = 'THERMX.INP', STATUS = 'OLD')
    OPEN(OUTP, FILE = 'THERMX.LST', STATUS = 'UNKNOWN')
    CALL SCRATCH1(ISCR2, 'RECENT.001  ')
    CALL SCRATCH1(ISCR23, 'RECENT.002  ')
    RETURN
    ENTRY FILIO2
    !=======================================================================
    !
    !     DEFINE ENDF/B DATA I/O UNITS AND OPTIONALLY DEFINE FILE NAMES.
    !
    !=======================================================================
    OPEN(ITAPE, FILE = NAME1X, STATUS = 'OLD')
    OPEN(OTAPE, FILE = NAME2X, STATUS = 'UNKNOWN')
END
SUBROUTINE ENDIT
    !=======================================================================
    !
    !     PRINT EXECUTION TIME AND TERMINATE
    !
    !=======================================================================
    CALL TIMER
    STOP
END